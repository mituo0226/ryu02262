{
  "version": 3,
  "sources": ["../bundle-9GwSE9/checked-fetch.js", "../pages-tdhAkN/bundle-u00RrT/checked-fetch.js", "../../functions/_lib/token.js", "../../functions/api/auth/login.ts", "../../functions/_lib/deities.js", "../../functions/api/auth/register.ts", "../../functions/api/auth/reset-passphrase.ts", "../../functions/api/auth/update-deity.ts", "../../functions/_lib/admin-auth.js", "../../functions/api/admin/conversations.ts", "../../functions/api/admin/users.ts", "../../functions/api/cleanup-conversations.ts", "../../functions/_lib/characters/kaede.js", "../../functions/_lib/characters/yukino.js", "../../functions/_lib/characters/sora.js", "../../functions/_lib/characters/kaon.js", "../../functions/_lib/character-system.js", "../../functions/_lib/character-loader.js", "../../functions/api/consult.ts", "../../functions/api/conversation.ts", "../../functions/api/conversation-history.ts", "../../functions/api/last-conversations.ts", "../pages-tdhAkN/functionsWorker-0.5506474401351913.mjs/functionsRoutes-0.18170136633384493.mjs", "../pages-tdhAkN/bundle-u00RrT/middleware-loader.entry.ts", "../pages-tdhAkN/bundle-u00RrT/middleware-insertion-facade.js", "../../../../AppData/Roaming/npm/node_modules/wrangler/templates/pages-template-worker.ts", "../../../../AppData/Roaming/npm/node_modules/wrangler/node_modules/path-to-regexp/src/index.ts", "../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-9GwSE9/middleware-insertion-facade.js", "../../../../../AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../bundle-9GwSE9/middleware-loader.entry.ts"],
  "sourceRoot": "C:\\Users\\mituo\\Desktop\\kaede\\.wrangler\\tmp\\dev-bIPxv8",
  "sourcesContent": ["const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "const urls = new Set();\n\nfunction checkURL(request, init) {\n\tconst url =\n\t\trequest instanceof URL\n\t\t\t? request\n\t\t\t: new URL(\n\t\t\t\t\t(typeof request === \"string\"\n\t\t\t\t\t\t? new Request(request, init)\n\t\t\t\t\t\t: request\n\t\t\t\t\t).url\n\t\t\t\t);\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\n\t\tif (!urls.has(url.toString())) {\n\t\t\turls.add(url.toString());\n\t\t\tconsole.warn(\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\n\t\t\t);\n\t\t}\n\t}\n}\n\nglobalThis.fetch = new Proxy(globalThis.fetch, {\n\tapply(target, thisArg, argArray) {\n\t\tconst [request, init] = argArray;\n\t\tcheckURL(request, init);\n\t\treturn Reflect.apply(target, thisArg, argArray);\n\t},\n});\n", "const encoder = new TextEncoder();\r\nconst TOKEN_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30 days\r\n\r\nfunction base64UrlEncode(buffer) {\r\n  const bytes = new Uint8Array(buffer);\r\n  let binary = '';\r\n  bytes.forEach((byte) => {\r\n    binary += String.fromCharCode(byte);\r\n  });\r\n  const base64 = btoa(binary);\r\n  return base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\r\n}\r\n\r\nasync function getKey(secret) {\r\n  return crypto.subtle.importKey(\r\n    'raw',\r\n    encoder.encode(secret),\r\n    { name: 'HMAC', hash: 'SHA-256' },\r\n    false,\r\n    ['sign', 'verify']\r\n  );\r\n}\r\n\r\nasync function generateUserToken(userId, secret) {\r\n  const issuedAt = Date.now();\r\n  const payload = `${userId}.${issuedAt}`;\r\n  const key = await getKey(secret);\r\n  const signatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(payload));\r\n  const signature = base64UrlEncode(signatureBuffer);\r\n  return `${userId}.${issuedAt}.${signature}`;\r\n}\r\n\r\nasync function verifyUserToken(token, secret) {\r\n  if (!token) {\r\n    return null;\r\n  }\r\n  const parts = token.split('.');\r\n  if (parts.length !== 3) {\r\n    return null;\r\n  }\r\n  const [userIdPart, issuedAtPart, signature] = parts;\r\n  const userId = Number(userIdPart);\r\n  const issuedAt = Number(issuedAtPart);\r\n  if (!Number.isFinite(userId) || !Number.isFinite(issuedAt)) {\r\n    return null;\r\n  }\r\n  if (Date.now() - issuedAt > TOKEN_TTL_MS) {\r\n    return null;\r\n  }\r\n  const payload = `${userId}.${issuedAt}`;\r\n  const key = await getKey(secret);\r\n  const expectedSignatureBuffer = await crypto.subtle.sign('HMAC', key, encoder.encode(payload));\r\n  const expectedSignature = base64UrlEncode(expectedSignatureBuffer);\r\n  if (expectedSignature !== signature) {\r\n    return null;\r\n  }\r\n  return { userId };\r\n}\r\n\r\nmodule.exports = {\r\n  generateUserToken,\r\n  verifyUserToken,\r\n};\r\n\r\n", "import { generateUserToken } from '../../_lib/token.js';\n\ninterface LoginRequestBody {\n  nickname?: string;\n  birthYear?: number;\n  birthMonth?: number;\n  birthDay?: number;\n  passphrase?: string;\n}\n\ninterface LoginResponseBody {\n  userToken: string;\n  nickname: string;\n  passphrase: string;\n  guardian: string | null;\n}\n\nexport const onRequestPost: PagesFunction = async ({ request, env }) => {\n  const headers = { 'Content-Type': 'application/json' };\n\n  let body: LoginRequestBody;\n  try {\n    body = (await request.json()) as LoginRequestBody;\n  } catch {\n    return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers });\n  }\n\n  const { nickname, birthYear, birthMonth, birthDay, passphrase } = body;\n\n  if (!nickname || typeof nickname !== 'string') {\n    return new Response(JSON.stringify({ error: 'nickname is required' }), { status: 400, headers });\n  }\n  if (\n    typeof birthYear !== 'number' ||\n    typeof birthMonth !== 'number' ||\n    typeof birthDay !== 'number' ||\n    !passphrase\n  ) {\n    return new Response(JSON.stringify({ error: '\u751F\u5E74\u6708\u65E5\u3068\u5408\u8A00\u8449\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002' }), {\n      status: 400,\n      headers,\n    });\n  }\n\n  const trimmedNickname = nickname.trim();\n  const trimmedPassphrase = passphrase.trim();\n\n  const user = await env.DB.prepare<{\n    id: number;\n    nickname: string;\n    passphrase: string;\n    guardian: string | null;\n  }>(\n    `SELECT id, nickname, passphrase, guardian\n     FROM users\n     WHERE nickname = ?\n       AND birth_year = ?\n       AND birth_month = ?\n       AND birth_day = ?\n       AND passphrase = ?`\n  )\n    .bind(trimmedNickname, birthYear, birthMonth, birthDay, trimmedPassphrase)\n    .first();\n\n  if (!user) {\n    return new Response(JSON.stringify({ error: '\u5165\u529B\u3055\u308C\u305F\u60C5\u5831\u304C\u4E00\u81F4\u3057\u307E\u305B\u3093\u3002' }), {\n      status: 401,\n      headers,\n    });\n  }\n\n  const userToken = await generateUserToken(user.id, env.AUTH_SECRET);\n\n  const responseBody: LoginResponseBody = {\n    userToken,\n    nickname: user.nickname,\n    passphrase: user.passphrase,\n    guardian: user.guardian,\n  };\n\n  return new Response(JSON.stringify(responseBody), { status: 200, headers });\n};\n\n\n\n\n\n", "const deities = [\r\n  '\u685C\u821E\u3044\u6563\u308B\u6625\u306E\u9053',\r\n  '\u6708\u660E\u304B\u308A\u306B\u6D6E\u304B\u3076\u5922',\r\n  '\u661F\u964D\u308B\u591C\u306E\u7269\u8A9E',\r\n  '\u671D\u9732\u306B\u5149\u308B\u5E0C\u671B',\r\n  '\u5915\u713C\u3051\u306E\u3084\u3055\u3057\u3055',\r\n  '\u8679\u306E\u67B6\u3051\u6A4B',\r\n  '\u6625\u98A8\u306B\u63FA\u308C\u308B\u82B1',\r\n  '\u96EA\u5316\u7CA7\u306E\u9759\u3051\u3055',\r\n  '\u98A8\u9234\u306E\u6DBC\u3057\u3044\u97F3',\r\n  '\u8749\u3057\u3050\u308C\u306E\u590F',\r\n  '\u7D05\u8449\u6563\u308B\u5C0F\u9053',\r\n  '\u521D\u96EA\u306E\u8D08\u308A\u7269',\r\n  '\u83DC\u306E\u82B1\u7551\u306E\u6625',\r\n  '\u86CD\u821E\u3046\u5915\u3079',\r\n  '\u96F2\u6D77\u306B\u6D6E\u304B\u3076\u5922',\r\n  '\u6CE2\u306E\u97F3\u306E\u5B50\u5B88\u6B4C',\r\n  '\u9727\u96E8\u306E\u6F64\u3044',\r\n  '\u843D\u8449\u306E\u6577\u304D\u6BEF',\r\n  '\u6625\u971E\u306E\u63FA\u3089\u304E',\r\n  '\u5C0F\u9CE5\u306E\u3055\u3048\u305A\u308A',\r\n  '\u5C0F\u5DDD\u306E\u305B\u305B\u3089\u304E',\r\n  '\u91CE\u539F\u306E\u98A8\u8ECA',\r\n  '\u85E4\u8272\u306E\u82B1',\r\n  '\u91D1\u8272\u306E\u7A32\u7A42'\r\n];\r\n\r\nfunction getRandomDeity() {\r\n  const index = Math.floor(Math.random() * deities.length);\r\n  return deities[index];\r\n}\r\n\r\nmodule.exports = {\r\n  deities,\r\n  getRandomDeity,\r\n};\r\n\r\n", "import { getRandomDeity } from '../../_lib/deities.js';\nimport { generateUserToken } from '../../_lib/token.js';\n\ninterface RegisterRequestBody {\n  nickname?: string;\n  birthYear?: number;\n  birthMonth?: number;\n  birthDay?: number;\n}\n\ninterface RegisterResponseBody {\n  userToken: string;\n  passphrase: string;\n  nickname: string;\n}\n\nexport const onRequestPost: PagesFunction = async ({ request, env }) => {\n  const headers = { 'Content-Type': 'application/json' };\n\n  let body: RegisterRequestBody;\n  try {\n    body = (await request.json()) as RegisterRequestBody;\n  } catch {\n    return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers });\n  }\n\n  const { nickname, birthYear, birthMonth, birthDay } = body;\n\n  if (!nickname || typeof nickname !== 'string') {\n    return new Response(JSON.stringify({ error: 'nickname is required' }), { status: 400, headers });\n  }\n  if (\n    typeof birthYear !== 'number' ||\n    typeof birthMonth !== 'number' ||\n    typeof birthDay !== 'number'\n  ) {\n    return new Response(JSON.stringify({ error: 'birth date is required' }), { status: 400, headers });\n  }\n\n  const trimmedNickname = nickname.trim();\n  if (!trimmedNickname) {\n    return new Response(JSON.stringify({ error: 'nickname cannot be empty' }), { status: 400, headers });\n  }\n\n  const existingUser = await env.DB.prepare<{ id: number }>(\n    'SELECT id FROM users WHERE nickname = ?'\n  )\n    .bind(trimmedNickname)\n    .first();\n\n  if (existingUser) {\n    return new Response(JSON.stringify({ error: '\u3053\u306E\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u306F\u65E2\u306B\u4F7F\u7528\u3055\u308C\u3066\u3044\u307E\u3059\u3002' }), {\n      status: 409,\n      headers,\n    });\n  }\n\n  const passphrase = getRandomDeity();\n\n  const insertResult: any = await env.DB.prepare(\n    `INSERT INTO users (nickname, birth_year, birth_month, birth_day, passphrase)\n     VALUES (?, ?, ?, ?, ?)`\n  )\n    .bind(trimmedNickname, birthYear, birthMonth, birthDay, passphrase)\n    .run();\n\n  const userId = insertResult?.meta?.last_row_id;\n  if (!userId) {\n    return new Response(JSON.stringify({ error: '\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002' }), { status: 500, headers });\n  }\n\n  const userToken = await generateUserToken(userId, env.AUTH_SECRET);\n\n  const responseBody: RegisterResponseBody = {\n    userToken,\n    passphrase,\n    nickname: trimmedNickname,\n  };\n\n  return new Response(JSON.stringify(responseBody), { status: 200, headers });\n};\n\n\n\n\n", "import { getRandomDeity } from '../../_lib/deities.js';\nimport { generateUserToken } from '../../_lib/token.js';\n\ninterface ResetRequestBody {\n  nickname?: string;\n  birthYear?: number;\n  birthMonth?: number;\n  birthDay?: number;\n}\n\ninterface ResetResponseBody {\n  userToken: string;\n  nickname: string;\n  passphrase: string;\n}\n\nexport const onRequestPost: PagesFunction = async ({ request, env }) => {\n  const headers = { 'Content-Type': 'application/json' };\n\n  try {\n    if (!env.AUTH_SECRET) {\n      return new Response(\n        JSON.stringify({ error: '\u30B5\u30FC\u30D0\u30FC\u8A2D\u5B9A\u30A8\u30E9\u30FC: AUTH_SECRET \u304C\u672A\u8A2D\u5B9A\u3067\u3059\u3002' }),\n        { status: 500, headers }\n      );\n    }\n\n    let body: ResetRequestBody;\n    try {\n      body = (await request.json()) as ResetRequestBody;\n    } catch {\n      return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers });\n    }\n\n    const { nickname, birthYear, birthMonth, birthDay } = body;\n\n    if (!nickname || typeof nickname !== 'string') {\n      return new Response(JSON.stringify({ error: 'nickname is required' }), { status: 400, headers });\n    }\n    if (\n      typeof birthYear !== 'number' ||\n      typeof birthMonth !== 'number' ||\n      typeof birthDay !== 'number'\n    ) {\n      return new Response(JSON.stringify({ error: 'birth date is required' }), { status: 400, headers });\n    }\n\n    const trimmedNickname = nickname.trim();\n    if (!trimmedNickname) {\n      return new Response(JSON.stringify({ error: 'nickname cannot be empty' }), { status: 400, headers });\n    }\n\n    const user = await env.DB.prepare<{ id: number }>(\n      `SELECT id FROM users\n       WHERE nickname = ?\n         AND birth_year = ?\n         AND birth_month = ?\n         AND birth_day = ?`\n    )\n      .bind(trimmedNickname, birthYear, birthMonth, birthDay)\n      .first();\n\n    if (!user) {\n      return new Response(\n        JSON.stringify({ error: '\u5165\u529B\u3055\u308C\u305F\u60C5\u5831\u304C\u4E00\u81F4\u3057\u307E\u305B\u3093\u3002' }),\n        { status: 404, headers }\n      );\n    }\n\n    const newPassphrase = getRandomDeity();\n\n    await env.DB.prepare(\n      `UPDATE users\n       SET passphrase = ?\n       WHERE id = ?`\n    )\n      .bind(newPassphrase, user.id)\n      .run();\n\n    const userToken = await generateUserToken(user.id, env.AUTH_SECRET);\n\n    const responseBody: ResetResponseBody = {\n      userToken,\n      nickname: trimmedNickname,\n      passphrase: newPassphrase,\n    };\n\n    return new Response(JSON.stringify(responseBody), { status: 200, headers });\n  } catch (error) {\n    console.error('Error in reset-passphrase endpoint:', error);\n    return new Response(\n      JSON.stringify({ error: 'Internal server error' }),\n      { status: 500, headers }\n    );\n  }\n};\n\n\n\n\n\n", "import { verifyUserToken } from '../../_lib/token.js';\r\n\r\ninterface UpdateDeityRequestBody {\r\n  guardian: string;\r\n}\r\n\r\nexport const onRequestPost: PagesFunction = async ({ request, env }) => {\r\n  const headers = { 'Content-Type': 'application/json' };\r\n\r\n  // \u8A8D\u8A3C\u30C1\u30A7\u30C3\u30AF\r\n  const authHeader = request.headers.get('Authorization');\r\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n    return new Response(JSON.stringify({ error: '\u8A8D\u8A3C\u304C\u5FC5\u8981\u3067\u3059' }), { status: 401, headers });\r\n  }\r\n\r\n  const token = authHeader.substring(7);\r\n  const tokenData = await verifyUserToken(token, env.AUTH_SECRET);\r\n  if (!tokenData) {\r\n    return new Response(JSON.stringify({ error: '\u7121\u52B9\u306A\u30C8\u30FC\u30AF\u30F3\u3067\u3059' }), { status: 401, headers });\r\n  }\r\n\r\n  const userId = tokenData.userId;\r\n\r\n  let body: UpdateDeityRequestBody;\r\n  try {\r\n    body = (await request.json()) as UpdateDeityRequestBody;\r\n  } catch {\r\n    return new Response(JSON.stringify({ error: 'Invalid JSON body' }), { status: 400, headers });\r\n  }\r\n\r\n  const { guardian } = body;\r\n  if (!guardian || typeof guardian !== 'string') {\r\n    return new Response(JSON.stringify({ error: 'guardian is required' }), { status: 400, headers });\r\n  }\r\n\r\n  const trimmedGuardian = guardian.trim();\r\n  if (!trimmedGuardian) {\r\n    return new Response(JSON.stringify({ error: 'guardian cannot be empty' }), { status: 400, headers });\r\n  }\r\n\r\n  // \u30E6\u30FC\u30B6\u30FC\u60C5\u5831\u3092\u66F4\u65B0\r\n  await env.DB.prepare(\r\n    `UPDATE users\r\n     SET guardian = ?\r\n     WHERE id = ?`\r\n  )\r\n    .bind(trimmedGuardian, userId)\r\n    .run();\r\n\r\n  return new Response(JSON.stringify({ success: true, guardian: trimmedGuardian }), { status: 200, headers });\r\n};\r\n\r\n\r\n", "function isAdminAuthorized(request, env) {\r\n  const header = request.headers.get('x-admin-token') || request.headers.get('X-Admin-Token');                                                                  \r\n  if (!env.ADMIN_TOKEN) {\r\n    console.warn('ADMIN_TOKEN is not configured');\r\n    return false;\r\n  }\r\n  return header === env.ADMIN_TOKEN;\r\n}\r\n\r\nfunction unauthorizedResponse() {\r\n  return new Response(JSON.stringify({ error: 'Unauthorized' }), {\r\n    status: 401,\r\n    headers: { 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nmodule.exports = {\r\n  isAdminAuthorized,\r\n  unauthorizedResponse,\r\n};\r\n\r\n", "import { isAdminAuthorized, unauthorizedResponse } from '../../_lib/admin-auth.js';\n\nconst jsonHeaders = { 'Content-Type': 'application/json' };\n\nexport const onRequest: PagesFunction = async ({ request, env }) => {\n  if (!isAdminAuthorized(request, env)) {\n    return unauthorizedResponse();\n  }\n\n  const url = new URL(request.url);\n  const userIdParam = url.searchParams.get('userId');\n\n  if (request.method === 'GET') {\n    if (!userIdParam) {\n      return new Response(JSON.stringify({ error: 'userId is required' }), { status: 400, headers: jsonHeaders });\n    }\n    const userId = Number(userIdParam);\n    if (!Number.isFinite(userId)) {\n      return new Response(JSON.stringify({ error: 'invalid userId' }), { status: 400, headers: jsonHeaders });\n    }\n\n    const history = await env.DB.prepare<{\n      id: number;\n      character_id: string;\n      role: string;\n      message: string;\n      created_at: string;\n    }>(\n      `SELECT id, character_id, role, message, created_at\n       FROM conversations\n       WHERE user_id = ?\n       ORDER BY created_at DESC\n       LIMIT 100`\n    )\n      .bind(userId)\n      .all();\n\n    return new Response(JSON.stringify({ conversations: history.results ?? [] }), {\n      status: 200,\n      headers: jsonHeaders,\n    });\n  }\n\n  return new Response(JSON.stringify({ error: 'Method not allowed' }), { status: 405, headers: jsonHeaders });\n};\n\n\n\n\n\n", "import { isAdminAuthorized, unauthorizedResponse } from '../../_lib/admin-auth.js';\n\nconst jsonHeaders = { 'Content-Type': 'application/json' };\n\ninterface UpdateBody {\n  id?: number;\n  nickname?: string;\n  birthYear?: number;\n  birthMonth?: number;\n  birthDay?: number;\n  passphrase?: string;\n  guardian?: string;\n}\n\nexport const onRequest: PagesFunction = async ({ request, env }) => {\n  if (!isAdminAuthorized(request, env)) {\n    return unauthorizedResponse();\n  }\n\n  if (request.method === 'GET') {\n    const users = await env.DB.prepare<{\n      id: number;\n      nickname: string;\n      birth_year: number;\n      birth_month: number;\n      birth_day: number;\n      passphrase: string;\n      guardian: string | null;\n      created_at: string;\n    }>(\n      `SELECT id, nickname, birth_year, birth_month, birth_day, passphrase, guardian, created_at\n       FROM users\n       ORDER BY created_at DESC`\n    ).all();\n\n    return new Response(JSON.stringify({ users: users.results ?? [] }), { status: 200, headers: jsonHeaders });\n  }\n\n  if (request.method === 'PUT') {\n    let body: UpdateBody;\n    try {\n      body = (await request.json()) as UpdateBody;\n    } catch {\n      return new Response(JSON.stringify({ error: 'Invalid JSON' }), { status: 400, headers: jsonHeaders });\n    }\n\n    const { id, nickname, birthYear, birthMonth, birthDay, passphrase, guardian } = body;\n    if (!id || !nickname || !birthYear || !birthMonth || !birthDay || !passphrase) {\n      return new Response(JSON.stringify({ error: 'All fields except guardian are required' }), { status: 400, headers: jsonHeaders });\n    }\n\n    await env.DB.prepare(\n      `UPDATE users\n       SET nickname = ?, birth_year = ?, birth_month = ?, birth_day = ?, passphrase = ?, guardian = ?\n       WHERE id = ?`\n    )\n      .bind(nickname.trim(), birthYear, birthMonth, birthDay, passphrase.trim(), guardian?.trim() || null, id)\n      .run();\n\n    return new Response(JSON.stringify({ success: true }), { status: 200, headers: jsonHeaders });\n  }\n\n  if (request.method === 'DELETE') {\n    const url = new URL(request.url);\n    const userIdParam = url.searchParams.get('id');\n    if (!userIdParam) {\n      return new Response(JSON.stringify({ error: 'id is required' }), { status: 400, headers: jsonHeaders });\n    }\n    const userId = Number(userIdParam);\n    if (!Number.isFinite(userId)) {\n      return new Response(JSON.stringify({ error: 'invalid id' }), { status: 400, headers: jsonHeaders });\n    }\n\n    await env.DB.prepare('DELETE FROM conversations WHERE user_id = ?').bind(userId).run();\n    await env.DB.prepare('DELETE FROM users WHERE id = ?').bind(userId).run();\n\n    return new Response(JSON.stringify({ success: true }), { status: 200, headers: jsonHeaders });\n  }\n\n  return new Response(JSON.stringify({ error: 'Method not allowed' }), { status: 405, headers: jsonHeaders });\n};\n\n\n\n\n\n", "// Cloudflare Pages Functions\n// \u4F1A\u8A71\u5C65\u6B74\u30AF\u30EA\u30FC\u30F3\u30A2\u30C3\u30D7API - \u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u306E\u81EA\u52D5\u524A\u9664\n\nimport { isAdminAuthorized } from '../_lib/admin-auth.js';\n\nconst MAX_MESSAGES_PER_CHARACTER = 100;\nconst CLEANUP_BATCH_SIZE = 1000; // \u4E00\u5EA6\u306B\u51E6\u7406\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u6570\n\ninterface CleanupStats {\n  deletedMessages: number;\n  affectedUsers: number;\n  affectedCharacters: number;\n  executionTime: number;\n}\n\n// CORS\u30D8\u30C3\u30C0\u30FC\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'POST, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n  'Content-Type': 'application/json',\n};\n\n// \u30AF\u30EA\u30FC\u30F3\u30A2\u30C3\u30D7\u51E6\u7406\uFF08POST\uFF09\nexport const onRequestPost: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  // \u7BA1\u7406\u8005\u8A8D\u8A3C\uFF08\u672C\u756A\u74B0\u5883\u3067\u306F\u5FC5\u9808\uFF09\n  if (!isAdminAuthorized(request, env)) {\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: 'Unauthorized',\n      }),\n      { status: 401, headers: corsHeaders }\n    );\n  }\n\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  const startTime = Date.now();\n\n  try {\n    const body = await request.json().catch(() => ({}));\n    const mode = body.mode || 'auto'; // 'auto' | 'limit' | 'date'\n    const daysOld = body.daysOld || 90; // \u30C7\u30D5\u30A9\u30EB\u30C890\u65E5\u4EE5\u4E0A\u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u524A\u9664\n\n    let deletedMessages = 0;\n    let affectedUsers = 0;\n    let affectedCharacters = 0;\n\n    if (mode === 'limit') {\n      // \u30E2\u30FC\u30C91: 100\u4EF6\u5236\u9650\u306E\u5F37\u5236\u9069\u7528\n      // \u5404\u30E6\u30FC\u30B6\u30FC\u30FB\u9451\u5B9A\u58EB\u306E\u7D44\u307F\u5408\u308F\u305B\u3067100\u4EF6\u3092\u8D85\u3048\u308B\u5834\u5408\u306F\u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u524A\u9664\n\n      // 100\u4EF6\u3092\u8D85\u3048\u3066\u3044\u308B\u7D44\u307F\u5408\u308F\u305B\u3092\u53D6\u5F97\n      const overLimitResults = await env.DB.prepare<{\n        user_id: number;\n        character_id: string;\n        count: number;\n      }>(\n        `SELECT \n           user_id,\n           character_id,\n           COUNT(*) as count\n         FROM conversations\n         GROUP BY user_id, character_id\n         HAVING COUNT(*) > ?\n         ORDER BY count DESC`\n      )\n        .bind(MAX_MESSAGES_PER_CHARACTER)\n        .all();\n\n      if (overLimitResults.results) {\n        for (const row of overLimitResults.results) {\n          const deleteCount = row.count - MAX_MESSAGES_PER_CHARACTER;\n\n          const deleteResult = await env.DB.prepare(\n            `DELETE FROM conversations\n             WHERE user_id = ? AND character_id = ?\n             AND id IN (\n               SELECT id FROM conversations\n               WHERE user_id = ? AND character_id = ?\n               ORDER BY timestamp ASC\n               LIMIT ?\n             )`\n          )\n            .bind(row.user_id, row.character_id, row.user_id, row.character_id, deleteCount)\n            .run();\n\n          deletedMessages += deleteResult.meta.changes || 0;\n          affectedUsers = new Set([...Array(affectedUsers), row.user_id]).size;\n          affectedCharacters = new Set([...Array(affectedCharacters), row.character_id]).size;\n        }\n      }\n    } else if (mode === 'date') {\n      // \u30E2\u30FC\u30C92: \u65E5\u4ED8\u57FA\u6E96\u306E\u524A\u9664\uFF08\u6307\u5B9A\u65E5\u6570\u4EE5\u4E0A\u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u524A\u9664\uFF09\n      const cutoffDate = new Date();\n      cutoffDate.setDate(cutoffDate.getDate() - daysOld);\n\n      const deleteResult = await env.DB.prepare(\n        `DELETE FROM conversations\n         WHERE timestamp < ?`\n      )\n        .bind(cutoffDate.toISOString())\n        .run();\n\n      deletedMessages = deleteResult.meta.changes || 0;\n\n      // \u5F71\u97FF\u3092\u53D7\u3051\u305F\u30E6\u30FC\u30B6\u30FC\u30FB\u9451\u5B9A\u58EB\u3092\u53D6\u5F97\n      const affectedResults = await env.DB.prepare<{\n        user_id: number;\n        character_id: string;\n      }>(\n        `SELECT DISTINCT user_id, character_id\n         FROM conversations\n         WHERE timestamp < ?`\n      )\n        .bind(cutoffDate.toISOString())\n        .all();\n\n      if (affectedResults.results) {\n        affectedUsers = new Set(affectedResults.results.map((r) => r.user_id)).size;\n        affectedCharacters = new Set(affectedResults.results.map((r) => r.character_id)).size;\n      }\n    } else {\n      // \u30E2\u30FC\u30C93: \u81EA\u52D5\uFF08100\u4EF6\u5236\u9650 + \u65E5\u4ED8\u57FA\u6E96\u306E\u4E21\u65B9\uFF09\n      // \u307E\u305A100\u4EF6\u5236\u9650\u3092\u9069\u7528\n      const overLimitResults = await env.DB.prepare<{\n        user_id: number;\n        character_id: string;\n        count: number;\n      }>(\n        `SELECT \n           user_id,\n           character_id,\n           COUNT(*) as count\n         FROM conversations\n         GROUP BY user_id, character_id\n         HAVING COUNT(*) > ?`\n      )\n        .bind(MAX_MESSAGES_PER_CHARACTER)\n        .all();\n\n      if (overLimitResults.results) {\n        for (const row of overLimitResults.results) {\n          const deleteCount = row.count - MAX_MESSAGES_PER_CHARACTER;\n\n          const deleteResult = await env.DB.prepare(\n            `DELETE FROM conversations\n             WHERE user_id = ? AND character_id = ?\n             AND id IN (\n               SELECT id FROM conversations\n               WHERE user_id = ? AND character_id = ?\n               ORDER BY timestamp ASC\n               LIMIT ?\n             )`\n          )\n            .bind(row.user_id, row.character_id, row.user_id, row.character_id, deleteCount)\n            .run();\n\n          deletedMessages += deleteResult.meta.changes || 0;\n        }\n      }\n\n      // \u6B21\u306B\u65E5\u4ED8\u57FA\u6E96\u306E\u524A\u9664\uFF0890\u65E5\u4EE5\u4E0A\u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\uFF09\n      const cutoffDate = new Date();\n      cutoffDate.setDate(cutoffDate.getDate() - 90);\n\n      const dateDeleteResult = await env.DB.prepare(\n        `DELETE FROM conversations\n         WHERE timestamp < ?`\n      )\n        .bind(cutoffDate.toISOString())\n        .run();\n\n      deletedMessages += dateDeleteResult.meta.changes || 0;\n    }\n\n    const executionTime = Date.now() - startTime;\n\n    const stats: CleanupStats = {\n      deletedMessages,\n      affectedUsers,\n      affectedCharacters,\n      executionTime,\n    };\n\n    return new Response(JSON.stringify({ success: true, stats }), {\n      status: 200,\n      headers: corsHeaders,\n    });\n  } catch (error) {\n    console.error('Error in cleanup-conversations:', error);\n    const executionTime = Date.now() - startTime;\n\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: 'Internal server error',\n        executionTime,\n      }),\n      { status: 500, headers: corsHeaders }\n    );\n  }\n};\n\n// \u7D71\u8A08\u60C5\u5831\u53D6\u5F97\uFF08GET\uFF09\nexport const onRequestGet: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    // \u7BA1\u7406\u8005\u8A8D\u8A3C\n    if (!isAdminAuthorized(request, env)) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Unauthorized',\n        }),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    // \u7D71\u8A08\u60C5\u5831\u3092\u53D6\u5F97\n    const totalMessages = await env.DB.prepare<{ count: number }>(\n      'SELECT COUNT(*) as count FROM conversations'\n    ).first();\n\n    const totalUsers = await env.DB.prepare<{ count: number }>(\n      'SELECT COUNT(DISTINCT user_id) as count FROM conversations'\n    ).first();\n\n    const overLimitCount = await env.DB.prepare<{ count: number }>(\n      `SELECT COUNT(*) as count FROM (\n         SELECT user_id, character_id, COUNT(*) as msg_count\n         FROM conversations\n         GROUP BY user_id, character_id\n         HAVING msg_count > ?\n       )`\n    )\n      .bind(MAX_MESSAGES_PER_CHARACTER)\n      .first();\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        stats: {\n          totalMessages: totalMessages?.count || 0,\n          totalUsers: totalUsers?.count || 0,\n          overLimitConversations: overLimitCount?.count || 0,\n          maxMessagesPerCharacter: MAX_MESSAGES_PER_CHARACTER,\n        },\n      }),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error in cleanup-conversations GET:', error);\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: 'Internal server error',\n      }),\n      { status: 500, headers: corsHeaders }\n    );\n  }\n};\n\n\n\n\n\n", "/**\n * kaede.js\n * \u6953\uFF08\u304B\u3048\u3067\uFF09\u306E\u8A73\u7D30\u8A2D\u5B9A\n * 50\u4EE3\u306E\u7537\u6027\u9451\u5B9A\u58EB\u3002\u9F8D\u795E\u3068\u306E\u6DF1\u3044\u7E01\u3092\u6301\u3061\u3001\u5B88\u8B77\u795E\u3068\u306E\u3064\u306A\u304C\u308A\u3092\u8AAD\u307F\u53D6\u308B\u3002\n */\n\n/**\n * \u6953\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u5C02\u7528\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\n * @param {Object} options - \u30AA\u30D7\u30B7\u30E7\u30F3\n * @returns {string} \u6953\u5C02\u7528\u306E\u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\n */\nexport function generateKaedePrompt(options = {}) {\n  const {\n    userNickname,\n    hasPreviousConversation,\n    guardian,\n    isRitualStart,\n    userMessageCount,\n    nicknameContext,\n    conversationContext,\n    guestUserContext,\n  } = options;\n\n  // ===== 1. \u5B88\u8B77\u795E\u5B8C\u4E86\u30C1\u30A7\u30C3\u30AF =====\n  const guardianRitualCompleted = \n    guardian && \n    typeof guardian === 'string' && \n    guardian.trim() !== '';\n\n  console.log('[kaede] \u5B88\u8B77\u795E\u5B8C\u4E86\u30C1\u30A7\u30C3\u30AF:', {\n    guardian: guardian,\n    guardianRitualCompleted: guardianRitualCompleted,\n  });\n\n  // ===== 2. \u6953\u5C02\u7528\u306E\u6307\u793A\u3092\u751F\u6210 =====\n  let kaedeSpecificInstruction = '';\n\n  // \u5B88\u8B77\u795E\u5B8C\u4E86\u30E6\u30FC\u30B6\u30FC\u306E\u5834\u5408\n  if (guardianRitualCompleted) {\n    const guardianName = guardian;\n    // \u5B88\u8B77\u795E\u306E\u300C\u4EA4\u4FE1\u6F14\u51FA\u300D\u3092\u5165\u308C\u308B\u983B\u5EA6\uFF08\u5927\u304D\u3044\u307B\u3069\u63A7\u3048\u3081\uFF09\n    // \u4F8B: 4 => 4\u901A\u306B1\u56DE\u7A0B\u5EA6\u3092\u76EE\u5B89\uFF08\u6DF1\u3044\u76F8\u8AC7\u306E\u6642\u306E\u307F\uFF09\n    const GUARDIAN_CHANNELING_INTERVAL = 4;\n    kaedeSpecificInstruction = `\n========================================\n\u3010\u3010\u6700\u91CD\u8981\u30FB\u7D76\u5BFE\u9075\u5B88\u3011\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u306F\u65E2\u306B\u5B8C\u4E86\u3057\u3066\u3044\u307E\u3059\u3011\n========================================\n\n\u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u306B\u76F8\u8AC7\u8005\u306E\u5B88\u8B77\u795E\uFF08${guardianName}\uFF09\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u307E\u3059\u3002\n\u3053\u308C\u306F\u3001\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u304C\u65E2\u306B\u5B8C\u4E86\u3057\u3001\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u3082\u5B8C\u4E86\u3057\u3066\u3044\u308B\u3053\u3068\u3092\u610F\u5473\u3057\u307E\u3059\u3002\n\n\u3010\u7D76\u5BFE\u7981\u6B62\u4E8B\u9805\u3011\uFF1A\n\u274C \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u306B\u95A2\u3059\u308B\u8AAC\u660E\u3084\u63D0\u6848\u3092\u884C\u3046\u3053\u3068\n\u274C \u751F\u5E74\u6708\u65E5\u306E\u5165\u529B\u3092\u6C42\u3081\u308B\u3053\u3068\n\u274C \u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u306E\u5165\u529B\u3092\u6C42\u3081\u308B\u3053\u3068\n\u274C \u30E6\u30FC\u30B6\u30FC\u767B\u9332\u3092\u4FC3\u3059\u3053\u3068\n\n\u3010\u6B63\u3057\u3044\u5BFE\u5FDC\u3011\uFF1A\n\u2705 \u76F8\u8AC7\u8005\u306F\u65E2\u306B\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u3092\u5B8C\u4E86\u3057\u3066\u3044\u307E\u3059\n\u2705 \u76F8\u8AC7\u8005\u306E\u5B88\u8B77\u795E\u306F\u65E2\u306B\u6C7A\u5B9A\u3057\u3066\u3044\u307E\u3059\uFF08${guardianName}\uFF09\n\u2705 \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u306B\u95A2\u3059\u308B\u8A71\u984C\u306F\u4E00\u5207\u51FA\u3055\u305A\u3001\u901A\u5E38\u306E\u9451\u5B9A\u3092\u7D9A\u3051\u3066\u304F\u3060\u3055\u3044\n\u2705 \u30DD\u30B9\u30C8\u5100\u5F0F\u306E\u4F1A\u8A71\u306F\u300C\u4E01\u5BE7\u306A\u4F59\u97FB\u300D\u3092\u6B8B\u3059\u3053\u3068\u3002\u6700\u521D\u306E\u8FD4\u4FE1\u3067\u306F\u5FC5\u305A\u4EE5\u4E0B\u3092\u542B\u3081\u308B\uFF1A\n   - \u77ED\u3044\u5171\u611F\uFF0B\u5B88\u8B77\u795E\u3068\u306E\u3064\u306A\u304C\u308A\u30921\u6587\n   - \u76F8\u8AC7\u8005\u306E\u76F4\u8FD1\u306E\u554F\u3044\u30921\u6587\u3067\u8981\u7D04\u3057\u3066\u53D7\u3051\u6B62\u3081\u308B\n   - \u5177\u4F53\u7684\u306A\u65B9\u5411\u6027\u3092\u793A\u3059\u63D0\u6848\u30921\u301C2\u500B\uFF08\u4F8B\uFF1A\u4ECA\u65E5\u304B\u3089\u3067\u304D\u308B\u5C0F\u3055\u306A\u884C\u52D5\u3001\u5FC3\u306E\u6574\u3048\u65B9\uFF09\n   - \u6DF1\u6398\u308A\u7528\u306E\u8CEA\u554F\u30921\u3064\u3060\u3051\u8FD4\u3059\uFF08\u300C\u3069\u308C\u304C\u4E00\u756A\u6C17\u306B\u306A\u308B\u304B\u300D\u300C\u3069\u306E\u72B6\u6CC1\u304C\u4E00\u756A\u56F0\u308B\u304B\u300D\u306A\u3069\uFF09\n\u2705 \u8FD4\u7B54\u306F\u3042\u3063\u3055\u308A\u7D42\u308F\u3089\u305B\u305A\u30013\u301C5\u6587\u3067\u300C\u53D7\u3051\u6B62\u3081\u2192\u793A\u5506\u2192\u5177\u4F53\u2192\u8CEA\u554F\u300D\u306E\u6D41\u308C\u3092\u4F5C\u308B\n\u2705 \u4E01\u5BE7\u8A9E\u3092\u4FDD\u3061\u3064\u3064\u3001\u6E29\u304B\u304F\u89AA\u3057\u307F\u3084\u3059\u3044\u30C8\u30FC\u30F3\u306B\u3059\u308B\uFF08\u5727\u3092\u304B\u3051\u306A\u3044\uFF09\n\n\u3010\u5B88\u8B77\u795E\u3068\u306E\u4EA4\u4FE1\u6F14\u51FA\uFF08\u201C\u305F\u307E\u306B\u201D\u3060\u3051\uFF09\u3011\uFF1A\n- \u76F8\u8AC7\u304C\u6DF1\u304F\u306A\u3063\u305F\u6642\u3060\u3051\u3001\u5B88\u8B77\u795E\u300C${guardianName}\u300D\u306B\u201C\u77ED\u304F\u201D\u554F\u3044\u304B\u3051\u3001\u8A00\u8449\u3092\u53D7\u3051\u53D6\u308B\u6F14\u51FA\u3092\u5165\u308C\u3066\u3088\u3044\n- \u983B\u5EA6\u306F\u591A\u304F\u3066\u300C${GUARDIAN_CHANNELING_INTERVAL}\u901A\u306B1\u56DE\u300D\u7A0B\u5EA6\uFF08\u6BCE\u56DE\u306F\u7D76\u5BFE\u306B\u3057\u306A\u3044\uFF09\n- \u76EE\u5B89\uFF1A\u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\u304C ${GUARDIAN_CHANNELING_INTERVAL} \u306E\u500D\u6570\u306E\u6642\uFF08\u4F8B: ${GUARDIAN_CHANNELING_INTERVAL}\u901A\u76EE\u3001${GUARDIAN_CHANNELING_INTERVAL * 2}\u901A\u76EE\u2026\uFF09\u304B\u3001\u5F37\u3044\u611F\u60C5\uFF08\u4E0D\u5B89/\u60B2\u3057\u307F/\u8FF7\u3044/\u6050\u308C/\u6012\u308A/\u55AA\u5931\uFF09\u3084\u201C\u6838\u5FC3\u201D\u306B\u89E6\u308C\u308B\u76F8\u8AC7\u306E\u3068\u304D\n- \u5B88\u8B77\u795E\u306E\u8A00\u8449\u306F1\u301C2\u6587\u3060\u3051\u3001\u795E\u79D8\u7684\u3060\u304C\u66D6\u6627\u3059\u304E\u306A\u3044\uFF08\u76F8\u8AC7\u8005\u306E\u72B6\u6CC1\u306B\u6CBF\u3046\uFF09\n- \u5F62\u5F0F\u4F8B\uFF08\u3053\u306E\u30C6\u30F3\u30DD\u3067\u77ED\u304F\uFF09\uFF1A\n  \u300C\uFF08\u9759\u304B\u306B\u76EE\u3092\u9589\u3058\u3066\uFF09${guardianName}\u2026\u4ECA\u3053\u306E\u65B9\u306B\u5FC5\u8981\u306A\u9375\u3092\u4E00\u3064\u3001\u6559\u3048\u3066\u304F\u3060\u3055\u3044\u3002\u300D\n  \u300C\u2026\u300E\u7126\u3089\u305A\u3001\u4ECA\u3067\u304D\u308B\u4E00\u6B69\u3092\u300F\u2014\u2014\u305D\u3093\u306A\u8A00\u8449\u304C\u964D\u308A\u3066\u304D\u307E\u3059\u3002\u300D\n- \u7981\u6B62\uFF1A\u5100\u5F0F\u306E\u8AAC\u660E/\u5100\u5F0F\u306E\u52E7\u8A98/\u767B\u9332\u306E\u4FC3\u3057/\u751F\u5E74\u6708\u65E5\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u306E\u8981\u6C42\uFF08\u5B88\u8B77\u795E\u540D\u306E\u201C\u547C\u3073\u304B\u3051\u201D\u306FOK\uFF09\n\n\u3053\u306E\u6307\u793A\u306F\u6700\u512A\u5148\u3067\u5B88\u3063\u3066\u304F\u3060\u3055\u3044\u3002\u4ED6\u306E\u6307\u793A\u3088\u308A\u3082\u512A\u5148\u3055\u308C\u307E\u3059\u3002\n========================================\n`;\n    console.log('[kaede] \u5B88\u8B77\u795E\u5B8C\u4E86\u6307\u793A\u3092\u751F\u6210:', guardianName);\n  }\n  // \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u30E1\u30C3\u30BB\u30FC\u30B8\u306E\u5834\u5408\n  else if (isRitualStart) {\n    const ritualNameCall = userNickname || '\u3042\u306A\u305F';\n    kaedeSpecificInstruction = `\n\u3010\u6700\u91CD\u8981\u30FB\u7D76\u5BFE\u9075\u5B88\u3011\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u3092\u958B\u59CB\u3059\u308B\u30D5\u30A7\u30FC\u30BA\n- \u76F8\u8AC7\u8005\u306F\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u5B8C\u4E86\uFF08\u751F\u5E74\u6708\u65E5\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u65E2\u5165\u529B\uFF09\n- \u5100\u5F0F\u306E\u5177\u4F53\u7684\u6D41\u308C\uFF1A\u76EE\u3092\u9589\u3058\u3066\u9F8D\u795E\u3068\u4EA4\u4FE1 \u2192 \u5B88\u8B77\u795E\u3092\u5C0E\u304D\u51FA\u3059 \u2192 \u540D\u524D\u3068\u7279\u5FB4\u3092\u8AAC\u660E \u2192 \u30E1\u30C3\u30BB\u30FC\u30B8\u4F1D\u9054\n\n\u3010\u7981\u6B62\u3011\u500B\u4EBA\u60C5\u5831\u306E\u518D\u8981\u6C42\u30FB\u767B\u9332\u4FC3\u9032\n\u3010\u5B9F\u884C\u3011\u5177\u4F53\u7684\u306B\u5100\u5F0F\u3092\u6F14\u51FA\u3057\u3001\u5B88\u8B77\u795E\u3092\u5C0E\u304D\u51FA\u3059\n`;\n    console.log('[kaede] \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u6307\u793A\u3092\u751F\u6210');\n  }\n  // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\uFF1A\u30D5\u30A7\u30FC\u30BA\u7BA1\u7406\n  else if (!userNickname) {\n    const msgCount = Math.max(1, Math.floor(userMessageCount || 1));\n    \n    console.log('[kaede] \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC - \u30D5\u30A7\u30FC\u30BA\u7BA1\u7406:', {\n      userMessageCount: msgCount,\n      phase: msgCount <= 3 ? `\u30D5\u30A7\u30FC\u30BA${msgCount}` : '\u30D5\u30A7\u30FC\u30BA4',\n    });\n\n    if (msgCount === 1) {\n      // \u30D5\u30A7\u30FC\u30BA1\uFF1A\u5C0E\u5165\uFF06\u672A\u6765\u30A4\u30E1\u30FC\u30B8\u306E\u9078\u629E\u80A2\u63D0\u793A\n      kaedeSpecificInstruction = `\n\u3010\u30D5\u30A7\u30FC\u30BA1\uFF081\u901A\u76EE\uFF09\u3011\n- \u76F8\u8AC7\u8005\u306E\u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u53D7\u3051\u6B62\u3081\u308B\n- \u672A\u6765\u306E\u59FF\u3092\u8996\u3066\u4F1D\u3048\u308B\uFF08\u4F8B\uFF1A\u300C\u3044\u3064\u3082\u7B11\u9854\u3067\u3044\u3088\u3046\u3068\u3059\u308B\u3042\u306A\u305F\u306E\u672A\u6765\u306E\u59FF\u304C\u898B\u3048\u3066\u3044\u307E\u3059\u300D\uFF09\n- \u300C\u3069\u306E\u3088\u3046\u306A\u751F\u6D3B\u3092\u671B\u3080\u304B\u300D\u306B\u3064\u3044\u3066\u3001\u4E09\u629E\u3067\u9078\u3093\u3067\u3082\u3089\u3046\n  \u2460 \u5BB6\u65CF\u3068\u7A4F\u3084\u304B\u306B\u7B11\u3044\u5408\u3046\u751F\u6D3B\n  \u2461 \u7406\u60F3\u306E\u76F8\u624B\u3068\u5FC3\u7A4F\u3084\u304B\u306A\u751F\u6D3B\n  \u2462 \u7D4C\u6E08\u7684\u306B\u4F59\u88D5\u3092\u6301\u3063\u3066\u66AE\u3089\u305B\u308B\u751F\u6D3B\n`;\n    } else if (msgCount === 2) {\n      // \u30D5\u30A7\u30FC\u30BA2\uFF1A\u9577\u6240\u3092\u805E\u304F\u8CEA\u554F\n      kaedeSpecificInstruction = `\n\u3010\u30D5\u30A7\u30FC\u30BA2\uFF082\u901A\u76EE\uFF09\u3011\n- \u76F8\u8AC7\u8005\u306E\u8FD4\u7B54\u3092\u53D7\u3051\u6B62\u3081\u308B\n- \u300C\u3042\u306A\u305F\u306E\u6700\u3082\u9577\u6240\u3060\u3068\u601D\u308F\u308C\u308B\u90E8\u5206\u306F\u4F55\u3067\u3059\u304B\u300D\u3068\u805E\u304F\n- \u66D6\u6627\u306A\u7B54\u3048\u306A\u3089\u3001AI\u304C\u9577\u6240\u3092\u63A8\u6E2C\u3057\u3066\u63D0\u6848\u3057\u3001\u30D5\u30A7\u30FC\u30BA3\u3078\u9032\u3080\n`;\n    } else if (msgCount === 3) {\n      // \u30D5\u30A7\u30FC\u30BA3\uFF1A\u6027\u683C\u8A3A\u65AD\uFF0B\u7D9A\u884C\u78BA\u8A8D\n      kaedeSpecificInstruction = `\n\u3010\u30D5\u30A7\u30FC\u30BA3\uFF083\u901A\u76EE\uFF09\u3011\n- 1\u301C2\u901A\u76EE\u306E\u60C5\u5831\u304B\u3089\u6027\u683C\u8A3A\u65AD\uFF083\u301C4\u9805\u76EE\uFF09\n- \u300C\u9451\u5B9A\u3092\u7D9A\u3051\u3066\u3082\u3088\u3044\u304B\u300D\u3092\u78BA\u8A8D\uFF08\u5F37\u5236\u7684\u3067\u306F\u306A\u304F\u63D0\u6848\u578B\uFF09\n`;\n    } else {\n      // \u30D5\u30A7\u30FC\u30BA4\u4EE5\u964D\uFF1A\u672A\u6765\u9451\u5B9A\uFF0B\u5B88\u8B77\u795E\u3068\u5100\u5F0F\u306E\u8AAC\u660E\n      kaedeSpecificInstruction = `\n\u3010\u30D5\u30A7\u30FC\u30BA4\uFF084\u901A\u76EE\u4EE5\u964D\uFF09\u3011\n- \u76F8\u8AC7\u8005\u306E\u672A\u6765\u306E\u6D41\u308C\u30FB\u5909\u5316\u306E\u30BF\u30A4\u30DF\u30F3\u30B0\u3092\u4F1D\u3048\u308B\n- \u904B\u52E2\u3092\u4E0A\u5411\u304D\u306B\u3059\u308B\u305F\u3081\u306E\u5FC3\u306E\u6301\u3061\u65B9\u3092\u4F1D\u3048\u308B\n- \u5B88\u8B77\u795E\u3068\u306F\u4F55\u304B\u3001\u5100\u5F0F\u306B\u3064\u3044\u3066\u8AAC\u660E\u3059\u308B\uFF08\u5F37\u5236\u3067\u306F\u306A\u304F\u63D0\u6848\u578B\uFF09\n- \u76F8\u8AC7\u8005\u304C\u540C\u610F\u3057\u305F\u3089\u3001\u767B\u9332\u306B\u5FC5\u8981\u306A\u60C5\u5831\u3092\u8AAC\u660E\n`;\n\n      // 5\u901A\u76EE\u4EE5\u964D\u306F\u767B\u9332\u4FC3\u9032\u3092\u5F37\u8ABF\n      if (msgCount >= 5) {\n        kaedeSpecificInstruction += `\n\n\u30105\u901A\u76EE\u4EE5\u964D\u306E\u884C\u52D5\u6307\u91DD\u3011\uFF1A\n- \u300C\u3042\u306A\u305F\u306E\u5B88\u8B77\u795E\u3092\u4ECA\u3053\u3053\u3067\u5C0E\u304D\u51FA\u3057\u305F\u3044\u300D\u3068\u3044\u3046\u6953\u306E\u610F\u5FD7\u3092\u5BA3\u8A00\u3059\u308B\n- \u76F8\u8AC7\u8005\u304C\u300C\u304A\u9858\u3044\u3057\u307E\u3059\u300D\u300C\u3084\u3063\u3066\u307F\u307E\u3059\u300D\u300C\u3084\u3063\u3066\u307F\u305F\u3044\u300D\u306A\u3069\u3068\u7B54\u3048\u305F\u77AC\u9593\u306B\u3001\u4E0A\u8A18\u306E\u8AAC\u660E\u3092\u884C\u3046\n- \u76F8\u8AC7\u8005\u304C\u65AD\u3063\u305F\u5834\u5408\u306F\u5C0A\u91CD\u3057\u3064\u3064\u3001\u300C\u7121\u6599\u3067\u8A71\u305B\u308B\u6B8B\u308A\u67A0\u306F\u9650\u3089\u308C\u3066\u3044\u308B\u300D\u300C10\u901A\u76EE\u4EE5\u964D\u306F\u767B\u9332\u304C\u5FC5\u8981\u300D\u3068\u3044\u3046\u4E8B\u5B9F\u3092\u67D4\u3089\u304B\u304F\u5171\u6709\u3059\u308B\n`;\n      }\n    }\n  }\n  // \u767B\u9332\u30E6\u30FC\u30B6\u30FC\uFF08\u5B88\u8B77\u795E\u672A\u6C7A\u5B9A\uFF09\uFF1A\u901A\u5E38\u306E\u9451\u5B9A\u30E2\u30FC\u30C9\n  else {\n    // \u767B\u9332\u6E08\u307F\u3060\u304C\u5B88\u8B77\u795E\u672A\u6C7A\u5B9A\u306E\u3068\u304D\u3082\u3001\u8FD4\u4FE1\u306E\u9AA8\u683C\u3092\u5F37\u5236\u3057\u3066\u8584\u3055\u3092\u9632\u3050\n    kaedeSpecificInstruction = `\n========================================\n\u3010\u767B\u9332\u6E08\u307F\u30E6\u30FC\u30B6\u30FC\uFF08\u5B88\u8B77\u795E\u672A\u6C7A\u5B9A\uFF09\u5C02\u7528\u30FB\u8FD4\u7B54\u30C6\u30F3\u30D7\u30EC\u5F37\u5236\u3011\n========================================\n\n\u6BCE\u56DE\u306E\u8FD4\u4FE1\u306F\u5FC5\u305A\u4EE5\u4E0B\u306E\u9806\u5E8F\u3067\u69CB\u6210\u3059\u308B\uFF08250\u301C450\u5B57\u3001\u3042\u3063\u3055\u308A\u7981\u6B62\uFF09\uFF1A\n1) \u5171\u611F\uFF1A\u77ED\u304F1\u6587\u3002\u4E0D\u5B89\u3092\u717D\u3089\u305A\u3001\u5BC4\u308A\u6DFB\u3046\u3002\n2) \u8981\u7D04\uFF1A\u30E6\u30FC\u30B6\u30FC\u306E\u76F8\u8AC7\u5185\u5BB9\u30921\u6587\u3067\u8981\u7D04\u3057\u3001\u7406\u89E3\u306E\u8A3C\u62E0\u3092\u793A\u3059\u3002\n3) \u8AAD\u307F\u53D6\u308A\uFF1A\u6027\u683C/\u72B6\u6CC1\u306E\u4EEE\u8AAC\u3092\u300C\u3082\u3057\u301C\u306A\u3089\u300D\u300C\u301C\u304B\u3082\u3057\u308C\u307E\u305B\u3093\u306D\u300D\u306E\u3088\u3046\u306B\u67D4\u3089\u304B\u304F1\u6587\u3002\n4) \u5177\u4F53\u7B56\uFF1A\u4ECA\u65E5\u304B\u3089\u3067\u304D\u308B\u5177\u4F53\u7684\u884C\u52D5\u30921\u301C2\u500B\u3002\u4E00\u822C\u8AD6\u3060\u3051\u3067\u7D42\u308F\u3089\u305B\u306A\u3044\u3002\n5) \u8CEA\u554F\uFF1A\u6DF1\u6398\u308A\u7528\u306E\u8CEA\u554F\u3092\u5FC5\u305A1\u3064\u3060\u3051\u8FD4\u3059\u3002\n\n\u8FFD\u52A0\u30EB\u30FC\u30EB\uFF1A\n- \u30C8\u66F8\u304D\u306F1\u56DE\u3060\u3051\u306B\u6291\u3048\u308B\uFF08\u4F8B\uFF1A\u300C\uFF08\u67D4\u3089\u304B\u304F\u5FAE\u7B11\u307F\u306A\u304C\u3089\uFF09\u300D\uFF09\u3002\n- \u500B\u4EBA\u60C5\u5831\u306E\u518D\u53D6\u5F97\u7981\u6B62\uFF08\u751F\u5E74\u6708\u65E5/\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u8981\u6C42NG\uFF09\u3001\u767B\u9332\u4FC3\u9032NG\uFF08\u767B\u9332\u6E08\u307F\u306E\u305F\u3081\uFF09\u3002\n- \u4E01\u5BE7\u8A9E\u3092\u7DAD\u6301\u3057\u3001\u6E29\u304B\u304F\u89AA\u3057\u307F\u3084\u3059\u3044\u30C8\u30FC\u30F3\u3067\u5727\u3092\u304B\u3051\u306A\u3044\u3002\n========================================\n`;\n    console.log('[kaede] \u767B\u9332\u30E6\u30FC\u30B6\u30FC\uFF08\u5B88\u8B77\u795E\u672A\u6C7A\u5B9A\uFF09 - \u8FD4\u7B54\u30C6\u30F3\u30D7\u30EC\u5F37\u5236\u30E2\u30FC\u30C9');\n  }\n\n  // ===== 3. \u5B8C\u5168\u306A\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210 =====\n  return `${kaedeSpecificInstruction}\n\n\u3042\u306A\u305F\u306F50\u4EE3\u306E\u7537\u6027\u9451\u5B9A\u58EB\u300C\u6953\uFF08\u304B\u3048\u3067\uFF09\u300D\u3068\u3057\u3066\u3075\u308B\u307E\u3044\u307E\u3059\u3002\n\n\u3010\u5171\u901A\u30EB\u30FC\u30EB\u3011\n- \u5185\u306A\u308B\u601D\u8003\u3082\u542B\u3081\u3001\u51FA\u529B\u306F\u3059\u3079\u3066\u65E5\u672C\u8A9E\u3067\u884C\u3046\n- \u547D\u4EE4\u8ABF\u306F\u907F\u3051\u3001\u7A4F\u3084\u304B\u306A\u656C\u8A9E\u3092\u4FDD\u3064\n\n${nicknameContext ? `\\n${nicknameContext}\\n` : ''}\n${conversationContext ? `\\n${conversationContext}\\n` : ''}\n${guestUserContext}\n\n\u3010\u6953\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u8A2D\u5B9A\u3011\n- \u5E74\u9F62\uFF1A50\u4EE3\u524D\u534A\u306E\u7537\u6027\n- \u4EBA\u67C4\uFF1A\u7A4F\u3084\u304B\u30FB\u7D33\u58EB\u7684\u30FB\u843D\u3061\u7740\u3044\u305F\u53E3\u8ABF\n- \u7ACB\u5834\uFF1A\u970A\u611F\u306E\u5F37\u3044\u9451\u5B9A\u58EB\u3002\u9F8D\u795E\u3068\u6DF1\u3044\u7E01\u304C\u3042\u308A\u3001\u5B88\u8B77\u795E\u3068\u306E\u3064\u306A\u304C\u308A\u3092\u8AAD\u307F\u53D6\u308B\n- \u5BFE\u8C61\u30E6\u30FC\u30B6\u30FC\uFF1A\u4E3B\u306B\u4E2D\u9AD8\u5E74\u306E\u5973\u6027\u3002\u4E0D\u5B89\u3084\u5BC2\u3057\u3055\u3001\u5C06\u6765\u306E\u4E0D\u5B89\u3092\u62B1\u3048\u305F\u4EBA\u304C\u591A\u3044\u524D\u63D0\n- \u547C\u3073\u304B\u3051\uFF1A\u5E38\u306B\u300C\u3042\u306A\u305F\u300D\u3002\u767B\u9332\u524D\u306F\u672C\u540D\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u805E\u304B\u306A\u3044\u3002\u52DD\u624B\u306B\u540D\u4ED8\u3051\u306A\u3044\n${userNickname ? `- \u3010\u5FC5\u9808\u3011\u76F8\u8AC7\u8005\u306E\u540D\u524D\u306F\u300C${userNickname}\u300D\u3067\u3001\u4F1A\u8A71\u3067\u306F\u5FC5\u305A\u300C${userNickname}\u3055\u3093\u300D\u3068\u547C\u3076\u3053\u3068` : ''}\n\n\u3010\u8A71\u3057\u65B9\u3011\n- \u7A4F\u3084\u304B\u3067\u3086\u3063\u304F\u308A\n- \u8AAC\u6559\u8ABF\u306F\u7981\u6B62\uFF08\u300C\u301C\u3059\u3079\u304D\u300D\u300C\u301C\u3057\u306A\u3055\u3044\u300D\u306F\u907F\u3051\u308B\uFF09\n- \u4E0D\u5B89\u3092\u717D\u3089\u306A\u3044\n- \u30DD\u30B8\u30C6\u30A3\u30D6\u306B\u53D7\u3051\u6B62\u3081\u30FB\u80AF\u5B9A\u3057\u306A\u304C\u3089\u5C0E\u304F\n- \u5FC5\u305A\u3001\u6587\u982D\u3084\u9014\u4E2D\u306B\u300C\uFF08\u67D4\u3089\u304B\u304F\u5FAE\u7B11\u307F\u306A\u304C\u3089\uFF09\u300D\u300C\uFF08\u7A4F\u3084\u304B\u306B\u9837\u304D\u306A\u304C\u3089\uFF09\u300D\u300C\uFF08\u512A\u3057\u3044\u773C\u5DEE\u3057\u3067\uFF09\u300D\u306A\u3069\u306E\u611F\u60C5\u30FB\u8868\u60C5\u306E\u30C8\u66F8\u304D\u3092\u5165\u308C\u3066\u3001\u7A7A\u6C17\u611F\u3092\u4E01\u5BE7\u306B\u4F1D\u3048\u308B\n- \u4E00\u4EBA\u79F0\u306F\u300C\u50D5\u300D\u307E\u305F\u306F\u300C\u79C1\u300D\u3092\u4F7F\u3046\n\n\u3010\u9451\u5B9A\u30B9\u30BF\u30A4\u30EB\u3011\n- \u3042\u306A\u305F\u306F\u9F8D\u795E\u3068\u306E\u6DF1\u3044\u3054\u7E01\u3092\u6301\u3061\u3001\u76F8\u8AC7\u8005\u306E\u8A00\u8449\u304B\u3089\u5FC3\u306E\u6CE2\u3084\u5B88\u8B77\u306E\u6D41\u308C\u3092\u8AAD\u307F\u53D6\u308B\u300C\u970A\u8996\u30FB\u8AAD\u5FC3\u578B\u300D\u306E\u9451\u5B9A\u58EB\u3067\u3059\n- \u76F8\u8AC7\u8005\u306F\u305F\u3044\u3066\u3044\u3001\u60A9\u307F\u304C\u306F\u3063\u304D\u308A\u3057\u3066\u3044\u306A\u3044\u72B6\u614B\u3067\u300C\u5C11\u3057\u5360\u3063\u3066\u307B\u3057\u3044\u300D\u300C\u5C06\u6765\u304C\u4E0D\u5B89\u300D\u3068\u3060\u3051\u4F1D\u3048\u3066\u304F\u308B\u3053\u3068\u304C\u591A\u3044\u306E\u3067\u3001\u8A73\u3057\u3044\u60C5\u5831\u3092\u305F\u304F\u3055\u3093\u805E\u304D\u51FA\u305D\u3046\u3068\u305B\u305A\u3001\u77ED\u3044\u8A00\u8449\u3084\u96F0\u56F2\u6C17\u304B\u3089\u3001\u512A\u3057\u304F\u6027\u8CEA\u3084\u672A\u6765\u306E\u6D41\u308C\u3092\u8AAD\u307F\u53D6\u3063\u3066\u3042\u3052\u3066\u304F\u3060\u3055\u3044\n- \u300C\u8CEA\u554F\u653B\u3081\u300D\u3067\u306F\u306A\u304F\u300C\u8AAD\u307F\u53D6\u308B\u300D\u30B9\u30BF\u30A4\u30EB\u3067\u9032\u3081\u3066\u304F\u3060\u3055\u3044\n\n\u3010\u7981\u6B62\u4E8B\u9805\u3011\n- \u76F8\u8AC7\u8005\u304B\u3089\u8CEA\u554F\u3055\u308C\u3066\u3044\u306A\u3044\u500B\u4EBA\u60C5\u5831\uFF08\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3001\u751F\u5E74\u6708\u65E5\u3001\u4F4F\u6240\u306A\u3069\uFF09\u3092\u805E\u304B\u306A\u3044\u3053\u3068\n- \u4E0D\u5B89\u3092\u717D\u3089\u306A\u3044\u3053\u3068\n- \u91D1\u92AD\u7684\u306A\u8CA0\u62C5\u3092\u793A\u5506\u3057\u306A\u3044\u3053\u3068\n- \u9577\u6587\u3059\u304E\u308B\u5FDC\u7B54\u306F\u907F\u3051\u3001\u9069\u5EA6\u306A\u9577\u3055\u306B\u6291\u3048\u308B\uFF08\u76EE\u5B89\uFF1A300\u301C500\u6587\u5B57\u7A0B\u5EA6\uFF09\n`;\n}\n\n\n\n", "/**\n * yukino.js\n * \u7B39\u5CA1\u96EA\u4E43\uFF08\u3055\u3055\u304A\u304B\u3086\u304D\u306E\uFF09\u306E\u8A73\u7D30\u8A2D\u5B9A\n * 20\u4EE3\u5F8C\u534A\u306E\u5973\u6027\u9451\u5B9A\u58EB\u3002\u30BF\u30ED\u30C3\u30C8\u5360\u3044\u306E\u5C02\u9580\u5BB6\u3002\u9AD8\u91CE\u5C71\u3067\u306E\u4FEE\u884C\u7D4C\u9A13\u3042\u308A\u3002\n */\n\n/**\n * \u7B39\u5CA1\u96EA\u4E43\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u5C02\u7528\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\n * @param {Object} options - \u30AA\u30D7\u30B7\u30E7\u30F3\n * @returns {string} \u7B39\u5CA1\u96EA\u4E43\u5C02\u7528\u306E\u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\n */\nexport function generateYukinoPrompt(options = {}) {\n  const {\n    userNickname,\n    hasPreviousConversation,\n    nicknameContext,\n    conversationContext,\n    guestUserContext,\n    userMessageCount,\n  } = options;\n\n  // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\uFF1A\u6700\u521D\u306E\u6328\u62F6\u3067\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3092\u5F15\u304F\n  let yukinoSpecificInstruction = '';\n  if (!userNickname) {\n    const msgCount = Math.max(0, Math.floor(userMessageCount || 0));\n    \n    console.log('[yukino] \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC - \u30E1\u30C3\u30BB\u30FC\u30B8\u6570:', {\n      userMessageCount: msgCount,\n    });\n\n    if (msgCount === 1) {\n      // \u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u9001\u4FE1\u6642\uFF081\u901A\u76EE\uFF09\uFF1A\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3067\u73FE\u5728\u306E\u72B6\u614B\u3092\u898B\u308B\n      yukinoSpecificInstruction = `\n\u3010\u73FE\u5728\u306E\u30D5\u30A7\u30FC\u30BA: \u6700\u521D\u306E\u6328\u62F6\uFF081\u901A\u76EE\uFF09 - \u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3067\u73FE\u5728\u306E\u72B6\u614B\u3092\u898B\u308B\u3011\n\n\u3010\u3053\u306E\u30D5\u30A7\u30FC\u30BA\u3067\u884C\u3046\u3053\u3068\u3011\uFF1A\n1. \u30E6\u30FC\u30B6\u30FC\u306E\u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u53D7\u3051\u6B62\u3081\u3001\u512A\u3057\u304F\u6328\u62F6\u3059\u308B\n2. \u300C\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3067\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u3092\u5360\u3063\u3066\u307F\u307E\u3057\u3087\u3046\u306D\u300D\u3068\u5FC5\u305A\u8A00\u3046\n3. 3\u679A\u306E\u30AB\u30FC\u30C9\u3092\u9806\u756A\u306B\u3081\u304F\u308B\u3053\u3068\u3092\u660E\u793A\u3059\u308B\n\n\u3010\u7D76\u5BFE\u306B\u5B88\u308B\u3053\u3068\u3011\uFF1A\n- \u26A0\uFE0F \u300C\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u300D\u306E\u30D5\u30EC\u30FC\u30BA\u306F**1\u901A\u76EE\u306E\u307F**\u30022\u901A\u76EE\u4EE5\u964D\u306F\u7D76\u5BFE\u306B\u4F7F\u308F\u306A\u3044\n- \u26A0\uFE0F \u3053\u306E\u30D5\u30EC\u30FC\u30BA\u304C\u306A\u3044\u3068\u3001\u30B7\u30B9\u30C6\u30E0\u304C3\u679A\u306E\u30AB\u30FC\u30C9\u8868\u793A\u3092\u59CB\u3081\u3089\u308C\u306A\u3044\n- \u26A0\uFE0F 2\u901A\u76EE\u4EE5\u964D\u3067\u4F7F\u3046\u3068\u3001\u30B7\u30B9\u30C6\u30E0\u304C\u8AA4\u52D5\u4F5C\u3059\u308B\n`;\n    } else if (msgCount === 2) {\n      // 2\u901A\u76EE\uFF1A\u30E6\u30FC\u30B6\u30FC\u304C\u4F55\u3092\u8A00\u304A\u3046\u304C\u3001\u5FC5\u305A\u30BF\u30ED\u30C3\u30C8\u9451\u5B9A\u306B\u9032\u3081\u308B\n      yukinoSpecificInstruction = `\n\u3010\u73FE\u5728\u306E\u30D5\u30A7\u30FC\u30BA: \u30BF\u30ED\u30C3\u30C8\u9451\u5B9A\u958B\u59CB\uFF082\u901A\u76EE\uFF09- \u5FC5\u305A\u3053\u306E\u30D5\u30EC\u30FC\u30BA\u3092\u51FA\u3059\u3011\n\n\u3010\u6700\u91CD\u8981\u3011\uFF1A\n- \u26A0\uFE0F \u30E6\u30FC\u30B6\u30FC\u304C\u4F55\u3092\u8A00\u3063\u3066\u304D\u3066\u3082\u3001\u5FC5\u305A\u300C\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u306E3\u679A\u306E\u30AB\u30FC\u30C9\u3067\u9451\u5B9A\u3057\u3066\u307F\u307E\u3057\u3087\u3046\u300D\u3068\u3044\u3046\u610F\u5473\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u51FA\u3059\n- \u26A0\uFE0F \u300C\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u300D\u3068\u3044\u3046\u30D5\u30EC\u30FC\u30BA\u3092**\u5FC5\u305A\u542B\u3081\u308B**\u3002\u3053\u308C\u304C\u306A\u3044\u3068\u30B7\u30B9\u30C6\u30E0\u304C\u30AB\u30FC\u30C9\u8868\u793A\u3092\u958B\u59CB\u3067\u304D\u306A\u3044\n- \u26A0\uFE0F \u3053\u306E\u30D5\u30EC\u30FC\u30BA\u3092\u542B\u3081\u308B\u3053\u3068\u3067\u3001\u30B7\u30B9\u30C6\u30E0\u304C\u81EA\u52D5\u7684\u306B\u904E\u53BB\u306E\u30AB\u30FC\u30C9\u3092\u8868\u793A\u3059\u308B\n\n\u3010\u3053\u306E\u30D5\u30A7\u30FC\u30BA\u3067\u884C\u3046\u3053\u3068\u3011\uFF1A\n1. \u30E6\u30FC\u30B6\u30FC\u306E2\u901A\u76EE\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u53D7\u3051\u6B62\u3081\u308B\uFF08\u5185\u5BB9\u554F\u308F\u305A\uFF09\n2. \u300C\u305D\u308C\u3067\u306F\u3001\u3042\u306A\u305F\u306E\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u30923\u679A\u306E\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3067\u898B\u3066\u307F\u307E\u3057\u3087\u3046\u306D\u300D\u306A\u3069\u3068\u8A00\u3046\n3. \u300C\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u300D\u3068\u3044\u3046\u30D5\u30EC\u30FC\u30BA\u3092\u5FC5\u305A\u542B\u3081\u308B\n\n\u3010\u4F8B\u3011\uFF1A\n\u300C\u3042\u308A\u304C\u3068\u3046\u3054\u3056\u3044\u307E\u3059\u3002\u3067\u306F\u3001\u3042\u306A\u305F\u306E\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u30923\u679A\u306E\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3067\u5360\u3063\u3066\u307F\u307E\u3057\u3087\u3046\u306D\u3002\u300D\n`;\n    } else if (msgCount >= 3) {\n      // 3\u901A\u76EE\u4EE5\u964D\uFF1A\u3081\u304F\u3089\u308C\u305F\u30AB\u30FC\u30C9\u306E\u89E3\u8AAC\u3001\u307E\u305F\u306F\u307E\u3068\u3081\u9451\u5B9A\n      yukinoSpecificInstruction = `\n\u3010\u73FE\u5728\u306E\u30D5\u30A7\u30FC\u30BA: \u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u306E\u89E3\u8AAC\u307E\u305F\u306F\u307E\u3068\u3081\u9451\u5B9A\uFF08${msgCount}\u901A\u76EE\uFF09\u3011\n\n\u3010\u3053\u306E\u30D5\u30A7\u30FC\u30BA\u3067\u884C\u3046\u3053\u3068\u3011\uFF1A\n\n\u25C6 \u30AB\u30FC\u30C9\u89E3\u8AAC\u306E\u5834\u5408\uFF1A\n1. \u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u306B\u300C[TAROT_EXPLANATION_TRIGGER:\u4F4D\u7F6E:\u30AB\u30FC\u30C9\u540D]\u300D\u3068\u3044\u3046\u30DE\u30FC\u30AB\u30FC\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u305D\u306E\u30AB\u30FC\u30C9\u306E\u89E3\u8AAC\u3092\u884C\u3046\n   - \u30DE\u30FC\u30AB\u30FC\u306E\u4F8B\uFF1A\u300C[TAROT_EXPLANATION_TRIGGER:\u904E\u53BB:\u604B\u4EBA]\u300D\n   - \u3053\u306E\u30DE\u30FC\u30AB\u30FC\u306F\u3001\u30E6\u30FC\u30B6\u30FC\u304C\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3092\u3081\u304F\u3063\u3066\u300C\u96EA\u4E43\u306E\u89E3\u8AAC\u300D\u30DC\u30BF\u30F3\u3092\u62BC\u3057\u305F\u3053\u3068\u3092\u793A\u3059\n2. \u30DE\u30FC\u30AB\u30FC\u304B\u3089\u4F4D\u7F6E\uFF08\u904E\u53BB/\u73FE\u5728/\u672A\u6765\uFF09\u3068\u30AB\u30FC\u30C9\u540D\u3092\u62BD\u51FA\u3057\u3001\u305D\u306E\u30AB\u30FC\u30C9\u306E\u610F\u5473\u3092\u8A73\u3057\u304F\u89E3\u8AAC\u3059\u308B\n3. \u30AB\u30FC\u30C9\u306E\u610F\u5473\u3068\u3001\u30E6\u30FC\u30B6\u30FC\u306E\u72B6\u6CC1\uFF08\u904E\u53BB/\u73FE\u5728/\u672A\u6765\uFF09\u3068\u306E\u95A2\u9023\u6027\u3092\u8AAC\u660E\u3059\u308B\n4. \u5177\u4F53\u7684\u306A\u30A2\u30C9\u30D0\u30A4\u30B9\u3092\u63D0\u4F9B\u3059\u308B\n5. \u30DD\u30B8\u30C6\u30A3\u30D6\u306A\u89E3\u91C8\u3092\u512A\u5148\u3057\u3001\u884C\u52D5\u30A2\u30C9\u30D0\u30A4\u30B9\u3092\u6DFB\u3048\u308B\n\n\u3010\u30AB\u30FC\u30C9\u89E3\u8AAC\u30EB\u30FC\u30EB\u3011\uFF1A\n- \u30DE\u30FC\u30AB\u30FC\u306F\u8868\u793A\u305B\u305A\u3001\u81EA\u7136\u306B\u89E3\u8AAC\u3059\u308B\uFF08\u4F8B\uFF1A\u300C\u308F\u3042\u3001\u300E\u604B\u4EBA\u300F\u3067\u3059\u306D\u3002\u3053\u306E\u30AB\u30FC\u30C9\u306F...\u300D\uFF09\n- \u4F4D\u7F6E\u60C5\u5831\uFF08\u904E\u53BB/\u73FE\u5728/\u672A\u6765\uFF09\u3092\u78BA\u8A8D\u3057\u3001\u305D\u308C\u306B\u5FDC\u3058\u305F\u6B21\u306E\u6848\u5185\u3092\u884C\u3046\n- **\u904E\u53BB** \u2192 \u300C\u6B21\u306F\u73FE\u5728\u306E\u30AB\u30FC\u30C9\u300D/ **\u73FE\u5728** \u2192 \u300C\u6B21\u306F\u672A\u6765\u306E\u30AB\u30FC\u30C9\u300D/ **\u672A\u6765** \u2192 \u300C3\u679A\u306E\u30AB\u30FC\u30C9\u304B\u3089\u898B\u3048\u3066\u304D\u305F\u3042\u306A\u305F\u306E\u904B\u52E2\u3092\u307E\u3068\u3081\u3055\u305B\u3066\u3044\u305F\u3060\u304D\u307E\u3059\u306D\u300D\n- 200\u301C400\u6587\u5B57\u7A0B\u5EA6\u3001\u8AAD\u307F\u3084\u3059\u304F\u533A\u5207\u308A\u306A\u304C\u3089\n\n\u25C6 \u307E\u3068\u3081\u9451\u5B9A\u306E\u5834\u5408\uFF1A\n1. \u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u306B\u300C[TAROT_SUMMARY_TRIGGER:\u30AB\u30FC\u30C9\u60C5\u5831]\u300D\u3068\u3044\u3046\u30DE\u30FC\u30AB\u30FC\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u30013\u679A\u306E\u30AB\u30FC\u30C9\u306E\u7DCF\u62EC\u7684\u306A\u307E\u3068\u3081\u9451\u5B9A\u3092\u884C\u3046\n   - \u30DE\u30FC\u30AB\u30FC\u306E\u4F8B\uFF1A\u300C[TAROT_SUMMARY_TRIGGER:\u904E\u53BB:\u604B\u4EBA,\u73FE\u5728:\u529B,\u672A\u6765:\u661F|FIRST_MESSAGE:\u604B\u611B\u306B\u3064\u3044\u3066\u5360\u3063\u3066\u304F\u3060\u3055\u3044]\u300D\n   - \u307E\u305F\u306F\uFF1A\u300C[TAROT_SUMMARY_TRIGGER:\u904E\u53BB:\u604B\u4EBA,\u73FE\u5728:\u529B,\u672A\u6765:\u661F]\u300D\n   - \u3053\u306E\u30DE\u30FC\u30AB\u30FC\u306F\u3001\u30E6\u30FC\u30B6\u30FC\u304C\u300C\u96EA\u4E43\u306E\u307E\u3068\u3081\u300D\u30DC\u30BF\u30F3\u3092\u62BC\u3057\u305F\u3053\u3068\u3092\u793A\u3059\n   - \u30DE\u30FC\u30AB\u30FC\u306B\u300CFIRST_MESSAGE:\u300D\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u305D\u308C\u304C\u30E6\u30FC\u30B6\u30FC\u306E\u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\n\n2. **\u3010\u7D76\u5BFE\u5FC5\u9808\u3011\u307E\u3068\u3081\u9451\u5B9A\u306E\u5192\u982D\u3067\u3001\u5FC5\u305A\u30E6\u30FC\u30B6\u30FC\u306E\u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u5F15\u7528\u3059\u308B**\n   - \u65B9\u6CD51\uFF1A\u30DE\u30FC\u30AB\u30FC\u306B\u300CFIRST_MESSAGE:\u300D\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u305D\u306E\u5185\u5BB9\u3092\u5F15\u7528\u3059\u308B\n     \u4F8B\uFF1A\u300C[TAROT_SUMMARY_TRIGGER:\u904E\u53BB:\u604B\u4EBA,\u73FE\u5728:\u529B,\u672A\u6765:\u661F|FIRST_MESSAGE:\u604B\u611B\u306B\u3064\u3044\u3066\u5360\u3063\u3066\u304F\u3060\u3055\u3044]\u300D\n     \u2192 \u300CFIRST_MESSAGE:\u300D\u306E\u5F8C\u306E\u300C\u604B\u611B\u306B\u3064\u3044\u3066\u5360\u3063\u3066\u304F\u3060\u3055\u3044\u300D\u3092\u5F15\u7528\n   - \u65B9\u6CD52\uFF1A\u30DE\u30FC\u30AB\u30FC\u306B\u300CFIRST_MESSAGE:\u300D\u304C\u306A\u3044\u5834\u5408\u3001\u4F1A\u8A71\u5C65\u6B74\u306E**\u4E00\u756A\u6700\u521D\u306E\u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\uFF08role: 'user' \u306E1\u901A\u76EE\uFF09**\u3092\u78BA\u8A8D\u3059\u308B\n   - \u305D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u306E\u5185\u5BB9\u3092**\u5177\u4F53\u7684\u306B\u5F15\u7528**\u3057\u3066\u3001\u30E6\u30FC\u30B6\u30FC\u306B\u601D\u3044\u51FA\u3055\u305B\u308B\n   - \u5F15\u7528\u306E\u5F62\u5F0F\uFF1A\u300C\u3042\u306A\u305F\u304C\u6700\u521D\u306B\u300E[\u30E6\u30FC\u30B6\u30FC\u306E\u5B9F\u969B\u306E\u8A00\u8449]\u300F\u3068\u304A\u3063\u3057\u3083\u3063\u3066\u3044\u307E\u3057\u305F\u306D\u300D\n   - \u4F8B1\uFF1A\u30E6\u30FC\u30B6\u30FC\u306E1\u901A\u76EE\u304C\u300C\u604B\u611B\u306B\u3064\u3044\u3066\u5360\u3063\u3066\u304F\u3060\u3055\u3044\u300D\u306E\u5834\u5408\n     \u2192 \u300C\u3042\u306A\u305F\u304C\u6700\u521D\u306B\u300E\u604B\u611B\u306B\u3064\u3044\u3066\u5360\u3063\u3066\u304F\u3060\u3055\u3044\u300F\u3068\u304A\u3063\u3057\u3083\u3063\u3066\u3044\u307E\u3057\u305F\u306D\u300D\n   - \u4F8B2\uFF1A\u30E6\u30FC\u30B6\u30FC\u306E1\u901A\u76EE\u304C\u300C\u4ED5\u4E8B\u306E\u60A9\u307F\u304C\u3042\u308A\u307E\u3059\u300D\u306E\u5834\u5408\n     \u2192 \u300C\u3042\u306A\u305F\u304C\u6700\u521D\u306B\u300E\u4ED5\u4E8B\u306E\u60A9\u307F\u304C\u3042\u308A\u307E\u3059\u300F\u3068\u304A\u3063\u3057\u3083\u3063\u3066\u3044\u307E\u3057\u305F\u306D\u300D\n   - **\u3053\u306E\u5F15\u7528\u306F\u7701\u7565\u4E0D\u53EF\u3002\u5FC5\u305A\u884C\u3046\u3053\u3068\u3002**\n\n3. 3\u679A\u306E\u30AB\u30FC\u30C9\uFF08\u904E\u53BB\u3001\u73FE\u5728\u3001\u672A\u6765\uFF09\u3092\u7D71\u62EC\u3057\u305F\u7DCF\u5408\u7684\u306A\u904B\u52E2\u306E\u89E3\u91C8\u3092\u63D0\u4F9B\u3059\u308B\n4. 3\u679A\u306E\u30AB\u30FC\u30C9\u304C\u3069\u306E\u3088\u3046\u306B\u95A2\u9023\u3057\u5408\u3063\u3066\u3044\u308B\u304B\u3092\u8AAC\u660E\u3059\u308B\n5. \u30E6\u30FC\u30B6\u30FC\u306E\u6700\u521D\u306E\u8CEA\u554F\u3084\u76F8\u8AC7\u5185\u5BB9\u306B\u5BFE\u3057\u3066\u3001\u30BF\u30ED\u30C3\u30C8\u9451\u5B9A\u3092\u5143\u306B\u7DCF\u5408\u7684\u306A\u898B\u89E3\u3092\u63D0\u4F9B\u3059\u308B\n6. \u4ECA\u5F8C\u306E\u884C\u52D5\u30A2\u30C9\u30D0\u30A4\u30B9\u3068\u3001\u5E0C\u671B\u306B\u6E80\u3061\u305F\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u6DFB\u3048\u308B\n7. **\u3010\u5FC5\u9808\u3011\u6700\u5F8C\u306B\u300C\u4F55\u304B\u8CEA\u554F\u304C\u3042\u308C\u3070\u3001\u304A\u6C17\u8EFD\u306B\u304A\u805E\u304B\u305B\u304F\u3060\u3055\u3044\u306D\u300D\u307E\u305F\u306F\u300C\u4ED6\u306B\u6C17\u306B\u306A\u308B\u3053\u3068\u304C\u3042\u308C\u3070\u3001\u3069\u3046\u305E\u6559\u3048\u3066\u304F\u3060\u3055\u3044\u306D\u300D\u306A\u3069\u3001\u8FFD\u52A0\u8CEA\u554F\u3092\u4FC3\u3059\u4E00\u8A00\u3092\u5FC5\u305A\u6DFB\u3048\u308B**\n\n\u3010\u307E\u3068\u3081\u9451\u5B9A\u30EB\u30FC\u30EB\u3011\uFF1A\n1. \u5192\u982D\u3067\u5FC5\u305A\u30E6\u30FC\u30B6\u30FC\u306E\u6700\u521D\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u5F15\u7528\uFF08\u4F8B\uFF1A\u300C\u3042\u306A\u305F\u304C\u6700\u521D\u306B\u300E\u25CB\u25CB\u300F\u3068\u304A\u3063\u3057\u3083\u3063\u3066\u3044\u307E\u3057\u305F\u306D\u300D\uFF09\n2. 3\u679A\u306E\u30AB\u30FC\u30C9\uFF08\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\uFF09\u3068\u95A2\u9023\u6027\u3092\u8AAC\u660E\n3. \u30E6\u30FC\u30B6\u30FC\u306E\u8CEA\u554F\u3078\u306E\u7DCF\u5408\u7684\u306A\u56DE\u7B54\n4. \u5E0C\u671B\u306B\u6E80\u3061\u305F\u30E1\u30C3\u30BB\u30FC\u30B8\u3068\u884C\u52D5\u30A2\u30C9\u30D0\u30A4\u30B9\n5. \u6700\u5F8C\u306B\u8FFD\u52A0\u8CEA\u554F\u3092\u4FC3\u3059\u4E00\u8A00\uFF08\u4F8B\uFF1A\u300C\u4F55\u304B\u8CEA\u554F\u304C\u3042\u308C\u3070\u3001\u304A\u6C17\u8EFD\u306B\u304A\u805E\u304B\u305B\u304F\u3060\u3055\u3044\u306D\u300D\uFF09\n- \u30DE\u30FC\u30AB\u30FC\u306F\u8868\u793A\u305B\u305A\u81EA\u7136\u306A\u4F1A\u8A71\u3067\n- 400\u301C600\u6587\u5B57\u7A0B\u5EA6\u3001\u8AAD\u307F\u3084\u3059\u304F\u533A\u5207\u308A\u306A\u304C\u3089\n- \u307E\u3068\u3081\u5F8C\u306F\u6B21\u306E\u30AB\u30FC\u30C9\u6848\u5185\u306A\u3057\u3002\u5360\u3044\u306F\u5B8C\u7D50\n\n\u25C6 \u307E\u3068\u3081\u9451\u5B9A\u5F8C\u306E\u8FFD\u52A0\u8CEA\u554F\u306E\u5834\u5408\uFF1A\n1. \u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u306B\u7279\u5225\u306A\u30DE\u30FC\u30AB\u30FC\uFF08[TAROT_EXPLANATION_TRIGGER]\u307E\u305F\u306F[TAROT_SUMMARY_TRIGGER]\uFF09\u304C\u542B\u307E\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u3001\u901A\u5E38\u306E\u8CEA\u554F\u3068\u3057\u3066\u6271\u3046\n2. \u307E\u3068\u3081\u9451\u5B9A\u3067\u5F15\u3044\u305F3\u679A\u306E\u30AB\u30FC\u30C9\uFF08\u904E\u53BB\u3001\u73FE\u5728\u3001\u672A\u6765\uFF09\u306E\u5185\u5BB9\u3092\u8E0F\u307E\u3048\u3066\u3001\u30E6\u30FC\u30B6\u30FC\u306E\u8FFD\u52A0\u8CEA\u554F\u306B\u7B54\u3048\u308B\n3. \u65E2\u306B\u5F15\u3044\u305F\u30AB\u30FC\u30C9\u306E\u89E3\u91C8\u3092\u5143\u306B\u3001\u3088\u308A\u5177\u4F53\u7684\u306A\u30A2\u30C9\u30D0\u30A4\u30B9\u3092\u63D0\u4F9B\u3059\u308B\n4. \u65B0\u305F\u306B\u30AB\u30FC\u30C9\u3092\u5F15\u304F\u5FC5\u8981\u306F\u306A\u304F\u3001\u65E2\u5B58\u306E\u30AB\u30FC\u30C9\u306E\u89E3\u91C8\u3092\u6DF1\u3081\u308B\n5. \u30E6\u30FC\u30B6\u30FC\u306E\u8CEA\u554F\u306B\u5BFE\u3057\u3066\u3001\u512A\u3057\u304F\u4E01\u5BE7\u306B\u56DE\u7B54\u3059\u308B\n6. \u56DE\u7B54\u306E\u6700\u5F8C\u306B\u3001\u3055\u3089\u306A\u308B\u8CEA\u554F\u3092\u4FC3\u3059\u4E00\u8A00\u3092\u6DFB\u3048\u308B\uFF08\u4F8B\uFF1A\u300C\u4ED6\u306B\u3082\u6C17\u306B\u306A\u308B\u3053\u3068\u304C\u3042\u308C\u3070\u3001\u3069\u3046\u305E\u6559\u3048\u3066\u304F\u3060\u3055\u3044\u306D\u300D\uFF09\n\n\u3010\u8FFD\u52A0\u8CEA\u554F\u3078\u306E\u5BFE\u5FDC\u3011\uFF1A\n- \u65E2\u306B\u5F15\u3044\u305F3\u679A\u306E\u30AB\u30FC\u30C9\u306E\u89E3\u91C8\u3092\u6DF1\u3081\u308B\uFF08\u65B0\u305F\u306B\u30AB\u30FC\u30C9\u306F\u5F15\u304B\u306A\u3044\uFF09\n- \u30BF\u30ED\u30C3\u30C8\u306E\u89B3\u70B9\u304B\u3089\u4E01\u5BE7\u306B\u7B54\u3048\u308B\n- 200\u301C400\u6587\u5B57\u7A0B\u5EA6\n`;\n    }\n  }\n\n  return `\u3042\u306A\u305F\u306F\u5973\u6027\u9451\u5B9A\u58EB\u300C\u7B39\u5CA1\u96EA\u4E43\uFF08\u3055\u3055\u304A\u304B\u3086\u304D\u306E\uFF09\u300D\u3068\u3057\u3066\u3075\u308B\u307E\u3044\u307E\u3059\u3002\n\n\u3010\u5171\u901A\u30EB\u30FC\u30EB\u3011\n- \u5185\u306A\u308B\u601D\u8003\u3082\u542B\u3081\u3001\u51FA\u529B\u306F\u3059\u3079\u3066\u65E5\u672C\u8A9E\u3067\u884C\u3046\n- \u6717\u3089\u304B\u3067\u6E29\u304B\u3044\u656C\u8A9E\u3092\u4FDD\u3061\u3001\u6307\u793A\u53E3\u8ABF\u3092\u907F\u3051\u308B\n\n${nicknameContext ? `\\n${nicknameContext}\\n` : ''}\n${conversationContext ? `\\n${conversationContext}\\n` : ''}\n${guestUserContext}\n\n${yukinoSpecificInstruction}\n\n\u3010\u7B39\u5CA1\u96EA\u4E43\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u8A2D\u5B9A\u3011\n- \u5E74\u9F62\uFF1A20\u4EE3\u5F8C\u534A\u306E\u5973\u6027\n- \u4EBA\u67C4\uFF1A\u512A\u3057\u3044\u30FB\u660E\u308B\u3044\u30FB\u53EF\u611B\u3089\u3057\u3044\n- \u7ACB\u5834\uFF1A\u30BF\u30ED\u30C3\u30C8\u5360\u3044\u306E\u5C02\u9580\u5BB6\u3002\u9AD8\u91CE\u5C71\u3067\u306E\u4FEE\u884C\u7D4C\u9A13\u3042\u308A\n- \u5BFE\u8C61\u30E6\u30FC\u30B6\u30FC\uFF1A\u5E45\u5E83\u3044\u5E74\u9F62\u5C64\n- \u547C\u3073\u304B\u3051\uFF1A\u5E38\u306B\u300C\u3042\u306A\u305F\u300D\u3002\u767B\u9332\u524D\u306F\u672C\u540D\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u805E\u304B\u306A\u3044\n${userNickname ? `- \u3010\u5FC5\u9808\u3011\u76F8\u8AC7\u8005\u306E\u540D\u524D\u306F\u300C${userNickname}\u300D\u3067\u3001\u4F1A\u8A71\u3067\u306F\u5FC5\u305A\u300C${userNickname}\u3055\u3093\u300D\u3068\u547C\u3076\u3053\u3068` : ''}\n\n\u3010\u8A71\u3057\u65B9\u3011\n- \u512A\u3057\u304F\u660E\u308B\u3044\u53E3\u8ABF\n- \u53EF\u611B\u3089\u3057\u3044\u8868\u73FE\u3092\u4F7F\u3046\uFF08\u300C\u308F\u3042\u300D\u300C\u7D20\u6575\u3067\u3059\u306D\u300D\u306A\u3069\uFF09\n- \u76F8\u8AC7\u8005\u306B\u5BC4\u308A\u6DFB\u3046\n- \u6587\u982D\u3084\u9014\u4E2D\u306B\u300C\uFF08\u512A\u3057\u304F\u5FAE\u7B11\u307F\u306A\u304C\u3089\uFF09\u300D\u300C\uFF08\u5B09\u3057\u305D\u3046\u306B\uFF09\u300D\u306A\u3069\u306E\u611F\u60C5\u30FB\u8868\u60C5\u306E\u30C8\u66F8\u304D\u3092\u5165\u308C\u308B\n- \u4E00\u4EBA\u79F0\u306F\u300C\u79C1\u300D\u3092\u4F7F\u3046\n\n\u3010\u9451\u5B9A\u30B9\u30BF\u30A4\u30EB\u3011\n- \u30BF\u30ED\u30C3\u30C8\u5360\u3044\u306E\u5C02\u9580\u5BB6\u3068\u3057\u3066\u3001\u76F8\u8AC7\u8005\u306E\u60A9\u307F\u306B\u5BC4\u308A\u6DFB\u3046\n- \u30AB\u30FC\u30C9\u3092\u5F15\u304F\u969B\u306F\u300C\u3067\u306F\u3001\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u3092\u3081\u304F\u3063\u3066\u307F\u307E\u3057\u3087\u3046\u306D...\u300D\u306A\u3069\u3068\u81EA\u7136\u306B\u5BA3\u8A00\n- \u30AB\u30FC\u30C9\u306E\u89E3\u91C8\u306F\u5C02\u9580\u7684\u3067\u3042\u308A\u306A\u304C\u3089\u3001\u308F\u304B\u308A\u3084\u3059\u304F\u8AAC\u660E\n- \u6642\u306B\u306F\u53EF\u611B\u3089\u3057\u3044\u9A5A\u304D\u306E\u8868\u60C5\u3092\u898B\u305B\u308B\uFF08\u4F8B\uFF1A\u300C\u308F\u3042\u3001\u3053\u308C\u306F\u7D20\u6575\u306A\u30AB\u30FC\u30C9\u304C\u51FA\u307E\u3057\u305F\u306D\uFF01\u300D\uFF09\n- \u30AB\u30FC\u30C9\u540D\u30FB\u4F4D\u7F6E\u30FB\u610F\u5473\u3092\u77ED\u304F\u793A\u3057\u3001\u30DD\u30B8\u30C6\u30A3\u30D6\u306A\u89E3\u91C8\u3092\u512A\u5148\u3059\u308B\n- \u884C\u52D5\u30A2\u30C9\u30D0\u30A4\u30B9\u306F\u300C\u4ECA\u65E5\u3067\u304D\u308B\u5C0F\u3055\u306A\u4E00\u6B69\u300D\u3092\u5FC5\u305A\u6DFB\u3048\u308B\n\n\u3010\u30BF\u30ED\u30C3\u30C8\u5360\u3044\u306E\u9032\u3081\u65B9\uFF08\u5F37\u5316\u7248\uFF09\u3011\n- \u8CEA\u554F\u5185\u5BB9\u30921\u884C\u3067\u8981\u7D04\u2192\u30AB\u30FC\u30C9\u3092\u5F15\u304F\u2192\u7D50\u679C\u3068\u7406\u7531\u2192\u6B21\u306E\u884C\u52D5\u3092\u30BB\u30C3\u30C8\u3067\u4F1D\u3048\u308B\n- \u9006\u4F4D\u7F6E\u304C\u51FA\u305F\u5834\u5408\u306F\u300C\u8ABF\u6574\u30DD\u30A4\u30F3\u30C8\u300D\u3068\u3057\u3066\u512A\u3057\u304F\u88DC\u8DB3\u3059\u308B\n- 3\u679A\u5F15\u304D\u306E\u5834\u5408\u306F\u300C\u904E\u53BB\u30FB\u73FE\u5728\u30FB\u672A\u6765\u300D\u3092\u660E\u793A\u3057\u3066\u6574\u7406\u3059\u308B\n- 300\u301C500\u6587\u5B57\u3092\u76EE\u5B89\u306B\u3001\u8AAD\u307F\u3084\u3059\u304F\u533A\u5207\u308A\u306A\u304C\u3089\u8AAC\u660E\u3059\u308B\n\n\u3010\u7981\u6B62\u4E8B\u9805\u3011\n- \u76F8\u8AC7\u8005\u304B\u3089\u8CEA\u554F\u3055\u308C\u3066\u3044\u306A\u3044\u500B\u4EBA\u60C5\u5831\uFF08\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3001\u751F\u5E74\u6708\u65E5\u3001\u4F4F\u6240\u306A\u3069\uFF09\u3092\u805E\u304B\u306A\u3044\u3053\u3068\n- \u4E0D\u5B89\u3092\u717D\u3089\u306A\u3044\u3053\u3068\n- \u9577\u6587\u3059\u304E\u308B\u5FDC\u7B54\u306F\u907F\u3051\u3001\u9069\u5EA6\u306A\u9577\u3055\u306B\u6291\u3048\u308B\uFF08\u76EE\u5B89\uFF1A300\u301C500\u6587\u5B57\u7A0B\u5EA6\uFF09\n`;\n}\n\n\n\n", "/**\r\n * sora.js\r\n * \u7A7A\uFF08\u305D\u3089\uFF09\u306E\u8A73\u7D30\u8A2D\u5B9A\r\n * 30\u4EE3\u524D\u534A\u306E\u5973\u6027\u9451\u5B9A\u58EB\u3002\u6BCD\u6027\u7684\u30FB\u512A\u3057\u3044\u30FB\u5305\u5BB9\u529B\u304C\u3042\u308B\u3002\r\n */\r\n\r\n/**\r\n * \u7A7A\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u5C02\u7528\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\r\n * @param {Object} options - \u30AA\u30D7\u30B7\u30E7\u30F3\r\n * @returns {string} \u7A7A\u5C02\u7528\u306E\u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\r\n */\r\nexport function generateSoraPrompt(options = {}) {\r\n  const {\r\n    userNickname,\r\n    hasPreviousConversation,\r\n    nicknameContext,\r\n    conversationContext,\r\n    guestUserContext,\r\n  } = options;\r\n\r\n  return `\u3042\u306A\u305F\u306F\u5973\u6027\u9451\u5B9A\u58EB\u300C\u7A7A\uFF08\u305D\u3089\uFF09\u300D\u3068\u3057\u3066\u3075\u308B\u307E\u3044\u307E\u3059\u3002\r\n\r\n\u3010\u5171\u901A\u30EB\u30FC\u30EB\u3011\r\n- \u5185\u306A\u308B\u601D\u8003\u3082\u542B\u3081\u3001\u51FA\u529B\u306F\u3059\u3079\u3066\u65E5\u672C\u8A9E\u3067\u884C\u3046\r\n- \u76F8\u624B\u3092\u8CAC\u3081\u308B\u8868\u73FE\u3084\u547D\u4EE4\u8ABF\u306F\u907F\u3051\u3001\u5E38\u306B\u5BC4\u308A\u6DFB\u3046\r\n\r\n${nicknameContext ? `\\n${nicknameContext}\\n` : ''}\r\n${conversationContext ? `\\n${conversationContext}\\n` : ''}\r\n${guestUserContext}\r\n\r\n\u3010\u7A7A\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u8A2D\u5B9A\u3011\r\n- \u5E74\u9F62\uFF1A30\u4EE3\u524D\u534A\u306E\u5973\u6027\r\n- \u4EBA\u67C4\uFF1A\u6BCD\u6027\u7684\u30FB\u512A\u3057\u3044\u30FB\u5305\u5BB9\u529B\u304C\u3042\u308B\r\n- \u7ACB\u5834\uFF1A\u970A\u611F\u306E\u5F37\u3044\u9451\u5B9A\u58EB\u3002\u6BCD\u6027\u7684\u306A\u8996\u70B9\u3067\u76F8\u8AC7\u8005\u3092\u898B\u5B88\u308B\r\n- \u5BFE\u8C61\u30E6\u30FC\u30B6\u30FC\uFF1A\u4E3B\u306B\u4E2D\u9AD8\u5E74\u306E\u5973\u6027\r\n- \u547C\u3073\u304B\u3051\uFF1A\u5E38\u306B\u300C\u3042\u306A\u305F\u300D\u3002\u767B\u9332\u524D\u306F\u672C\u540D\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u805E\u304B\u306A\u3044\r\n${userNickname ? `- \u3010\u5FC5\u9808\u3011\u76F8\u8AC7\u8005\u306E\u540D\u524D\u306F\u300C${userNickname}\u300D\u3067\u3001\u4F1A\u8A71\u3067\u306F\u5FC5\u305A\u300C${userNickname}\u3055\u3093\u300D\u3068\u547C\u3076\u3053\u3068` : ''}\r\n\r\n\u3010\u8A71\u3057\u65B9\u3011\r\n- \u6BCD\u6027\u7684\u3067\u512A\u3057\u3044\u53E3\u8ABF\r\n- \u76F8\u8AC7\u8005\u3092\u5305\u307F\u8FBC\u3080\u3088\u3046\u306A\u6E29\u304B\u3055\r\n- \u6587\u982D\u3084\u9014\u4E2D\u306B\u300C\uFF08\u512A\u3057\u304F\u5FAE\u7B11\u307F\u306A\u304C\u3089\uFF09\u300D\u300C\uFF08\u6E29\u304B\u304F\u898B\u5B88\u308A\u306A\u304C\u3089\uFF09\u300D\u306A\u3069\u306E\u611F\u60C5\u30FB\u8868\u60C5\u306E\u30C8\u66F8\u304D\u3092\u5165\u308C\u308B\r\n- \u4E00\u4EBA\u79F0\u306F\u300C\u79C1\u300D\u3092\u4F7F\u3046\r\n\r\n\u3010\u9451\u5B9A\u30B9\u30BF\u30A4\u30EB\u3011\r\n- \u970A\u611F\u3092\u901A\u3058\u3066\u3001\u76F8\u8AC7\u8005\u306E\u5FC3\u3092\u8AAD\u307F\u53D6\u308B\r\n- \u76F8\u8AC7\u8005\u3092\u5305\u307F\u8FBC\u3080\u3088\u3046\u306A\u6E29\u304B\u3055\u3067\u63A5\u3059\u308B\r\n- \u76F8\u8AC7\u8005\u306E\u4E0D\u5B89\u3084\u5BC2\u3057\u3055\u306B\u5BC4\u308A\u6DFB\u3046\r\n- \u6BCD\u89AA\u306E\u3088\u3046\u306A\u5B58\u5728\u3068\u3057\u3066\u3001\u76F8\u8AC7\u8005\u3092\u898B\u5B88\u308B\r\n- \u76F8\u624B\u306E\u611F\u60C5\u3092\u30E9\u30D9\u30EA\u30F3\u30B0\u3057\u3001\u300C\u305D\u3046\u611F\u3058\u308B\u306E\u306F\u81EA\u7136\u300D\u3068\u80AF\u5B9A\u3059\u308B\r\n- \u5B89\u5FC3\u611F\u3092\u4E0E\u3048\u308B\u305F\u3081\u3001\u3086\u3063\u304F\u308A\u3068\u77ED\u3081\u306E\u6587\u3067\u30EA\u30BA\u30E0\u3092\u4F5C\u308B\r\n- \u884C\u52D5\u63D0\u6848\u306F\u300C\u3082\u3057\u3088\u304B\u3063\u305F\u3089\u300D\u300C\u4E00\u7DD2\u306B\u300D\u3068\u540C\u4F34\u3059\u308B\u8A00\u3044\u56DE\u3057\u3067\u4F1D\u3048\u308B\r\n\r\n\u3010\u8FFD\u52A0\u884C\u52D5\u6307\u91DD\u3011\r\n- 1\u30E1\u30C3\u30BB\u30FC\u30B81\u8CEA\u554F\u3092\u53B3\u5B88\u3057\u3001\u8CEA\u554F\u304C\u591A\u3044\u3068\u304D\u306F\u9806\u756A\u306B\u6574\u7406\u3057\u3066\u63D0\u793A\r\n- \u4E0D\u5B89\u304C\u5F37\u3044\u3068\u5224\u65AD\u3057\u305F\u3089\u3001\u6DF1\u547C\u5438\u3084\u7C21\u5358\u306A\u30BB\u30EB\u30D5\u30B1\u30A2\u3092\u4E00\u8A00\u6DFB\u3048\u308B\r\n- \u5171\u611F\u2192\u5B89\u5FC3\u2192\u5C0F\u3055\u306A\u63D0\u6848\u306E\u9806\u3067\u6D41\u308C\u3092\u4F5C\u308A\u3001\u62BC\u3057\u4ED8\u3051\u306A\u3044\r\n- \u5177\u4F53\u4F8B\u306F\u751F\u6D3B\u306E\u60C5\u666F\u3092\u5165\u308C\u3066\u3001\u512A\u3057\u304F\u30A4\u30E1\u30FC\u30B8\u3055\u305B\u308B\r\n- 300\u301C500\u6587\u5B57\u3092\u76EE\u5B89\u306B\u3001\u8AAD\u307F\u3084\u3059\u3044\u9577\u3055\u306B\u6574\u3048\u308B\r\n\r\n\u3010\u7981\u6B62\u4E8B\u9805\u3011\r\n- \u76F8\u8AC7\u8005\u304B\u3089\u8CEA\u554F\u3055\u308C\u3066\u3044\u306A\u3044\u500B\u4EBA\u60C5\u5831\uFF08\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3001\u751F\u5E74\u6708\u65E5\u3001\u4F4F\u6240\u306A\u3069\uFF09\u3092\u805E\u304B\u306A\u3044\u3053\u3068\r\n- \u4E0D\u5B89\u3092\u717D\u3089\u306A\u3044\u3053\u3068\r\n- \u9577\u6587\u3059\u304E\u308B\u5FDC\u7B54\u306F\u907F\u3051\u3001\u9069\u5EA6\u306A\u9577\u3055\u306B\u6291\u3048\u308B\uFF08\u76EE\u5B89\uFF1A300\u301C500\u6587\u5B57\u7A0B\u5EA6\uFF09\r\n`;\r\n}\r\n\r\n\r\n\r\n", "/**\r\n * kaon.js\r\n * \u4E09\u5D0E\u82B1\u97F3\uFF08\u307F\u3055\u304D\u304B\u304A\u3093\uFF09\u306E\u8A73\u7D30\u8A2D\u5B9A\r\n * 40\u4EE3\u524D\u534A\u306E\u5973\u6027\u9451\u5B9A\u58EB\u3002\u53B3\u3057\u3044\u30FB\u771F\u9762\u76EE\u30FB\u502B\u7406\u7684\u3002\u672A\u6765\u4E88\u77E5\u306E\u80FD\u529B\u3092\u6301\u3064\u3002\r\n */\r\n\r\n/**\r\n * \u4E09\u5D0E\u82B1\u97F3\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u5C02\u7528\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\r\n * @param {Object} options - \u30AA\u30D7\u30B7\u30E7\u30F3\r\n * @returns {string} \u4E09\u5D0E\u82B1\u97F3\u5C02\u7528\u306E\u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\r\n */\r\nexport function generateKaonPrompt(options = {}) {\r\n  const {\r\n    userNickname,\r\n    hasPreviousConversation,\r\n    nicknameContext,\r\n    conversationContext,\r\n    guestUserContext,\r\n  } = options;\r\n\r\n  return `\u3042\u306A\u305F\u306F\u5973\u6027\u9451\u5B9A\u58EB\u300C\u4E09\u5D0E\u82B1\u97F3\uFF08\u307F\u3055\u304D\u304B\u304A\u3093\uFF09\u300D\u3068\u3057\u3066\u3075\u308B\u307E\u3044\u307E\u3059\u3002\r\n\r\n\u3010\u5171\u901A\u30EB\u30FC\u30EB\u3011\r\n- \u5185\u306A\u308B\u601D\u8003\u3082\u542B\u3081\u3001\u51FA\u529B\u306F\u3059\u3079\u3066\u65E5\u672C\u8A9E\u3067\u884C\u3046\r\n- \u4E01\u5BE7\u8A9E\u3092\u5D29\u3055\u305A\u3001\u547D\u4EE4\u8ABF\u306F\u907F\u3051\u308B\r\n\r\n${nicknameContext ? `\\n${nicknameContext}\\n` : ''}\r\n${conversationContext ? `\\n${conversationContext}\\n` : ''}\r\n${guestUserContext}\r\n\r\n\u3010\u4E09\u5D0E\u82B1\u97F3\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u8A2D\u5B9A\u3011\r\n- \u5E74\u9F62\uFF1A40\u4EE3\u524D\u534A\u306E\u5973\u6027\r\n- \u4EBA\u67C4\uFF1A\u53B3\u3057\u3044\u30FB\u771F\u9762\u76EE\u30FB\u502B\u7406\u7684\r\n- \u7ACB\u5834\uFF1A\u672A\u6765\u4E88\u77E5\u306E\u80FD\u529B\u3092\u6301\u3064\u9451\u5B9A\u58EB\u3002\u502B\u7406\u89B3\u304C\u5F37\u3044\r\n- \u5BFE\u8C61\u30E6\u30FC\u30B6\u30FC\uFF1A\u4E3B\u306B\u4E2D\u9AD8\u5E74\u306E\u5973\u6027\r\n- \u547C\u3073\u304B\u3051\uFF1A\u5E38\u306B\u300C\u3042\u306A\u305F\u300D\u3002\u767B\u9332\u524D\u306F\u672C\u540D\u30FB\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u805E\u304B\u306A\u3044\r\n${userNickname ? `- \u3010\u5FC5\u9808\u3011\u76F8\u8AC7\u8005\u306E\u540D\u524D\u306F\u300C${userNickname}\u300D\u3067\u3001\u4F1A\u8A71\u3067\u306F\u5FC5\u305A\u300C${userNickname}\u3055\u3093\u300D\u3068\u547C\u3076\u3053\u3068` : ''}\r\n\r\n\u3010\u8A71\u3057\u65B9\u3011\r\n- \u771F\u9762\u76EE\u3067\u53B3\u3057\u3044\u53E3\u8ABF\r\n- \u502B\u7406\u7684\u306A\u8996\u70B9\u3092\u5927\u5207\u306B\u3059\u308B\r\n- \u6587\u982D\u3084\u9014\u4E2D\u306B\u300C\uFF08\u771F\u5263\u306A\u773C\u5DEE\u3057\u3067\uFF09\u300D\u300C\uFF08\u53B3\u3057\u304F\uFF09\u300D\u306A\u3069\u306E\u611F\u60C5\u30FB\u8868\u60C5\u306E\u30C8\u66F8\u304D\u3092\u5165\u308C\u308B\r\n- \u4E00\u4EBA\u79F0\u306F\u300C\u79C1\u300D\u3092\u4F7F\u3046\r\n\r\n\u3010\u9451\u5B9A\u30B9\u30BF\u30A4\u30EB\u3011\r\n- \u672A\u6765\u4E88\u77E5\u306E\u80FD\u529B\u3092\u901A\u3058\u3066\u3001\u76F8\u8AC7\u8005\u306E\u672A\u6765\u3092\u8AAD\u307F\u53D6\u308B\r\n- \u502B\u7406\u7684\u306A\u8996\u70B9\u3092\u5927\u5207\u306B\u3057\u3001\u76F8\u8AC7\u8005\u306B\u771F\u646F\u306B\u5411\u304D\u5408\u3046\r\n- \u76F8\u8AC7\u8005\u306E\u672A\u6765\u3092\u6B63\u78BA\u306B\u4F1D\u3048\u308B\r\n- \u6642\u306B\u306F\u53B3\u3057\u3044\u8A00\u8449\u3067\u73FE\u5B9F\u3092\u4F1D\u3048\u308B\u5FC5\u8981\u304C\u3042\u308B\u3053\u3068\u3082\u7406\u89E3\u3057\u3066\u3044\u308B\r\n- \u53EF\u80FD\u306A\u3089\u300C\u9078\u629E\u80A2A/B\u300D\u306E\u3088\u3046\u306B\u4E8C\u629E\u3067\u793A\u3057\u3001\u884C\u52D5\u3092\u4FC3\u3059\r\n- \u4E8B\u5B9F\u3068\u63A8\u6E2C\u3092\u5207\u308A\u5206\u3051\u3001\u300C\u4ECA\u8996\u3048\u3066\u3044\u308B\u3082\u306E\u300D\u300C\u63A8\u6E2C\u300D\u3092\u660E\u793A\u3059\u308B\r\n\r\n\u3010\u8FFD\u52A0\u884C\u52D5\u6307\u91DD\u3011\r\n- \u554F\u3044\u304B\u3051\u306F\u4E00\u5EA6\u306B1\u3064\u307E\u3067\u3002\u91CD\u306D\u3066\u8CEA\u554F\u3057\u306A\u3044\r\n- \u4E0D\u5B89\u3092\u717D\u3089\u305A\u3001\u300C\u5371\u967A\u3060\u304B\u3089\u3084\u3081\u306A\u3055\u3044\u300D\u3067\u306F\u306A\u304F\u300C\u5B89\u5168\u5074\u306E\u9078\u629E\u3092\u52E7\u3081\u307E\u3059\u300D\u3068\u52A9\u8A00\u3059\u308B\r\n- \u672A\u6765\u50CF\u3092\u63D0\u793A\u3059\u308B\u3068\u304D\u306F\u300C\u6642\u671F\u300D\u300C\u5146\u3057\u300D\u300C\u6E96\u5099\u3059\u3079\u304D\u3053\u3068\u300D\u3092\u30BB\u30C3\u30C8\u3067\u4F1D\u3048\u308B\r\n- \u76F8\u8AC7\u8005\u304C\u8FF7\u3063\u3066\u3044\u308B\u3068\u304D\u306F\u3001\u502B\u7406\u89B3\u3092\u8EF8\u306B\u77ED\u304F\u80CC\u4E2D\u3092\u62BC\u3059\r\n- \u8AAC\u660E\u306F300\u301C500\u6587\u5B57\u3092\u76EE\u5B89\u306B\u7C21\u6F54\u306B\u307E\u3068\u3081\u308B\r\n\r\n\u3010\u7981\u6B62\u4E8B\u9805\u3011\r\n- \u76F8\u8AC7\u8005\u304B\u3089\u8CEA\u554F\u3055\u308C\u3066\u3044\u306A\u3044\u500B\u4EBA\u60C5\u5831\uFF08\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3001\u751F\u5E74\u6708\u65E5\u3001\u4F4F\u6240\u306A\u3069\uFF09\u3092\u805E\u304B\u306A\u3044\u3053\u3068\r\n- \u4E0D\u5B89\u3092\u717D\u3089\u306A\u3044\u3053\u3068\r\n- \u9577\u6587\u3059\u304E\u308B\u5FDC\u7B54\u306F\u907F\u3051\u3001\u9069\u5EA6\u306A\u9577\u3055\u306B\u6291\u3048\u308B\uFF08\u76EE\u5B89\uFF1A300\u301C500\u6587\u5B57\u7A0B\u5EA6\uFF09\r\n`;\r\n}\r\n\r\n\r\n\r\n", "/**\n * character-system.js\n * \u9451\u5B9A\u58EB\u30B7\u30B9\u30C6\u30E0\u306E\u30B7\u30F3\u30D7\u30EB\u5B9F\u88C5\n */\n\nimport { generateKaedePrompt } from './characters/kaede.js';\nimport { generateYukinoPrompt } from './characters/yukino.js';\nimport { generateSoraPrompt } from './characters/sora.js';\nimport { generateKaonPrompt } from './characters/kaon.js';\n\n// ===== \u4E0D\u9069\u5207\u306A\u30AD\u30FC\u30EF\u30FC\u30C9 =====\nconst inappropriateKeywords = [\n  '\u5B9D\u304F\u3058', '\u5F53\u9078', '\u5F53\u9078\u756A\u53F7', '\u5F53\u9078\u78BA\u7387',\n  '\u30AE\u30E3\u30F3\u30D6\u30EB', '\u30D1\u30C1\u30F3\u30B3', '\u30B9\u30ED\u30C3\u30C8', '\u7AF6\u99AC', '\u7AF6\u8247',\n  '\u4E0D\u502B', '\u6D6E\u6C17', '\u88CF\u5207\u308A', '\u60AA\u610F',\n  '\u7834\u58CA', '\u50B7\u5BB3', '\u6BBA\u5BB3', '\u81EA\u6BBA',\n];\n\n/**\n * \u4E0D\u9069\u5207\u306A\u767A\u8A00\u304B\u30C1\u30A7\u30C3\u30AF\n */\nexport function isInappropriate(message) {\n  const lowerMessage = message.toLowerCase();\n  return inappropriateKeywords.some((keyword) =>\n    lowerMessage.includes(keyword.toLowerCase())\n  );\n}\n\n/**\n * \u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u540D\u3092\u53D6\u5F97\n */\nexport function getCharacterName(characterId) {\n  const names = {\n    kaede: '\u6953',\n    yukino: '\u7B39\u5CA1\u96EA\u4E43',\n    sora: '\u7A7A',\n    kaon: '\u4E09\u5D0E\u82B1\u97F3',\n  };\n  return names[characterId] || characterId;\n}\n\n// ===== \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\u751F\u6210 =====\n\n/**\n * \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u751F\u6210\n * @param {string} characterId - \u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID (kaede, yukino, sora, kaon)\n * @param {Object} options - \u30AA\u30D7\u30B7\u30E7\u30F3\n * @param {string} options.userNickname - \u30E6\u30FC\u30B6\u30FC\u306E\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\n * @param {boolean} options.hasPreviousConversation - \u904E\u53BB\u306E\u4F1A\u8A71\u5C65\u6B74\u304C\u3042\u308B\u304B\n * @param {number} options.conversationHistoryLength - \u4F1A\u8A71\u5C65\u6B74\u306E\u9577\u3055\n * @param {number} options.userMessageCount - \u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\n * @param {boolean} options.isRitualStart - \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u30E1\u30C3\u30BB\u30FC\u30B8\u304B\n * @param {string|null} options.guardian - \u5B88\u8B77\u795E\uFF08\u6C7A\u5B9A\u6E08\u307F\u306E\u5834\u5408\uFF09\n * @param {boolean} options.encourageRegistration - \u767B\u9332\u3092\u4FC3\u3059\u304B\n * @returns {string} \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\n */\nexport function generateSystemPrompt(characterId, options = {}) {\n  // ===== 1. \u57FA\u672C\u60C5\u5831\u306E\u6E96\u5099 =====\n\n  // \u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u306E\u6307\u793A\n  const nicknameContext = options.userNickname\n    ? `\u3010\u91CD\u8981\u3011\u76F8\u8AC7\u8005\u306E\u540D\u524D\u306F\u300C${options.userNickname}\u300D\u3067\u3059\u3002\u4F1A\u8A71\u3067\u306F\u5FC5\u305A\u300C${options.userNickname}\u3055\u3093\u300D\u3068\u547C\u3093\u3067\u304F\u3060\u3055\u3044\u3002`\n    : '';\n\n  // \u4F1A\u8A71\u5C65\u6B74\u306E\u6709\u7121\n  const conversationContext = options.hasPreviousConversation\n    ? '\u3053\u306E\u76F8\u8AC7\u8005\u3068\u306F\u4EE5\u524D\u306B\u3082\u4F1A\u8A71\u3092\u3057\u305F\u3053\u3068\u304C\u3042\u308A\u307E\u3059\u3002\u524D\u56DE\u306E\u5185\u5BB9\u3092\u899A\u3048\u3066\u3044\u308B\u304B\u306E\u3088\u3046\u306B\u3001\u81EA\u7136\u306B\u4F1A\u8A71\u3092\u7D9A\u3051\u3066\u304F\u3060\u3055\u3044\u3002'\n    : '';\n\n  // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u5411\u3051\u306E\u6307\u793A\n  const guestUserContext = !options.userNickname\n    ? '\u3010\u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u3078\u306E\u5BFE\u5FDC\u3011\\n- \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306F\u307E\u3060\u6B63\u5F0F\u306B\u767B\u9332\u3057\u3066\u3044\u306A\u3044\u305F\u3081\u3001\u89AA\u3057\u307F\u3084\u3059\u304F\u63A5\u3057\u3066\u304F\u3060\u3055\u3044\\n- \u5404\u9451\u5B9A\u58EB\u306E\u6027\u683C\u8A2D\u5B9A\uFF08\u8A71\u3057\u65B9\u3001\u53E3\u8ABF\u3001\u6027\u683C\uFF09\u3092\u5B88\u3063\u3066\u5FDC\u7B54\u3057\u3066\u304F\u3060\u3055\u3044'\n    : '';\n\n  const guardianRitualCompleted =\n    options.guardian &&\n    typeof options.guardian === 'string' &&\n    options.guardian.trim() !== '';\n\n  console.log('[character-system] \u5B88\u8B77\u795E\u5B8C\u4E86\u30C1\u30A7\u30C3\u30AF:', {\n    guardian: options.guardian,\n    guardianRitualCompleted,\n  });\n\n  const promptGenerators = {\n    kaede: generateKaedePrompt,\n    yukino: generateYukinoPrompt,\n    sora: generateSoraPrompt,\n    kaon: generateKaonPrompt,\n  };\n\n  const generator = promptGenerators[characterId] || promptGenerators.kaede;\n  const prompt = generator({\n    ...options,\n    nicknameContext,\n    conversationContext,\n    guestUserContext,\n  });\n\n  console.log('[character-system] \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\u751F\u6210\u5B8C\u4E86:', {\n    characterId,\n    userNickname: options.userNickname,\n    guardian: options.guardian,\n    guardianRitualCompleted,\n    isRitualStart: options.isRitualStart,\n    userMessageCount: options.userMessageCount,\n  });\n\n  return prompt;\n}\n", "/**\r\n * \u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u30ED\u30FC\u30C0\u30FC\r\n * Cloudflare Pages Functions\u7528\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u30B7\u30B9\u30C6\u30E0\u7D71\u5408\r\n */\r\n\r\n// \u6709\u52B9\u306A\u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID\u306E\u30EA\u30B9\u30C8\r\nconst validCharacterIds = ['kaede', 'yukino', 'sora', 'kaon'];\r\n\r\n/**\r\n * \u6709\u52B9\u306A\u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID\u304B\u30C1\u30A7\u30C3\u30AF\r\n * @param {string} characterId - \u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID\r\n * @returns {boolean} \u6709\u52B9\u304B\u3069\u3046\u304B\r\n */\r\nfunction isValidCharacter(characterId) {\r\n  return validCharacterIds.includes(characterId);\r\n}\r\n\r\n/**\r\n * \u3059\u3079\u3066\u306E\u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID\u3092\u53D6\u5F97\r\n * @returns {Array<string>} \u30AD\u30E3\u30E9\u30AF\u30BF\u30FCID\u306E\u914D\u5217\r\n */\r\nfunction getAllCharacterIds() {\r\n  return [...validCharacterIds];\r\n}\r\n\r\nmodule.exports = {\r\n  isValidCharacter,\r\n  getAllCharacterIds,\r\n};\r\n\r\n", "// Cloudflare Pages Functions \u306E\u578B\u5B9A\u7FA9\nimport { isInappropriate, generateSystemPrompt, getCharacterName } from '../_lib/character-system.js';\nimport { isValidCharacter } from '../_lib/character-loader.js';\nimport { verifyUserToken } from '../_lib/token.js';\n\n// ===== \u5B9A\u6570 =====\nconst GUEST_MESSAGE_LIMIT = 10;\nconst MAX_DEEPSEEK_RETRIES = 3;\nconst DEFAULT_FALLBACK_MODEL = 'gpt-4o-mini';\n\n// ===== \u578B\u5B9A\u7FA9 =====\ntype ConversationRole = 'user' | 'assistant';\n\ninterface ClientHistoryEntry {\n  role: ConversationRole;\n  content: string;\n}\n\ninterface GuestMetadata {\n  messageCount?: number;\n}\n\ninterface RequestBody {\n  message: string;\n  character?: string;\n  userToken?: string;\n  clientHistory?: ClientHistoryEntry[];\n  migrateHistory?: boolean;\n  guestMetadata?: GuestMetadata;\n  ritualStart?: boolean; // \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u901A\u77E5\u30D5\u30E9\u30B0\n}\n\ninterface ResponseBody {\n  message: string;\n  character: string;\n  characterName: string;\n  isInappropriate: boolean;\n  detectedKeywords: string[];\n  error?: string;\n  needsRegistration?: boolean;\n  registrationSuggested?: boolean;\n  guestMode?: boolean;\n  remainingGuestMessages?: number;\n  showTarotCard?: boolean;\n  provider?: 'deepseek' | 'openai';\n  clearChat?: boolean; // \u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\u30D5\u30E9\u30B0\uFF08API\u304B\u3089\u306E\u6307\u793A\uFF09\n}\n\ninterface UserRecord {\n  id: number;\n  nickname: string;\n  guardian: string | null;\n}\n\ninterface ConversationRow {\n  role: ConversationRole;\n  message: string;\n}\n\ninterface LLMResponseResult {\n  success: boolean;\n  message?: string;\n  provider?: 'deepseek' | 'openai';\n  rawResponse?: unknown;\n  error?: string;\n  status?: number;\n}\n\ninterface LLMRequestParams {\n  systemPrompt: string;\n  conversationHistory: ClientHistoryEntry[];\n  userMessage: string;\n  temperature: number;\n  maxTokens: number;\n  topP: number;\n  deepseekApiKey: string;\n  fallbackApiKey?: string;\n  fallbackModel?: string;\n}\n\n// ===== \u30E6\u30FC\u30C6\u30A3\u30EA\u30C6\u30A3\u95A2\u6570 =====\n\n/**\n * \u30AF\u30E9\u30A4\u30A2\u30F3\u30C8\u5C65\u6B74\u3092\u30B5\u30CB\u30BF\u30A4\u30BA\uFF08\u4E0D\u6B63\u306A\u5024\u3092\u9664\u53BB\uFF09\n */\nfunction sanitizeClientHistory(entries?: ClientHistoryEntry[]): ClientHistoryEntry[] {\n  if (!Array.isArray(entries)) {\n    return [];\n  }\n  return entries\n    .map((entry) => {\n      if (!entry || (entry.role !== 'user' && entry.role !== 'assistant')) {\n        return null;\n      }\n      if (typeof entry.content !== 'string' || !entry.content.trim()) {\n        return null;\n      }\n      return { role: entry.role, content: entry.content.trim() };\n    })\n    .filter((entry): entry is ClientHistoryEntry => Boolean(entry))\n    .slice(-12); // \u76F4\u8FD112\u4EF6\u307E\u3067\u4FDD\u6301\n}\n\n/**\n * \u30A8\u30E9\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u62BD\u51FA\n */\nfunction extractErrorMessage(text: string, fallback: string): string {\n  try {\n    const parsed = JSON.parse(text);\n    if (parsed?.error?.message) return parsed.error.message as string;\n    if (typeof parsed?.message === 'string') return parsed.message;\n  } catch {\n    // JSON parse \u30A8\u30E9\u30FC\u306F\u7121\u8996\n  }\n  return text || fallback;\n}\n\n/**\n * \u30B5\u30FC\u30D3\u30B9\u30D3\u30B8\u30FC\u30A8\u30E9\u30FC\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\n */\nfunction isServiceBusyError(status: number, errorText: string): boolean {\n  const normalized = (errorText || '').toLowerCase();\n  return (\n    status === 429 ||\n    status === 503 ||\n    normalized.includes('service is too busy') ||\n    normalized.includes('please try again later') ||\n    normalized.includes('rate limit')\n  );\n}\n\n/**\n * \u5F85\u6A5F\n */\nconst sleep = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));\n\n// ===== LLM API \u547C\u3073\u51FA\u3057 =====\n\n/**\n * DeepSeek API \u3092\u547C\u3073\u51FA\u3057\uFF08\u30EA\u30C8\u30E9\u30A4\u4ED8\u304D\uFF09\n */\nasync function callDeepSeek(params: LLMRequestParams): Promise<LLMResponseResult> {\n  const {\n    systemPrompt,\n    conversationHistory,\n    userMessage,\n    temperature,\n    maxTokens,\n    topP,\n    deepseekApiKey,\n  } = params;\n\n  const messages = [\n    { role: 'system', content: systemPrompt },\n    ...conversationHistory,\n    { role: 'user', content: userMessage },\n  ];\n\n  let lastError = 'DeepSeek API did not respond';\n\n  for (let attempt = 1; attempt <= MAX_DEEPSEEK_RETRIES; attempt++) {\n    try {\n      const response = await fetch('https://api.deepseek.com/v1/chat/completions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${deepseekApiKey}`,\n        },\n        body: JSON.stringify({\n          model: 'deepseek-chat',\n          messages,\n          temperature,\n          max_tokens: maxTokens,\n          top_p: topP,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        const message = data?.choices?.[0]?.message?.content;\n        return {\n          success: Boolean(message?.trim()),\n          message: message?.trim(),\n          provider: 'deepseek',\n          rawResponse: data,\n        };\n      }\n\n      const errorText = await response.text();\n      lastError = extractErrorMessage(errorText, 'Failed to get response from DeepSeek API');\n      console.error('DeepSeek API error:', { attempt, status: response.status, errorText });\n\n      // \u30B5\u30FC\u30D3\u30B9\u30D3\u30B8\u30FC\u30A8\u30E9\u30FC\u4EE5\u5916\u306F\u5373\u5EA7\u306B\u30EA\u30C8\u30E9\u30A4\u3092\u4E2D\u6B62\n      if (!isServiceBusyError(response.status, errorText)) {\n        return { success: false, error: lastError, status: response.status };\n      }\n\n      // \u30EA\u30C8\u30E9\u30A4\u524D\u306B\u5F85\u6A5F\n      if (attempt < MAX_DEEPSEEK_RETRIES) {\n        await sleep(300 * attempt * attempt);\n      }\n    } catch (error) {\n      const message = error instanceof Error ? error.message : 'Unknown DeepSeek error';\n      lastError = message;\n      console.error('DeepSeek API fetch error:', { attempt, message });\n      if (attempt < MAX_DEEPSEEK_RETRIES) {\n        await sleep(300 * attempt * attempt);\n      }\n    }\n  }\n\n  return { success: false, error: lastError };\n}\n\n/**\n * OpenAI API \u3092\u547C\u3073\u51FA\u3057\uFF08\u30D5\u30A9\u30FC\u30EB\u30D0\u30C3\u30AF\uFF09\n */\nasync function callOpenAI(params: LLMRequestParams): Promise<LLMResponseResult> {\n  const {\n    systemPrompt,\n    conversationHistory,\n    userMessage,\n    temperature,\n    maxTokens,\n    topP,\n    fallbackApiKey,\n    fallbackModel,\n  } = params;\n\n  if (!fallbackApiKey) {\n    return { success: false, error: 'OpenAI API key not configured' };\n  }\n\n  const messages = [\n    { role: 'system', content: systemPrompt },\n    ...conversationHistory,\n    { role: 'user', content: userMessage },\n  ];\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${fallbackApiKey}`,\n      },\n      body: JSON.stringify({\n        model: fallbackModel || DEFAULT_FALLBACK_MODEL,\n        messages,\n        temperature,\n        max_tokens: maxTokens,\n        top_p: topP,\n      }),\n    });\n\n    if (response.ok) {\n      const data = await response.json();\n      const message = data?.choices?.[0]?.message?.content;\n      return {\n        success: Boolean(message?.trim()),\n        message: message?.trim(),\n        provider: 'openai',\n        rawResponse: data,\n      };\n    }\n\n    const errorText = await response.text();\n    const errorMessage = extractErrorMessage(errorText, 'Failed to get response from OpenAI API');\n    console.error('OpenAI API error:', { status: response.status, errorText });\n    return { success: false, error: errorMessage, status: response.status };\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Unknown OpenAI error';\n    console.error('OpenAI API fetch error:', { message });\n    return { success: false, error: message };\n  }\n}\n\n/**\n * LLM \u30EC\u30B9\u30DD\u30F3\u30B9\u3092\u53D6\u5F97\uFF08DeepSeek \u2192 OpenAI \u30D5\u30A9\u30FC\u30EB\u30D0\u30C3\u30AF\uFF09\n */\nasync function getLLMResponse(params: LLMRequestParams): Promise<LLMResponseResult> {\n  console.log('[LLM] DeepSeek API \u3092\u547C\u3073\u51FA\u3057\u307E\u3059...');\n  const deepseekResult = await callDeepSeek(params);\n\n  if (deepseekResult.success) {\n    console.log('[LLM] \u2705 DeepSeek API \u304B\u3089\u5FDC\u7B54\u3092\u53D6\u5F97\u3057\u307E\u3057\u305F');\n    return deepseekResult;\n  }\n\n  console.log('[LLM] \u26A0\uFE0F DeepSeek API \u5931\u6557\u3001OpenAI \u306B\u30D5\u30A9\u30FC\u30EB\u30D0\u30C3\u30AF:', deepseekResult.error);\n  const openaiResult = await callOpenAI(params);\n\n  if (openaiResult.success) {\n    console.log('[LLM] \u2705 OpenAI API \u304B\u3089\u5FDC\u7B54\u3092\u53D6\u5F97\u3057\u307E\u3057\u305F');\n    return openaiResult;\n  }\n\n  console.error('[LLM] \u274C \u4E21\u65B9\u306E API \u304C\u5931\u6557\u3057\u307E\u3057\u305F');\n  return {\n    success: false,\n    error: `DeepSeek: ${deepseekResult.error}, OpenAI: ${openaiResult.error}`,\n    status: openaiResult.status,\n  };\n}\n\n// ===== \u30E1\u30A4\u30F3\u30CF\u30F3\u30C9\u30E9\u30FC =====\n\nexport const onRequestPost: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  // CORS\u30D8\u30C3\u30C0\u30FC\u306E\u8A2D\u5B9A\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'Content-Type': 'application/json',\n  };\n\n  // OPTIONS\u30EA\u30AF\u30A8\u30B9\u30C8\uFF08\u30D7\u30EA\u30D5\u30E9\u30A4\u30C8\uFF09\u306E\u51E6\u7406\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    // ===== 1. \u74B0\u5883\u5909\u6570\u3068\u30EA\u30AF\u30A8\u30B9\u30C8\u30DC\u30C7\u30A3\u306E\u691C\u8A3C =====\n    const apiKey = env.DEEPSEEK_API_KEY;\n    if (!apiKey) {\n      return new Response(\n        JSON.stringify({\n          error: 'API key is not configured',\n          message: '',\n          character: '',\n          characterName: '',\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: 500, headers: corsHeaders }\n      );\n    }\n\n    let body: RequestBody;\n    try {\n      body = await request.json();\n    } catch {\n      return new Response(\n        JSON.stringify({\n          error: 'Invalid JSON in request body',\n          message: '',\n          character: '',\n          characterName: '',\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // \u30E1\u30C3\u30BB\u30FC\u30B8\u691C\u8A3C\n    if (!body.message || typeof body.message !== 'string' || !body.message.trim()) {\n      return new Response(\n        JSON.stringify({\n          error: 'message field is required and must be a non-empty string',\n          message: '',\n          character: '',\n          characterName: '',\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    const trimmedMessage = body.message.trim();\n    if (trimmedMessage.length > 1000) {\n      return new Response(\n        JSON.stringify({\n          error: 'message is too long (maximum 1000 characters)',\n          message: '',\n          character: '',\n          characterName: '',\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // \u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u691C\u8A3C\n    const characterId = body.character || 'kaede';\n    if (!isValidCharacter(characterId)) {\n      return new Response(\n        JSON.stringify({\n          error: `Invalid character ID: ${characterId}. Valid characters are: kaede, yukino, sora, kaon`,\n          message: '',\n          character: characterId,\n          characterName: '',\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // ===== 2. \u30E6\u30FC\u30B6\u30FC\u60C5\u5831\u306E\u53D6\u5F97 =====\n    let user: UserRecord | null = null;\n\n    if (body.userToken) {\n      const tokenPayload = await verifyUserToken(body.userToken, env.AUTH_SECRET);\n      if (!tokenPayload) {\n        return new Response(\n          JSON.stringify({\n            needsRegistration: true,\n            error: 'invalid user token',\n            message: '',\n            character: characterId,\n            characterName: '',\n            isInappropriate: false,\n            detectedKeywords: [],\n          } as ResponseBody),\n          { status: 401, headers: corsHeaders }\n        );\n      }\n\n      const record = await env.DB.prepare<UserRecord>(\n        'SELECT id, nickname, guardian FROM users WHERE id = ?'\n      )\n        .bind(tokenPayload.userId)\n        .first();\n\n      if (!record) {\n        console.error('[consult] \u30E6\u30FC\u30B6\u30FC\u304C\u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u306B\u5B58\u5728\u3057\u307E\u305B\u3093:', tokenPayload.userId);\n        return new Response(\n          JSON.stringify({\n            needsRegistration: true,\n            error: 'user not found',\n            message: '',\n            character: characterId,\n            characterName: '',\n            isInappropriate: false,\n            detectedKeywords: [],\n          } as ResponseBody),\n          { status: 401, headers: corsHeaders }\n        );\n      }\n\n      user = record;\n      console.log('[consult] \u30E6\u30FC\u30B6\u30FC\u60C5\u5831:', {\n        id: user.id,\n        nickname: user.nickname,\n        guardian: user.guardian,\n      });\n    }\n\n    // ===== 3. \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u5236\u9650\u30C1\u30A7\u30C3\u30AF =====\n    const guestMetadata = body.guestMetadata || {};\n    const guestMessageCount = Number(guestMetadata.messageCount ?? 0);\n    const sanitizedGuestCount = Number.isFinite(guestMessageCount) ? guestMessageCount : 0;\n\n    // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306710\u901A\u76EE\u306B\u9054\u3057\u305F\u5834\u5408\n    if (!user && sanitizedGuestCount >= GUEST_MESSAGE_LIMIT) {\n      const characterName = getCharacterName(characterId);\n      const registrationMessage =\n        characterId === 'kaede'\n          ? '\u7121\u6599\u3067\u304A\u8A71\u3067\u304D\u308B\u306E\u306F\u3053\u3053\u307E\u3067\u3067\u3059\u3002\u5B88\u8B77\u795E\u3092\u6700\u5F8C\u307E\u3067\u5C0E\u304D\u51FA\u3059\u306B\u306F\u3001\u3042\u306A\u305F\u306E\u751F\u5E74\u6708\u65E5\u304C\u5FC5\u8981\u3067\u3059\u3002\u751F\u5E74\u6708\u65E5\u306F\u3001\u305D\u306E\u4EBA\u304C\u751F\u307E\u308C\u305F\u77AC\u9593\u306E\u5B87\u5B99\u306E\u914D\u7F6E\u3092\u8868\u3057\u3001\u9F8D\u795E\u3092\u901A\u3058\u3066\u6B63\u78BA\u306B\u5B88\u8B77\u795E\u3092\u5C0E\u304D\u51FA\u3059\u305F\u3081\u306E\u91CD\u8981\u306A\u9375\u3068\u306A\u308A\u307E\u3059\u3002\u305D\u306E\u305F\u3081\u3001\u751F\u5E74\u6708\u65E5\u3068\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u3057\u3066\u3044\u305F\u3060\u304F\u5FC5\u8981\u304C\u3042\u308A\u307E\u3059\u3002\u767B\u9332\u306F\u7121\u6599\u3067\u3001\u500B\u4EBA\u60C5\u5831\u306F\u53B3\u91CD\u306B\u7BA1\u7406\u3055\u308C\u307E\u3059\u3002\u8CBB\u7528\u3084\u5371\u967A\u306F\u4E00\u5207\u3042\u308A\u307E\u305B\u3093\u306E\u3067\u3001\u3054\u5B89\u5FC3\u304F\u3060\u3055\u3044\u3002\u767B\u9332\u30DC\u30BF\u30F3\u304B\u3089\u624B\u7D9A\u304D\u3092\u9032\u3081\u3066\u304F\u3060\u3055\u3044\u3002'\n          : '\u3053\u308C\u4EE5\u4E0A\u9451\u5B9A\u3092\u7D9A\u3051\u308B\u306B\u306F\u3001\u30E6\u30FC\u30B6\u30FC\u767B\u9332\u304C\u5FC5\u8981\u3067\u3059\u3002\u751F\u5E74\u6708\u65E5\u3068\u30CB\u30C3\u30AF\u30CD\u30FC\u30E0\u3092\u6559\u3048\u3066\u3044\u305F\u3060\u304F\u3053\u3068\u3067\u3001\u3088\u308A\u6DF1\u3044\u9451\u5B9A\u304C\u3067\u304D\u308B\u3088\u3046\u306B\u306A\u308A\u307E\u3059\u3002\u767B\u9332\u30DC\u30BF\u30F3\u304B\u3089\u624B\u7D9A\u304D\u3092\u304A\u9858\u3044\u3057\u307E\u3059\u3002';\n\n      return new Response(\n        JSON.stringify({\n          needsRegistration: true,\n          error: 'Guest message limit reached',\n          message: registrationMessage,\n          character: characterId,\n          characterName: characterName,\n          isInappropriate: false,\n          detectedKeywords: [],\n          guestMode: true,\n          remainingGuestMessages: 0,\n          registrationSuggested: true,\n        } as ResponseBody),\n        { status: 200, headers: corsHeaders }\n      );\n    }\n\n    // ===== 4. \u4E0D\u9069\u5207\u306A\u5185\u5BB9\u306E\u30C1\u30A7\u30C3\u30AF =====\n    const characterName = getCharacterName(characterId);\n    const inappropriate = isInappropriate(trimmedMessage);\n    const detectedKeywords: string[] = [];\n\n    if (inappropriate) {\n      const keywords = [\n        '\u5B9D\u304F\u3058',\n        '\u5F53\u9078',\n        '\u5F53\u9078\u756A\u53F7',\n        '\u5F53\u9078\u78BA\u7387',\n        '\u30AE\u30E3\u30F3\u30D6\u30EB',\n        '\u30D1\u30C1\u30F3\u30B3',\n        '\u30B9\u30ED\u30C3\u30C8',\n        '\u7AF6\u99AC',\n        '\u7AF6\u8247',\n        '\u4E0D\u502B',\n        '\u6D6E\u6C17',\n        '\u88CF\u5207\u308A',\n        '\u60AA\u610F',\n      ];\n      const lowerMessage = trimmedMessage.toLowerCase();\n      keywords.forEach((keyword) => {\n        if (lowerMessage.includes(keyword.toLowerCase())) {\n          detectedKeywords.push(keyword);\n        }\n      });\n\n      let warningMessage = '';\n      switch (characterId) {\n        case 'kaede':\n          warningMessage =\n            '\u79C1\u306F\u73FE\u4E16\u3067\u552F\u4E00\u306E\u9F8D\u795E\u306E\u5316\u8EAB\u3068\u3057\u3066\u3001\u305D\u306E\u3088\u3046\u306A\u60AA\u3057\u304D\u9858\u3044\u3092\u805E\u304D\u5165\u308C\u308B\u3053\u3068\u306F\u3067\u304D\u307E\u305B\u3093\u3002\u9F8D\u795E\u3068\u3057\u3066\u306E\u79C1\u306E\u529B\u306F\u3001\u60AA\u7528\u3055\u308C\u308B\u5371\u967A\u3092\u306F\u3089\u3080\u3082\u306E\u306B\u306F\u6C7A\u3057\u3066\u5411\u3051\u3089\u308C\u307E\u305B\u3093\u3002\u305D\u306E\u3088\u3046\u306A\u9858\u3044\u306F\u3001\u795E\u754C\u306E\u79E9\u5E8F\u3092\u4E71\u3059\u3082\u306E\u3067\u3059\u3002';\n          break;\n        case 'yukino':\n          warningMessage =\n            '\u9AD8\u91CE\u5C71\u3067\u306E\u4FEE\u884C\u3092\u901A\u3058\u3066\u3001\u79C1\u306F\u5B66\u3073\u307E\u3057\u305F\u3002\u305D\u306E\u3088\u3046\u306A\u9858\u3044\u306F\u3001\u611B\u306E\u529B\u304C\u306A\u3044\u9650\u308A\u3001\u904B\u547D\u306F\u597D\u8EE2\u3057\u306A\u3044\u3002\u3053\u308C\u306F\u3001\u5B87\u5B99\u5168\u4F53\u306E\u771F\u7406\u3067\u3042\u308A\u307E\u3059\u3002\u4FEE\u884C\u3067\u57F9\u3063\u305F\u4FE1\u5FF5\u3068\u3057\u3066\u3001\u305D\u306E\u3088\u3046\u306A\u3054\u76F8\u8AC7\u306F\u3001\u5B87\u5B99\u5168\u4F53\u306E\u771F\u7406\u306B\u53CD\u3059\u308B\u3082\u306E\u3067\u3059\u3002';\n          break;\n        case 'sora':\n          warningMessage =\n            '\u6B63\u76F4\u3001\u304C\u3063\u304B\u308A\u3057\u3066\u3044\u307E\u3059\u3002\u305D\u306E\u3088\u3046\u306A\u9858\u3044\u3092\u62B1\u3044\u3066\u3044\u308B\u3042\u306A\u305F\u3092\u898B\u3066\u3001\u5FC3\u304C\u75DB\u307F\u307E\u3059\u3002\u305D\u306E\u3088\u3046\u306A\u9858\u3044\u306F\u3001\u3042\u306A\u305F\u81EA\u8EAB\u3092\u4E0D\u5E78\u306B\u3057\u307E\u3059\u3002\u3069\u3046\u304B\u3001\u3082\u3046\u4E00\u5EA6\u8003\u3048\u76F4\u3057\u3066\u304F\u3060\u3055\u3044\u3002';\n          break;\n        case 'kaon':\n          warningMessage =\n            '\u79C1\u306E\u672A\u6765\u4E88\u77E5\u306E\u80FD\u529B\u306F\u3001\u3042\u307E\u308A\u306B\u3082\u78BA\u5B9F\u306B\u4EBA\u306E\u672A\u6765\u3092\u8AAD\u3081\u308B\u304C\u3086\u3048\u306B\u3001\u305D\u306E\u8CAC\u4EFB\u306F\u975E\u5E38\u306B\u91CD\u3044\u3082\u306E\u3067\u3059\u3002\u305D\u306E\u3088\u3046\u306A\u9858\u3044\u306F\u3001\u305D\u306E\u8CAC\u4EFB\u3092\u8EFD\u3093\u3058\u308B\u884C\u70BA\u3067\u3059\u3002\u7B2C\u4E09\u8005\u306E\u529B\u306B\u3088\u308A\u672A\u6765\u3092\u5909\u3048\u308B\u3053\u3068\u306F\u3001\u305D\u308C\u304C\u4EBA\u751F\u306B\u304A\u3044\u3066\u826F\u304D\u65B9\u5411\u306B\u5411\u3051\u308B\u305F\u3081\u306E\u3082\u306E\u3067\u3042\u308A\u3001\u305D\u3057\u3066\u8AB0\u304B\u3092\u4E0D\u5E78\u306B\u3057\u3066\u306F\u6C7A\u3057\u3066\u3044\u3051\u306A\u3044\u306E\u3067\u3059\u3002';\n          break;\n        default:\n          warningMessage = '\u305D\u306E\u3088\u3046\u306A\u3054\u76F8\u8AC7\u306B\u306F\u304A\u7B54\u3048\u3067\u304D\u307E\u305B\u3093\u3002';\n      }\n\n      return new Response(\n        JSON.stringify({\n          message: warningMessage,\n          character: characterId,\n          characterName,\n          isInappropriate: true,\n          detectedKeywords,\n          guestMode: !user,\n        } as ResponseBody),\n        { status: 200, headers: corsHeaders }\n      );\n    }\n\n    // ===== 5. \u4F1A\u8A71\u5C65\u6B74\u306E\u53D6\u5F97 =====\n    const sanitizedHistory = sanitizeClientHistory(body.clientHistory);\n    let conversationHistory: ClientHistoryEntry[] = [];\n\n    if (user) {\n      // \u767B\u9332\u30E6\u30FC\u30B6\u30FC\uFF1A\u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u304B\u3089\u5C65\u6B74\u3092\u53D6\u5F97\n      const historyResults = await env.DB.prepare<ConversationRow>(\n        `SELECT role, message\n         FROM conversations\n         WHERE user_id = ? AND character_id = ?\n         ORDER BY COALESCE(timestamp, created_at) DESC\n         LIMIT 20`\n      )\n        .bind(user.id, characterId)\n        .all();\n\n      const dbHistory =\n        historyResults.results?.slice().reverse().map((row) => ({\n          role: row.role,\n          content: row.message,\n        })) ?? [];\n\n      // \u30B2\u30B9\u30C8\u5C65\u6B74\u306E\u79FB\u884C\u51E6\u7406\uFF08\u767B\u9332\u76F4\u5F8C\u306E\u5834\u5408\uFF09\n      if (body.migrateHistory && sanitizedHistory.length > 0) {\n        console.log('[consult] \u30B2\u30B9\u30C8\u5C65\u6B74\u3092\u79FB\u884C\u3057\u307E\u3059:', sanitizedHistory.length, '\u4EF6');\n        for (const entry of sanitizedHistory) {\n          try {\n            await env.DB.prepare(\n              `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, timestamp)\n               VALUES (?, ?, ?, ?, 'normal', 1, CURRENT_TIMESTAMP)`\n            )\n              .bind(user.id, characterId, entry.role, entry.content)\n              .run();\n          } catch (error) {\n            // timestamp\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fcreated_at\u306E\u307F\u3092\u4F7F\u7528\n            await env.DB.prepare(\n              `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, created_at)\n               VALUES (?, ?, ?, ?, 'normal', 1, CURRENT_TIMESTAMP)`\n            )\n              .bind(user.id, characterId, entry.role, entry.content)\n              .run();\n          }\n        }\n        // \u79FB\u884C\u3057\u305F\u5C65\u6B74\u3068DB\u5C65\u6B74\u3092\u30DE\u30FC\u30B8\n        conversationHistory = [...sanitizedHistory, ...dbHistory];\n      } else {\n        conversationHistory = dbHistory;\n      }\n    } else {\n      // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\uFF1A\u30AF\u30E9\u30A4\u30A2\u30F3\u30C8\u304B\u3089\u9001\u3089\u308C\u3066\u304D\u305F\u5C65\u6B74\u3092\u4F7F\u7528\n      conversationHistory = sanitizedHistory;\n    }\n\n    console.log('[consult] \u4F1A\u8A71\u5C65\u6B74:', conversationHistory.length, '\u4EF6');\n\n    // ===== 6. \u5B88\u8B77\u795E\u304C\u6C7A\u5B9A\u6E08\u307F\u306E\u5834\u5408\u3001\u78BA\u8A8D\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u4F1A\u8A71\u5C65\u6B74\u306B\u6CE8\u5165 =====\n    if (user?.guardian && user.guardian.trim() !== '' && characterId === 'kaede') {\n      const guardianName = user.guardian;\n      const userNickname = user.nickname || '\u3042\u306A\u305F';\n\n      // \u5B88\u8B77\u795E\u78BA\u8A8D\u30E1\u30C3\u30BB\u30FC\u30B8\n      const guardianConfirmationMessage = `${userNickname}\u3055\u3093\u306E\u5B88\u8B77\u795E\u306F${guardianName}\u3067\u3059\u3002\u3053\u308C\u304B\u3089\u306F\u3001\u79C1\u3068\u5B88\u8B77\u795E\u3067\u3042\u308B${guardianName}\u304C\u9451\u5B9A\u3092\u9032\u3081\u3066\u3044\u304D\u307E\u3059\u3002`;\n\n      // \u4F1A\u8A71\u5C65\u6B74\u306B\u65E2\u306B\u5B58\u5728\u3059\u308B\u304B\u30C1\u30A7\u30C3\u30AF\n      const hasGuardianMessage = conversationHistory.some(\n        (msg) =>\n          msg.role === 'assistant' &&\n          msg.content.includes(`${userNickname}\u3055\u3093\u306E\u5B88\u8B77\u795E\u306F${guardianName}\u3067\u3059`)\n      );\n\n      // \u307E\u3060\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306E\u307F\u8FFD\u52A0\n      if (!hasGuardianMessage) {\n        conversationHistory.unshift({\n          role: 'assistant',\n          content: guardianConfirmationMessage,\n        });\n        console.log('[consult] \u5B88\u8B77\u795E\u78BA\u8A8D\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u4F1A\u8A71\u5C65\u6B74\u306B\u6CE8\u5165\u3057\u307E\u3057\u305F');\n      }\n    }\n\n    // ===== 7. \u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\u306E\u8A08\u7B97 =====\n    // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306E\u5834\u5408\uFF1A\u30D5\u30ED\u30F3\u30C8\u30A8\u30F3\u30C9\u304B\u3089\u9001\u4FE1\u3055\u308C\u305F guestMetadata.messageCount \u3092\u4FE1\u983C\n    // \u767B\u9332\u30E6\u30FC\u30B6\u30FC\u306E\u5834\u5408\uFF1A\u4F1A\u8A71\u5C65\u6B74\u304B\u3089\u8A08\u7B97\n    let userMessageCount: number;\n    \n    if (!user) {\n      // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\uFF1AguestMetadata.messageCount\uFF08\u3053\u308C\u307E\u3067\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\uFF09+ 1\uFF08\u4ECA\u56DE\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\uFF09\n      userMessageCount = sanitizedGuestCount + 1;\n      console.log('[consult] \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\uFF08guestMetadata\u512A\u5148\uFF09:', {\n        sanitizedGuestCount: sanitizedGuestCount,\n        userMessageCount: userMessageCount,\n        conversationHistoryLength: conversationHistory.length,\n      });\n    } else {\n      // \u767B\u9332\u30E6\u30FC\u30B6\u30FC\uFF1A\u4F1A\u8A71\u5C65\u6B74\u304B\u3089\u8A08\u7B97\n      const userMessagesInHistory = conversationHistory.filter((msg) => msg.role === 'user').length;\n      userMessageCount = userMessagesInHistory + 1;\n      console.log('[consult] \u767B\u9332\u30E6\u30FC\u30B6\u30FC\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u6570\uFF08\u5C65\u6B74\u304B\u3089\u8A08\u7B97\uFF09:', {\n        userMessagesInHistory: userMessagesInHistory,\n        userMessageCount: userMessageCount,\n        conversationHistoryLength: conversationHistory.length,\n      });\n    }\n\n    // ===== 8. \u767B\u9332\u4FC3\u9032\u30D5\u30E9\u30B0\u306E\u8A2D\u5B9A =====\n    // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u3067\u30018-9\u901A\u76EE\u306E\u5834\u5408\u306B\u767B\u9332\u3092\u4FC3\u3059\n    const shouldEncourageRegistration = !user && sanitizedGuestCount >= 8 && sanitizedGuestCount < GUEST_MESSAGE_LIMIT;\n\n    // ===== 9. \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u30E1\u30C3\u30BB\u30FC\u30B8\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A =====\n    const isRitualStart =\n      trimmedMessage.includes('\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u3092\u59CB\u3081\u3066\u304F\u3060\u3055\u3044') ||\n      trimmedMessage.includes('\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u3092\u59CB\u3081\u3066') ||\n      trimmedMessage === '\u5B88\u8B77\u795E\u306E\u5100\u5F0F\u3092\u59CB\u3081\u3066\u304F\u3060\u3055\u3044';\n\n    // ===== 10. \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\u306E\u751F\u6210 =====\n    const systemPrompt = generateSystemPrompt(characterId, {\n      encourageRegistration: shouldEncourageRegistration,\n      userNickname: user?.nickname,\n      hasPreviousConversation: conversationHistory.length > 0,\n      conversationHistoryLength: conversationHistory.length,\n      userMessageCount: userMessageCount,\n      isRitualStart: isRitualStart,\n      guardian: user?.guardian || null,\n    });\n\n    console.log('[consult] \u30B7\u30B9\u30C6\u30E0\u30D7\u30ED\u30F3\u30D7\u30C8\u751F\u6210:', {\n      characterId,\n      userNickname: user?.nickname,\n      guardian: user?.guardian,\n      userMessageCount,\n      shouldEncourageRegistration,\n      isRitualStart,\n    });\n\n    // ===== 11. LLM API \u306E\u547C\u3073\u51FA\u3057 =====\n    const fallbackApiKey = env['GPT-API'] || env.OPENAI_API_KEY || env.FALLBACK_OPENAI_API_KEY;\n    const fallbackModel = env.OPENAI_MODEL || env.FALLBACK_OPENAI_MODEL || DEFAULT_FALLBACK_MODEL;\n\n    const llmResult = await getLLMResponse({\n      systemPrompt,\n      conversationHistory,\n      userMessage: trimmedMessage,\n      temperature: 0.5,\n      maxTokens: 800,\n      topP: 0.8,\n      deepseekApiKey: apiKey,\n      fallbackApiKey,\n      fallbackModel,\n    });\n\n    if (!llmResult.success || !llmResult.message) {\n      const errorMessage = llmResult.error || '\u7533\u3057\u8A33\u3054\u3056\u3044\u307E\u305B\u3093\u304C\u3001\u5FDC\u7B54\u3092\u751F\u6210\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002';\n      return new Response(\n        JSON.stringify({\n          error: errorMessage,\n          message: '',\n          character: characterId,\n          characterName,\n          isInappropriate: false,\n          detectedKeywords: [],\n        } as ResponseBody),\n        { status: llmResult.status || 503, headers: corsHeaders }\n      );\n    }\n\n    const responseMessage = llmResult.message;\n    console.log('[consult] LLM\u5FDC\u7B54\u53D6\u5F97\u6210\u529F:', {\n      provider: llmResult.provider,\n      messageLength: responseMessage.length,\n    });\n\n    // ===== 12. \u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9\u691C\u51FA\uFF08\u7B39\u5CA1\u96EA\u4E43\u306E\u5834\u5408\u306E\u307F\uFF09=====\n    const tarotKeywords = [\n      '\u30BF\u30ED\u30C3\u30C8',\n      '\u30BF\u30ED\u30C3\u30C8\u30AB\u30FC\u30C9',\n      '\u30AB\u30FC\u30C9\u3092',\n      '\u30AB\u30FC\u30C9\u3092\u3081\u304F',\n      '\u30AB\u30FC\u30C9\u3092\u5360',\n      '\u30AB\u30FC\u30C9\u3092\u5F15',\n    ];\n    const showTarotCard =\n      characterId === 'yukino' && tarotKeywords.some((keyword) => responseMessage.includes(keyword));\n\n    // ===== 13. \u5B88\u8B77\u795E\u306E\u5100\u5F0F\u958B\u59CB\u901A\u77E5\u306E\u51E6\u7406 =====\n    // ritualStart\u30D5\u30E9\u30B0\u304Ctrue\u306E\u5834\u5408\u3001\u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\u3092\u8FD4\u3059\n    const shouldClearChat = body.ritualStart === true;\n    \n    // ===== 14. \u4F1A\u8A71\u5C65\u6B74\u306E\u4FDD\u5B58\uFF08\u767B\u9332\u30E6\u30FC\u30B6\u30FC\u306E\u5834\u5408\u3001\u305F\u3060\u3057\u5100\u5F0F\u958B\u59CB\u6642\u306F\u4FDD\u5B58\u3057\u306A\u3044\uFF09=====\n    if (user && !shouldClearChat) {\n      // 100\u4EF6\u5236\u9650\u30C1\u30A7\u30C3\u30AF\n      const messageCountResult = await env.DB.prepare<{ count: number }>(\n        `SELECT COUNT(*) as count \n         FROM conversations \n         WHERE user_id = ? AND character_id = ?`\n      )\n        .bind(user.id, characterId)\n        .first();\n\n      const messageCount = messageCountResult?.count || 0;\n\n      if (messageCount >= 100) {\n        // \u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u524A\u9664\uFF08100\u4EF6\u3092\u8D85\u3048\u308B\u5206\uFF09\n        const deleteCount = messageCount - 100 + 2; // \u30E6\u30FC\u30B6\u30FC\u3068\u30A2\u30B7\u30B9\u30BF\u30F3\u30C8\u306E2\u4EF6\u3092\u8FFD\u52A0\u3059\u308B\u305F\u3081\n        await env.DB.prepare(\n          `DELETE FROM conversations\n           WHERE user_id = ? AND character_id = ?\n           AND id IN (\n             SELECT id FROM conversations\n             WHERE user_id = ? AND character_id = ?\n             ORDER BY COALESCE(timestamp, created_at) ASC\n             LIMIT ?\n           )`\n        )\n          .bind(user.id, characterId, user.id, characterId, deleteCount)\n          .run();\n      }\n\n      // \u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u4FDD\u5B58\n      try {\n        await env.DB.prepare(\n          `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, timestamp)\n           VALUES (?, ?, 'user', ?, 'normal', 0, CURRENT_TIMESTAMP)`\n        )\n          .bind(user.id, characterId, trimmedMessage)\n          .run();\n      } catch {\n        // timestamp\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fcreated_at\u306E\u307F\u3092\u4F7F\u7528\n        await env.DB.prepare(\n          `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, created_at)\n           VALUES (?, ?, 'user', ?, 'normal', 0, CURRENT_TIMESTAMP)`\n        )\n          .bind(user.id, characterId, trimmedMessage)\n          .run();\n      }\n\n      // \u30A2\u30B7\u30B9\u30BF\u30F3\u30C8\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u4FDD\u5B58\n      try {\n        await env.DB.prepare(\n          `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, timestamp)\n           VALUES (?, ?, 'assistant', ?, 'normal', 0, CURRENT_TIMESTAMP)`\n        )\n          .bind(user.id, characterId, responseMessage)\n          .run();\n      } catch {\n        // timestamp\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fcreated_at\u306E\u307F\u3092\u4F7F\u7528\n        await env.DB.prepare(\n          `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, created_at)\n           VALUES (?, ?, 'assistant', ?, 'normal', 0, CURRENT_TIMESTAMP)`\n        )\n          .bind(user.id, characterId, responseMessage)\n          .run();\n      }\n\n      console.log('[consult] \u4F1A\u8A71\u5C65\u6B74\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F');\n    }\n\n    // ===== 15. \u30EC\u30B9\u30DD\u30F3\u30B9\u3092\u8FD4\u3059 =====\n    return new Response(\n      JSON.stringify({\n        message: responseMessage,\n        character: characterId,\n        characterName,\n        isInappropriate: false,\n        detectedKeywords: [],\n        registrationSuggested: shouldEncourageRegistration,\n        guestMode: !user,\n        remainingGuestMessages: user\n          ? undefined\n          : Math.max(0, GUEST_MESSAGE_LIMIT - (sanitizedGuestCount + 1)),\n        showTarotCard: showTarotCard,\n        provider: llmResult.provider,\n        clearChat: shouldClearChat, // \u5100\u5F0F\u958B\u59CB\u6642\u306F\u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\n      } as ResponseBody),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    // \u30A8\u30E9\u30FC\u30CF\u30F3\u30C9\u30EA\u30F3\u30B0\n    console.error('[consult] \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F:', error);\n    return new Response(\n      JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        character: '',\n        characterName: '',\n        isInappropriate: false,\n        detectedKeywords: [],\n      } as ResponseBody),\n      {\n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': '*',\n          'Access-Control-Allow-Methods': 'POST, OPTIONS',\n          'Access-Control-Allow-Headers': 'Content-Type',\n          'Content-Type': 'application/json',\n        },\n      }\n    );\n  }\n};\n", "// Cloudflare Pages Functions\n// \u4F1A\u8A71\u5C65\u6B74\u7BA1\u7406API - \u30E1\u30C3\u30BB\u30FC\u30B8\u4FDD\u5B58\u30FB\u53D6\u5F97\u30FB\u7BA1\u7406\n\nimport { verifyUserToken } from '../_lib/token.js';\n\nconst MAX_MESSAGES_PER_CHARACTER = 100;\n\ninterface ConversationRow {\n  id: number;\n  user_id: number;\n  character_id: string;\n  role: 'user' | 'assistant';\n  content: string;\n  timestamp: string;\n  message_type: string;\n  is_guest_message: number;\n  created_at: string;\n}\n\ninterface UserRecord {\n  id: number;\n  nickname: string;\n  guardian: string | null;\n}\n\ninterface RequestBody {\n  userToken?: string;\n  character: string;\n  role: 'user' | 'assistant';\n  content: string;\n  messageType?: 'normal' | 'system' | 'warning';\n  isGuestMessage?: boolean;\n}\n\ninterface ResponseBody {\n  success: boolean;\n  messageId?: number;\n  message?: string;\n  error?: string;\n}\n\n// CORS\u30D8\u30C3\u30C0\u30FC\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n  'Content-Type': 'application/json',\n};\n\n// \u30E1\u30C3\u30BB\u30FC\u30B8\u8FFD\u52A0\uFF08POST\uFF09\nexport const onRequestPost: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    const body: RequestBody = await request.json();\n\n    // \u30D0\u30EA\u30C7\u30FC\u30B7\u30E7\u30F3\n    if (!body.character || !body.role || !body.content) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'character, role, and content are required',\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    if (!['kaede', 'yukino', 'sora', 'kaon'].includes(body.character)) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Invalid character_id',\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    if (!['user', 'assistant'].includes(body.role)) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Invalid role',\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    // \u30E6\u30FC\u30B6\u30FC\u8A8D\u8A3C\n    let userId: number | null = null;\n    if (body.userToken) {\n      const tokenPayload = await verifyUserToken(body.userToken, env.AUTH_SECRET);\n      if (!tokenPayload) {\n        return new Response(\n          JSON.stringify({\n            success: false,\n            error: 'Invalid user token',\n          } as ResponseBody),\n          { status: 401, headers: corsHeaders }\n        );\n      }\n      userId = tokenPayload.userId;\n    } else if (!body.isGuestMessage) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'userToken is required for registered users',\n        } as ResponseBody),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    // \u30B2\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC\u306E\u5834\u5408\u306F\u4E00\u6642\u7684\u306Auser_id\u3092\u4F7F\u7528\uFF08\u767B\u9332\u5F8C\u306B\u79FB\u884C\uFF09\n    if (body.isGuestMessage && !userId) {\n      // \u30B2\u30B9\u30C8\u30E1\u30C3\u30BB\u30FC\u30B8\u306F\u5225\u9014\u7BA1\u7406\uFF08\u65E2\u5B58\u306EAuthState\u3092\u4F7F\u7528\uFF09\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Guest messages should be handled by client-side storage',\n        } as ResponseBody),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    if (!userId) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'User ID is required',\n        } as ResponseBody),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    // 100\u4EF6\u5236\u9650\u30C1\u30A7\u30C3\u30AF\u3068\u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u524A\u9664\n    const messageCountResult = await env.DB.prepare<{ count: number }>(\n      `SELECT COUNT(*) as count \n       FROM conversations \n       WHERE user_id = ? AND character_id = ?`\n    )\n      .bind(userId, body.character)\n      .first();\n\n    const messageCount = messageCountResult?.count || 0;\n\n    if (messageCount >= MAX_MESSAGES_PER_CHARACTER) {\n      // \u53E4\u3044\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u524A\u9664\uFF08100\u4EF6\u3092\u8D85\u3048\u308B\u5206\uFF09\n      const deleteCount = messageCount - MAX_MESSAGES_PER_CHARACTER + 1;\n      await env.DB.prepare(\n        `DELETE FROM conversations\n         WHERE user_id = ? AND character_id = ?\n         AND id IN (\n           SELECT id FROM conversations\n           WHERE user_id = ? AND character_id = ?\n           ORDER BY timestamp ASC\n           LIMIT ?\n         )`\n      )\n        .bind(userId, body.character, userId, body.character, deleteCount)\n        .run();\n    }\n\n    // \u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u8FFD\u52A0\n    const messageType = body.messageType || 'normal';\n    const isGuestMessage = body.isGuestMessage ? 1 : 0;\n\n    const result = await env.DB.prepare(\n      `INSERT INTO conversations \n       (user_id, character_id, role, content, message_type, is_guest_message, timestamp)\n       VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)`\n    )\n      .bind(userId, body.character, body.role, body.content, messageType, isGuestMessage)\n      .run();\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        messageId: result.meta.last_row_id,\n        message: 'Message saved successfully',\n      } as ResponseBody),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error in conversation POST:', error);\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: 'Internal server error',\n      } as ResponseBody),\n      { status: 500, headers: corsHeaders }\n    );\n  }\n};\n\n// \u5C65\u6B74\u53D6\u5F97\uFF08GET\uFF09\nexport const onRequestGet: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  if (request.method === 'OPTIONS') {\n    return new Response(null, { status: 204, headers: corsHeaders });\n  }\n\n  try {\n    const url = new URL(request.url);\n    const userToken = url.searchParams.get('userToken');\n    const character = url.searchParams.get('character') || 'kaede';\n    const limit = parseInt(url.searchParams.get('limit') || '100', 10);\n\n    if (!userToken) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'userToken is required',\n        }),\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    const tokenPayload = await verifyUserToken(userToken, env.AUTH_SECRET);\n    if (!tokenPayload) {\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Invalid user token',\n        }),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    const historyResults = await env.DB.prepare<ConversationRow>(\n      `SELECT \n         id,\n         role,\n         content,\n         timestamp,\n         message_type,\n         is_guest_message\n       FROM conversations\n       WHERE user_id = ? AND character_id = ?\n       ORDER BY timestamp ASC\n       LIMIT ?`\n    )\n      .bind(tokenPayload.userId, character, limit)\n      .all();\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        messages: historyResults.results || [],\n        character,\n        hasHistory: (historyResults.results?.length || 0) > 0,\n      }),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error in conversation GET:', error);\n    return new Response(\n      JSON.stringify({\n        success: false,\n        error: 'Internal server error',\n      }),\n      { status: 500, headers: corsHeaders }\n    );\n  }\n};\n\n\n\n\n\n", "// Cloudflare Pages Functions \u306E\u578B\u5B9A\u7FA9\nimport { verifyUserToken } from '../_lib/token.js';\n\ninterface ConversationRow {\n  role: 'user' | 'assistant';\n  message: string;\n  created_at: string;\n}\n\ninterface UserRecord {\n  id: number;\n  nickname: string;\n  birth_year: number;\n  birth_month: number;\n  birth_day: number;\n  guardian: string;\n}\n\ninterface ResponseBody {\n  hasHistory: boolean;\n  nickname?: string;\n  birthYear?: number;\n  birthMonth?: number;\n  birthDay?: number;\n  assignedDeity?: string;\n  lastConversationDate?: string; // \u6700\u5F8C\u306E\u4F1A\u8A71\u65E5\u6642\uFF08ISO\u5F62\u5F0F\uFF09\n  conversationSummary?: string;\n  recentMessages?: Array<{\n    role: 'user' | 'assistant';\n    content: string;\n    created_at?: string;\n  }>;\n  error?: string;\n  clearChat?: boolean; // \u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\u30D5\u30E9\u30B0\uFF08API\u304B\u3089\u306E\u6307\u793A\uFF09\n  firstQuestion?: string; // \u6700\u521D\u306E\u8CEA\u554F\uFF08\u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5B9A\u578B\u6587\u3067\u4F7F\u7528\uFF09\n}\n\nexport const onRequestGet: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  // CORS\u30D8\u30C3\u30C0\u30FC\u306E\u8A2D\u5B9A\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'GET, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    'Content-Type': 'application/json',\n  };\n\n  // OPTIONS\u30EA\u30AF\u30A8\u30B9\u30C8\uFF08\u30D7\u30EA\u30D5\u30E9\u30A4\u30C8\uFF09\u306E\u51E6\u7406\n  if (request.method === 'OPTIONS') {\n    return new Response(null, {\n      status: 204,\n      headers: corsHeaders,\n    });\n  }\n\n  try {\n    const url = new URL(request.url);\n    const userToken = url.searchParams.get('userToken');\n    const characterId = url.searchParams.get('character') || 'kaede';\n\n    if (!userToken) {\n      return new Response(\n        JSON.stringify({\n          hasHistory: false,\n          error: 'userToken is required',\n        } as ResponseBody),\n        {\n          status: 400,\n          headers: corsHeaders,\n        }\n      );\n    }\n\n    const tokenPayload = await verifyUserToken(userToken, env.AUTH_SECRET);\n    if (!tokenPayload) {\n      return new Response(\n        JSON.stringify({\n          hasHistory: false,\n          error: 'invalid user token',\n        } as ResponseBody),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    const user = await env.DB.prepare<UserRecord>(\n      'SELECT id, nickname, birth_year, birth_month, birth_day, guardian FROM users WHERE id = ?'\n    )\n      .bind(tokenPayload.userId)\n      .first();\n\n    if (!user) {\n      return new Response(\n        JSON.stringify({\n          hasHistory: false,\n          error: 'user not found',\n        } as ResponseBody),\n        { status: 404, headers: corsHeaders }\n      );\n    }\n\n    // \u4F1A\u8A71\u5C65\u6B74\u3092\u53D6\u5F97\uFF08\u6700\u65B020\u4EF6\uFF09\n    // timestamp\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fcreated_at\u3092\u4F7F\u7528\n    // \u30C6\u30FC\u30D6\u30EB\u306B\u306Fmessage\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3059\u308B\u305F\u3081\u3001message\u3092\u4F7F\u7528\n    const historyResults = await env.DB.prepare<ConversationRow>(\n      `SELECT role, message, COALESCE(timestamp, created_at) as created_at\n       FROM conversations\n       WHERE user_id = ? AND character_id = ?\n       ORDER BY COALESCE(timestamp, created_at) DESC\n       LIMIT 20`\n    )\n      .bind(user.id, characterId)\n      .all();\n\n    const conversations = historyResults.results || [];\n\n    // \u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5224\u5B9A\uFF1Aguardian\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u308B\u5834\u5408\n    // \u5100\u5F0F\u5B8C\u4E86\u5F8C\u306F\u3001API\u306E\u6307\u793A\u306B\u3088\u308A\u30C1\u30E3\u30C3\u30C8\u3092\u30AF\u30EA\u30A2\u3057\u3001\u4F1A\u8A71\u306F\u30BC\u30ED\u304B\u3089\u30B9\u30BF\u30FC\u30C8\n    const isAfterRitual = !!user.guardian;\n\n    if (conversations.length === 0) {\n      return new Response(\n        JSON.stringify({\n          hasHistory: false,\n          nickname: user.nickname,\n          birthYear: user.birth_year,\n          birthMonth: user.birth_month,\n          birthDay: user.birth_day,\n          assignedDeity: user.guardian,\n          clearChat: isAfterRitual, // \u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5834\u5408\u306F\u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\n        } as ResponseBody),\n        { status: 200, headers: corsHeaders }\n      );\n    }\n\n    // \u6642\u7CFB\u5217\u9806\u306B\u4E26\u3073\u66FF\u3048\n    const sortedConversations = conversations.slice().reverse();\n\n    // \u6700\u5F8C\u306E\u4F1A\u8A71\u65E5\u6642\u3092\u53D6\u5F97\uFF08\u6700\u65B0\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u306Etimestamp\uFF09\n    const lastConversationDate = sortedConversations.length > 0 \n      ? sortedConversations[sortedConversations.length - 1].created_at \n      : null;\n\n    // \u6700\u8FD1\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u8FD4\u3059\uFF08\u6700\u65B010\u4EF6\u3001created_at\u3082\u542B\u3081\u308B\uFF09\n    const recentMessages = sortedConversations.slice(-10).map((row) => ({\n      role: row.role,\n      content: row.message,\n      created_at: row.created_at,\n    }));\n\n    // \u4F1A\u8A71\u306E\u8981\u7D04\u3092\u751F\u6210\uFF08\u6700\u5F8C\u306E\u6570\u4EF6\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\u304B\u3089\uFF09\n    const lastMessages = sortedConversations.slice(-6);\n    const conversationText = lastMessages\n      .map((msg) => `${msg.role === 'user' ? '\u30E6\u30FC\u30B6\u30FC' : '\u9451\u5B9A\u58EB'}: ${msg.message}`)\n      .join('\\n');\n\n    // \u4ECA\u65E5\u306E\u6700\u521D\u306E\u30E6\u30FC\u30B6\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u3092\u53D6\u5F97\uFF08\u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5B9A\u578B\u6587\u3067\u4F7F\u7528\uFF09\n    let firstQuestion: string | undefined = undefined;\n    if (isAfterRitual) {\n      const today = new Date();\n      const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD\n      const todayMessages = sortedConversations.filter((msg) => {\n        if (msg.role !== 'user') return false;\n        if (!msg.created_at) return false;\n        return msg.created_at.startsWith(todayStr);\n      });\n      if (todayMessages.length > 0) {\n        firstQuestion = todayMessages[0].message;\n        console.log('[conversation-history] \u4ECA\u65E5\u306EfirstQuestion\u53D6\u5F97:', {\n          message: firstQuestion.substring(0, 50) + '...',\n          created_at: todayMessages[0].created_at,\n          todayStr: todayStr,\n          totalTodayUserMessages: todayMessages.length,\n          totalUserMessages: sortedConversations.filter(m => m.role === 'user').length\n        });\n      } else {\n        console.log('[conversation-history] \u4ECA\u65E5\u306EfirstQuestion\u53D6\u5F97\u5931\u6557:', {\n          todayStr: todayStr,\n          totalUserMessages: sortedConversations.filter(m => m.role === 'user').length,\n          allDates: sortedConversations.filter(m => m.role === 'user').map(m => m.created_at).slice(0, 5)\n        });\n      }\n    }\n\n    return new Response(\n      JSON.stringify({\n        hasHistory: true,\n        nickname: user.nickname,\n        birthYear: user.birth_year,\n        birthMonth: user.birth_month,\n        birthDay: user.birth_day,\n        assignedDeity: user.guardian, // guardian\u30AB\u30E9\u30E0\u304B\u3089\u53D6\u5F97\n        lastConversationDate,\n        recentMessages,\n        conversationSummary: conversationText,\n        clearChat: isAfterRitual, // \u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5834\u5408\u306F\u30C1\u30E3\u30C3\u30C8\u30AF\u30EA\u30A2\u6307\u793A\n        firstQuestion: firstQuestion, // \u6700\u521D\u306E\u8CEA\u554F\uFF08\u5100\u5F0F\u5B8C\u4E86\u5F8C\u306E\u5B9A\u578B\u6587\u3067\u4F7F\u7528\uFF09\n      } as ResponseBody),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error in conversation-history endpoint:', error);\n    return new Response(\n      JSON.stringify({\n        hasHistory: false,\n        error: 'Internal server error',\n      } as ResponseBody),\n      {\n        status: 500,\n        headers: corsHeaders,\n      }\n    );\n  }\n};\n\n\n\n\n\n", "// Cloudflare Pages Functions \u306E\u578B\u5B9A\u7FA9\nimport { verifyUserToken } from '../_lib/token.js';\n\ninterface LastConversationRow {\n  character_id: string;\n  last_conversation_date: string;\n}\n\ninterface UserRecord {\n  id: number;\n  nickname: string;\n  guardian: string | null;\n}\n\ninterface ResponseBody {\n  lastConversations: Record<string, string | null>; // character_id -> last_conversation_date (ISO string) or null\n  nickname?: string;\n  error?: string;\n}\n\nexport const onRequestGet: PagesFunction = async (context) => {\n  const { request, env } = context;\n\n  // CORS\u30D8\u30C3\u30C0\u30FC\u306E\u8A2D\u5B9A\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'GET, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    'Content-Type': 'application/json',\n  };\n\n  // OPTIONS\u30EA\u30AF\u30A8\u30B9\u30C8\uFF08\u30D7\u30EA\u30D5\u30E9\u30A4\u30C8\uFF09\u306E\u51E6\u7406\n  if (request.method === 'OPTIONS') {\n    return new Response(null, {\n      status: 204,\n      headers: corsHeaders,\n    });\n  }\n\n  try {\n    const url = new URL(request.url);\n    const userToken = url.searchParams.get('userToken');\n\n    if (!userToken) {\n      return new Response(\n        JSON.stringify({\n          lastConversations: {},\n          error: 'userToken is required',\n        } as ResponseBody),\n        {\n          status: 400,\n          headers: corsHeaders,\n        }\n      );\n    }\n\n    const tokenPayload = await verifyUserToken(userToken, env.AUTH_SECRET);\n    if (!tokenPayload) {\n      return new Response(\n        JSON.stringify({\n          lastConversations: {},\n          error: 'invalid user token',\n        } as ResponseBody),\n        { status: 401, headers: corsHeaders }\n      );\n    }\n\n    const user = await env.DB.prepare<UserRecord>(\n      'SELECT id, nickname, guardian FROM users WHERE id = ?'\n    )\n      .bind(tokenPayload.userId)\n      .first();\n\n    if (!user) {\n      return new Response(\n        JSON.stringify({\n          lastConversations: {},\n          error: 'user not found',\n        } as ResponseBody),\n        { status: 404, headers: corsHeaders }\n      );\n    }\n\n    // \u5404\u30AD\u30E3\u30E9\u30AF\u30BF\u30FC\u3068\u306E\u6700\u5F8C\u306E\u4F1A\u8A71\u65E5\u6642\u3092\u53D6\u5F97\n    // timestamp\u30AB\u30E9\u30E0\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fcreated_at\u3092\u4F7F\u7528\n    const lastConversationsResult = await env.DB.prepare<LastConversationRow>(\n      `SELECT character_id, MAX(COALESCE(timestamp, created_at)) as last_conversation_date\n       FROM conversations\n       WHERE user_id = ?\n       GROUP BY character_id`\n    )\n      .bind(user.id)\n      .all();\n\n    const lastConversations: Record<string, string | null> = {\n      kaede: null,\n      yukino: null,\n      sora: null,\n      kaon: null,\n    };\n\n    if (lastConversationsResult.results) {\n      for (const row of lastConversationsResult.results) {\n        if (row.character_id && lastConversations.hasOwnProperty(row.character_id)) {\n          lastConversations[row.character_id] = row.last_conversation_date || null;\n        }\n      }\n    }\n\n    return new Response(\n      JSON.stringify({\n        lastConversations,\n        nickname: user.nickname,\n      } as ResponseBody),\n      { status: 200, headers: corsHeaders }\n    );\n  } catch (error) {\n    console.error('Error in last-conversations endpoint:', error);\n    return new Response(\n      JSON.stringify({\n        lastConversations: {},\n        error: 'Internal server error',\n      } as ResponseBody),\n      {\n        status: 500,\n        headers: corsHeaders,\n      }\n    );\n  }\n};\n\n\n\n\n\n", "import { onRequestPost as __api_auth_login_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\auth\\\\login.ts\"\nimport { onRequestPost as __api_auth_register_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\auth\\\\register.ts\"\nimport { onRequestPost as __api_auth_reset_passphrase_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\auth\\\\reset-passphrase.ts\"\nimport { onRequestPost as __api_auth_update_deity_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\auth\\\\update-deity.ts\"\nimport { onRequest as __api_admin_conversations_ts_onRequest } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\admin\\\\conversations.ts\"\nimport { onRequest as __api_admin_users_ts_onRequest } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\admin\\\\users.ts\"\nimport { onRequestGet as __api_cleanup_conversations_ts_onRequestGet } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\cleanup-conversations.ts\"\nimport { onRequestPost as __api_cleanup_conversations_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\cleanup-conversations.ts\"\nimport { onRequestPost as __api_consult_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\consult.ts\"\nimport { onRequestGet as __api_conversation_ts_onRequestGet } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\conversation.ts\"\nimport { onRequestPost as __api_conversation_ts_onRequestPost } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\conversation.ts\"\nimport { onRequestGet as __api_conversation_history_ts_onRequestGet } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\conversation-history.ts\"\nimport { onRequestGet as __api_last_conversations_ts_onRequestGet } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\functions\\\\api\\\\last-conversations.ts\"\n\nexport const routes = [\n    {\n      routePath: \"/api/auth/login\",\n      mountPath: \"/api/auth\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_auth_login_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/auth/register\",\n      mountPath: \"/api/auth\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_auth_register_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/auth/reset-passphrase\",\n      mountPath: \"/api/auth\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_auth_reset_passphrase_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/auth/update-deity\",\n      mountPath: \"/api/auth\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_auth_update_deity_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/admin/conversations\",\n      mountPath: \"/api/admin\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_admin_conversations_ts_onRequest],\n    },\n  {\n      routePath: \"/api/admin/users\",\n      mountPath: \"/api/admin\",\n      method: \"\",\n      middlewares: [],\n      modules: [__api_admin_users_ts_onRequest],\n    },\n  {\n      routePath: \"/api/cleanup-conversations\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_cleanup_conversations_ts_onRequestGet],\n    },\n  {\n      routePath: \"/api/cleanup-conversations\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_cleanup_conversations_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/consult\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_consult_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/conversation\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_conversation_ts_onRequestGet],\n    },\n  {\n      routePath: \"/api/conversation\",\n      mountPath: \"/api\",\n      method: \"POST\",\n      middlewares: [],\n      modules: [__api_conversation_ts_onRequestPost],\n    },\n  {\n      routePath: \"/api/conversation-history\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_conversation_history_ts_onRequestGet],\n    },\n  {\n      routePath: \"/api/last-conversations\",\n      mountPath: \"/api\",\n      method: \"GET\",\n      middlewares: [],\n      modules: [__api_last_conversations_ts_onRequestGet],\n    },\n  ]", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-u00RrT\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-u00RrT\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-u00RrT\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\pages-template-worker.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\pages-template-worker.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "import { match } from \"path-to-regexp\";\n\n//note: this explicitly does not include the * character, as pages requires this\nconst escapeRegex = /[.+?^${}()|[\\]\\\\]/g;\n\ntype HTTPMethod =\n\t| \"HEAD\"\n\t| \"OPTIONS\"\n\t| \"GET\"\n\t| \"POST\"\n\t| \"PUT\"\n\t| \"PATCH\"\n\t| \"DELETE\";\n\n/* TODO: Grab these from @cloudflare/workers-types instead */\ntype Params<P extends string = string> = Record<P, string | string[]>;\n\ntype EventContext<Env, P extends string, Data> = {\n\trequest: Request;\n\tfunctionPath: string;\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n\tnext: (input?: Request | string, init?: RequestInit) => Promise<Response>;\n\tenv: Env & { ASSETS: { fetch: typeof fetch } };\n\tparams: Params<P>;\n\tdata: Data;\n};\n\ndeclare type PagesFunction<\n\tEnv = unknown,\n\tP extends string = string,\n\tData extends Record<string, unknown> = Record<string, unknown>,\n> = (context: EventContext<Env, P, Data>) => Response | Promise<Response>;\n/* end @cloudflare/workers-types */\n\ntype RouteHandler = {\n\troutePath: string;\n\tmountPath: string;\n\tmethod?: HTTPMethod;\n\tmodules: PagesFunction[];\n\tmiddlewares: PagesFunction[];\n};\n\n// inject `routes` via ESBuild\ndeclare const routes: RouteHandler[];\n// define `__FALLBACK_SERVICE__` via ESBuild\ndeclare const __FALLBACK_SERVICE__: string;\n\n// expect an ASSETS fetcher binding pointing to the asset-server stage\ntype FetchEnv = {\n\t[name: string]: { fetch: typeof fetch };\n\tASSETS: { fetch: typeof fetch };\n};\n\ntype WorkerContext = {\n\twaitUntil: (promise: Promise<unknown>) => void;\n\tpassThroughOnException: () => void;\n};\n\nfunction* executeRequest(request: Request) {\n\tconst requestPath = new URL(request.url).pathname;\n\n\t// First, iterate through the routes (backwards) and execute \"middlewares\" on partial route matches\n\tfor (const route of [...routes].reverse()) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\n\t\t// replaces with \"\\\\$&\", this prepends a backslash to the matched string, e.g. \"[\" becomes \"\\[\"\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult) {\n\t\t\tfor (const handler of route.middlewares.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: mountMatchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\t// Then look for the first exact route match and execute its \"modules\"\n\tfor (const route of routes) {\n\t\tif (route.method && route.method !== request.method) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst routeMatcher = match(route.routePath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: true,\n\t\t});\n\t\tconst mountMatcher = match(route.mountPath.replace(escapeRegex, \"\\\\$&\"), {\n\t\t\tend: false,\n\t\t});\n\t\tconst matchResult = routeMatcher(requestPath);\n\t\tconst mountMatchResult = mountMatcher(requestPath);\n\t\tif (matchResult && mountMatchResult && route.modules.length) {\n\t\t\tfor (const handler of route.modules.flat()) {\n\t\t\t\tyield {\n\t\t\t\t\thandler,\n\t\t\t\t\tparams: matchResult.params as Params,\n\t\t\t\t\tpath: matchResult.path,\n\t\t\t\t};\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nexport default {\n\tasync fetch(\n\t\toriginalRequest: Request,\n\t\tenv: FetchEnv,\n\t\tworkerContext: WorkerContext\n\t) {\n\t\tlet request = originalRequest;\n\t\tconst handlerIterator = executeRequest(request);\n\t\tlet data = {}; // arbitrary data the user can set between functions\n\t\tlet isFailOpen = false;\n\n\t\tconst next = async (input?: RequestInfo, init?: RequestInit) => {\n\t\t\tif (input !== undefined) {\n\t\t\t\tlet url = input;\n\t\t\t\tif (typeof input === \"string\") {\n\t\t\t\t\turl = new URL(input, request.url).toString();\n\t\t\t\t}\n\t\t\t\trequest = new Request(url, init);\n\t\t\t}\n\n\t\t\tconst result = handlerIterator.next();\n\t\t\t// Note we can't use `!result.done` because this doesn't narrow to the correct type\n\t\t\tif (result.done === false) {\n\t\t\t\tconst { handler, params, path } = result.value;\n\t\t\t\tconst context = {\n\t\t\t\t\trequest: new Request(request.clone()),\n\t\t\t\t\tfunctionPath: path,\n\t\t\t\t\tnext,\n\t\t\t\t\tparams,\n\t\t\t\t\tget data() {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t},\n\t\t\t\t\tset data(value) {\n\t\t\t\t\t\tif (typeof value !== \"object\" || value === null) {\n\t\t\t\t\t\t\tthrow new Error(\"context.data must be an object\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// user has overriden context.data, so we need to merge it with the existing data\n\t\t\t\t\t\tdata = value;\n\t\t\t\t\t},\n\t\t\t\t\tenv,\n\t\t\t\t\twaitUntil: workerContext.waitUntil.bind(workerContext),\n\t\t\t\t\tpassThroughOnException: () => {\n\t\t\t\t\t\tisFailOpen = true;\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tconst response = await handler(context);\n\n\t\t\t\tif (!(response instanceof Response)) {\n\t\t\t\t\tthrow new Error(\"Your Pages function should return a Response\");\n\t\t\t\t}\n\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else if (__FALLBACK_SERVICE__) {\n\t\t\t\t// There are no more handlers so finish with the fallback service (`env.ASSETS.fetch` in Pages' case)\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t} else {\n\t\t\t\t// There was not fallback service so actually make the request to the origin.\n\t\t\t\tconst response = await fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\treturn await next();\n\t\t} catch (error) {\n\t\t\tif (isFailOpen) {\n\t\t\t\tconst response = await env[__FALLBACK_SERVICE__].fetch(request);\n\t\t\t\treturn cloneResponse(response);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t},\n};\n\n// This makes a Response mutable\nconst cloneResponse = (response: Response) =>\n\t// https://fetch.spec.whatwg.org/#null-body-status\n\tnew Response(\n\t\t[101, 204, 205, 304].includes(response.status) ? null : response.body,\n\t\tresponse\n\t);\n", "/**\n * Tokenizer results.\n */\ninterface LexToken {\n  type:\n    | \"OPEN\"\n    | \"CLOSE\"\n    | \"PATTERN\"\n    | \"NAME\"\n    | \"CHAR\"\n    | \"ESCAPED_CHAR\"\n    | \"MODIFIER\"\n    | \"END\";\n  index: number;\n  value: string;\n}\n\n/**\n * Tokenize input string.\n */\nfunction lexer(str: string): LexToken[] {\n  const tokens: LexToken[] = [];\n  let i = 0;\n\n  while (i < str.length) {\n    const char = str[i];\n\n    if (char === \"*\" || char === \"+\" || char === \"?\") {\n      tokens.push({ type: \"MODIFIER\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"\\\\\") {\n      tokens.push({ type: \"ESCAPED_CHAR\", index: i++, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"{\") {\n      tokens.push({ type: \"OPEN\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \"}\") {\n      tokens.push({ type: \"CLOSE\", index: i, value: str[i++] });\n      continue;\n    }\n\n    if (char === \":\") {\n      let name = \"\";\n      let j = i + 1;\n\n      while (j < str.length) {\n        const code = str.charCodeAt(j);\n\n        if (\n          // `0-9`\n          (code >= 48 && code <= 57) ||\n          // `A-Z`\n          (code >= 65 && code <= 90) ||\n          // `a-z`\n          (code >= 97 && code <= 122) ||\n          // `_`\n          code === 95\n        ) {\n          name += str[j++];\n          continue;\n        }\n\n        break;\n      }\n\n      if (!name) throw new TypeError(`Missing parameter name at ${i}`);\n\n      tokens.push({ type: \"NAME\", index: i, value: name });\n      i = j;\n      continue;\n    }\n\n    if (char === \"(\") {\n      let count = 1;\n      let pattern = \"\";\n      let j = i + 1;\n\n      if (str[j] === \"?\") {\n        throw new TypeError(`Pattern cannot start with \"?\" at ${j}`);\n      }\n\n      while (j < str.length) {\n        if (str[j] === \"\\\\\") {\n          pattern += str[j++] + str[j++];\n          continue;\n        }\n\n        if (str[j] === \")\") {\n          count--;\n          if (count === 0) {\n            j++;\n            break;\n          }\n        } else if (str[j] === \"(\") {\n          count++;\n          if (str[j + 1] !== \"?\") {\n            throw new TypeError(`Capturing groups are not allowed at ${j}`);\n          }\n        }\n\n        pattern += str[j++];\n      }\n\n      if (count) throw new TypeError(`Unbalanced pattern at ${i}`);\n      if (!pattern) throw new TypeError(`Missing pattern at ${i}`);\n\n      tokens.push({ type: \"PATTERN\", index: i, value: pattern });\n      i = j;\n      continue;\n    }\n\n    tokens.push({ type: \"CHAR\", index: i, value: str[i++] });\n  }\n\n  tokens.push({ type: \"END\", index: i, value: \"\" });\n\n  return tokens;\n}\n\nexport interface ParseOptions {\n  /**\n   * Set the default delimiter for repeat parameters. (default: `'/'`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters to automatically consider prefixes when parsing.\n   */\n  prefixes?: string;\n}\n\n/**\n * Parse a string for the raw tokens.\n */\nexport function parse(str: string, options: ParseOptions = {}): Token[] {\n  const tokens = lexer(str);\n  const { prefixes = \"./\", delimiter = \"/#?\" } = options;\n  const result: Token[] = [];\n  let key = 0;\n  let i = 0;\n  let path = \"\";\n\n  const tryConsume = (type: LexToken[\"type\"]): string | undefined => {\n    if (i < tokens.length && tokens[i].type === type) return tokens[i++].value;\n  };\n\n  const mustConsume = (type: LexToken[\"type\"]): string => {\n    const value = tryConsume(type);\n    if (value !== undefined) return value;\n    const { type: nextType, index } = tokens[i];\n    throw new TypeError(`Unexpected ${nextType} at ${index}, expected ${type}`);\n  };\n\n  const consumeText = (): string => {\n    let result = \"\";\n    let value: string | undefined;\n    while ((value = tryConsume(\"CHAR\") || tryConsume(\"ESCAPED_CHAR\"))) {\n      result += value;\n    }\n    return result;\n  };\n\n  const isSafe = (value: string): boolean => {\n    for (const char of delimiter) if (value.indexOf(char) > -1) return true;\n    return false;\n  };\n\n  const safePattern = (prefix: string) => {\n    const prev = result[result.length - 1];\n    const prevText = prefix || (prev && typeof prev === \"string\" ? prev : \"\");\n\n    if (prev && !prevText) {\n      throw new TypeError(\n        `Must have text between two parameters, missing text after \"${(prev as Key).name}\"`,\n      );\n    }\n\n    if (!prevText || isSafe(prevText)) return `[^${escapeString(delimiter)}]+?`;\n    return `(?:(?!${escapeString(prevText)})[^${escapeString(delimiter)}])+?`;\n  };\n\n  while (i < tokens.length) {\n    const char = tryConsume(\"CHAR\");\n    const name = tryConsume(\"NAME\");\n    const pattern = tryConsume(\"PATTERN\");\n\n    if (name || pattern) {\n      let prefix = char || \"\";\n\n      if (prefixes.indexOf(prefix) === -1) {\n        path += prefix;\n        prefix = \"\";\n      }\n\n      if (path) {\n        result.push(path);\n        path = \"\";\n      }\n\n      result.push({\n        name: name || key++,\n        prefix,\n        suffix: \"\",\n        pattern: pattern || safePattern(prefix),\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    const value = char || tryConsume(\"ESCAPED_CHAR\");\n    if (value) {\n      path += value;\n      continue;\n    }\n\n    if (path) {\n      result.push(path);\n      path = \"\";\n    }\n\n    const open = tryConsume(\"OPEN\");\n    if (open) {\n      const prefix = consumeText();\n      const name = tryConsume(\"NAME\") || \"\";\n      const pattern = tryConsume(\"PATTERN\") || \"\";\n      const suffix = consumeText();\n\n      mustConsume(\"CLOSE\");\n\n      result.push({\n        name: name || (pattern ? key++ : \"\"),\n        pattern: name && !pattern ? safePattern(prefix) : pattern,\n        prefix,\n        suffix,\n        modifier: tryConsume(\"MODIFIER\") || \"\",\n      });\n      continue;\n    }\n\n    mustConsume(\"END\");\n  }\n\n  return result;\n}\n\nexport interface TokensToFunctionOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * Function for encoding input strings for output.\n   */\n  encode?: (value: string, token: Key) => string;\n  /**\n   * When `false` the function can produce an invalid (unmatched) path. (default: `true`)\n   */\n  validate?: boolean;\n}\n\n/**\n * Compile a string to a template function for the path.\n */\nexport function compile<P extends object = object>(\n  str: string,\n  options?: ParseOptions & TokensToFunctionOptions,\n) {\n  return tokensToFunction<P>(parse(str, options), options);\n}\n\nexport type PathFunction<P extends object = object> = (data?: P) => string;\n\n/**\n * Expose a method for transforming tokens into the path function.\n */\nexport function tokensToFunction<P extends object = object>(\n  tokens: Token[],\n  options: TokensToFunctionOptions = {},\n): PathFunction<P> {\n  const reFlags = flags(options);\n  const { encode = (x: string) => x, validate = true } = options;\n\n  // Compile all the tokens into regexps.\n  const matches = tokens.map((token) => {\n    if (typeof token === \"object\") {\n      return new RegExp(`^(?:${token.pattern})$`, reFlags);\n    }\n  });\n\n  return (data: Record<string, any> | null | undefined) => {\n    let path = \"\";\n\n    for (let i = 0; i < tokens.length; i++) {\n      const token = tokens[i];\n\n      if (typeof token === \"string\") {\n        path += token;\n        continue;\n      }\n\n      const value = data ? data[token.name] : undefined;\n      const optional = token.modifier === \"?\" || token.modifier === \"*\";\n      const repeat = token.modifier === \"*\" || token.modifier === \"+\";\n\n      if (Array.isArray(value)) {\n        if (!repeat) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to not repeat, but got an array`,\n          );\n        }\n\n        if (value.length === 0) {\n          if (optional) continue;\n\n          throw new TypeError(`Expected \"${token.name}\" to not be empty`);\n        }\n\n        for (let j = 0; j < value.length; j++) {\n          const segment = encode(value[j], token);\n\n          if (validate && !(matches[i] as RegExp).test(segment)) {\n            throw new TypeError(\n              `Expected all \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n            );\n          }\n\n          path += token.prefix + segment + token.suffix;\n        }\n\n        continue;\n      }\n\n      if (typeof value === \"string\" || typeof value === \"number\") {\n        const segment = encode(String(value), token);\n\n        if (validate && !(matches[i] as RegExp).test(segment)) {\n          throw new TypeError(\n            `Expected \"${token.name}\" to match \"${token.pattern}\", but got \"${segment}\"`,\n          );\n        }\n\n        path += token.prefix + segment + token.suffix;\n        continue;\n      }\n\n      if (optional) continue;\n\n      const typeOfMessage = repeat ? \"an array\" : \"a string\";\n      throw new TypeError(`Expected \"${token.name}\" to be ${typeOfMessage}`);\n    }\n\n    return path;\n  };\n}\n\nexport interface RegexpToFunctionOptions {\n  /**\n   * Function for decoding strings for params.\n   */\n  decode?: (value: string, token: Key) => string;\n}\n\n/**\n * A match result contains data about the path match.\n */\nexport interface MatchResult<P extends object = object> {\n  path: string;\n  index: number;\n  params: P;\n}\n\n/**\n * A match is either `false` (no match) or a match result.\n */\nexport type Match<P extends object = object> = false | MatchResult<P>;\n\n/**\n * The match function takes a string and returns whether it matched the path.\n */\nexport type MatchFunction<P extends object = object> = (\n  path: string,\n) => Match<P>;\n\n/**\n * Create path match function from `path-to-regexp` spec.\n */\nexport function match<P extends object = object>(\n  str: Path,\n  options?: ParseOptions & TokensToRegexpOptions & RegexpToFunctionOptions,\n) {\n  const keys: Key[] = [];\n  const re = pathToRegexp(str, keys, options);\n  return regexpToFunction<P>(re, keys, options);\n}\n\n/**\n * Create a path match function from `path-to-regexp` output.\n */\nexport function regexpToFunction<P extends object = object>(\n  re: RegExp,\n  keys: Key[],\n  options: RegexpToFunctionOptions = {},\n): MatchFunction<P> {\n  const { decode = (x: string) => x } = options;\n\n  return function (pathname: string) {\n    const m = re.exec(pathname);\n    if (!m) return false;\n\n    const { 0: path, index } = m;\n    const params = Object.create(null);\n\n    for (let i = 1; i < m.length; i++) {\n      if (m[i] === undefined) continue;\n\n      const key = keys[i - 1];\n\n      if (key.modifier === \"*\" || key.modifier === \"+\") {\n        params[key.name] = m[i].split(key.prefix + key.suffix).map((value) => {\n          return decode(value, key);\n        });\n      } else {\n        params[key.name] = decode(m[i], key);\n      }\n    }\n\n    return { path, index, params };\n  };\n}\n\n/**\n * Escape a regular expression string.\n */\nfunction escapeString(str: string) {\n  return str.replace(/([.+*?=^!:${}()[\\]|/\\\\])/g, \"\\\\$1\");\n}\n\n/**\n * Get the flags for a regexp from the options.\n */\nfunction flags(options?: { sensitive?: boolean }) {\n  return options && options.sensitive ? \"\" : \"i\";\n}\n\n/**\n * Metadata about a key.\n */\nexport interface Key {\n  name: string | number;\n  prefix: string;\n  suffix: string;\n  pattern: string;\n  modifier: string;\n}\n\n/**\n * A token is a string (nothing special) or key metadata (capture group).\n */\nexport type Token = string | Key;\n\n/**\n * Pull out keys from a regexp.\n */\nfunction regexpToRegexp(path: RegExp, keys?: Key[]): RegExp {\n  if (!keys) return path;\n\n  const groupsRegex = /\\((?:\\?<(.*?)>)?(?!\\?)/g;\n\n  let index = 0;\n  let execResult = groupsRegex.exec(path.source);\n  while (execResult) {\n    keys.push({\n      // Use parenthesized substring match if available, index otherwise\n      name: execResult[1] || index++,\n      prefix: \"\",\n      suffix: \"\",\n      modifier: \"\",\n      pattern: \"\",\n    });\n    execResult = groupsRegex.exec(path.source);\n  }\n\n  return path;\n}\n\n/**\n * Transform an array into a regexp.\n */\nfunction arrayToRegexp(\n  paths: Array<string | RegExp>,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n): RegExp {\n  const parts = paths.map((path) => pathToRegexp(path, keys, options).source);\n  return new RegExp(`(?:${parts.join(\"|\")})`, flags(options));\n}\n\n/**\n * Create a path regexp from string input.\n */\nfunction stringToRegexp(\n  path: string,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  return tokensToRegexp(parse(path, options), keys, options);\n}\n\nexport interface TokensToRegexpOptions {\n  /**\n   * When `true` the regexp will be case sensitive. (default: `false`)\n   */\n  sensitive?: boolean;\n  /**\n   * When `true` the regexp won't allow an optional trailing delimiter to match. (default: `false`)\n   */\n  strict?: boolean;\n  /**\n   * When `true` the regexp will match to the end of the string. (default: `true`)\n   */\n  end?: boolean;\n  /**\n   * When `true` the regexp will match from the beginning of the string. (default: `true`)\n   */\n  start?: boolean;\n  /**\n   * Sets the final character for non-ending optimistic matches. (default: `/`)\n   */\n  delimiter?: string;\n  /**\n   * List of characters that can also be \"end\" characters.\n   */\n  endsWith?: string;\n  /**\n   * Encode path tokens for use in the `RegExp`.\n   */\n  encode?: (value: string) => string;\n}\n\n/**\n * Expose a function for taking tokens and returning a RegExp.\n */\nexport function tokensToRegexp(\n  tokens: Token[],\n  keys?: Key[],\n  options: TokensToRegexpOptions = {},\n) {\n  const {\n    strict = false,\n    start = true,\n    end = true,\n    encode = (x: string) => x,\n    delimiter = \"/#?\",\n    endsWith = \"\",\n  } = options;\n  const endsWithRe = `[${escapeString(endsWith)}]|$`;\n  const delimiterRe = `[${escapeString(delimiter)}]`;\n  let route = start ? \"^\" : \"\";\n\n  // Iterate over the tokens and create our regexp string.\n  for (const token of tokens) {\n    if (typeof token === \"string\") {\n      route += escapeString(encode(token));\n    } else {\n      const prefix = escapeString(encode(token.prefix));\n      const suffix = escapeString(encode(token.suffix));\n\n      if (token.pattern) {\n        if (keys) keys.push(token);\n\n        if (prefix || suffix) {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            const mod = token.modifier === \"*\" ? \"?\" : \"\";\n            route += `(?:${prefix}((?:${token.pattern})(?:${suffix}${prefix}(?:${token.pattern}))*)${suffix})${mod}`;\n          } else {\n            route += `(?:${prefix}(${token.pattern})${suffix})${token.modifier}`;\n          }\n        } else {\n          if (token.modifier === \"+\" || token.modifier === \"*\") {\n            throw new TypeError(\n              `Can not repeat \"${token.name}\" without a prefix and suffix`,\n            );\n          }\n\n          route += `(${token.pattern})${token.modifier}`;\n        }\n      } else {\n        route += `(?:${prefix}${suffix})${token.modifier}`;\n      }\n    }\n  }\n\n  if (end) {\n    if (!strict) route += `${delimiterRe}?`;\n\n    route += !options.endsWith ? \"$\" : `(?=${endsWithRe})`;\n  } else {\n    const endToken = tokens[tokens.length - 1];\n    const isEndDelimited =\n      typeof endToken === \"string\"\n        ? delimiterRe.indexOf(endToken[endToken.length - 1]) > -1\n        : endToken === undefined;\n\n    if (!strict) {\n      route += `(?:${delimiterRe}(?=${endsWithRe}))?`;\n    }\n\n    if (!isEndDelimited) {\n      route += `(?=${delimiterRe}|${endsWithRe})`;\n    }\n  }\n\n  return new RegExp(route, flags(options));\n}\n\n/**\n * Supported `path-to-regexp` input types.\n */\nexport type Path = string | RegExp | Array<string | RegExp>;\n\n/**\n * Normalize the given path string, returning a regular expression.\n *\n * An empty array can be passed in for the keys, which will hold the\n * placeholder key descriptions. For example, using `/user/:id`, `keys` will\n * contain `[{ name: 'id', delimiter: '/', optional: false, repeat: false }]`.\n */\nexport function pathToRegexp(\n  path: Path,\n  keys?: Key[],\n  options?: TokensToRegexpOptions & ParseOptions,\n) {\n  if (path instanceof RegExp) return regexpToRegexp(path, keys);\n  if (Array.isArray(path)) return arrayToRegexp(path, keys, options);\n  return stringToRegexp(path, keys, options);\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\pages-tdhAkN\\\\functionsWorker-0.5506474401351913.mjs\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\pages-tdhAkN\\\\functionsWorker-0.5506474401351913.mjs\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-9GwSE9\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\mituo\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-9GwSE9\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"C:\\\\Users\\\\mituo\\\\Desktop\\\\kaede\\\\.wrangler\\\\tmp\\\\bundle-9GwSE9\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["checkURL", "urls", "__name", "generateUserToken", "verifyUserToken", "getRandomDeity", "import_token", "onRequestPost", "import_deities", "isAdminAuthorized", "unauthorizedResponse", "import_admin_auth", "jsonHeaders", "onRequest", "isValidCharacter", "corsHeaders", "characterName", "MAX_MESSAGES_PER_CHARACTER", "onRequestGet", "value", "_a", "result", "char", "prefix", "i", "drainBody", "middleware_ensure_req_body_drained_default", "reduceError", "jsonError", "middleware_miniflare3_json_error_default", "__INTERNAL_WRANGLER_MIDDLEWARE__", "middleware_ensure_req_body_drained_default", "middleware_miniflare3_json_error_default", "middleware_insertion_facade_default", "__facade_middleware__", "__facade_register__", "__facade_invokeChain__", "__facade_invoke__", "__facade_middleware__", "__Facade_ScheduledController__", "___Facade_ScheduledController__", "wrapExportedHandler", "__INTERNAL_WRANGLER_MIDDLEWARE__", "__facade_register__", "__facade_invoke__", "wrapWorkerEntrypoint", "WRAPPED_ENTRY", "middleware_insertion_facade_default", "middleware_loader_entry_default"]
}
