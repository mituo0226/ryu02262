# 鑑定士の性格設定テスト

## 概要

このテストスイートは、各鑑定士の性格設定がAPIに正しく反映されているかを検証します。

## テストの種類

### 1. プロンプト生成テスト（現在実装済み）

**目的**: 各鑑定士の性格設定ファイル（`functions/_lib/characters/*.js`）が、システムプロンプト生成関数（`character-system.js`）を通じて正しく反映されているかを検証します。

**「テストユーザー」について**:
- テストコード内の「テストユーザー」は、プロンプト生成関数に渡す**仮のユーザー名**です
- 実際のAPIエンドポイント（`/api/consult`）は呼び出していません
- プロンプト生成関数（`generateKaedePrompt`など）を直接呼び出して、生成されたプロンプトに性格設定が含まれているかを確認します

**例**:
```javascript
const prompt = generateKaedePrompt({
  userNickname: 'テストユーザー',  // ← これは仮のユーザー名
  hasPreviousConversation: false,
});

// プロンプトに「楓」「50代前半の男性」などが含まれているか確認
expect(prompt).toContain('楓');
```

### 2. API統合テスト（未実装・オプション）

**目的**: 実際のAPIエンドポイント（`/api/consult`）を呼び出して、性格設定が正しく反映されているかを検証します。

**必要なもの**:
- データベース接続（モックまたはテスト用DB）
- APIキー（モックまたはテスト用キー）
- Cloudflare Pages Functionsのテスト環境

**実装方法**:
- APIエンドポイントをモックする
- または、実際のテスト環境でAPIを呼び出す
- レスポンスのメッセージ内容に性格設定が反映されているかを確認

## テストの内容

### 1. 各鑑定士の個別テスト

- **楓（kaede）**: 穏やかで50代前半の男性、龍神との縁、守護神の儀式
- **笹岡雪乃（yukino）**: 30代半ばの女性、タロット占い、心理学
- **水野ソラ（sora）**: 27歳の男性、タメ口、共感力が高い
- **三崎花音（kaon）**: 天体音響心理鑑定士、艶っぽい語尾、占星術・数秘術

### 2. システムプロンプト生成の統合テスト

`generateSystemPrompt`関数が各鑑定士のプロンプトを正しく生成するかを確認します。

### 3. 性格設定の一貫性テスト

各鑑定士の話し方、年齢・性別設定が一貫しているかを確認します。

## テストの実行方法

```bash
# テストを実行
npm test

# ウォッチモードで実行（ファイル変更を監視）
npm run test:watch

# UIモードで実行（ブラウザで結果を確認）
npm run test:ui
```

## テストの追加方法

新しいテストケースを追加する場合は、`character-personality.test.js`に以下を追加してください：

```javascript
it('新しいテストケース', () => {
  const prompt = generateSystemPrompt('characterId', {
    userNickname: 'テストユーザー',  // 仮のユーザー名
    hasPreviousConversation: false,
  });
  
  // 検証内容
  expect(prompt).toContain('期待される文字列');
});
```

## 注意事項

- テストは`functions/_lib/characters/*.js`の性格設定ファイルを直接読み込みます
- 実際のAPIエンドポイント（`/api/consult`）を呼び出すテストは別途作成が必要です
- 環境変数やデータベース接続は不要です（プロンプト生成のみをテスト）

## 現在のテストの限界

現在のテストは**プロンプト生成関数**のみをテストしています。つまり：

✅ **確認できること**:
- 性格設定ファイルが正しく読み込まれているか
- プロンプト生成関数が正しく動作しているか
- 生成されたプロンプトに性格設定が含まれているか

❌ **確認できないこと**:
- 実際のAPIエンドポイント（`/api/consult`）が正しく動作しているか
- LLM APIが正しく呼び出されているか
- データベースへの保存が正しく行われているか
- 実際のレスポンスメッセージに性格設定が反映されているか

## 次のステップ（オプション）

実際のAPIエンドポイントをテストする場合は、以下のような統合テストを作成できます：

1. **APIエンドポイントのモックテスト**
   - `consult.ts`の関数を直接呼び出す
   - データベースとLLM APIをモックする

2. **E2Eテスト**
   - 実際のテスト環境でAPIを呼び出す
   - レスポンスを検証する
