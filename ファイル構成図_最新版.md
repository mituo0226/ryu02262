# プロジェクトファイル構成図（最新版）

```
kaede/                                    (プロジェクトルート)
│
├── 📁 database/                         データベース関連
│   ├── cloudflare-d1-migration.sql
│   ├── cloudflare-d1-quick-migration.sql
│   ├── MIGRATION_INSTRUCTIONS.md
│   ├── migration.sql
│   ├── queries.sql
│   ├── README.md
│   └── schema.sql
│
├── 📁 docs/                             ドキュメント
│   ├── ADMIN_CHAT_ANALYSIS_PANEL_DEBUG.md
│   ├── GUEST_HISTORY_COUNTING.md
│   ├── GUEST_HISTORY_FLOW.md
│   ├── GUEST_USER_MESSAGE_COUNT.md
│   ├── MESSAGE_COUNT_FIX_SUMMARY.md
│   ├── MESSAGE_COUNT_FIX.md
│   ├── MESSAGE_COUNT_INVESTIGATION.md
│   ├── MESSAGE_COUNT_ORIGIN.md
│   ├── PHASE_MANAGEMENT_IMPLEMENTATION.md
│   └── PHASE_MANAGEMENT_STATUS.md
│
├── 📁 functions/                         Cloudflare Pages Functions (バックエンドAPI)
│   ├── 📁 _lib/                        共通ライブラリ
│   │   ├── admin-auth.js               (管理者認証)
│   │   ├── character-loader.js          (キャラクター読み込み)
│   │   ├── character-system.js          (キャラクターシステム)
│   │   ├── deities.js                   (神様割り当て)
│   │   └── token.js                     (トークン生成)
│   │
│   ├── 📁 api/                         APIエンドポイント
│   │   ├── 📁 admin/                   管理者用API
│   │   │   ├── conversations.ts
│   │   │   └── users.ts
│   │   │
│   │   ├── 📁 auth/                    認証API
│   │   │   ├── login.ts                 (ログイン)
│   │   │   ├── register.ts              (ユーザー登録)
│   │   │   └── reset-passphrase.ts      (合言葉リセット)
│   │   │
│   │   ├── cleanup-conversations.ts     (会話履歴クリーンアップ)
│   │   ├── consult.ts                   (鑑定API - DeepSeek連携)
│   │   ├── conversation-history.ts      (会話履歴取得)
│   │   ├── conversation.ts              (会話管理)
│   │   ├── last-conversations.ts        (最新会話取得)
│   │   └── types.d.ts                   (型定義)
│   │
│   └── 📁 lib/
│       └── character-system-temp.js
│
├── 📁 public/                           ⭐ メイン制作フォルダ（Cloudflare公開用）
│   │
│   ├── 📄 index.html                    CSSあり版（メインファイル）
│   ├── 📄 _redirects                    リダイレクト設定
│   │
│   ├── 📁 backup/                       バックアップ
│   │   └── index.backup.html
│   │
│   ├── 📁 css/                          スタイルシート
│   │   ├── styles.css                   メインスタイル
│   │   └── styles.backup.css
│   │
│   ├── 📁 data/                         データファイル
│   │   └── characters.json              キャラクター情報
│   │
│   ├── 📁 js/                           JavaScriptファイル
│   │   ├── auth-state.js                認証状態管理
│   │   ├── character-features.js        キャラクター機能
│   │   ├── chat-api.js                  チャットAPI
│   │   ├── chat-data.js                 チャットデータ
│   │   ├── chat-init.js                 チャット初期化
│   │   ├── chat-ui.js                   チャットUI
│   │   │
│   │   ├── 📁 features/                 機能別モジュール
│   │   │   ├── README.md
│   │   │   └── yukino-tarot.js           (雪乃のタロット機能)
│   │   │
│   │   ├── 📁 fortune-tellers/           占い師システム
│   │   │   ├── character-base.js         キャラクターベース
│   │   │   ├── config-manager.js         設定管理
│   │   │   ├── index.js                  メイン
│   │   │   │
│   │   │   ├── 📁 characters/            キャラクター別ロジック
│   │   │   │   ├── 📁 kaede/              楓
│   │   │   │   │   ├── buddhist.js         (仏教関連)
│   │   │   │   │   ├── concrete-questions.js (具体的な質問)
│   │   │   │   │   ├── conversation-flow.js (会話フロー)
│   │   │   │   │   ├── deep-psychology.js   (深層心理学)
│   │   │   │   │   ├── fortune-telling.js   (占い)
│   │   │   │   │   ├── index.js
│   │   │   │   │   └── responses.js         (応答)
│   │   │   │   │
│   │   │   │   ├── 📁 kaon/               三崎花音
│   │   │   │   │   ├── ethics.js            (倫理)
│   │   │   │   │   └── index.js
│   │   │   │   │
│   │   │   │   ├── 📁 sora/               水野ソラ
│   │   │   │   │   ├── index.js
│   │   │   │   │   └── motherly.js          (母性的)
│   │   │   │   │
│   │   │   │   └── 📁 yukino/             笹岡雪乃
│   │   │   │       ├── astrology.js         (占星術)
│   │   │   │       ├── index.js
│   │   │   │       └── tarot.js             (タロット)
│   │   │   │
│   │   │   └── 📁 utils/                  ユーティリティ
│   │   │       ├── filters.js              フィルター
│   │   │       ├── helpers.js               ヘルパー関数
│   │   │       └── validators.js            バリデーター
│   │   │
│   │   └── 📁 utils/                      ユーティリティ
│   │       └── guardian.js                 ⭐ 守護神決定ロジック（新規追加）
│   │
│   ├── 📁 nocss/                         CSSなし版（マッチングサイト内システム用）
│   │   ├── index.html
│   │   ├── kaede-back.html
│   │   ├── kaede.html
│   │   ├── kaon-back.html
│   │   ├── kaon.html
│   │   ├── main.html
│   │   ├── sora-back.html
│   │   ├── sora.html
│   │   ├── yukino-back.html
│   │   └── yukino.html
│   │
│   ├── 📁 pages/                         ページファイル
│   │   ├── 📁 admin/                     管理者ページ
│   │   │   └── dashboard.html             ダッシュボード
│   │   │
│   │   ├── 📁 auth/                      認証ページ
│   │   │   ├── login.html                 ログイン
│   │   │   ├── passphrase-reset.html     合言葉リセット
│   │   │   ├── passphrase-success.html   合言葉リセット成功
│   │   │   └── register.html              ユーザー登録
│   │   │
│   │   ├── 📁 chat/                      チャットページ
│   │   │   ├── chat.html                  チャット画面
│   │   │   ├── guest-chat.html            ゲストチャット
│   │   │   └── tarot-waiting.html         タロット待機画面
│   │   │
│   │   ├── 📁 profiles/                   プロフィールページ
│   │   │   ├── back.html                  背景画面
│   │   │   ├── kaede.html                 楓のプロフィール
│   │   │   ├── kaon.html                  三崎花音のプロフィール
│   │   │   ├── sora.html                  水野ソラのプロフィール
│   │   │   └── yukino.html                笹岡雪乃のプロフィール
│   │   │
│   │   ├── appraisers-list.html           鑑定士一覧
│   │   ├── guardian-ritual.html           ⭐ 守護神の儀式（新規追加）
│   │   ├── main.html                      メインページ
│   │   └── welcome-back.html              ウェルカムバック
│   │
│   └── 📁 photo/                         画像・動画ファイル
│       ├── rogo.png                       ロゴ
│       ├── top.png                        トップ画像
│       ├── back.png                       背景画像
│       ├── back.mp4                       背景動画
│       │
│       ├── kaede.png, kaede2.png          楓の画像
│       ├── kaon.png, kaon2.png             三崎花音の画像
│       ├── sora.png, sora2.png             水野ソラの画像
│       ├── yukino.png, yukino2.png         笹岡雪乃の画像
│       ├── yukino.mp4                      雪乃の動画
│       ├── sakura.mp4, sakura2.mp4         桜の動画
│       │
│       ├── 📁 kami/                        守護神画像
│       │   ├── amaterasu.png               天照大神
│       │   ├── okuni-nushi.png             大国主命
│       │   ├── dainithi-nyorai.png         大日如来
│       │   ├── senju.png                   千手観音
│       │   ├── fudo.png                    不動明王
│       │   ├── kaede-inori.png             楓の祈り
│       │   ├── dragon.png                  龍
│       │   └── cosmo.mp4                   コスモ動画
│       │
│       └── 📁 TAROT/                       タロットカード画像
│           ├── card back.png               カード裏
│           ├── The Fool.png                愚者
│           ├── The Magician.png             魔術師
│           ├── THE HIGH PRIESTESS.png       女教皇
│           ├── THE EMPRESS.png              女帝
│           ├── THE EMPEROR.png              皇帝
│           ├── THE HIEROPHANT.png           教皇
│           ├── THE LOVERS.png               恋人
│           ├── THE CHARIOT.png              戦車
│           ├── STRENGTH.png                 力
│           ├── THE HERMIT.png               隠者
│           ├── WHEEL OF FORTUNE.png         運命の輪
│           ├── JUSTICE.png                  正義
│           ├── THE HANGED MAN.png           吊された男
│           ├── DEATH.png                    死神
│           ├── TEMPERANCE.png               節制
│           ├── THE DEVIL.png                悪魔
│           ├── THE TOWER.png                塔
│           ├── THE STAR.png                  星
│           ├── THE MOON.png                 月
│           ├── THE SUN.png                  太陽
│           ├── JUDGEMENT.png                審判
│           └── THE WORLD.png                世界
│
├── 📄 index.html                          ルート版（CSSあり、public/を参照）
├── 📄 .gitattributes                      改行コード設定
├── 📄 README.md                           プロジェクト説明
├── 📄 GUEST_CHAT_FLOW_DIAGRAM.md          ゲストチャットフロー図
├── 📄 ファイル構成_簡易版.md               簡易版構成図
├── 📄 プロジェクト構成図.txt               旧構成図
└── 📄 プロフィール.txt                     プロフィール情報
```

## 主要なディレクトリ説明

### 📁 `public/` - メイン制作フォルダ
- Cloudflare Pagesで公開されるメインのフォルダ
- CSSあり版のHTMLファイルとスタイルシート
- 画像・動画などの静的リソース

### 📁 `functions/` - バックエンドAPI
- Cloudflare Pages Functions（サーバーレス関数）
- 認証、会話管理、鑑定APIなど

### 📁 `public/js/` - フロントエンドJavaScript
- 認証状態管理
- チャット機能
- 占い師システム（各キャラクターのロジック）
- **新規追加**: `utils/guardian.js` - 守護神決定ロジック

### 📁 `public/pages/` - ページファイル
- 認証ページ（ログイン、登録）
- チャットページ
- プロフィールページ
- **新規追加**: `guardian-ritual.html` - 守護神の儀式画面

### 📁 `public/photo/` - 画像・動画リソース
- キャラクター画像
- 守護神画像（`kami/`）
- タロットカード画像（`TAROT/`）

### 📁 `database/` - データベース関連
- スキーマ定義
- マイグレーションスクリプト

### 📁 `docs/` - ドキュメント
- 実装メモ
- デバッグ情報
- フロー図など

## 新規追加ファイル（最新）

- ✅ `public/js/utils/guardian.js` - 守護神決定ロジック
- ✅ `public/pages/guardian-ritual.html` - 守護神の儀式画面

## ファイル命名規則

- **HTMLファイル**: ケバブケース（例: `guardian-ritual.html`）
- **JavaScriptファイル**: ケバブケース（例: `auth-state.js`）
- **TypeScriptファイル**: ケバブケース（例: `register.ts`）
- **画像ファイル**: スネークケースまたはケバブケース（例: `kaede.png`, `okuni-nushi.png`）

## 注意事項

- `nocss/` フォルダはCSSなし版（マッチングサイト内システム用）
- 画像パスは `public/photo/` からの相対パスで指定

