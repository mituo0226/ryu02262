<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユーザー管理 - 運命の扉</title>
  <link rel="stylesheet" href="../../css/styles.css">
  <style>
    :root { color-scheme: dark; }
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* ヘッダー（固定） */
    header {
      flex-shrink: 0;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 600;
    }
    
    header .muted {
      color: #9da2c6;
      font-size: 13px;
      margin: 0 0 12px;
    }
    
    .token-input {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .token-input input {
      flex: 1;
      min-width: 300px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 14px;
    }
    
    .token-input input:focus {
      outline: none;
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15);
    }
    
    .token-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .token-input button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .badge.connected {
      background: rgba(0, 200, 120, 0.25);
      color: #90ffc7;
      border-color: rgba(0, 200, 120, 0.4);
    }
    
    /* メインコンテナ（横並び） */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }
    
    /* サイドバー（左側、固定幅） */
    .admin-navigation {
      flex-shrink: 0;
      width: 280px;
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 16px;
    }
    
    .admin-navigation::-webkit-scrollbar {
      width: 6px;
    }
    
    .admin-navigation::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .admin-navigation::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 3px;
    }
    
    .admin-navigation::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    .admin-navigation h2 {
      margin: 0 0 20px;
      font-size: 16px;
      font-weight: 600;
      color: #c7cdff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.25);
      color: #f7f5ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      font-family: inherit;
      position: relative;
    }
    
    .admin-nav-item:hover {
      background: rgba(138, 43, 226, 0.25);
      border-color: rgba(138, 43, 226, 0.4);
      transform: translateX(4px);
    }
    
    .admin-nav-item.active {
      background: rgba(138, 43, 226, 0.4);
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: rgba(138, 43, 226, 0.9);
      border-radius: 0 2px 2px 0;
    }
    
    .admin-nav-url {
      display: block;
      font-size: 11px;
      color: #9da2c6;
      margin-top: 4px;
      opacity: 0.7;
    }
    
    /* コンテンツエリア（右側、スクロール可能） */
    .content-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: rgba(0, 0, 0, 0.2);
      min-width: 0;
    }
    
    .content-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .content-area::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .content-area::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 4px;
    }
    
    .content-area::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    /* モバイル版: ナビゲーションを上部に横並び */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        width: 100%;
        flex-direction: row;
        gap: 8px;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      
      .admin-navigation h2 {
        display: none;
      }
      
      .admin-nav-item {
        flex: 0 0 auto;
        min-width: 140px;
        white-space: nowrap;
        padding: 10px 14px;
        font-size: 13px;
        margin-bottom: 0;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-item.active::before {
        display: none;
      }
      
      .admin-nav-url {
        display: none;
      }
    }
    
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }
    main {
      flex: 1;
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 4vw, 28px); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label {
      font-size: 13px;
      color: #bfc4ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    textarea { min-height: 140px; }
    button, .button-link {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    button:hover, .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(138, 43, 226, 0.35);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
      vertical-align: top;
    }
    th { font-weight: 600; color: #c7cdff; }
    
    .dashboard-columns {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .column-left,
    .column-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #resultSummary {
      margin-bottom: 10px;
    }
    .detail-card.hidden,
    .conversation-card.hidden {
      display: none;
    }
    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .conversation-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 14px;
      color: #f7f5ff;
    }
    .conversation-item summary {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }
    .conversation-item summary::-webkit-details-marker {
      display: none;
    }
    .conversation-meta {
      font-size: 12px;
      color: #c7cff5;
    }
    .conversation-body {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    @media (max-width: 768px) {
      table { font-size: 12px; }
      .dashboard-layout { padding: 0 16px 32px; }
      
      /* モバイル: ナビゲーションを上部に */
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        min-width: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .admin-navigation h2 {
        width: 100%;
        margin: 0 0 12px;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-url {
        display: none; /* モバイルではURLを非表示 */
      }
    }
    @media (min-width: 769px) {
      /* PC: ナビゲーションを左側に */
      .main-container {
        flex-direction: row;
      }
    }
    @media (min-width: 960px) {
      .dashboard-columns {
        flex-direction: row;
        align-items: flex-start;
        gap: 24px;
      }
      .column-left {
        width: 45%;
        max-width: 520px;
      }
      .column-right {
        flex: 1;
      }
    }
    .token-input { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .token-input input { flex: 1; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }
    .list-scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: linear-gradient(135deg, rgba(255, 78, 132, 0.9), rgba(255, 130, 0, 0.8)); }
    .muted { color: #9da2c6; font-size: 12px; }
    
    /* タブ機能 */
    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    /* PC版: 左側に配置 */
    @media (min-width: 769px) {
      .admin-tabs {
        justify-content: flex-start;
        align-items: flex-start;
        padding-left: 20px;
      }
    }
    
    .admin-tab {
      padding: 12px 24px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: #f7f5ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .admin-tab:hover {
      background: rgba(138, 43, 226, 0.3);
    }
    
    .admin-tab.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .tab-content {
      display: none;
      height: 100%;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>ユーザー管理ダッシュボード</h1>
    <p class="muted">管理操作用のパスコード（X-Admin-Token）を入力して接続してください。</p>
    <div class="token-input">
      <input type="password" id="adminToken" placeholder="管理者トークン">
      <button id="connectButton">接続</button>
      <span id="connectionStatus" class="badge">未接続</span>
    </div>
  </header>

  <div class="main-container">
    <!-- ナビゲーション（PC: 左側、モバイル: 上部） -->
    <nav class="admin-navigation">
      <h2>管理メニュー</h2>
      <button class="admin-nav-item active" data-tab="user-search">
        ユーザー検索
        <div class="admin-nav-url">ユーザーの検索・管理</div>
      </button>
      <button class="admin-nav-item" data-tab="guest-sessions">
        ゲストセッション管理
        <div class="admin-nav-url">ゲストユーザーの履歴管理</div>
      </button>
    </nav>
    
    <!-- メインコンテンツエリア -->
    <div class="content-area">

      <!-- ユーザー検索タブ -->
      <div class="tab-content active" id="user-search-tab">
      <div class="dashboard-layout">
        <div class="dashboard-columns">
      <div class="column-left">
        <section class="card">
          <h2>ユーザー検索</h2>
          <form id="searchForm">
            <label>ニックネーム
              <input type="text" id="searchNickname" placeholder="部分一致で検索できます">
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">年
                <input type="number" id="searchYear" min="1900" max="2100" placeholder="例: 1990">
              </label>
              <label style="flex:1;">月
                <input type="number" id="searchMonth" min="1" max="12" placeholder="1-12">
              </label>
              <label style="flex:1;">日
                <input type="number" id="searchDay" min="1" max="31" placeholder="1-31">
              </label>
            </div>
            <div class="actions">
              <button type="submit">検索する</button>
              <button type="button" id="resetSearchButton">条件をクリア</button>
            </div>
            <p class="muted">※ニックネーム / 生年月日のいずれか一つだけでも検索可能です。空のまま検索すると全ユーザーが表示されます。</p>
          </form>
        </section>

        <section class="card">
          <h2>検索結果</h2>
          <div id="resultSummary" class="muted">検索結果 0 件</div>
          <div class="list-scroll">
            <table>
              <thead>
                <tr>
                  <th>ユーザータイプ</th>
                  <th>ID</th>
                  <th>識別情報</th>
                  <th>誕生日</th>
                  <th>合言葉</th>
                  <th>守護神</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="7" class="muted">接続して読み込み...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-right">
        <section class="card detail-card hidden" id="detailCard">
          <h2>ユーザー情報</h2>
          <p class="muted" id="selectedUserLabel"></p>
          <form id="userForm">
            <input type="hidden" id="formUserId">
            <label>ニックネーム
              <input type="text" id="formNickname" required>
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">年
                <input type="number" id="formYear" min="1900" max="2100" required>
              </label>
              <label style="flex:1;">月
                <input type="number" id="formMonth" min="1" max="12" required>
              </label>
              <label style="flex:1;">日
                <input type="number" id="formDay" min="1" max="31" required>
              </label>
            </div>
            <label>合言葉
              <select id="formPassphrase"></select>
            </label>
            <label>守護神
              <select id="formGuardian">
                <option value="">未決定</option>
                <option value="天照大神">天照大神</option>
                <option value="大国主命">大国主命</option>
                <option value="大日如来">大日如来</option>
                <option value="千手観音">千手観音</option>
                <option value="不動明王">不動明王</option>
              </select>
            </label>
            <div class="actions">
              <button type="submit">更新する</button>
              <button type="button" class="danger" id="deleteUserButton">退会（削除）</button>
            </div>
            <p class="muted" id="formStatus"></p>
          </form>
        </section>

        <section class="card conversation-card hidden" id="conversationCard">
          <h2>会話履歴（最新100件）</h2>
          <div id="conversationList" class="conversation-list">
            <p class="muted">ユーザーを選択すると会話履歴を表示します。</p>
          </div>
        </section>
      </div>
    </div>
    </div>
      </div>

      <!-- ゲストセッション管理タブ -->
      <div class="tab-content" id="guest-sessions-tab">
        <div class="dashboard-layout">
          <section class="card">
            <h2>ゲストセッション管理</h2>
            <p class="muted">ゲストユーザーのセッションと会話履歴を管理します。セッションIDまたはIPアドレスで検索できます。</p>
            
            <div style="margin-bottom: 20px;">
              <form id="guestSessionSearchForm" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                  <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #9da2c6;">セッションID</label>
                  <input type="text" id="searchSessionId" placeholder="セッションIDで検索" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.4); color: #fff; font-size: 14px;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                  <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #9da2c6;">IPアドレス</label>
                  <input type="text" id="searchIpAddress" placeholder="IPアドレスで検索" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.4); color: #fff; font-size: 14px;">
                </div>
                <div style="flex: 1; min-width: 200px;">
                  <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #9da2c6;">鑑定師</label>
                  <select id="searchCharacterId" style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.4); color: #fff; font-size: 14px;">
                    <option value="">すべて</option>
                    <option value="kaede">楓</option>
                    <option value="yukino">笹岡雪乃</option>
                    <option value="sora">水野ソラ</option>
                    <option value="kaon">三崎花音</option>
                  </select>
                </div>
                <div>
                  <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9)); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    検索
                  </button>
                </div>
                <div>
                  <button type="button" id="refreshGuestSessionsBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(138, 43, 226, 0.3); border: 1px solid rgba(138, 43, 226, 0.5); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    最新20件を表示
                  </button>
                </div>
              </form>
            </div>

            <div style="margin-bottom: 20px; padding: 16px; background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 8px;">
              <h3 style="margin: 0 0 12px; font-size: 16px; color: #ff6b6b;">一括操作</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="button" id="clearAllGuestSessionsBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(220, 38, 38, 0.3); border: 1px solid rgba(220, 38, 38, 0.5); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                  全ゲストセッションを削除
                </button>
                <div style="flex: 1; min-width: 200px; display: flex; gap: 8px;">
                  <input type="text" id="quickDeleteSessionId" placeholder="セッションIDを入力して削除" style="flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0, 0, 0, 0.4); color: #fff; font-size: 14px;">
                  <button type="button" id="quickDeleteSessionBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(220, 38, 38, 0.3); border: 1px solid rgba(220, 38, 38, 0.5); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    削除
                  </button>
                </div>
              </div>
              <p class="muted" style="margin: 8px 0 0; font-size: 12px;">⚠️ 削除操作は取り消せません。実行前に確認してください。</p>
            </div>

            <div id="guestSessionList" style="margin-top: 20px;">
              <p class="muted">検索ボタンをクリックするか、「最新20件を表示」をクリックしてください。</p>
            </div>
          </section>

          <section class="card hidden" id="guestSessionDetailCard">
            <h2>セッション詳細</h2>
            <div id="guestSessionDetail" style="margin-bottom: 20px;">
              <!-- セッション詳細情報 -->
            </div>
            <div style="display: flex; gap: 12px;">
              <button id="viewGuestConversationsBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(138, 43, 226, 0.3); border: 1px solid rgba(138, 43, 226, 0.5); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">
                会話履歴を表示
              </button>
              <button id="deleteGuestSessionBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: rgba(220, 38, 38, 0.3); border: 1px solid rgba(220, 38, 38, 0.5); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer;">
                セッションと履歴を削除
              </button>
            </div>
          </section>

          <section class="card hidden" id="guestConversationsCard">
            <h2>会話履歴</h2>
            <div id="guestConversationsList" style="margin-top: 20px;">
              <p class="muted">読み込み中...</p>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ナビゲーションのアクティブ状態を設定
    (function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.admin-nav-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/admin/') && href === 'dashboard.html')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    })();
    
    const adminTokenInput = document.getElementById('adminToken');
    const connectButton = document.getElementById('connectButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const userTableBody = document.getElementById('userTableBody');
    const form = document.getElementById('userForm');
    const formUserId = document.getElementById('formUserId');
    const formNickname = document.getElementById('formNickname');
    const formYear = document.getElementById('formYear');
    const formMonth = document.getElementById('formMonth');
    const formDay = document.getElementById('formDay');
    const formPassphrase = document.getElementById('formPassphrase');
    const formGuardian = document.getElementById('formGuardian');
    const formStatus = document.getElementById('formStatus');
    const deleteUserButton = document.getElementById('deleteUserButton');
    const searchForm = document.getElementById('searchForm');
    const searchNickname = document.getElementById('searchNickname');
    const searchYear = document.getElementById('searchYear');
    const searchMonth = document.getElementById('searchMonth');
    const searchDay = document.getElementById('searchDay');
    const resetSearchButton = document.getElementById('resetSearchButton');
    const resultSummary = document.getElementById('resultSummary');
    const detailCard = document.getElementById('detailCard');
    const selectedUserLabel = document.getElementById('selectedUserLabel');
    const conversationCard = document.getElementById('conversationCard');
    const conversationList = document.getElementById('conversationList');

    const deities = [
      '桜舞い散る春の道',
      '月明かりに浮かぶ夢',
      '星降る夜の物語',
      '朝露に光る希望',
      '夕焼けのやさしさ',
      '虹の架け橋',
      '春風に揺れる花',
      '雪化粧の静けさ',
      '風鈴の涼しい音',
      '蝉しぐれの夏',
      '紅葉散る小道',
      '初雪の贈り物',
      '菜の花畑の春',
      '蛍舞う夕べ',
      '雲海に浮かぶ夢',
      '波の音の子守歌',
      '霧雨の潤い',
      '落葉の敷き毯',
      '春霞の揺らぎ',
      '小鳥のさえずり',
      '小川のせせらぎ',
      '野原の風車',
      '藤色の花',
      '金色の稲穂'
    ];
    deities.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      formPassphrase.appendChild(option);
    });

    let currentToken = '';
    let users = [];
    let guestSessions = [];
    let filteredUsers = [];
    let selectedUserId = null;
    let selectedGuestSessionId = null;

    function hideDetailSections() {
      detailCard.classList.add('hidden');
      conversationCard.classList.add('hidden');
      conversationList.innerHTML = '<p class="muted">ユーザーを選択すると会話履歴を表示します。</p>';
      selectedUserLabel.textContent = '';
      formStatus.textContent = '';
      selectedUserId = null;
    }

    function showDetailSections(user) {
      detailCard.classList.remove('hidden');
      conversationCard.classList.remove('hidden');
      selectedUserLabel.textContent = `ID: ${user.id} / ${user.nickname} / ${user.birth_year}年${user.birth_month}月${user.birth_day}日`;
    }

    hideDetailSections();

    function setStatus(message, success = false) {
      connectionStatus.textContent = message;
      connectionStatus.style.background = success ? 'rgba(0,120,86,0.4)' : 'rgba(138,43,226,0.2)';
    }

    async function fetchUsers() {
      try {
        // 登録ユーザーを取得
        const usersRes = await fetch('/api/admin/users', {
          headers: { 'X-Admin-Token': currentToken },
        });
        const usersData = await usersRes.json();
        if (!usersRes.ok) throw new Error(usersData.error || '取得に失敗しました');
        users = usersData.users || [];

        // ゲストセッションを取得
        try {
          const guestRes = await fetch('/api/admin/clear-guest-sessions', {
            headers: { 'X-Admin-Token': currentToken },
          });
          const guestData = await guestRes.json();
          if (guestRes.ok && guestData.sessions) {
            guestSessions = guestData.sessions.map(session => ({
              id: session.id,
              session_id: session.session_id,
              ip_address: session.ip_address,
              message_count: session.message_count || 0,
              created_at: session.created_at,
              last_activity_at: session.last_activity_at,
              isGuest: true
            }));
          }
        } catch (guestError) {
          console.warn('ゲストセッションの取得に失敗:', guestError);
          guestSessions = [];
        }

        applyFilters();
        renderUsers();
        hideDetailSections();
        setStatus('接続済み', true);
      } catch (error) {
        console.error(error);
        setStatus('接続エラー');
        userTableBody.innerHTML = `<tr><td colspan="7" class="muted">${error.message}</td></tr>`;
      }
    }

    function applyFilters() {
      const nickname = searchNickname.value.trim();
      const yearValue = searchYear.value.trim();
      const monthValue = searchMonth.value.trim();
      const dayValue = searchDay.value.trim();

      const hasNickname = nickname.length > 0;
      const hasYear = yearValue.length > 0;
      const hasMonth = monthValue.length > 0;
      const hasDay = dayValue.length > 0;

      // 登録ユーザーのフィルタリング
      let filteredRegisteredUsers = users;
      if (hasNickname || hasYear || hasMonth || hasDay) {
        const year = Number(yearValue);
        const month = Number(monthValue);
        const day = Number(dayValue);

        filteredRegisteredUsers = users.filter((user) => {
          const nicknameMatch = hasNickname ? user.nickname.includes(nickname) : true;
          const yearMatch = hasYear ? user.birth_year === year : true;
          const monthMatch = hasMonth ? user.birth_month === month : true;
          const dayMatch = hasDay ? user.birth_day === day : true;
          return nicknameMatch && yearMatch && monthMatch && dayMatch;
        });
      }

      // ゲストセッションのフィルタリング（IPアドレスやセッションIDで検索可能）
      let filteredGuestSessions = guestSessions;
      if (hasNickname) {
        // ニックネーム検索はゲストには適用しない（セッションIDやIPアドレスで検索）
        filteredGuestSessions = guestSessions.filter(session => 
          (session.session_id && session.session_id.includes(nickname)) ||
          (session.ip_address && session.ip_address.includes(nickname))
        );
      }

      // 登録ユーザーとゲストセッションを結合
      filteredUsers = [
        ...filteredRegisteredUsers.map(u => ({ ...u, isGuest: false })),
        ...filteredGuestSessions
      ];
    }

    function renderUsers(list = filteredUsers) {
      resultSummary.textContent = `検索結果 ${list.length} 件（登録: ${list.filter(u => !u.isGuest).length}件、ゲスト: ${list.filter(u => u.isGuest).length}件）`;
      if (!list.length) {
        userTableBody.innerHTML = '<tr><td colspan="7" class="muted">ユーザーが見つかりません。</td></tr>';
        return;
      }
      
      userTableBody.innerHTML = list.map((user) => {
        if (user.isGuest) {
          // ゲストユーザーの表示
          const sessionIdShort = user.session_id ? user.session_id.substring(0, 16) + '...' : 'N/A';
          return `
            <tr style="background: rgba(138, 43, 226, 0.05);">
              <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(138, 43, 226, 0.3); color: #d6c9ff;">ゲスト</span></td>
              <td>${user.id}</td>
              <td style="font-size: 11px;">
                <div style="font-family: monospace; color: #d6c9ff;">セッション: ${sessionIdShort}</div>
                <div style="color: #9da2c6; margin-top: 4px;">IP: ${user.ip_address || 'N/A'}</div>
                <div style="color: #9da2c6; margin-top: 2px;">メッセージ: ${user.message_count || 0}件</div>
              </td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td><button class="button-link" data-guest-session-id="${user.id}" data-session-id="${user.session_id}">詳細</button></td>
            </tr>
          `;
        } else {
          // 登録ユーザーの表示
          return `
            <tr>
              <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(0, 120, 86, 0.3); color: #7dd3a0;">登録</span></td>
              <td>${user.id}</td>
              <td>${user.nickname}</td>
              <td>${user.birth_year}/${user.birth_month}/${user.birth_day}</td>
              <td>${user.passphrase || '未設定'}</td>
              <td>${user.guardian || '未決定'}</td>
              <td><button class="button-link" data-user-id="${user.id}">選択</button></td>
            </tr>
          `;
        }
      }).join('');
    }

    userTableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target.matches('[data-user-id]')) {
        // 登録ユーザーを選択
        const id = Number(target.dataset.userId);
        const user = users.find((u) => u.id === id);
        if (user) {
          populateForm(user);
          fetchConversations(id);
          selectedUserId = id;
          selectedGuestSessionId = null;
        }
      } else if (target.matches('[data-guest-session-id]')) {
        // ゲストセッションを選択
        const sessionId = target.dataset.sessionId;
        const guestId = Number(target.dataset.guestSessionId);
        selectedGuestSessionId = guestId;
        selectedUserId = null;
        
        // ゲストセッション管理タブに切り替え
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector('[data-tab="guest-sessions"]')?.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('guest-sessions-tab')?.classList.add('active');
        
        // ゲストセッションを選択状態にする
        if (window.selectGuestSession) {
          const guestSession = guestSessions.find(s => s.id === guestId);
          if (guestSession) {
            window.selectGuestSession(guestSession.id, guestSession.session_id, guestSession.ip_address || '', guestSession.message_count || 0);
          }
        }
        
        // ゲストセッションの会話履歴を表示
        if (viewGuestConversationsBtn) {
          setTimeout(() => {
            viewGuestConversationsBtn.click();
          }, 100);
        }
      }
    });

    function populateForm(user) {
      formUserId.value = user.id;
      formNickname.value = user.nickname;
      formYear.value = user.birth_year;
      formMonth.value = user.birth_month;
      formDay.value = user.birth_day;
      formPassphrase.value = user.passphrase || '';
      formGuardian.value = user.guardian || '';
      formStatus.textContent = '';
      selectedUserId = user.id;
      showDetailSections(user);
    }

    function renderConversationList(records) {
      if (!records.length) {
        conversationList.innerHTML = '<p class="muted">会話履歴はまだありません。</p>';
        return;
      }
      conversationList.innerHTML = records.map((item, index) => {
        const title = `[${item.character_id}] ${item.role === 'assistant' ? '鑑定士' : '相談者'} / ${new Date(item.created_at).toLocaleString('ja-JP')}`;
        const safeContent = item.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <details class="conversation-item" ${index === 0 ? 'open' : ''}>
            <summary>
              <span>${title}</span>
              <span class="conversation-meta">#${records.length - index}</span>
            </summary>
            <div class="conversation-body">${safeContent}</div>
          </details>
        `;
      }).join('');
    }

    async function fetchConversations(userId) {
      conversationList.innerHTML = '<p class="muted">読み込み中...</p>';
      try {
        const res = await fetch(`/api/admin/conversations?userId=${userId}`, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '会話履歴の取得に失敗しました');
        renderConversationList(data.conversations || []);
      } catch (error) {
        conversationList.innerHTML = `<p class="muted">${error.message}</p>`;
      }
    }

    connectButton.addEventListener('click', () => {
      currentToken = adminTokenInput.value.trim();
      if (!currentToken) {
        setStatus('トークンを入力してください');
        return;
      }
      fetchUsers();
    });

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
      renderUsers();
      hideDetailSections();
    });

    resetSearchButton.addEventListener('click', () => {
      searchForm.reset();
      filteredUsers = [...users];
      renderUsers();
      hideDetailSections();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formUserId.value) {
        formStatus.textContent = 'ユーザーを選択してください。';
        return;
      }
      const payload = {
        id: Number(formUserId.value),
        nickname: formNickname.value.trim(),
        birthYear: Number(formYear.value),
        birthMonth: Number(formMonth.value),
        birthDay: Number(formDay.value),
        passphrase: formPassphrase.value,
        guardian: formGuardian.value || null,
      };
      try {
        const res = await fetch('/api/admin/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': currentToken,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '更新に失敗しました');
        formStatus.textContent = '更新しました。';
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    deleteUserButton.addEventListener('click', async () => {
      if (!formUserId.value) {
        formStatus.textContent = 'ユーザーを選択してください。';
        return;
      }
      if (!confirm('本当に退会処理を行いますか？会話履歴も削除されます。')) {
        return;
      }
      try {
        const res = await fetch(`/api/admin/users?id=${formUserId.value}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '削除に失敗しました');
        formStatus.textContent = '削除しました。';
        form.reset();
        hideDetailSections();
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    // ============================================
    // タブ切り替え機能（管理メニューから）
    // ============================================
    document.querySelectorAll('.admin-nav-item').forEach(navItem => {
      navItem.addEventListener('click', () => {
        const targetTab = navItem.dataset.tab;
        if (!targetTab) return;
        
        // ナビゲーションボタンのアクティブ状態を更新
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');
        
        // コンテンツの表示を切り替え
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const targetContent = document.getElementById(`${targetTab}-tab`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        if (targetTab === 'guest-sessions') {
          renderGuestSessionsView();
        } else {
          hideDetailSections(); // ユーザー検索タブに戻ったら詳細を隠す
        }
      });
    });
    
    // ============================================
    // ゲストセッション管理機能
    // ============================================
    const guestSessionSearchForm = document.getElementById('guestSessionSearchForm');
    const searchSessionId = document.getElementById('searchSessionId');
    const searchIpAddress = document.getElementById('searchIpAddress');
    const searchCharacterId = document.getElementById('searchCharacterId');
    const refreshGuestSessionsBtn = document.getElementById('refreshGuestSessionsBtn');
    const guestSessionList = document.getElementById('guestSessionList');
    const guestSessionDetailCard = document.getElementById('guestSessionDetailCard');
    const guestSessionDetail = document.getElementById('guestSessionDetail');
    const guestConversationsCard = document.getElementById('guestConversationsCard');
    const guestConversationsList = document.getElementById('guestConversationsList');
    const viewGuestConversationsBtn = document.getElementById('viewGuestConversationsBtn');
    const deleteGuestSessionBtn = document.getElementById('deleteGuestSessionBtn');

    let selectedGuestSession = null;

    function renderGuestSessionsView() {
      // 初期状態にリセット
      if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');
      if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
      selectedGuestSession = null;
      if (guestSessionList) guestSessionList.innerHTML = '<p class="muted">検索ボタンをクリックするか、「最新20件を表示」をクリックしてください。</p>';
    }

    async function fetchGuestSessions(ipAddress = null, sessionId = null, characterId = null) {
      if (!currentToken) {
        if (guestSessionList) guestSessionList.innerHTML = '<p class="muted" style="color: #ff6b6b;">管理者トークンを入力して接続してください。</p>';
        return;
      }

      try {
        let url = '/api/admin/clear-guest-sessions';
        const params = [];
        
        if (sessionId) {
          params.push(`sessionId=${encodeURIComponent(sessionId)}`);
        } else if (ipAddress) {
          params.push(`ipAddress=${encodeURIComponent(ipAddress)}`);
        } else if (characterId) {
          params.push(`characterId=${encodeURIComponent(characterId)}`);
        }
        
        if (params.length > 0) {
          url += '?' + params.join('&');
        }

        const res = await fetch(url, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '取得に失敗しました');

        const sessions = data.sessions || [];
        renderGuestSessionList(sessions);
      } catch (error) {
        console.error(error);
        if (guestSessionList) guestSessionList.innerHTML = `<p class="muted" style="color: #ff6b6b;">${error.message}</p>`;
      }
    }

    function renderGuestSessionList(sessions) {
      if (!guestSessionList) return;
      
      if (!sessions || sessions.length === 0) {
        guestSessionList.innerHTML = '<p class="muted">該当するセッションが見つかりませんでした。</p>';
        return;
      }

      guestSessionList.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">セッションID</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">IPアドレス</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">メッセージ数</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">作成日時</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">最終活動</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #9da2c6;">操作</th>
              </tr>
            </thead>
            <tbody>
              ${sessions.map(session => `
                <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer;" 
                    onclick="selectGuestSession(${session.id}, '${(session.session_id || '').replace(/'/g, "\\'")}', '${(session.ip_address || '').replace(/'/g, "\\'")}', ${session.message_count || 0})">
                  <td style="padding: 12px; font-size: 12px; font-family: monospace; color: #d6c9ff;">${session.session_id || 'N/A'}</td>
                  <td style="padding: 12px; font-size: 12px; color: #e8d5ff;">${session.ip_address || 'N/A'}</td>
                  <td style="padding: 12px; font-size: 12px; color: #e8d5ff;">${session.message_count || 0}</td>
                  <td style="padding: 12px; font-size: 12px; color: #9da2c6;">${session.created_at ? new Date(session.created_at).toLocaleString('ja-JP') : 'N/A'}</td>
                  <td style="padding: 12px; font-size: 12px; color: #9da2c6;">${session.last_activity_at ? new Date(session.last_activity_at).toLocaleString('ja-JP') : 'N/A'}</td>
                  <td style="padding: 12px;">
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                      <button onclick="event.stopPropagation(); selectGuestSession(${session.id}, '${(session.session_id || '').replace(/'/g, "\\'")}', '${(session.ip_address || '').replace(/'/g, "\\'")}', ${session.message_count || 0})" 
                              style="padding: 6px 12px; font-size: 12px; background: rgba(138, 43, 226, 0.3); border: 1px solid rgba(138, 43, 226, 0.5); border-radius: 6px; color: #fff; cursor: pointer;">
                        詳細
                      </button>
                      <button onclick="event.stopPropagation(); viewGuestSessionHistory(${session.id}, '${(session.session_id || '').replace(/'/g, "\\'")}')" 
                              style="padding: 6px 12px; font-size: 12px; background: rgba(75, 0, 129, 0.3); border: 1px solid rgba(75, 0, 129, 0.5); border-radius: 6px; color: #fff; cursor: pointer;">
                        履歴
                      </button>
                      <button onclick="event.stopPropagation(); quickDeleteGuestSession('${(session.session_id || '').replace(/'/g, "\\'")}', ${session.id})" 
                              style="padding: 6px 12px; font-size: 12px; background: rgba(220, 38, 38, 0.3); border: 1px solid rgba(220, 38, 38, 0.5); border-radius: 6px; color: #fff; cursor: pointer;">
                        削除
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    window.selectGuestSession = function(sessionId, sessionIdStr, ipAddress, messageCount) {
      selectedGuestSession = {
        id: sessionId,
        session_id: sessionIdStr,
        ip_address: ipAddress,
        message_count: messageCount
      };

      if (!guestSessionDetail) return;

      guestSessionDetail.innerHTML = `
        <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 16px;">
          <div style="margin-bottom: 12px;">
            <strong style="color: #9da2c6; font-size: 12px;">セッションID:</strong>
            <div style="font-family: monospace; color: #d6c9ff; margin-top: 4px; word-break: break-all;">${sessionIdStr}</div>
          </div>
          <div style="margin-bottom: 12px;">
            <strong style="color: #9da2c6; font-size: 12px;">IPアドレス:</strong>
            <div style="color: #e8d5ff; margin-top: 4px;">${ipAddress || 'N/A'}</div>
          </div>
          <div style="margin-bottom: 12px;">
            <strong style="color: #9da2c6; font-size: 12px;">メッセージ数:</strong>
            <div style="color: #e8d5ff; margin-top: 4px;">${messageCount} 件</div>
          </div>
        </div>
      `;

      if (guestSessionDetailCard) guestSessionDetailCard.classList.remove('hidden');
      if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
    };

    if (guestSessionSearchForm) {
      guestSessionSearchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const sessionId = searchSessionId ? searchSessionId.value.trim() : '';
        const ipAddress = searchIpAddress ? searchIpAddress.value.trim() : '';
        const characterId = searchCharacterId ? searchCharacterId.value.trim() : '';
        
        if (!sessionId && !ipAddress && !characterId) {
          alert('セッションID、IPアドレス、または鑑定師を選択してください。');
          return;
        }

        await fetchGuestSessions(ipAddress || null, sessionId || null, characterId || null);
      });
    }

    if (refreshGuestSessionsBtn) {
      refreshGuestSessionsBtn.addEventListener('click', async () => {
        if (searchSessionId) searchSessionId.value = '';
        if (searchIpAddress) searchIpAddress.value = '';
        if (searchCharacterId) searchCharacterId.value = '';
        await fetchGuestSessions();
      });
    }

    // ゲストセッションの会話履歴を直接表示する関数
    window.viewGuestSessionHistory = async function(sessionId, sessionIdStr) {
      if (!currentToken) {
        alert('管理者トークンを入力して接続してください。');
        return;
      }

      if (!guestConversationsList) return;
      guestConversationsList.innerHTML = '<p class="muted">読み込み中...</p>';
      if (guestConversationsCard) guestConversationsCard.classList.remove('hidden');
      if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');

      try {
        const res = await fetch(`/api/admin/conversations?userId=${sessionId}`, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '会話履歴の取得に失敗しました');

        const conversations = data.conversations || [];
        renderGuestConversations(conversations, sessionIdStr);
      } catch (error) {
        console.error(error);
        if (guestConversationsList) guestConversationsList.innerHTML = `<p class="muted" style="color: #ff6b6b;">${error.message}</p>`;
      }
    };

    if (viewGuestConversationsBtn) {
      viewGuestConversationsBtn.addEventListener('click', async () => {
        if (!selectedGuestSession) {
          alert('セッションを選択してください。');
          return;
        }

        if (!currentToken) {
          alert('管理者トークンを入力して接続してください。');
          return;
        }

        if (!guestConversationsList) return;
        guestConversationsList.innerHTML = '<p class="muted">読み込み中...</p>';
        if (guestConversationsCard) guestConversationsCard.classList.remove('hidden');

        try {
          // 会話履歴を取得（conversations APIを使用）
          const res = await fetch(`/api/admin/conversations?userId=${selectedGuestSession.id}`, {
            headers: { 'X-Admin-Token': currentToken },
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '会話履歴の取得に失敗しました');

          const conversations = data.conversations || [];
          renderGuestConversations(conversations, selectedGuestSession.session_id);
        } catch (error) {
          console.error(error);
          if (guestConversationsList) guestConversationsList.innerHTML = `<p class="muted" style="color: #ff6b6b;">${error.message}</p>`;
        }
      });
    }

    function renderGuestConversations(conversations, sessionIdStr = null) {
      if (!guestConversationsList) return;
      
      if (!conversations || conversations.length === 0) {
        guestConversationsList.innerHTML = '<p class="muted">会話履歴がありません。</p>';
        return;
      }

      const characterNames = {
        'kaede': '楓',
        'yukino': '笹岡雪乃',
        'sora': '水野ソラ',
        'kaon': '三崎花音'
      };

      guestConversationsList.innerHTML = `
        ${sessionIdStr ? `<div style="margin-bottom: 16px; padding: 12px; background: rgba(138, 43, 226, 0.1); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 8px;">
          <strong style="color: #d6c9ff; font-size: 13px;">セッションID:</strong>
          <div style="font-family: monospace; color: #e8d5ff; margin-top: 4px; word-break: break-all; font-size: 12px;">${sessionIdStr}</div>
        </div>` : ''}
        <div style="max-height: 600px; overflow-y: auto;">
          ${conversations.map(conv => {
            const message = (conv.message || conv.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const characterName = characterNames[conv.character_id] || conv.character_id || '';
            return `
            <div style="margin-bottom: 16px; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                  <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; 
                      background: ${conv.role === 'user' ? 'rgba(138, 43, 226, 0.3)' : 'rgba(75, 0, 129, 0.3)'}; 
                      color: ${conv.role === 'user' ? '#d6c9ff' : '#b794ff'};">
                    ${conv.role === 'user' ? 'ユーザー' : 'アシスタント'}
                  </span>
                  ${characterName ? `<span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; background: rgba(138, 43, 226, 0.2); color: #b794ff;">
                    ${characterName}
                  </span>` : ''}
                </div>
                <span style="font-size: 11px; color: #9da2c6;">
                  ${conv.timestamp ? new Date(conv.timestamp).toLocaleString('ja-JP') : 'N/A'}
                </span>
              </div>
              <div style="color: #e8d5ff; font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${message}</div>
            </div>
          `;
          }).join('')}
        </div>
      `;
    }

    if (deleteGuestSessionBtn) {
      deleteGuestSessionBtn.addEventListener('click', async () => {
        if (!selectedGuestSession) {
          alert('セッションを選択してください。');
          return;
        }

        if (!currentToken) {
          alert('管理者トークンを入力して接続してください。');
          return;
        }

        if (!confirm(`セッションID: ${selectedGuestSession.session_id}\n\nこのセッションとすべての会話履歴を削除しますか？\nこの操作は取り消せません。`)) {
          return;
        }

        try {
          const res = await fetch('/api/admin/clear-guest-sessions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': currentToken,
            },
            body: JSON.stringify({
              sessionId: selectedGuestSession.session_id,
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '削除に失敗しました');

          alert(`削除しました。\n削除されたセッション: ${data.deletedSessions || 0}件\n削除されたメッセージ: ${data.deletedMessages || 0}件`);
          
          // 表示をリセット
          if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');
          if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
          selectedGuestSession = null;
          
          // リストを更新
          await fetchGuestSessions();
        } catch (error) {
          console.error(error);
          alert(`削除に失敗しました: ${error.message}`);
        }
      });
    }

    // 一括削除機能
    const clearAllGuestSessionsBtn = document.getElementById('clearAllGuestSessionsBtn');
    if (clearAllGuestSessionsBtn) {
      clearAllGuestSessionsBtn.addEventListener('click', async () => {
        if (!currentToken) {
          alert('管理者トークンを入力して接続してください。');
          return;
        }

        if (!confirm('⚠️ 警告\n\nすべてのゲストセッションと会話履歴を削除します。\nこの操作は取り消せません。\n\n本当に実行しますか？')) {
          return;
        }

        if (!confirm('最後の確認です。\n\n本当にすべてのゲストセッションを削除しますか？')) {
          return;
        }

        try {
          const res = await fetch('/api/admin/clear-guest-sessions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': currentToken,
            },
            body: JSON.stringify({
              clearAll: true,
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '削除に失敗しました');

          alert(`削除しました。\n削除されたセッション: ${data.deletedSessions || 0}件\n削除されたメッセージ: ${data.deletedMessages || 0}件`);
          
          // 表示をリセット
          if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');
          if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
          selectedGuestSession = null;
          
          // リストを更新
          await fetchGuestSessions();
        } catch (error) {
          console.error(error);
          alert(`削除に失敗しました: ${error.message}`);
        }
      });
    }

    // クイック削除機能（セッションID入力）
    const quickDeleteSessionId = document.getElementById('quickDeleteSessionId');
    const quickDeleteSessionBtn = document.getElementById('quickDeleteSessionBtn');
    if (quickDeleteSessionBtn) {
      quickDeleteSessionBtn.addEventListener('click', async () => {
        if (!currentToken) {
          alert('管理者トークンを入力して接続してください。');
          return;
        }

        const sessionId = quickDeleteSessionId ? quickDeleteSessionId.value.trim() : '';
        if (!sessionId) {
          alert('セッションIDを入力してください。');
          return;
        }

        if (!confirm(`セッションID: ${sessionId}\n\nこのセッションとすべての会話履歴を削除しますか？\nこの操作は取り消せません。`)) {
          return;
        }

        try {
          const res = await fetch('/api/admin/clear-guest-sessions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': currentToken,
            },
            body: JSON.stringify({
              sessionId: sessionId,
            }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '削除に失敗しました');

          alert(`削除しました。\n削除されたセッション: ${data.deletedSessions || 0}件\n削除されたメッセージ: ${data.deletedMessages || 0}件`);
          
          // 入力欄をクリア
          if (quickDeleteSessionId) quickDeleteSessionId.value = '';
          
          // 表示をリセット
          if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');
          if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
          selectedGuestSession = null;
          
          // リストを更新
          await fetchGuestSessions();
        } catch (error) {
          console.error(error);
          alert(`削除に失敗しました: ${error.message}`);
        }
      });
    }

    // セッションリストからのクイック削除
    window.quickDeleteGuestSession = async function(sessionId, sessionDbId) {
      if (!currentToken) {
        alert('管理者トークンを入力して接続してください。');
        return;
      }

      if (!confirm(`セッションID: ${sessionId}\n\nこのセッションとすべての会話履歴を削除しますか？\nこの操作は取り消せません。`)) {
        return;
      }

      try {
        const res = await fetch('/api/admin/clear-guest-sessions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': currentToken,
          },
          body: JSON.stringify({
            sessionId: sessionId,
          }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '削除に失敗しました');

        alert(`削除しました。\n削除されたセッション: ${data.deletedSessions || 0}件\n削除されたメッセージ: ${data.deletedMessages || 0}件`);
        
        // 表示をリセット
        if (guestSessionDetailCard) guestSessionDetailCard.classList.add('hidden');
        if (guestConversationsCard) guestConversationsCard.classList.add('hidden');
        selectedGuestSession = null;
        
        // リストを更新
        await fetchGuestSessions();
      } catch (error) {
        console.error(error);
        alert(`削除に失敗しました: ${error.message}`);
      }
    };
    
  </script>
</body>
</html>
