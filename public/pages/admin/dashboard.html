<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - é‹å‘½ã®æ‰‰</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    :root { color-scheme: dark; }
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* PCç‰ˆ: å…¨ä½“ã‚’å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      body {
        align-items: flex-start;
      }
    }
    header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.4);
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPC: å·¦å´ã€ãƒ¢ãƒã‚¤ãƒ«: ä¸Šéƒ¨ï¼‰ */
    .admin-navigation {
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 240px;
    }
    
    .admin-navigation h2 {
      margin: 0 0 16px;
      font-size: 18px;
      color: #c7cdff;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 12px;
    }
    
    .admin-nav-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      border-radius: 8px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      color: #f7f5ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      font-family: inherit;
    }
    
    .admin-nav-item:hover {
      background: rgba(138, 43, 226, 0.35);
      border-color: rgba(138, 43, 226, 0.5);
      transform: translateX(4px);
    }
    
    .admin-nav-item.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .admin-nav-url {
      font-size: 11px;
      color: #9da2c6;
      margin-top: 4px;
      word-break: break-all;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã«æ¨ªä¸¦ã³ */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        flex-direction: row;
        gap: 8px;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        min-width: auto;
        padding: 12px;
        overflow-x: auto;
      }
      
      .admin-navigation h2 {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’éè¡¨ç¤º */
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: 120px;
        white-space: nowrap;
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(2px); /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸‹æ–¹å‘ã«å‹•ã */
      }
      
      .admin-nav-url {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯URLã‚’éè¡¨ç¤º */
      }
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
      max-width: 100%;
    }
    
    /* PCç‰ˆ: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      .content-area {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0 20px 40px;
    }
    main {
      flex: 1;
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 4vw, 28px); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label {
      font-size: 13px;
      color: #bfc4ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    textarea { min-height: 140px; }
    button, .button-link {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    button:hover, .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(138, 43, 226, 0.35);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
      vertical-align: top;
    }
    th { font-weight: 600; color: #c7cdff; }
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0 20px 40px;
      width: 100%;
      max-width: 100%;
    }
    
    /* PCç‰ˆ: å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      .dashboard-layout {
        align-items: flex-start;
      }
    }
    
    .dashboard-columns {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .column-left,
    .column-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #resultSummary {
      margin-bottom: 10px;
    }
    .detail-card.hidden,
    .conversation-card.hidden {
      display: none;
    }
    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .conversation-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 14px;
      color: #f7f5ff;
    }
    .conversation-item summary {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }
    .conversation-item summary::-webkit-details-marker {
      display: none;
    }
    .conversation-meta {
      font-size: 12px;
      color: #c7cff5;
    }
    .conversation-body {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    @media (max-width: 768px) {
      table { font-size: 12px; }
      .dashboard-layout { padding: 0 16px 32px; }
      
      /* ãƒ¢ãƒã‚¤ãƒ«: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã« */
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        min-width: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .admin-navigation h2 {
        width: 100%;
        margin: 0 0 12px;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-url {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯URLã‚’éè¡¨ç¤º */
      }
    }
    @media (min-width: 769px) {
      /* PC: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å·¦å´ã« */
      .main-container {
        flex-direction: row;
      }
    }
    @media (min-width: 960px) {
      .dashboard-columns {
        flex-direction: row;
        align-items: flex-start;
        gap: 24px;
      }
      .column-left {
        width: 45%;
        max-width: 520px;
      }
      .column-right {
        flex: 1;
      }
    }
    .token-input { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .token-input input { flex: 1; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }
    .list-scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: linear-gradient(135deg, rgba(255, 78, 132, 0.9), rgba(255, 130, 0, 0.8)); }
    .muted { color: #9da2c6; font-size: 12px; }
    
    /* ã‚¿ãƒ–æ©Ÿèƒ½ */
    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    /* PCç‰ˆ: å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      .admin-tabs {
        justify-content: flex-start;
        align-items: flex-start;
        padding-left: 20px;
      }
    }
    
    .admin-tab {
      padding: 12px 24px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: #f7f5ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .admin-tab:hover {
      background: rgba(138, 43, 226, 0.3);
    }
    
    .admin-tab.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆç®¡ç† */
    .chat-admin-container {
      padding: 20px;
      max-width: 100%;
    }
    
    .chat-admin-entry {
      text-align: left;
    }
    
    .chat-admin-entry h2 {
      margin-bottom: 10px;
      font-size: 24px;
      text-align: left;
    }
    
    .chat-admin-entry > p {
      margin-bottom: 30px;
      text-align: left;
    }
    
    .user-type-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .user-type-card {
      background: rgba(255, 255, 255, 0.04);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .user-type-card:hover {
      background: rgba(138, 43, 226, 0.2);
      border-color: rgba(138, 43, 226, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(138, 43, 226, 0.3);
    }
    
    .user-type-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #f7f5ff;
    }
    
    .user-type-card p {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
      line-height: 1.6;
    }
    
    .chat-admin-select {
      text-align: left;
    }
    
    .chat-admin-select h2 {
      margin-bottom: 20px;
      font-size: 24px;
      text-align: left;
    }
    
    .user-type-badge {
      display: inline-block;
      margin-bottom: 20px;
      padding: 6px 16px;
      background: rgba(138, 43, 226, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 20px;
      font-size: 14px;
    }
    
    .appraisers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .appraiser-card {
      background: rgba(255, 255, 255, 0.04);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .appraiser-card:hover {
      background: rgba(138, 43, 226, 0.2);
      border-color: rgba(138, 43, 226, 0.6);
      transform: translateY(-3px);
    }
    
    .appraiser-card img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 10px;
      object-fit: cover;
    }
    
    .appraiser-card h3 {
      margin: 0 0 5px;
      font-size: 16px;
    }
    
    .appraiser-card p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .back-button {
      padding: 10px 20px;
      background: rgba(75, 0, 130, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 8px;
      color: #f7f5ff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .back-button:hover {
      background: rgba(75, 0, 130, 0.5);
      border-color: rgba(138, 43, 226, 0.8);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆç®¡ç†çµ±åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .chat-admin-wrapper {
      display: flex;
      gap: 20px;
      height: calc(100vh - 200px);
      min-height: 600px;
    }
    
    .chat-panel {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-panel iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .analysis-panel {
      width: 350px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      overflow-y: auto;
      max-height: 100%;
    }
    
    .analysis-panel h3 {
      margin: 0 0 20px;
      font-size: 18px;
      color: #f7f5ff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }
    
    .analysis-section {
      margin-bottom: 20px;
    }
    
    .analysis-section h4 {
      margin: 0 0 10px;
      font-size: 14px;
      color: #c7cdff;
      font-weight: 600;
    }
    
    .analysis-content {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.6;
      color: #e8d5ff;
    }
    
    .analysis-content p {
      margin: 0;
    }
    
    .analysis-item {
      margin-bottom: 8px;
    }
    
    .analysis-item:last-child {
      margin-bottom: 0;
    }
    
    .analysis-label {
      font-weight: 600;
      color: #b794ff;
      margin-right: 8px;
    }
    
    .analysis-value {
      color: #e8d5ff;
    }
    
    /* ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .test-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .test-button {
      padding: 8px 12px;
      background: rgba(138, 43, 226, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 6px;
      color: #f7f5ff;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      width: 100%;
    }
    
    .test-button:hover {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.8);
      transform: translateX(2px);
    }
    
    .test-button.danger {
      background: rgba(255, 78, 132, 0.3);
      border-color: rgba(255, 78, 132, 0.5);
    }
    
    .test-button.danger:hover {
      background: rgba(255, 78, 132, 0.5);
      border-color: rgba(255, 78, 132, 0.8);
    }
    
    .test-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 1200px) {
      .chat-admin-wrapper {
        flex-direction: column;
        height: auto;
      }
      
      .analysis-panel {
        width: 100%;
        max-height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p class="muted">ç®¡ç†æ“ä½œç”¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆX-Admin-Tokenï¼‰ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
    <div class="token-input">
      <input type="password" id="adminToken" placeholder="ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³">
      <button id="connectButton">æ¥ç¶š</button>
      <span id="connectionStatus" class="badge">æœªæ¥ç¶š</span>
    </div>
  </header>

  <div class="main-container">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPC: å·¦å´ã€ãƒ¢ãƒã‚¤ãƒ«: ä¸Šéƒ¨ï¼‰ -->
    <nav class="admin-navigation">
      <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button class="admin-nav-item active" data-tab="user-search">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        <div class="admin-nav-url">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ»ç®¡ç†</div>
      </button>
      <button class="admin-nav-item" data-tab="chat-admin">
        ãƒãƒ£ãƒƒãƒˆç®¡ç†
        <div class="admin-nav-url">ãƒãƒ£ãƒƒãƒˆå‹•ä½œã®ç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆ</div>
      </button>
    </nav>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ– -->
      <div class="tab-content active" id="user-search-tab">
      <div class="dashboard-layout">
        <div class="dashboard-columns">
      <div class="column-left">
        <section class="card">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</h2>
          <form id="searchForm">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
              <input type="text" id="searchNickname" placeholder="éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã§ãã¾ã™">
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">å¹´
                <input type="number" id="searchYear" min="1900" max="2100" placeholder="ä¾‹: 1990">
              </label>
              <label style="flex:1;">æœˆ
                <input type="number" id="searchMonth" min="1" max="12" placeholder="1-12">
              </label>
              <label style="flex:1;">æ—¥
                <input type="number" id="searchDay" min="1" max="31" placeholder="1-31">
              </label>
            </div>
            <label>åˆè¨€è‘‰
              <input type="text" id="searchPassphrase" placeholder="ä¾‹: æ¡œèˆã„æ•£ã‚‹æ˜¥ã®é“">
            </label>
            <div class="actions">
              <button type="submit">æ¤œç´¢ã™ã‚‹</button>
              <button type="button" id="resetSearchButton">æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</button>
            </div>
            <p class="muted">â€»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  / ç”Ÿå¹´æœˆæ—¥ / åˆè¨€è‘‰ã®ã„ãšã‚Œã‹ä¸€ã¤ã ã‘ã§ã‚‚æ¤œç´¢å¯èƒ½ã§ã™ã€‚ç©ºã®ã¾ã¾æ¤œç´¢ã™ã‚‹ã¨å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </form>
        </section>

        <section class="card">
          <h2>æ¤œç´¢çµæœ</h2>
          <div id="resultSummary" class="muted">æ¤œç´¢çµæœ 0 ä»¶</div>
          <div class="list-scroll">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
                  <th>èª•ç”Ÿæ—¥</th>
                  <th>åˆè¨€è‘‰</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="5" class="muted">æ¥ç¶šã—ã¦èª­ã¿è¾¼ã¿...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-right">
        <section class="card detail-card hidden" id="detailCard">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
          <p class="muted" id="selectedUserLabel"></p>
          <form id="userForm">
            <input type="hidden" id="formUserId">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
              <input type="text" id="formNickname" required>
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">å¹´
                <input type="number" id="formYear" min="1900" max="2100" required>
              </label>
              <label style="flex:1;">æœˆ
                <input type="number" id="formMonth" min="1" max="12" required>
              </label>
              <label style="flex:1;">æ—¥
                <input type="number" id="formDay" min="1" max="31" required>
              </label>
            </div>
            <label>åˆè¨€è‘‰
              <select id="formDeity"></select>
            </label>
            <div class="actions">
              <button type="submit">æ›´æ–°ã™ã‚‹</button>
              <button type="button" class="danger" id="deleteUserButton">é€€ä¼šï¼ˆå‰Šé™¤ï¼‰</button>
            </div>
            <p class="muted" id="formStatus"></p>
          </form>
        </section>

        <section class="card conversation-card hidden" id="conversationCard">
          <h2>ä¼šè©±å±¥æ­´ï¼ˆæœ€æ–°100ä»¶ï¼‰</h2>
          <div id="conversationList" class="conversation-list">
            <p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
          </div>
        </section>
      </div>
    </div>
    </div>
      </div>

      <!-- ãƒãƒ£ãƒƒãƒˆç®¡ç†ã‚¿ãƒ– -->
      <div class="tab-content" id="chat-admin-tab">
        <div class="chat-admin-container" id="chatAdminContainer">
          <div class="chat-admin-entry" id="chatAdminEntry">
            <h2>ç®¡ç†è€…ç”¨ãƒãƒ£ãƒƒãƒˆ - ã‚¨ãƒ³ãƒˆãƒªãƒ¼</h2>
            <p class="muted">æœ¬ç•ªç’°å¢ƒã¨åŒã˜çŠ¶æ…‹ã§ãƒãƒ£ãƒƒãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            
            <div class="user-type-selector">
              <div class="user-type-card" data-user-type="guest">
                <h3>ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <p>åˆã‚ã¦ã®æ–¹å…¥å£ã¨åŒã˜çŠ¶æ…‹ã§å‹•ä½œã—ã¾ã™ã€‚ç™»éŒ²ãªã—ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã™ï¼ˆ10é€šã¾ã§ï¼‰ã€‚</p>
              </div>
              
              <div class="user-type-card" data-user-type="registered">
                <h3>ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
                <p>ç™»éŒ²æ¸ˆã¿ã®æ–¹å…¥å£ã¨åŒã˜çŠ¶æ…‹ã§å‹•ä½œã—ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
              </div>
            </div>
          </div>

          <div class="chat-admin-select hidden" id="chatAdminSelect">
            <h2>ã©ã®é‘‘å®šå¸«ã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ</h2>
            <div class="user-type-badge" id="chatUserTypeBadge"></div>
            <div class="appraisers-grid" id="chatAppraisersGrid"></div>
            <button class="back-button" id="chatBackToEntryBtn">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠã«æˆ»ã‚‹</button>
          </div>

          <div class="chat-admin-chat hidden" id="chatAdminChat">
            <div class="chat-admin-wrapper">
              <div class="chat-panel" id="chatPanel">
                <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
              </div>
              <div class="analysis-panel" id="analysisPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <h3 style="margin: 0;">ä¼šè©±åˆ†æãƒ‘ãƒãƒ«</h3>
                  <button class="test-button" id="refreshAnalysisBtn" style="padding: 6px 12px; font-size: 12px; min-width: auto;">
                    ğŸ”„ æ›´æ–°
                  </button>
                </div>
                <div class="analysis-section">
                  <h4>ç¾åœ¨ã®çŠ¶æ…‹</h4>
                  <div id="analysisCurrentState" class="analysis-content">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±</h4>
                  <div id="analysisPhaseInfo" class="analysis-content">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>ä¼šè©±å±¥æ­´æ§‹é€ </h4>
                  <div id="analysisHistory" class="analysis-content">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                  </div>
                </div>
                <div class="analysis-section" id="debugSection" style="display: none;">
                  <h4>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
                  <div id="debugInfo" class="analysis-content" style="font-size: 11px; color: #9da2c6;">
                    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º -->
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
                  <div class="analysis-content">
                    <div class="test-controls">
                      <button class="test-button" id="resetConversationBtn" title="ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚²ã‚¹ãƒˆçŠ¶æ…‹ã«æˆ»ã™ï¼‰">
                        ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ
                      </button>
                      <button class="test-button" id="resetPhaseBtn" title="ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ï¼‰">
                        ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆ
                      </button>
                      <button class="test-button" id="triggerEventBtn" title="å®ˆè­·ç¥ã®å„€å¼ã‚’ç›´æ¥ç™ºå‹•ï¼ˆç™»éŒ²æ¸ˆã¿ã®å ´åˆã®ã¿ï¼‰">
                        ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•
                      </button>
                      <button class="test-button" id="simulateRegistrationBtn" title="ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ">
                        ç™»éŒ²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                      </button>
                      <button class="test-button danger" id="logoutBtn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚²ã‚¹ãƒˆçŠ¶æ…‹ã«æˆ»ã™">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button class="back-button" id="chatBackToSelectBtn" style="margin-top: 10px;">é‘‘å®šå¸«é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
    (function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.admin-nav-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/admin/') && href === 'dashboard.html')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    })();
    
    const adminTokenInput = document.getElementById('adminToken');
    const connectButton = document.getElementById('connectButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const userTableBody = document.getElementById('userTableBody');
    const form = document.getElementById('userForm');
    const formUserId = document.getElementById('formUserId');
    const formNickname = document.getElementById('formNickname');
    const formYear = document.getElementById('formYear');
    const formMonth = document.getElementById('formMonth');
    const formDay = document.getElementById('formDay');
    const formDeity = document.getElementById('formDeity');
    const formStatus = document.getElementById('formStatus');
    const deleteUserButton = document.getElementById('deleteUserButton');
    const searchForm = document.getElementById('searchForm');
    const searchNickname = document.getElementById('searchNickname');
    const searchYear = document.getElementById('searchYear');
    const searchMonth = document.getElementById('searchMonth');
    const searchDay = document.getElementById('searchDay');
    const searchPassphrase = document.getElementById('searchPassphrase');
    const resetSearchButton = document.getElementById('resetSearchButton');
    const resultSummary = document.getElementById('resultSummary');
    const detailCard = document.getElementById('detailCard');
    const selectedUserLabel = document.getElementById('selectedUserLabel');
    const conversationCard = document.getElementById('conversationCard');
    const conversationList = document.getElementById('conversationList');

    const deities = [
      'æ¡œèˆã„æ•£ã‚‹æ˜¥ã®é“',
      'æœˆæ˜ã‹ã‚Šã«æµ®ã‹ã¶å¤¢',
      'æ˜Ÿé™ã‚‹å¤œã®ç‰©èª',
      'æœéœ²ã«å…‰ã‚‹å¸Œæœ›',
      'å¤•ç„¼ã‘ã®ã‚„ã•ã—ã•',
      'è™¹ã®æ¶ã‘æ©‹',
      'æ˜¥é¢¨ã«æºã‚Œã‚‹èŠ±',
      'é›ªåŒ–ç²§ã®é™ã‘ã•',
      'é¢¨éˆ´ã®æ¶¼ã—ã„éŸ³',
      'è‰ã—ãã‚Œã®å¤',
      'ç´…è‘‰æ•£ã‚‹å°é“',
      'åˆé›ªã®è´ˆã‚Šç‰©',
      'èœã®èŠ±ç•‘ã®æ˜¥',
      'è›èˆã†å¤•ã¹',
      'é›²æµ·ã«æµ®ã‹ã¶å¤¢',
      'æ³¢ã®éŸ³ã®å­å®ˆæ­Œ',
      'éœ§é›¨ã®æ½¤ã„',
      'è½è‘‰ã®æ•·ãæ¯¯',
      'æ˜¥éœã®æºã‚‰ã',
      'å°é³¥ã®ã•ãˆãšã‚Š',
      'å°å·ã®ã›ã›ã‚‰ã',
      'é‡åŸã®é¢¨è»Š',
      'è—¤è‰²ã®èŠ±',
      'é‡‘è‰²ã®ç¨²ç©‚'
    ];
    deities.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      formDeity.appendChild(option);
    });

    let currentToken = '';
    let users = [];
    let filteredUsers = [];
    let selectedUserId = null;

    function hideDetailSections() {
      detailCard.classList.add('hidden');
      conversationCard.classList.add('hidden');
      conversationList.innerHTML = '<p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>';
      selectedUserLabel.textContent = '';
      formStatus.textContent = '';
      selectedUserId = null;
    }

    function showDetailSections(user) {
      detailCard.classList.remove('hidden');
      conversationCard.classList.remove('hidden');
      selectedUserLabel.textContent = `ID: ${user.id} / ${user.nickname} / ${user.birth_year}å¹´${user.birth_month}æœˆ${user.birth_day}æ—¥`;
    }

    hideDetailSections();

    function setStatus(message, success = false) {
      connectionStatus.textContent = message;
      connectionStatus.style.background = success ? 'rgba(0,120,86,0.4)' : 'rgba(138,43,226,0.2)';
    }

    async function fetchUsers() {
      try {
        const res = await fetch('/api/admin/users', {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        users = data.users;
        applyFilters();
        renderUsers();
        hideDetailSections();
        setStatus('æ¥ç¶šæ¸ˆã¿', true);
      } catch (error) {
        console.error(error);
        setStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        userTableBody.innerHTML = `<tr><td colspan="5" class="muted">${error.message}</td></tr>`;
      }
    }

    function applyFilters() {
      const nickname = searchNickname.value.trim();
      const yearValue = searchYear.value.trim();
      const monthValue = searchMonth.value.trim();
      const dayValue = searchDay.value.trim();
      const passphrase = searchPassphrase.value.trim();

      const hasNickname = nickname.length > 0;
      const hasYear = yearValue.length > 0;
      const hasMonth = monthValue.length > 0;
      const hasDay = dayValue.length > 0;
      const hasPassphrase = passphrase.length > 0;

      if (!hasNickname && !hasYear && !hasMonth && !hasDay && !hasPassphrase) {
        filteredUsers = [...users];
        return;
      }

      const year = Number(yearValue);
      const month = Number(monthValue);
      const day = Number(dayValue);

      filteredUsers = users.filter((user) => {
        const nicknameMatch = hasNickname ? user.nickname.includes(nickname) : true;
        const yearMatch = hasYear ? user.birth_year === year : true;
        const monthMatch = hasMonth ? user.birth_month === month : true;
        const dayMatch = hasDay ? user.birth_day === day : true;
        const passphraseMatch = hasPassphrase ? user.assigned_deity.includes(passphrase) : true;
        return nicknameMatch && yearMatch && monthMatch && dayMatch && passphraseMatch;
      });
    }

    function renderUsers(list = filteredUsers) {
      resultSummary.textContent = `æ¤œç´¢çµæœ ${list.length} ä»¶`;
      if (!list.length) {
        userTableBody.innerHTML = '<tr><td colspan="5" class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }
      userTableBody.innerHTML = list.map((user) => `
        <tr>
          <td>${user.id}</td>
          <td>${user.nickname}</td>
          <td>${user.birth_year}/${user.birth_month}/${user.birth_day}</td>
          <td>${user.assigned_deity}</td>
          <td><button class="button-link" data-user-id="${user.id}">é¸æŠ</button></td>
        </tr>
      `).join('');
    }

    userTableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target.matches('[data-user-id]')) {
        const id = Number(target.dataset.userId);
        const user = users.find((u) => u.id === id);
        if (user) {
          populateForm(user);
          fetchConversations(id);
        }
      }
    });

    function populateForm(user) {
      formUserId.value = user.id;
      formNickname.value = user.nickname;
      formYear.value = user.birth_year;
      formMonth.value = user.birth_month;
      formDay.value = user.birth_day;
      formDeity.value = user.assigned_deity;
      formStatus.textContent = '';
      selectedUserId = user.id;
      showDetailSections(user);
    }

    function renderConversationList(records) {
      if (!records.length) {
        conversationList.innerHTML = '<p class="muted">ä¼šè©±å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      conversationList.innerHTML = records.map((item, index) => {
        const title = `[${item.character_id}] ${item.role === 'assistant' ? 'é‘‘å®šå£«' : 'ç›¸è«‡è€…'} / ${new Date(item.created_at).toLocaleString('ja-JP')}`;
        const safeContent = item.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <details class="conversation-item" ${index === 0 ? 'open' : ''}>
            <summary>
              <span>${title}</span>
              <span class="conversation-meta">#${records.length - index}</span>
            </summary>
            <div class="conversation-body">${safeContent}</div>
          </details>
        `;
      }).join('');
    }

    async function fetchConversations(userId) {
      conversationList.innerHTML = '<p class="muted">èª­ã¿è¾¼ã¿ä¸­...</p>';
      try {
        const res = await fetch(`/api/admin/conversations?userId=${userId}`, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ä¼šè©±å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        renderConversationList(data.conversations || []);
      } catch (error) {
        conversationList.innerHTML = `<p class="muted">${error.message}</p>`;
      }
    }

    connectButton.addEventListener('click', () => {
      currentToken = adminTokenInput.value.trim();
      if (!currentToken) {
        setStatus('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      fetchUsers();
    });

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
      renderUsers();
      hideDetailSections();
    });

    resetSearchButton.addEventListener('click', () => {
      searchForm.reset();
      filteredUsers = [...users];
      renderUsers();
      hideDetailSections();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      const payload = {
        id: Number(formUserId.value),
        nickname: formNickname.value.trim(),
        birthYear: Number(formYear.value),
        birthMonth: Number(formMonth.value),
        birthDay: Number(formDay.value),
        assignedDeity: formDeity.value,
      };
      try {
        const res = await fetch('/api/admin/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': currentToken,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'æ›´æ–°ã—ã¾ã—ãŸã€‚';
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    deleteUserButton.addEventListener('click', async () => {
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      if (!confirm('æœ¬å½“ã«é€€ä¼šå‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿä¼šè©±å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }
      try {
        const res = await fetch(`/api/admin/users?id=${formUserId.value}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'å‰Šé™¤ã—ã¾ã—ãŸã€‚';
        form.reset();
        hideDetailSections();
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    // ============================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    // ============================================
    document.querySelectorAll('.admin-nav-item').forEach(navItem => {
      navItem.addEventListener('click', () => {
        const targetTab = navItem.dataset.tab;
        if (!targetTab) return;
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const targetContent = document.getElementById(`${targetTab}-tab`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        // ãƒãƒ£ãƒƒãƒˆç®¡ç†ã‚¿ãƒ–ã®å ´åˆã€è¡¨ç¤ºã‚’æ›´æ–°
        if (targetTab === 'chat-admin') {
          renderChatAdminView();
        } else {
          // åˆ†æãƒ‘ãƒãƒ«ã®æ›´æ–°ã‚’åœæ­¢
          stopAnalysisPanel();
          hideDetailSections(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è©³ç´°ã‚’éš ã™
        }
      });
    });
    
    // ãƒãƒ£ãƒƒãƒˆç®¡ç†ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderChatAdminView() {
      if (!chatAdminEntry || !chatAdminSelect || !chatAdminChat) return;
      
      chatAdminEntry.classList.add('hidden');
      chatAdminSelect.classList.add('hidden');
      chatAdminChat.classList.add('hidden');
      
      if (chatAdminBackButton) chatAdminBackButton.classList.add('hidden');
      if (chatAdminSelectBackButton) chatAdminSelectBackButton.classList.add('hidden');
      
      // åˆæœŸçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      currentChatAdminView = 'entry';
      currentUserType = null;
      currentCharacter = null;
      
      chatAdminEntry.classList.remove('hidden');
    }

    // ============================================
    // ãƒãƒ£ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½
    // ============================================
    const chatAdminEntry = document.getElementById('chatAdminEntry');
    const chatAdminSelect = document.getElementById('chatAdminSelect');
    const chatAdminChat = document.getElementById('chatAdminChat');
    const chatUserTypeBadge = document.getElementById('chatUserTypeBadge');
    const chatAppraisersGrid = document.getElementById('chatAppraisersGrid');
    const chatBackToEntryBtn = document.getElementById('chatBackToEntryBtn');
    const chatBackToSelectBtn = document.getElementById('chatBackToSelectBtn');
    const chatAdminBackButton = document.getElementById('chatBackToSelectBtn');
    const chatAdminSelectBackButton = document.getElementById('chatBackToEntryBtn');
    const chatAdminIframe = document.getElementById('chatAdminIframe');
    
    let currentUserType = null;
    let currentCharacter = null;
    let currentChatAdminView = 'entry'; // 'entry', 'select', 'chat'
    
    const appraisers = [
      { id: 'kaede', name: 'æ¥“', nameKana: 'ã‹ãˆã§', image: '../../photo/kaede.png' },
      { id: 'yukino', name: 'ç¬¹å²¡é›ªä¹ƒ', nameKana: 'ã•ã•ãŠã‹ ã‚†ãã®', image: '../../photo/yukino.png' },
      { id: 'sora', name: 'æ°´é‡ã‚½ãƒ©', nameKana: 'ã¿ãšã® ãã‚‰', image: '../../photo/sora.png' },
      { id: 'kaon', name: 'ä¸‰å´èŠ±éŸ³', nameKana: 'ã¿ã•ã ã‹ãŠã‚“', image: '../../photo/kaon.png' }
    ];
    
    // é‘‘å®šå¸«ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    function updateAppraiserCards() {
      chatAppraisersGrid.innerHTML = '';
      appraisers.forEach(appraiser => {
        const card = document.createElement('div');
        card.className = 'appraiser-card';
        card.innerHTML = `
          <img src="${appraiser.image}" alt="${appraiser.name}" onerror="this.src='../../photo/rogo.png'">
          <h3>${appraiser.name}</h3>
          <p>${appraiser.nameKana}</p>
        `;
        
        card.addEventListener('click', () => {
          currentCharacter = appraiser.id;
          currentChatAdminView = 'chat';
          showChatAdminChat();
        });
        
        chatAppraisersGrid.appendChild(card);
      });
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—é¸æŠ
    document.querySelectorAll('.user-type-card').forEach(card => {
      card.addEventListener('click', () => {
        currentUserType = card.dataset.userType;
        currentChatAdminView = 'select';
        showChatAdminSelect();
      });
    });
    
    // é‘‘å®šå¸«é¸æŠç”»é¢ã‚’è¡¨ç¤º
    function showChatAdminSelect() {
      chatAdminEntry.classList.add('hidden');
      chatAdminSelect.classList.remove('hidden');
      chatAdminChat.classList.add('hidden');
      
      chatUserTypeBadge.textContent = currentUserType === 'guest' ? 'ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼';
      
      updateAppraiserCards();
    }
    
    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
    function showChatAdminChat() {
      chatAdminEntry.classList.add('hidden');
      chatAdminSelect.classList.add('hidden');
      chatAdminChat.classList.remove('hidden');
      
      // iframeã§æœ¬ç•ªç’°å¢ƒã®ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ï¼ˆåŒã˜å‹•ä½œã‚’ç¢ºèªï¼‰
      // çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€
      const basePath = window.location.origin + window.location.pathname.replace(/\/[^/]+$/, '');
      const chatUrl = `${basePath}/../chat/chat.html?character=${currentCharacter}&userType=${currentUserType}`;
      console.log('åˆ†æãƒ‘ãƒãƒ«: iframeèª­ã¿è¾¼ã¿URL', chatUrl);
      
      const chatPanel = document.getElementById('chatPanel');
      
      // iframeãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
      const existingIframe = document.getElementById('chatAdminIframe');
      if (existingIframe) {
        existingIframe.remove();
        stopAnalysisPanel();
      }
      
      const iframe = document.createElement('iframe');
      iframe.src = chatUrl;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.id = 'chatAdminIframe';
      iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms'); // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
      
      chatPanel.innerHTML = '';
      chatPanel.appendChild(iframe);
      
      // iframeã®èª­ã¿è¾¼ã¿çŠ¶æ³ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      iframe.addEventListener('load', () => {
        console.log('åˆ†æãƒ‘ãƒãƒ«: iframeã®loadã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ', {
          src: iframe.src,
          contentWindow: !!iframe.contentWindow,
          contentDocument: !!iframe.contentDocument
        });
      });
      
      iframe.addEventListener('error', (e) => {
        console.error('åˆ†æãƒ‘ãƒãƒ«: iframeã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', e);
      });
      
      // åˆ†æãƒ‘ãƒãƒ«ã®æ›´æ–°ã‚’é–‹å§‹
      startAnalysisPanel(iframe, currentCharacter, currentUserType);
    }
    
    // åˆ†æãƒ‘ãƒãƒ«ã‚’æ›´æ–°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼‰
    let analysisInterval = null;
    let updateRequestTimeout = null; // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²æ­¢
    function requestChatDataDebounced(iframe, character, userType, delay = 500) {
      // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
      if (updateRequestTimeout) {
        clearTimeout(updateRequestTimeout);
      }
      
      // æ–°ã—ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
      updateRequestTimeout = setTimeout(() => {
        updateAnalysisPanelPostMessage(iframe, character, userType, false);
        updateRequestTimeout = null;
      }, delay);
    }
    
    function startAnalysisPanel(iframe, character, userType) {
      // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
      if (analysisInterval) {
        clearInterval(analysisInterval);
        analysisInterval = null;
      }
      
      // åˆ†æãƒ‘ãƒãƒ«ã«èª­ã¿è¾¼ã¿ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const loadingMsg = '<p style="color: #c7cdff;">â³ ãƒãƒ£ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
      const currentStateDiv = document.getElementById('analysisCurrentState');
      const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
      const historyDiv = document.getElementById('analysisHistory');
      if (currentStateDiv) currentStateDiv.innerHTML = loadingMsg;
      if (phaseInfoDiv) phaseInfoDiv.innerHTML = loadingMsg;
      if (historyDiv) historyDiv.innerHTML = loadingMsg;
      
      console.log('[åˆ†æãƒ‘ãƒãƒ«] postMessageæ–¹å¼ã§é–‹å§‹', { character, userType });
      
      // postMessageæ–¹å¼: iframeæº–å‚™å®Œäº†é€šçŸ¥ã‚’å¾…ã¤ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚¹ãƒŠãƒ¼ã§å‡¦ç†ï¼‰
      // åˆå›æ›´æ–°ã‚’æº–å‚™å®Œäº†é€šçŸ¥å¾Œã«å®Ÿè¡Œï¼ˆè‡ªå‹•æ›´æ–°ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
      // å®šæœŸæ›´æ–°ã¯æ§ãˆã‚ã«ï¼ˆ5ç§’ã”ã¨ã€ã¾ãŸã¯æ‰‹å‹•æ›´æ–°ã®ã¿ï¼‰
      
      // åˆå›æ›´æ–°ã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰è©¦è¡Œ
      setTimeout(() => {
        updateAnalysisPanelPostMessage(iframe, character, userType, false);
      }, 2000); // 2ç§’å¾Œã«åˆå›æ›´æ–°
      
      // å®šæœŸæ›´æ–°ï¼ˆ30ç§’ã”ã¨ - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ã‚’å„ªå…ˆï¼‰
      analysisInterval = setInterval(() => {
        // æº–å‚™å®Œäº†é€šçŸ¥ã‚’å—ä¿¡ã—ã¦ã„ã‚‹å ´åˆã®ã¿æ›´æ–°
        if (iframeReadyReceived) {
          updateAnalysisPanelPostMessage(iframe, character, userType, false);
        }
      }, 30000); // 30ç§’ã”ã¨ã«æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    }
    
    function stopAnalysisPanel() {
      if (analysisInterval) {
        clearInterval(analysisInterval);
        analysisInterval = null;
      }
    }
    
    // iframeæº–å‚™å®Œäº†é€šçŸ¥ã‚’å—ã‘å–ã‚‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚¹ãƒŠãƒ¼ï¼‰
    let iframeReadyReceived = false; // æº–å‚™å®Œäº†é€šçŸ¥ã‚’å—ä¿¡æ¸ˆã¿ã‹ã©ã†ã‹
    
    window.addEventListener('message', (event) => {
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®ã¿è¨±å¯
      if (event.origin !== window.location.origin) {
        return;
      }
      
      if (event.data.type === 'CHAT_IFRAME_READY') {
        if (iframeReadyReceived) {
          console.log('[ç®¡ç†ç”»é¢] æº–å‚™å®Œäº†é€šçŸ¥ã¯æ—¢ã«å—ä¿¡æ¸ˆã¿ã§ã™');
          return; // 2å›ç›®ä»¥é™ã¯ç„¡è¦–
        }
        iframeReadyReceived = true;
        
        console.log('[ç®¡ç†ç”»é¢] iframeãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ:', event.data);
        
        // è‡ªå‹•çš„ã«åˆ†æãƒ‘ãƒãƒ«ã‚’æ›´æ–°
        const iframe = document.getElementById('chatAdminIframe');
        if (iframe && currentCharacter && currentUserType) {
          console.log('[ç®¡ç†ç”»é¢] æº–å‚™å®Œäº†é€šçŸ¥ã‚’å—ä¿¡ã€åˆ†æãƒ‘ãƒãƒ«ã‚’æ›´æ–°ã—ã¾ã™');
          // ã™ãã«æ›´æ–°ã‚’è©¦è¡Œ
          updateAnalysisPanelPostMessage(iframe, currentCharacter, currentUserType, false);
        }
      }
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†é€šçŸ¥ã‚’å—ã‘å–ã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹æ›´æ–°ï¼‰
      if (event.data.type === 'CHAT_MESSAGE_SENT') {
        console.log('[ç®¡ç†ç”»é¢] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’æ¤œçŸ¥ã€åˆ†æãƒ‘ãƒãƒ«ã‚’å³åº§ã«æ›´æ–°ã—ã¾ã™:', event.data);
        
        const iframe = document.getElementById('chatAdminIframe');
        if (iframe && currentCharacter && currentUserType) {
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ›´æ–°ï¼ˆAIå¿œç­”å¾…ã¡ï¼‰
          // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²æ­¢
          requestChatDataDebounced(iframe, currentCharacter, currentUserType);
        }
      }
    });
    
    // åˆ†æãƒ‘ãƒãƒ«ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆpostMessageãƒ™ãƒ¼ã‚¹ - æ–°å®Ÿè£…ï¼‰
    async function updateAnalysisPanelPostMessage(iframe, character, userType, showDebug = false) {
      const currentStateDiv = document.getElementById('analysisCurrentState');
      const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
      const historyDiv = document.getElementById('analysisHistory');
      const debugSection = document.getElementById('debugSection');
      const debugInfoDiv = document.getElementById('debugInfo');
      const debugInfo = [];
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
      const loadingMsg = '<p style="color: #c7cdff;">â³ èª­ã¿è¾¼ã¿ä¸­...</p>';
      if (currentStateDiv) currentStateDiv.innerHTML = loadingMsg;
      if (phaseInfoDiv) phaseInfoDiv.innerHTML = loadingMsg;
      if (historyDiv) historyDiv.innerHTML = loadingMsg;
      
      try {
        debugInfo.push(`ğŸ” åˆ†æãƒ‘ãƒãƒ«æ›´æ–°é–‹å§‹: ${new Date().toLocaleTimeString()}`);
        debugInfo.push(`ğŸ“‹ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${character}, ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—: ${userType}`);
        
        if (!iframe || !iframe.contentWindow) {
          throw new Error('iframeãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€contentWindowã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
        }
        
        debugInfo.push(`âœ… iframe.src: ${iframe.src}`);
        
        // postMessageã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const chatData = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            window.removeEventListener('message', messageHandler);
            reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’ä»¥å†…ã«ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'));
          }, 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          
          const messageHandler = (event) => {
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®ã¿è¨±å¯
            if (event.origin !== window.location.origin) {
              console.warn('[ç®¡ç†ç”»é¢] ä¸æ­£ãªã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', event.origin);
              return;
            }
            
            if (event.data.type === 'CHAT_DATA_RESPONSE') {
              clearTimeout(timeout);
              window.removeEventListener('message', messageHandler);
              debugInfo.push('âœ… ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸ');
              resolve(event.data.data);
            } else if (event.data.type === 'CHAT_DATA_ERROR') {
              clearTimeout(timeout);
              window.removeEventListener('message', messageHandler);
              reject(new Error(event.data.error));
            }
          };
          
          window.addEventListener('message', messageHandler);
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          try {
            iframe.contentWindow.postMessage({
              type: 'REQUEST_CHAT_DATA'
            }, window.location.origin);
            debugInfo.push('ğŸ“¤ ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸ');
          } catch (error) {
            clearTimeout(timeout);
            window.removeEventListener('message', messageHandler);
            reject(new Error(`postMessageé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`));
          }
        });
        
        debugInfo.push(`âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°=${chatData.messageCount || 0}, å±¥æ­´æ•°=${chatData.conversationHistory?.length || 0}`);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        const messageCount = chatData.messageCount || 0;
        const conversationHistory = Array.isArray(chatData.conversationHistory) ? chatData.conversationHistory : [];
        const characterName = chatData.character || character || 'ä¸æ˜';
        
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        if (currentStateDiv) {
          currentStateDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—:</span>
              <span class="analysis-value">${chatData.userType === 'registered' ? 'ç™»éŒ²æ¸ˆã¿' : 'ã‚²ã‚¹ãƒˆ'}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</span>
              <span class="analysis-value">${characterName}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ç™»éŒ²çŠ¶æ…‹:</span>
              <span class="analysis-value">${chatData.currentState?.isRegistered ? 'ç™»éŒ²æ¸ˆã¿' : 'æœªç™»éŒ²'}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</span>
              <span class="analysis-value">${messageCount}é€š</span>
            </div>
          `;
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤º
        const phase = calculatePhase(messageCount, character);
        if (phaseInfoDiv) {
          phaseInfoDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º:</span>
              <span class="analysis-value">${phase.name}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">èª¬æ˜:</span>
              <span class="analysis-value">${phase.description}</span>
            </div>
          `;
        }
        
        // ä¼šè©±å±¥æ­´æ§‹é€ ã‚’è¡¨ç¤º
        if (historyDiv) {
          const userMessages = conversationHistory.filter(m => m && m.role === 'user').length;
          const assistantMessages = conversationHistory.filter(m => m && m.role === 'assistant').length;
          historyDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</span>
              <span class="analysis-value">${conversationHistory.length}ä»¶</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</span>
              <span class="analysis-value">${userMessages}ä»¶</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</span>
              <span class="analysis-value">${assistantMessages}ä»¶</span>
            </div>
          `;
        }
        
        debugInfo.push('âœ… åˆ†æãƒ‘ãƒãƒ«æ›´æ–°å®Œäº†');
        
        if (showDebug && debugInfoDiv) {
          debugInfoDiv.innerHTML = debugInfo.join('<br>');
          if (debugSection) debugSection.style.display = 'block';
        }
        
      } catch (error) {
        console.error('åˆ†æãƒ‘ãƒãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        debugInfo.push(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        
        const errorMsg = `<p style="color: #ff7a8a;">âš ï¸ ${error.message}</p>`;
        if (currentStateDiv) currentStateDiv.innerHTML = errorMsg;
        if (phaseInfoDiv) phaseInfoDiv.innerHTML = errorMsg;
        if (historyDiv) historyDiv.innerHTML = errorMsg;
        
        if (showDebug && debugInfoDiv) {
          debugInfoDiv.innerHTML = debugInfo.join('<br>') + `<br>âŒ ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`;
          if (debugSection) debugSection.style.display = 'block';
        }
      }
    }
    
    // åˆ†æãƒ‘ãƒãƒ«ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆæ—§å®Ÿè£… - å»ƒæ­¢ï¼‰
    // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚updateAnalysisPanelPostMessageã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
    function updateAnalysisPanel(iframe, character, userType, showDebug = false) {
        console.warn('[éæ¨å¥¨] updateAnalysisPanelã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚updateAnalysisPanelPostMessageã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
        // æ—§å®Ÿè£…ã‚’å‘¼ã³å‡ºã™ä»£ã‚ã‚Šã«ã€postMessageæ–¹å¼ã‚’å‘¼ã³å‡ºã™
        return updateAnalysisPanelPostMessage(iframe, character, userType, showDebug);
      const debugInfo = [];
      const debugSection = document.getElementById('debugSection');
      const debugInfoDiv = document.getElementById('debugInfo');
      
      try {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’åé›†
        debugInfo.push(`æ›´æ–°æ™‚åˆ»: ${new Date().toLocaleTimeString()}`);
        debugInfo.push(`character: ${character || 'æœªè¨­å®š'}`);
        debugInfo.push(`userType: ${userType || 'æœªè¨­å®š'}`);
        debugInfo.push(`iframe.src: ${iframe ? iframe.src : 'æœªå®šç¾©'}`);
        debugInfo.push(`iframe.contentWindow: ${iframe && iframe.contentWindow ? 'å­˜åœ¨' : 'ãªã—'}`);
        debugInfo.push(`iframe.contentDocument: ${iframe && iframe.contentDocument ? 'å­˜åœ¨' : 'ãªã—'}`);
        
        if (iframe && iframe.contentDocument) {
          const doc = iframe.contentDocument;
          debugInfo.push(`document.readyState: ${doc.readyState}`);
          debugInfo.push(`document.title: ${doc.title || 'ãªã—'}`);
          
          // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã®ç¢ºèª
          const scripts = doc.querySelectorAll('script');
          debugInfo.push(`scriptè¦ç´ ã®æ•°: ${scripts.length}`);
        }
        
        // iframeãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆ
        if (!iframe || !iframe.contentWindow) {
          const errorMsg = '<p style="color: #ff7a8a;">ãƒãƒ£ãƒƒãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>';
          debugInfo.push('âŒ iframeã¾ãŸã¯contentWindowãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          const currentStateDiv = document.getElementById('analysisCurrentState');
          const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
          const historyDiv = document.getElementById('analysisHistory');
          if (currentStateDiv) currentStateDiv.innerHTML = errorMsg;
          if (phaseInfoDiv) phaseInfoDiv.innerHTML = errorMsg;
          if (historyDiv) historyDiv.innerHTML = errorMsg;
          
          if (showDebug && debugInfoDiv) {
            debugInfoDiv.innerHTML = debugInfo.join('<br>');
            if (debugSection) debugSection.style.display = 'block';
          }
          return;
        }
        
        const iframeWindow = iframe.contentWindow;
        debugInfo.push('âœ… iframe.contentWindow: å­˜åœ¨');
        
        // ã™ã¹ã¦ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºèª
        const globalKeys = Object.keys(iframeWindow).filter(key => 
          key.includes('Chat') || key.includes('Auth') || key.includes('window')
        );
        debugInfo.push(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ï¼ˆChat/Authé–¢é€£ï¼‰: ${globalKeys.length > 0 ? globalKeys.join(', ') : 'ãªã—'}`);
        
        // å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const hasAuthState = !!iframeWindow.AuthState;
        const hasChatData = !!iframeWindow.ChatData;
        const hasChatUI = !!iframeWindow.ChatUI;
        const hasChatInit = !!iframeWindow.ChatInit;
        
        debugInfo.push(`AuthState: ${hasAuthState ? 'âœ…' : 'âŒ'} (${hasAuthState ? typeof iframeWindow.AuthState : 'N/A'})`);
        debugInfo.push(`ChatData: ${hasChatData ? 'âœ…' : 'âŒ'} (${hasChatData ? typeof iframeWindow.ChatData : 'N/A'})`);
        debugInfo.push(`ChatUI: ${hasChatUI ? 'âœ…' : 'âŒ'} (${hasChatUI ? typeof iframeWindow.ChatUI : 'N/A'})`);
        debugInfo.push(`ChatInit: ${hasChatInit ? 'âœ…' : 'âŒ'} (${hasChatInit ? typeof iframeWindow.ChatInit : 'N/A'})`);
        
        // windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç›´æ¥ç¢ºèª
        if (iframe.contentDocument) {
          const scripts = iframe.contentDocument.querySelectorAll('script[src]');
          debugInfo.push(`èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ: ${Array.from(scripts).map(s => s.src.split('/').pop()).join(', ')}`);
        }
        
        if (!hasAuthState || !hasChatData) {
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
          const loadingMsg = `
            <p style="color: #ffb84d;">ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <p style="font-size: 11px; color: #9da2c6; margin-top: 8px;">
              AuthState: ${hasAuthState ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'èª­ã¿è¾¼ã¿ä¸­...'}<br>
              ChatData: ${hasChatData ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'èª­ã¿è¾¼ã¿ä¸­...'}
            </p>
          `;
          const currentStateDiv = document.getElementById('analysisCurrentState');
          const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
          const historyDiv = document.getElementById('analysisHistory');
          if (currentStateDiv) currentStateDiv.innerHTML = loadingMsg;
          if (phaseInfoDiv) phaseInfoDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...</p>';
          if (historyDiv) historyDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...</p>';
          
          console.log('åˆ†æãƒ‘ãƒãƒ«: AuthStateã¾ãŸã¯ChatDataãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', {
            AuthState: hasAuthState,
            ChatData: hasChatData,
            ChatUI: hasChatUI,
            ChatInit: hasChatInit
          });
          
          if (showDebug && debugInfoDiv) {
            debugInfoDiv.innerHTML = debugInfo.join('<br>');
            if (debugSection) debugSection.style.display = 'block';
          }
          return;
        }
        
        debugInfo.push('âœ… ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒèª­ã¿è¾¼ã¿æ¸ˆã¿');
        
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
        const isRegistered = iframeWindow.AuthState.isRegistered();
        const chatData = iframeWindow.ChatData;
        
        // characterInfoãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        let characterInfo = null;
        let characterName = character || 'èª­ã¿è¾¼ã¿ä¸­...';
        if (chatData.characterInfo && typeof chatData.characterInfo === 'object') {
          characterInfo = chatData.characterInfo[character];
          if (characterInfo && characterInfo.name) {
            characterName = characterInfo.name;
          }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ï¼ˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚²ã‚¹ãƒˆã§ç•°ãªã‚‹ï¼‰
        let messageCount = 0;
        let conversationHistory = [];
        
        try {
          if (isRegistered) {
            // ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
            const historyData = chatData.conversationHistory;
            if (historyData && historyData.recentMessages) {
              conversationHistory = Array.isArray(historyData.recentMessages) ? historyData.recentMessages : [];
              messageCount = conversationHistory.filter(msg => msg && msg.role === 'user').length;
            }
          } else {
            // ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
            if (typeof chatData.getGuestMessageCount === 'function') {
              messageCount = chatData.getGuestMessageCount(character) || 0;
            }
            if (typeof chatData.getGuestHistory === 'function') {
              conversationHistory = chatData.getGuestHistory(character) || [];
            }
          }
        } catch (e) {
          console.error('åˆ†æãƒ‘ãƒãƒ«: ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', e);
          messageCount = 0;
          conversationHistory = [];
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¨ˆç®—
        const phase = calculatePhase(messageCount, character);
        
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        const currentStateDiv = document.getElementById('analysisCurrentState');
        if (currentStateDiv) {
          currentStateDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—:</span>
              <span class="analysis-value">${userType === 'guest' ? 'ã‚²ã‚¹ãƒˆ' : 'ç™»éŒ²'}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</span>
              <span class="analysis-value">${characterName}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ç™»éŒ²çŠ¶æ…‹:</span>
              <span class="analysis-value">${isRegistered ? 'ç™»éŒ²æ¸ˆã¿' : 'æœªç™»éŒ²'}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</span>
              <span class="analysis-value">${messageCount}é€š</span>
            </div>
          `;
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤º
        const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
        if (phaseInfoDiv) {
          phaseInfoDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º:</span>
              <span class="analysis-value">${phase.name}</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">èª¬æ˜:</span>
              <span class="analysis-value">${phase.description}</span>
            </div>
          `;
        }
        
        // ä¼šè©±å±¥æ­´æ§‹é€ ã‚’è¡¨ç¤º
        const historyDiv = document.getElementById('analysisHistory');
        if (historyDiv) {
          const userMessages = Array.isArray(conversationHistory) 
            ? conversationHistory.filter(m => m && m.role === 'user').length 
            : 0;
          const assistantMessages = Array.isArray(conversationHistory)
            ? conversationHistory.filter(m => m && m.role === 'assistant').length
            : 0;
          historyDiv.innerHTML = `
            <div class="analysis-item">
              <span class="analysis-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</span>
              <span class="analysis-value">${conversationHistory.length}ä»¶</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</span>
              <span class="analysis-value">${userMessages}ä»¶</span>
            </div>
            <div class="analysis-item">
              <span class="analysis-label">ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</span>
              <span class="analysis-value">${assistantMessages}ä»¶</span>
          </div>
        `;
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆshowDebugãŒtrueã®å ´åˆï¼‰
        if (showDebug && debugInfoDiv) {
          debugInfo.push('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
          debugInfoDiv.innerHTML = debugInfo.join('<br>');
          if (debugSection) debugSection.style.display = 'block';
        }
      } catch (error) {
        console.error('åˆ†æãƒ‘ãƒãƒ«ã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        debugInfo.push(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        const errorMsg = `<p style="color: #ff7a8a;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p><p style="font-size: 11px; color: #9da2c6;">è©³ç´°ã¯ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>`;
        const currentStateDiv = document.getElementById('analysisCurrentState');
        const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
        const historyDiv = document.getElementById('analysisHistory');
        if (currentStateDiv) currentStateDiv.innerHTML = errorMsg;
        if (phaseInfoDiv) phaseInfoDiv.innerHTML = errorMsg;
        if (historyDiv) historyDiv.innerHTML = errorMsg;
        
        if (showDebug && debugInfoDiv) {
          debugInfoDiv.innerHTML = debugInfo.join('<br>') + `<br>âŒ ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`;
          if (debugSection) debugSection.style.display = 'block';
        }
      }
    }
    
    // åˆ†æãƒ‘ãƒãƒ«ã‚’æ‰‹å‹•ã§æ›´æ–°ã™ã‚‹ãƒœã‚¿ãƒ³
    const refreshAnalysisBtn = document.getElementById('refreshAnalysisBtn');
    if (refreshAnalysisBtn) {
      refreshAnalysisBtn.addEventListener('click', () => {
        const iframe = document.getElementById('chatAdminIframe');
        if (iframe && currentCharacter && currentUserType) {
          console.log('åˆ†æãƒ‘ãƒãƒ«: æ‰‹å‹•æ›´æ–°ã‚’å®Ÿè¡Œï¼ˆpostMessageæ–¹å¼ï¼‰', { currentCharacter, currentUserType });
          updateAnalysisPanelPostMessage(iframe, currentCharacter, currentUserType, true);
        } else {
          alert('ãƒãƒ£ãƒƒãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
        }
      });
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãƒœã‚¿ãƒ³
    const showDebugBtn = document.getElementById('showDebugBtn');
    if (showDebugBtn) {
      showDebugBtn.addEventListener('click', () => {
        const iframe = document.getElementById('chatAdminIframe');
        const debugSection = document.getElementById('debugSection');
        const debugInfoDiv = document.getElementById('debugInfo');
        
        if (debugSection && debugInfoDiv) {
          if (debugSection.style.display === 'none' || !debugSection.style.display) {
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
            if (iframe && currentCharacter && currentUserType) {
              updateAnalysisPanelPostMessage(iframe, currentCharacter, currentUserType, true);
            } else {
              debugInfoDiv.innerHTML = 'ãƒãƒ£ãƒƒãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
              debugSection.style.display = 'block';
            }
          } else {
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éè¡¨ç¤º
            debugSection.style.display = 'none';
          }
        }
      });
    }
    
    // ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¨ˆç®—
    function calculatePhase(messageCount, character) {
      if (character === 'kaede') {
        if (messageCount === 1) {
          return {
            name: 'ãƒ•ã‚§ãƒ¼ã‚º1',
            description: 'å°å…¥ï¼†æœªæ¥ã‚¤ãƒ¡ãƒ¼ã‚¸ã®é¸æŠè‚¢æç¤º'
          };
        } else if (messageCount === 2) {
          return {
            name: 'ãƒ•ã‚§ãƒ¼ã‚º2',
            description: 'é•·æ‰€ã‚’èãè³ªå•ï¼ˆæœ€å¾Œã®è³ªå•ï¼‰'
          };
        } else if (messageCount === 3) {
          return {
            name: 'ãƒ•ã‚§ãƒ¼ã‚º3',
            description: 'æ€§æ ¼è¨ºæ–­ï¼‹ç¶šè¡Œç¢ºèª'
          };
        } else {
          return {
            name: 'ãƒ•ã‚§ãƒ¼ã‚º4',
            description: 'æœªæ¥é‘‘å®šï¼‹å®ˆè­·ç¥ã¨å„€å¼ã®èª¬æ˜'
          };
        }
      }
      return {
        name: 'æœªè¨­å®š',
        description: 'ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“'
      };
    }
    
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    if (chatBackToEntryBtn) {
      chatBackToEntryBtn.addEventListener('click', () => {
        currentChatAdminView = 'entry';
        currentUserType = null;
        currentCharacter = null;
        stopAnalysisPanel();
        chatAdminEntry.classList.remove('hidden');
        chatAdminSelect.classList.add('hidden');
        chatAdminChat.classList.add('hidden');
      });
    }
    
    if (chatBackToSelectBtn) {
      chatBackToSelectBtn.addEventListener('click', () => {
        currentChatAdminView = 'select';
        currentCharacter = null;
        stopAnalysisPanel();
        showChatAdminSelect();
        const chatPanel = document.getElementById('chatPanel');
        if (chatPanel) {
          chatPanel.innerHTML = '';
        }
      });
    }
    
    // ============================================
    // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½
    // ============================================
    const resetConversationBtn = document.getElementById('resetConversationBtn');
    const resetPhaseBtn = document.getElementById('resetPhaseBtn');
    const triggerEventBtn = document.getElementById('triggerEventBtn');
    const simulateRegistrationBtn = document.getElementById('simulateRegistrationBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚²ã‚¹ãƒˆçŠ¶æ…‹ã«æˆ»ã™ï¼‰
    if (resetConversationBtn) {
      resetConversationBtn.addEventListener('click', () => {
        if (!confirm('ä¼šè©±å±¥æ­´ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚²ã‚¹ãƒˆçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ãƒã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§iframeã«ãƒªã‚»ãƒƒãƒˆå‘½ä»¤ã‚’é€ä¿¡
            iframe.contentWindow.postMessage({
              type: 'ADMIN_RESET_CONVERSATION',
              character: currentCharacter
            }, '*');
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
              iframe.src = iframe.src;
              alert('ä¼šè©±ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            }, 100);
          }
        } catch (error) {
          console.error('ä¼šè©±ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('ä¼šè©±ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      });
    }
    
    // ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ï¼‰
    if (resetPhaseBtn) {
      resetPhaseBtn.addEventListener('click', () => {
        if (!confirm('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆä¼šè©±å±¥æ­´ã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ãƒã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§iframeã«ãƒ•ã‚§ãƒ¼ã‚ºãƒªã‚»ãƒƒãƒˆå‘½ä»¤ã‚’é€ä¿¡
            iframe.contentWindow.postMessage({
              type: 'ADMIN_RESET_PHASE',
              character: currentCharacter
            }, '*');
            
            alert('ãƒ•ã‚§ãƒ¼ã‚ºãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            // åˆ†æãƒ‘ãƒãƒ«ã‚’æ›´æ–°
            setTimeout(() => {
              if (iframe.contentWindow) {
                updateAnalysisPanelPostMessage(iframe, currentCharacter, currentUserType);
              }
            }, 500);
          }
        } catch (error) {
          console.error('ãƒ•ã‚§ãƒ¼ã‚ºãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      });
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•ï¼ˆå®ˆè­·ç¥ã®å„€å¼ã‚’ç›´æ¥ãƒˆãƒªã‚¬ãƒ¼ï¼‰
    if (triggerEventBtn) {
      triggerEventBtn.addEventListener('click', async () => {
        if (!confirm('å®ˆè­·ç¥ã®å„€å¼ã‚’ç›´æ¥ç™ºå‹•ã—ã¾ã™ã‹ï¼Ÿï¼ˆç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿æœ‰åŠ¹ï¼‰')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ãƒã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§iframeã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•å‘½ä»¤ã‚’é€ä¿¡
            iframe.contentWindow.postMessage({
              type: 'ADMIN_TRIGGER_RITUAL',
              character: currentCharacter
            }, '*');
            
            alert('å®ˆè­·ç¥ã®å„€å¼ã‚’ç™ºå‹•ã—ã¾ã—ãŸã€‚');
          }
        } catch (error) {
          console.error('ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºå‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      });
    }
    
    // ç™»éŒ²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼‰
    if (simulateRegistrationBtn) {
      simulateRegistrationBtn.addEventListener('click', async () => {
        const nickname = prompt('ãƒ†ã‚¹ãƒˆç”¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼');
        if (!nickname) return;
        
        const year = prompt('ç”Ÿå¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1990');
        const month = prompt('ç”Ÿæœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1');
        const day = prompt('ç”Ÿæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1');
        
        if (!year || !month || !day) return;
        
        try {
          // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              nickname: nickname,
              birthYear: parseInt(year),
              birthMonth: parseInt(month),
              birthDay: parseInt(day)
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.token) {
            // iframeã«ãƒã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç™»éŒ²æƒ…å ±ã‚’é€ä¿¡
            const iframe = document.getElementById('chatAdminIframe');
            if (iframe) {
              iframe.contentWindow.postMessage({
                type: 'ADMIN_SIMULATE_REGISTRATION',
                token: data.token,
                nickname: data.nickname,
                assignedDeity: data.assignedDeity
              }, '*');
              
              alert(`ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${nickname}ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
              setTimeout(() => {
                iframe.src = iframe.src;
              }, 500);
            }
          } else {
            alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        } catch (error) {
          console.error('ç™»éŒ²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('ç™»éŒ²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      });
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚²ã‚¹ãƒˆçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ãƒã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§iframeã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‘½ä»¤ã‚’é€ä¿¡
            iframe.contentWindow.postMessage({
              type: 'ADMIN_LOGOUT'
            }, '*');
            
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
            setTimeout(() => {
              iframe.src = iframe.src;
            }, 500);
          }
        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      });
    }
  </script>
</body>
</html>
