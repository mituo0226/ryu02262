<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - é‹å‘½ã®æ‰‰</title>
  <link rel="stylesheet" href="../../css/styles.css">
  <style>
    :root { color-scheme: dark; }
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ */
    header {
      flex-shrink: 0;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 600;
    }
    
    header .muted {
      color: #9da2c6;
      font-size: 13px;
      margin: 0 0 12px;
    }
    
    .token-input {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .token-input input {
      flex: 0 1 auto;
      min-width: 200px;
      max-width: 400px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .token-input input {
        flex: 1;
        max-width: none;
      }
    }
    
    .token-input input:focus {
      outline: none;
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15);
    }
    
    .token-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .token-input button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .badge.connected {
      background: rgba(0, 200, 120, 0.25);
      color: #90ffc7;
      border-color: rgba(0, 200, 120, 0.4);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ¨ªä¸¦ã³ï¼‰ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå·¦å´ã€å›ºå®šå¹…ï¼‰ */
    .admin-navigation {
      flex-shrink: 0;
      width: 280px;
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 16px;
    }
    
    .admin-navigation::-webkit-scrollbar {
      width: 6px;
    }
    
    .admin-navigation::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .admin-navigation::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 3px;
    }
    
    .admin-navigation::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    .admin-navigation h2 {
      margin: 0 0 20px;
      font-size: 16px;
      font-weight: 600;
      color: #c7cdff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.25);
      color: #f7f5ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      font-family: inherit;
      position: relative;
    }
    
    .admin-nav-item:hover {
      background: rgba(138, 43, 226, 0.25);
      border-color: rgba(138, 43, 226, 0.4);
      transform: translateX(4px);
    }
    
    .admin-nav-item.active {
      background: rgba(138, 43, 226, 0.4);
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: rgba(138, 43, 226, 0.9);
      border-radius: 0 2px 2px 0;
    }
    
    .admin-nav-url {
      display: block;
      font-size: 11px;
      color: #9da2c6;
      margin-top: 4px;
      opacity: 0.7;
    }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆå³å´ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
    .content-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: rgba(0, 0, 0, 0.2);
      min-width: 0;
    }
    
    .content-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .content-area::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .content-area::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 4px;
    }
    
    .content-area::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã«æ¨ªä¸¦ã³ */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        width: 100%;
        flex-direction: row;
        gap: 8px;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      
      .admin-navigation h2 {
        display: none;
      }
      
      .admin-nav-item {
        flex: 0 0 auto;
        min-width: 140px;
        white-space: nowrap;
        padding: 10px 14px;
        font-size: 13px;
        margin-bottom: 0;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-item.active::before {
        display: none;
      }
      
      .admin-nav-url {
        display: none;
      }
    }
    
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }
    
    main {
      flex: 1;
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 4vw, 28px); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label {
      font-size: 13px;
      color: #bfc4ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    textarea { min-height: 140px; }
    button, .button-link {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    button:hover, .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(138, 43, 226, 0.35);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
      vertical-align: top;
    }
    th { font-weight: 600; color: #c7cdff; }
    
    .dashboard-columns {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .column-left,
    .column-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #resultSummary {
      margin-bottom: 10px;
    }
    .detail-card.hidden,
    .conversation-card.hidden {
      display: none;
    }
    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .conversation-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 14px;
      color: #f7f5ff;
    }
    .conversation-item summary {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }
    .conversation-item summary::-webkit-details-marker {
      display: none;
    }
    .conversation-meta {
      font-size: 12px;
      color: #c7cff5;
    }
    .conversation-body {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    @media (max-width: 768px) {
      table { font-size: 12px; }
      .dashboard-layout { padding: 0 16px 32px; }
      
      /* ãƒ¢ãƒã‚¤ãƒ«: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã« */
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        min-width: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .admin-navigation h2 {
        width: 100%;
        margin: 0 0 12px;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-url {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯URLã‚’éè¡¨ç¤º */
      }
    }
    @media (min-width: 769px) {
      /* PC: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å·¦å´ã« */
      .main-container {
        flex-direction: row;
      }
    }
    @media (min-width: 960px) {
      .dashboard-columns {
        flex-direction: row;
        align-items: flex-start;
        gap: 24px;
      }
      .column-left {
        width: 65%;
        max-width: 800px;
      }
      .column-right {
        flex: 1;
        min-width: 400px;
      }
    }
    .token-input { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .token-input input { flex: 1; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }
    .list-scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: linear-gradient(135deg, rgba(255, 78, 132, 0.9), rgba(255, 130, 0, 0.8)); }
    .muted { color: #9da2c6; font-size: 12px; }
    
    /* ã‚¿ãƒ–æ©Ÿèƒ½ */
    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    /* PCç‰ˆ: å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      .admin-tabs {
        justify-content: flex-start;
        align-items: flex-start;
        padding-left: 20px;
      }
    }
    
    .admin-tab {
      padding: 12px 24px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: #f7f5ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .admin-tab:hover {
      background: rgba(138, 43, 226, 0.3);
    }
    
    .admin-tab.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .tab-content {
      display: none;
      height: 100%;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p class="muted">ç®¡ç†æ“ä½œç”¨ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆX-Admin-Tokenï¼‰ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
    <div class="token-input">
      <input type="password" id="adminToken" placeholder="ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³">
      <button id="connectButton">æ¥ç¶š</button>
      <span id="connectionStatus" class="badge">æœªæ¥ç¶š</span>
    </div>
  </header>

  <div class="main-container">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPC: å·¦å´ã€ãƒ¢ãƒã‚¤ãƒ«: ä¸Šéƒ¨ï¼‰ -->
    <nav class="admin-navigation">
      <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button class="admin-nav-item active" data-tab="user-search">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        <div class="admin-nav-url">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ»ç®¡ç†</div>
      </button>
      <button class="admin-nav-item" data-tab="character-tests">
        æ€§æ ¼è¨­å®šãƒ†ã‚¹ãƒˆ
        <div class="admin-nav-url">å„é‘‘å®šå£«ã®æ€§æ ¼è¨­å®šã‚’ãƒ†ã‚¹ãƒˆ</div>
      </button>
    </nav>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ– -->
      <div class="tab-content active" id="user-search-tab">
      <div class="dashboard-layout">
        <div class="dashboard-columns">
      <div class="column-left">
        <section class="card">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</h2>
          <form id="searchForm">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
              <input type="text" id="searchNickname" placeholder="éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã§ãã¾ã™">
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">å¹´
                <input type="number" id="searchYear" min="1900" max="2100" placeholder="ä¾‹: 1990">
              </label>
              <label style="flex:1;">æœˆ
                <input type="number" id="searchMonth" min="1" max="12" placeholder="1-12">
              </label>
              <label style="flex:1;">æ—¥
                <input type="number" id="searchDay" min="1" max="31" placeholder="1-31">
              </label>
            </div>
            <div class="actions">
              <button type="submit">æ¤œç´¢ã™ã‚‹</button>
              <button type="button" id="resetSearchButton">æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</button>
            </div>
            <p class="muted">â€»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  / ç”Ÿå¹´æœˆæ—¥ã®ã„ãšã‚Œã‹ä¸€ã¤ã ã‘ã§ã‚‚æ¤œç´¢å¯èƒ½ã§ã™ã€‚ç©ºã®ã¾ã¾æ¤œç´¢ã™ã‚‹ã¨å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </form>
        </section>

        <section class="card">
          <h2>æ¤œç´¢çµæœ</h2>
          <div id="resultSummary" class="muted">æ¤œç´¢çµæœ 0 ä»¶</div>
          <div class="list-scroll">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
                  <th>èª•ç”Ÿæ—¥</th>
                  <th>åˆè¨€è‘‰</th>
                  <th>å®ˆè­·ç¥</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="6" class="muted">æ¥ç¶šã—ã¦èª­ã¿è¾¼ã¿...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-right">
        <section class="card detail-card hidden" id="detailCard">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
          <p class="muted" id="selectedUserLabel"></p>
          <form id="userForm">
            <input type="hidden" id="formUserId">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
              <input type="text" id="formNickname" required>
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">å¹´
                <input type="number" id="formYear" min="1900" max="2100" required>
              </label>
              <label style="flex:1;">æœˆ
                <input type="number" id="formMonth" min="1" max="12" required>
              </label>
              <label style="flex:1;">æ—¥
                <input type="number" id="formDay" min="1" max="31" required>
              </label>
            </div>
            <label>åˆè¨€è‘‰
              <select id="formPassphrase"></select>
            </label>
            <label>å®ˆè­·ç¥
              <select id="formGuardian">
                <option value="">æœªæ±ºå®š</option>
                <option value="å¤©ç…§å¤§ç¥">å¤©ç…§å¤§ç¥</option>
                <option value="å¤§å›½ä¸»å‘½">å¤§å›½ä¸»å‘½</option>
                <option value="å¤§æ—¥å¦‚æ¥">å¤§æ—¥å¦‚æ¥</option>
                <option value="åƒæ‰‹è¦³éŸ³">åƒæ‰‹è¦³éŸ³</option>
                <option value="ä¸å‹•æ˜ç‹">ä¸å‹•æ˜ç‹</option>
              </select>
            </label>
            <div class="actions">
              <button type="submit">æ›´æ–°ã™ã‚‹</button>
              <button type="button" class="danger" id="deleteUserButton">é€€ä¼šï¼ˆå‰Šé™¤ï¼‰</button>
            </div>
            <p class="muted" id="formStatus"></p>
          </form>
        </section>

        <section class="card conversation-card hidden" id="conversationCard">
          <h2>ä¼šè©±å±¥æ­´ï¼ˆæœ€æ–°100ä»¶ï¼‰</h2>
          <div id="conversationList" class="conversation-list">
            <p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
          </div>
        </section>
      </div>
      </div>
    </div>
      </div>

      <!-- æ€§æ ¼è¨­å®šãƒ†ã‚¹ãƒˆã‚¿ãƒ– -->
      <div class="tab-content" id="character-tests-tab">
        <div class="dashboard-layout">
          <section class="card">
            <h2>å„é‘‘å®šå£«ã®æ€§æ ¼è¨­å®šãƒ†ã‚¹ãƒˆ</h2>
            <p class="muted">å„é‘‘å®šå£«ã®æ€§æ ¼è¨­å®šãŒAPIã«æ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            
            <div class="actions" style="margin-top: 20px;">
              <button id="runTestsButton" style="padding: 12px 24px; font-size: 16px;">
                ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
              </button>
            </div>

            <div id="testResults" style="margin-top: 24px;"></div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
    (function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.admin-nav-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/admin/') && href === 'dashboard.html')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    })();
    
    const adminTokenInput = document.getElementById('adminToken');
    const connectButton = document.getElementById('connectButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const userTableBody = document.getElementById('userTableBody');
    const form = document.getElementById('userForm');
    const formUserId = document.getElementById('formUserId');
    const formNickname = document.getElementById('formNickname');
    const formYear = document.getElementById('formYear');
    const formMonth = document.getElementById('formMonth');
    const formDay = document.getElementById('formDay');
    const formPassphrase = document.getElementById('formPassphrase');
    const formGuardian = document.getElementById('formGuardian');
    const formStatus = document.getElementById('formStatus');
    const deleteUserButton = document.getElementById('deleteUserButton');
    const searchForm = document.getElementById('searchForm');
    const searchNickname = document.getElementById('searchNickname');
    const searchYear = document.getElementById('searchYear');
    const searchMonth = document.getElementById('searchMonth');
    const searchDay = document.getElementById('searchDay');
    const resetSearchButton = document.getElementById('resetSearchButton');
    const resultSummary = document.getElementById('resultSummary');
    const detailCard = document.getElementById('detailCard');
    const selectedUserLabel = document.getElementById('selectedUserLabel');
    const conversationCard = document.getElementById('conversationCard');
    const conversationList = document.getElementById('conversationList');

    const deities = [
      'æ¡œèˆã„æ•£ã‚‹æ˜¥ã®é“',
      'æœˆæ˜ã‹ã‚Šã«æµ®ã‹ã¶å¤¢',
      'æ˜Ÿé™ã‚‹å¤œã®ç‰©èª',
      'æœéœ²ã«å…‰ã‚‹å¸Œæœ›',
      'å¤•ç„¼ã‘ã®ã‚„ã•ã—ã•',
      'è™¹ã®æ¶ã‘æ©‹',
      'æ˜¥é¢¨ã«æºã‚Œã‚‹èŠ±',
      'é›ªåŒ–ç²§ã®é™ã‘ã•',
      'é¢¨éˆ´ã®æ¶¼ã—ã„éŸ³',
      'è‰ã—ãã‚Œã®å¤',
      'ç´…è‘‰æ•£ã‚‹å°é“',
      'åˆé›ªã®è´ˆã‚Šç‰©',
      'èœã®èŠ±ç•‘ã®æ˜¥',
      'è›èˆã†å¤•ã¹',
      'é›²æµ·ã«æµ®ã‹ã¶å¤¢',
      'æ³¢ã®éŸ³ã®å­å®ˆæ­Œ',
      'éœ§é›¨ã®æ½¤ã„',
      'è½è‘‰ã®æ•·ãæ¯¯',
      'æ˜¥éœã®æºã‚‰ã',
      'å°é³¥ã®ã•ãˆãšã‚Š',
      'å°å·ã®ã›ã›ã‚‰ã',
      'é‡åŸã®é¢¨è»Š',
      'è—¤è‰²ã®èŠ±',
      'é‡‘è‰²ã®ç¨²ç©‚'
    ];
    deities.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      formPassphrase.appendChild(option);
    });

    let currentToken = '';
    let users = [];
    let filteredUsers = [];
    let selectedUserId = null;

    function hideDetailSections() {
      detailCard.classList.add('hidden');
      conversationCard.classList.add('hidden');
      conversationList.innerHTML = '<p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>';
      selectedUserLabel.textContent = '';
      formStatus.textContent = '';
      form.style.display = 'block'; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã«æˆ»ã™
      selectedUserId = null;
    }

    function showDetailSections(user) {
      detailCard.classList.remove('hidden');
      conversationCard.classList.remove('hidden');
      selectedUserLabel.textContent = `ID: ${user.id} / ${user.nickname} / ${user.birth_year}å¹´${user.birth_month}æœˆ${user.birth_day}æ—¥`;
      form.style.display = 'block';
    }

    hideDetailSections();

    function setStatus(message, success = false) {
      connectionStatus.textContent = message;
      connectionStatus.style.background = success ? 'rgba(0,120,86,0.4)' : 'rgba(138,43,226,0.2)';
    }

    async function fetchUsers() {
      try {
        // ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å–å¾—
        const usersRes = await fetch('/api/admin/users', {
          headers: { 'X-Admin-Token': currentToken },
        });
        const usersData = await usersRes.json();
        if (!usersRes.ok) throw new Error(usersData.error || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // APIã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ•´å½¢
        users = (usersData.users || []).map(user => ({
          id: user.id,
          nickname: user.nickname,
          birth_year: user.birth_year,
          birth_month: user.birth_month,
          birth_day: user.birth_day,
          passphrase: user.passphrase,
          guardian: user.guardian,
          created_at: user.created_at,
          message_count: user.message_count || 0
        }));

        applyFilters();
        renderUsers();
        hideDetailSections();
        setStatus('æ¥ç¶šæ¸ˆã¿', true);
      } catch (error) {
        console.error(error);
        setStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼');
        userTableBody.innerHTML = `<tr><td colspan="6" class="muted">${error.message}</td></tr>`;
      }
    }

    function applyFilters() {
      const nickname = searchNickname.value.trim();
      const yearValue = searchYear.value.trim();
      const monthValue = searchMonth.value.trim();
      const dayValue = searchDay.value.trim();

      const hasNickname = nickname.length > 0;
      const hasYear = yearValue.length > 0;
      const hasMonth = monthValue.length > 0;
      const hasDay = dayValue.length > 0;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filteredUsers = users.filter((user) => {
        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ¤œç´¢
        let nicknameMatch = true;
        if (hasNickname) {
          nicknameMatch = user.nickname && user.nickname.includes(nickname);
        }

        // ç”Ÿå¹´æœˆæ—¥æ¤œç´¢
        const year = Number(yearValue);
        const month = Number(monthValue);
        const day = Number(dayValue);
        const yearMatch = hasYear ? (user.birth_year === year) : true;
        const monthMatch = hasMonth ? (user.birth_month === month) : true;
        const dayMatch = hasDay ? (user.birth_day === day) : true;

        return nicknameMatch && yearMatch && monthMatch && dayMatch;
      });
    }

    function renderUsers(list = filteredUsers) {
      resultSummary.textContent = `æ¤œç´¢çµæœ ${list.length} ä»¶`;
      if (!list.length) {
        userTableBody.innerHTML = '<tr><td colspan="6" class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }
      
      userTableBody.innerHTML = list.map((user) => {
        return `
          <tr>
            <td>${user.id}</td>
            <td>${user.nickname || 'N/A'}</td>
            <td>${user.birth_year ? `${user.birth_year}/${user.birth_month}/${user.birth_day}` : '-'}</td>
            <td>${user.passphrase || 'æœªè¨­å®š'}</td>
            <td>${user.guardian || 'æœªæ±ºå®š'}</td>
            <td><button class="button-link" data-user-id="${user.id}">é¸æŠ</button></td>
          </tr>
        `;
      }).join('');
    }

    userTableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target.matches('[data-user-id]')) {
        const id = Number(target.dataset.userId);
        const user = users.find((u) => u.id === id);
        if (user) {
          populateForm(user);
          fetchConversations(id);
          selectedUserId = id;
        }
      }
    });

    function populateForm(user) {
      formUserId.value = user.id;
      formNickname.value = user.nickname;
      formYear.value = user.birth_year;
      formMonth.value = user.birth_month;
      formDay.value = user.birth_day;
      formPassphrase.value = user.passphrase || '';
      formGuardian.value = user.guardian || '';
      formStatus.textContent = '';
      selectedUserId = user.id;
      showDetailSections(user);
    }

    function renderConversationList(records) {
      if (!records.length) {
        conversationList.innerHTML = '<p class="muted">ä¼šè©±å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      conversationList.innerHTML = records.map((item, index) => {
        const title = `[${item.character_id}] ${item.role === 'assistant' ? 'é‘‘å®šå£«' : 'ç›¸è«‡è€…'} / ${new Date(item.created_at).toLocaleString('ja-JP')}`;
        const safeContent = item.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <details class="conversation-item" ${index === 0 ? 'open' : ''}>
            <summary>
              <span>${title}</span>
              <span class="conversation-meta">#${records.length - index}</span>
            </summary>
            <div class="conversation-body">${safeContent}</div>
          </details>
        `;
      }).join('');
    }

    async function fetchConversations(userId) {
      conversationList.innerHTML = '<p class="muted">èª­ã¿è¾¼ã¿ä¸­...</p>';
      try {
        const res = await fetch(`/api/admin/conversations?userId=${userId}`, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ä¼šè©±å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        renderConversationList(data.conversations || []);
      } catch (error) {
        conversationList.innerHTML = `<p class="muted">${error.message}</p>`;
      }
    }

    connectButton.addEventListener('click', () => {
      currentToken = adminTokenInput.value.trim();
      if (!currentToken) {
        setStatus('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      fetchUsers();
    });

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
      renderUsers();
    });

    resetSearchButton.addEventListener('click', () => {
      searchForm.reset();
      applyFilters();
      renderUsers();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      const payload = {
        id: Number(formUserId.value),
        nickname: formNickname.value.trim(),
        birthYear: Number(formYear.value),
        birthMonth: Number(formMonth.value),
        birthDay: Number(formDay.value),
        passphrase: formPassphrase.value,
        guardian: formGuardian.value || null,
      };
      try {
        const res = await fetch('/api/admin/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': currentToken,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'æ›´æ–°ã—ã¾ã—ãŸã€‚';
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    deleteUserButton.addEventListener('click', async () => {
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      if (!confirm('æœ¬å½“ã«é€€ä¼šå‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿä¼šè©±å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }
      try {
        const res = await fetch(`/api/admin/users?id=${formUserId.value}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'å‰Šé™¤ã—ã¾ã—ãŸã€‚';
        form.reset();
        hideDetailSections();
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    // ============================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    // ============================================
    document.querySelectorAll('.admin-nav-item').forEach(navItem => {
      navItem.addEventListener('click', () => {
        const targetTab = navItem.dataset.tab;
        if (!targetTab) return;
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const targetContent = document.getElementById(`${targetTab}-tab`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        hideDetailSections(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è©³ç´°ã‚’éš ã™
      });
    });

    // ============================================
    // æ€§æ ¼è¨­å®šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
    // ============================================
    const runTestsButton = document.getElementById('runTestsButton');
    const testResults = document.getElementById('testResults');

    if (runTestsButton && testResults) {
      runTestsButton.addEventListener('click', async () => {
        if (!currentToken) {
          alert('ã¾ãšç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        runTestsButton.disabled = true;
        runTestsButton.textContent = 'â³ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
        testResults.innerHTML = '<p class="muted">ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...</p>';

        try {
          const response = await fetch('/api/admin/run-tests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': currentToken,
            },
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
          renderTestResults(data);
        } catch (error) {
          console.error('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          testResults.innerHTML = `
            <div style="padding: 16px; background: rgba(255, 78, 132, 0.1); border: 1px solid rgba(255, 78, 132, 0.3); border-radius: 8px;">
              <p style="color: #ff6b9d; margin: 0;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            </div>
          `;
        } finally {
          runTestsButton.disabled = false;
          runTestsButton.textContent = 'ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ';
        }
      });
    }

    function renderTestResults(data) {
      const { summary, testSuites, integrationTests, timestamp } = data;
      
      let html = `
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 12px;">ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h3>
          <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
            <div style="padding: 12px 20px; background: rgba(138, 43, 226, 0.2); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3);">
              <div style="font-size: 12px; color: #9da2c6; margin-bottom: 4px;">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
              <div style="font-size: 24px; font-weight: 600;">${summary.total}</div>
            </div>
            <div style="padding: 12px 20px; background: rgba(76, 175, 80, 0.2); border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.3);">
              <div style="font-size: 12px; color: #9da2c6; margin-bottom: 4px;">æˆåŠŸ</div>
              <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${summary.passed}</div>
            </div>
            <div style="padding: 12px 20px; background: rgba(255, 78, 132, 0.2); border-radius: 8px; border: 1px solid rgba(255, 78, 132, 0.3);">
              <div style="font-size: 12px; color: #9da2c6; margin-bottom: 4px;">å¤±æ•—</div>
              <div style="font-size: 24px; font-weight: 600; color: #ff4e84;">${summary.failed}</div>
            </div>
            <div style="padding: 12px 20px; background: rgba(138, 43, 226, 0.2); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.3);">
              <div style="font-size: 12px; color: #9da2c6; margin-bottom: 4px;">æˆåŠŸç‡</div>
              <div style="font-size: 24px; font-weight: 600;">${summary.passRate}%</div>
            </div>
          </div>
          <p class="muted" style="margin: 0;">å®Ÿè¡Œæ™‚åˆ»: ${new Date(timestamp).toLocaleString('ja-JP')}</p>
        </div>
      `;

      // å„é‘‘å®šå£«ã®ãƒ†ã‚¹ãƒˆçµæœ
      testSuites.forEach(suite => {
        const passedCount = suite.tests.filter(t => t.passed).length;
        const totalCount = suite.tests.length;
        const passRate = totalCount > 0 ? Math.round((passedCount / totalCount) * 100) : 0;
        
        html += `
          <div style="margin-bottom: 24px; padding: 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px;">
            <h3 style="margin: 0 0 12px;">
              ${suite.characterName} (${suite.characterId})
              <span style="font-size: 14px; font-weight: normal; color: ${passRate === 100 ? '#4caf50' : passRate >= 50 ? '#ff9800' : '#ff4e84'};">
                ${passedCount}/${totalCount} æˆåŠŸ (${passRate}%)
              </span>
            </h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${suite.tests.map(test => `
                <div style="padding: 10px 12px; background: ${test.passed ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 78, 132, 0.1)'}; border-left: 3px solid ${test.passed ? '#4caf50' : '#ff4e84'}; border-radius: 4px;">
                  <div style="font-weight: 500; margin-bottom: 4px;">${test.name}</div>
                  <div style="font-size: 13px; color: ${test.passed ? '#4caf50' : '#ff4e84'};">
                    ${test.message}
                  </div>
                  ${test.details ? `<div style="font-size: 12px; color: #9da2c6; margin-top: 4px;">${test.details}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      // çµ±åˆãƒ†ã‚¹ãƒˆçµæœ
      if (integrationTests && integrationTests.length > 0) {
        html += `
          <div style="margin-bottom: 24px; padding: 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px;">
            <h3 style="margin: 0 0 12px;">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã®çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${integrationTests.map(test => `
                <div style="padding: 10px 12px; background: ${test.passed ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 78, 132, 0.1)'}; border-left: 3px solid ${test.passed ? '#4caf50' : '#ff4e84'}; border-radius: 4px;">
                  <div style="font-weight: 500; margin-bottom: 4px;">${test.name}</div>
                  <div style="font-size: 13px; color: ${test.passed ? '#4caf50' : '#ff4e84'};">
                    ${test.message}
                  </div>
                  ${test.details ? `<div style="font-size: 12px; color: #9da2c6; margin-top: 4px;">${test.details}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      testResults.innerHTML = html;
    }
    
  </script>
</body>
</html>
