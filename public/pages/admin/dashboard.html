<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - é‹å‘½ã®æ‰‰</title>
  <link rel="stylesheet" href="../../css/styles.css">
  <style>
    :root { color-scheme: dark; }
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ */
    header {
      flex-shrink: 0;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 600;
    }
    
    header .muted {
      color: #9da2c6;
      font-size: 13px;
      margin: 0 0 12px;
    }
    
    .token-input {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .token-input input {
      flex: 0 1 auto;
      min-width: 200px;
      max-width: 400px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .token-input input {
        flex: 1;
        max-width: none;
      }
    }
    
    .token-input input:focus {
      outline: none;
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15);
    }
    
    .token-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .token-input button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .badge.connected {
      background: rgba(0, 200, 120, 0.25);
      color: #90ffc7;
      border-color: rgba(0, 200, 120, 0.4);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ¨ªä¸¦ã³ï¼‰ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå·¦å´ã€å›ºå®šå¹…ï¼‰ */
    .admin-navigation {
      flex-shrink: 0;
      width: 280px;
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 16px;
    }
    
    .admin-navigation::-webkit-scrollbar {
      width: 6px;
    }
    
    .admin-navigation::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .admin-navigation::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 3px;
    }
    
    .admin-navigation::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    .admin-navigation h2 {
      margin: 0 0 20px;
      font-size: 16px;
      font-weight: 600;
      color: #c7cdff;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.25);
      color: #f7f5ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      font-family: inherit;
      position: relative;
    }
    
    .admin-nav-item:hover {
      background: rgba(138, 43, 226, 0.25);
      border-color: rgba(138, 43, 226, 0.4);
      transform: translateX(4px);
    }
    
    .admin-nav-item.active {
      background: rgba(138, 43, 226, 0.4);
      border-color: rgba(138, 43, 226, 0.6);
      box-shadow: 0 2px 8px rgba(138, 43, 226, 0.3);
    }
    
    .admin-nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: rgba(138, 43, 226, 0.9);
      border-radius: 0 2px 2px 0;
    }
    
    .admin-nav-url {
      display: block;
      font-size: 11px;
      color: #9da2c6;
      margin-top: 4px;
      opacity: 0.7;
    }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆå³å´ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
    .content-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: rgba(0, 0, 0, 0.2);
      min-width: 0;
      min-height: 0;
      /* flexboxã§é«˜ã•ã‚’è¨ˆç®—ã•ã›ã‚‹ï¼ˆheight: 0ã¯å‰Šé™¤ï¼‰ */
    }
    
    .content-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .content-area::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .content-area::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 4px;
    }
    
    .content-area::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã«æ¨ªä¸¦ã³ */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        width: 100%;
        flex-direction: row;
        gap: 8px;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      
      .admin-navigation h2 {
        display: none;
      }
      
      .admin-nav-item {
        flex: 0 0 auto;
        min-width: 140px;
        white-space: nowrap;
        padding: 10px 14px;
        font-size: 13px;
        margin-bottom: 0;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-item.active::before {
        display: none;
      }
      
      .admin-nav-url {
        display: none;
      }
    }
    
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }
    
    main {
      flex: 1;
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 4vw, 28px); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label {
      font-size: 13px;
      color: #bfc4ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    textarea { min-height: 140px; }
    button, .button-link {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    button:hover, .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(138, 43, 226, 0.35);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
      vertical-align: top;
    }
    th { font-weight: 600; color: #c7cdff; }
    
    .dashboard-columns {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .column-left,
    .column-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #resultSummary {
      margin-bottom: 10px;
    }
    .detail-card.hidden,
    .conversation-card.hidden {
      display: none;
    }
    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .conversation-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 14px;
      color: #f7f5ff;
    }
    .conversation-item summary {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }
    .conversation-item summary::-webkit-details-marker {
      display: none;
    }
    .conversation-item summary::before {
      content: 'â–¶';
      display: inline-block;
      width: 16px;
      margin-right: 8px;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .conversation-item[open] summary::before {
      transform: rotate(90deg);
    }
    .conversation-meta {
      font-size: 12px;
      color: #c7cff5;
    }
    .conversation-body {
      margin-top: 10px;
      margin-left: 24px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: #e0e0e0;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
    }
    @media (max-width: 768px) {
      table { font-size: 12px; }
      .dashboard-layout { padding: 0 16px 32px; }
      
      /* ãƒ¢ãƒã‚¤ãƒ«: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šéƒ¨ã« */
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        min-width: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .admin-navigation h2 {
        width: 100%;
        margin: 0 0 12px;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-url {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯URLã‚’éè¡¨ç¤º */
      }
    }
    @media (min-width: 769px) {
      /* PC: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å·¦å´ã« */
      .main-container {
        flex-direction: row;
      }
    }
    @media (min-width: 960px) {
      .dashboard-columns {
        flex-direction: row;
        align-items: flex-start;
        gap: 16px;
      }
      .column-left {
        width: 35%;
        min-width: 350px;
        flex-shrink: 0;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
      .column-right {
        flex: 1;
        min-width: 500px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }
    }
    
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ‘ãƒãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .user-info-panel {
      position: fixed;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      padding: 80px 16px 20px;
      overflow-y: auto;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    
    .user-info-panel.open {
      transform: translateX(0);
    }
    
    .user-info-panel-close {
      position: fixed;
      top: 80px;
      left: 268px;
      background: rgba(255, 78, 132, 0.3);
      border: 1px solid rgba(255, 78, 132, 0.5);
      color: #ff6b9d;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      z-index: 101;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .user-info-panel.open .user-info-panel-close {
      opacity: 1;
      pointer-events: auto;
    }
    
    .user-info-panel-close:hover {
      background: rgba(255, 78, 132, 0.3);
    }
    .token-input { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .token-input input { flex: 1; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }
    .list-scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: linear-gradient(135deg, rgba(255, 78, 132, 0.9), rgba(255, 130, 0, 0.8)); }
    .muted { color: #9da2c6; font-size: 12px; }
    
    /* ã‚¿ãƒ–æ©Ÿèƒ½ */
    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    /* PCç‰ˆ: å·¦å´ã«é…ç½® */
    @media (min-width: 769px) {
      .admin-tabs {
        justify-content: flex-start;
        align-items: flex-start;
        padding-left: 20px;
      }
    }
    
    .admin-tab {
      padding: 12px 24px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: #f7f5ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .admin-tab:hover {
      background: rgba(138, 43, 226, 0.3);
    }
    
    .admin-tab.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .tab-content {
      display: none !important;
    }
    
    .tab-content.active {
      display: block !important;
      min-height: 100%; /* PCç”»é¢ã§ç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
      height: 100%; /* è¦ªè¦ç´ ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
    }
    
    .hidden {
      display: none !important;
    }
    
    /* ========================================
       ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
       ======================================== */
    
    /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã®å·¦å´ãƒ‘ãƒãƒ«ï¼ˆç¸®å°ç‰ˆï¼‰ */
    body.test-mode-active .column-left {
      max-width: 280px;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      border-right: 1px solid rgba(138, 43, 226, 0.2);
      padding-right: 12px;
      margin-right: 12px;
    }
    
    /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã®ä¸­å¤®ã‚¨ãƒªã‚¢ */
    body.test-mode-active .content-area {
      flex: 1;
      overflow-y: auto;
    }
    
    /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ã®å³å´ãƒ‘ãƒãƒ«ï¼ˆãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºï¼‰ */
    body.test-mode-active .column-right {
      display: flex;
      flex-direction: column;
      background: rgba(138, 43, 226, 0.05);
      border: 1px solid rgba(138, 43, 226, 0.2);
      border-radius: 12px;
      padding: 16px;
      gap: 0;
      min-height: 500px;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .test-chat-screen-header {
      font-size: 14px;
      font-weight: 600;
      color: #d6c9ff;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    /* ãƒãƒ£ãƒƒãƒˆç”»é¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .test-chat-screen-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .test-chat-screen-messages .message {
      padding: 12px;
      border-radius: 8px;
      word-wrap: break-word;
      animation: slideInMessage 0.4s ease;
    }
    
    .test-chat-screen-messages .message.system {
      background: rgba(138, 43, 226, 0.2);
      border-left: 3px solid rgba(138, 43, 226, 0.6);
      color: #d6c9ff;
      text-align: center;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
      font-size: 12px;
    }
    
    .test-chat-screen-messages .message.assistant {
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.3);
      color: #f7f5ff;
      margin-right: auto;
      max-width: 85%;
    }
    
    .test-chat-screen-messages .message.user {
      background: rgba(75, 120, 180, 0.15);
      border: 1px solid rgba(75, 120, 180, 0.3);
      color: #b8d4ff;
      margin-left: auto;
      max-width: 85%;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p class="muted">ç®¡ç†è€…ç”¨ã®çµ±åˆç®¡ç†ç”»é¢ã§ã™ã€‚</p>
  </header>

  <!-- IPç®¡ç†ãƒ‘ãƒãƒ«å‰Šé™¤ - èªå¯ãƒã‚§ãƒƒã‚¯å»ƒæ­¢ -->

  <div class="main-container">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPC: å·¦å´ã€ãƒ¢ãƒã‚¤ãƒ«: ä¸Šéƒ¨ï¼‰ -->
    <nav class="admin-navigation">
      <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <button class="admin-nav-item active" data-tab="user-search">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        <div class="admin-nav-url">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢ãƒ»ç®¡ç†</div>
      </button>
      <button class="admin-nav-item" data-tab="token-usage">
        ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨çŠ¶æ³
        <div class="admin-nav-url">API ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®ç¢ºèª</div>
      </button>
    </nav>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ– -->
      <div class="tab-content active" id="user-search-tab">
        <div class="dashboard-layout">
          <div class="dashboard-columns">
            <!-- å·¦å´ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆå›ºå®šï¼‰ -->
            <div id="userInfoPanel" class="user-info-panel">
              <button class="user-info-panel-close" id="closeUserPanel">âœ•</button>
              <section class="card" style="margin: 0;">
                <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
                <p class="muted" id="selectedUserLabel"></p>
                <form id="userForm">
                  <input type="hidden" id="formUserId">
                  <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
                    <input type="text" id="formNickname" required>
                  </label>
                  <div style="display:flex; gap:8px;">
                    <label style="flex:1;">å¹´
                      <input type="number" id="formYear" min="1900" max="2100" required>
                    </label>
                    <label style="flex:1;">æœˆ
                      <input type="number" id="formMonth" min="1" max="12" required>
                    </label>
                    <label style="flex:1;">æ—¥
                      <input type="number" id="formDay" min="1" max="31" required>
                    </label>
                  </div>
                  <label>åˆè¨€è‘‰
                    <select id="formPassphrase"></select>
                  </label>
                  <label>å®ˆè­·ç¥
                    <select id="formGuardian">
                      <option value="">æœªæ±ºå®š</option>
                      <option value="å¤©ç…§å¤§ç¥">å¤©ç…§å¤§ç¥</option>
                      <option value="å¤§å›½ä¸»å‘½">å¤§å›½ä¸»å‘½</option>
                      <option value="å¤§æ—¥å¦‚æ¥">å¤§æ—¥å¦‚æ¥</option>
                      <option value="åƒæ‰‹è¦³éŸ³">åƒæ‰‹è¦³éŸ³</option>
                      <option value="ä¸å‹•æ˜ç‹">ä¸å‹•æ˜ç‹</option>
                    </select>
                  </label>
                  <div class="actions">
                    <button type="submit">æ›´æ–°ã™ã‚‹</button>
                    <button type="button" class="danger" id="deleteUserButton">é€€ä¼šï¼ˆå‰Šé™¤ï¼‰</button>
                  </div>
                  <p class="muted" id="formStatus"></p>
                </form>
              </section>
            </div>

            <!-- çœŸã‚“ä¸­ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ -->
            <div class="column-left">
              <section class="card">
                <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</h2>
                <form id="searchForm">
                  <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
                    <input type="text" id="searchNickname" placeholder="éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã§ãã¾ã™">
                  </label>
                  <div style="display:flex; gap:8px;">
                    <label style="flex:1;">å¹´
                      <input type="number" id="searchYear" min="1900" max="2100" placeholder="ä¾‹: 1990">
                    </label>
                    <label style="flex:1;">æœˆ
                      <input type="number" id="searchMonth" min="1" max="12" placeholder="1-12">
                    </label>
                    <label style="flex:1;">æ—¥
                      <input type="number" id="searchDay" min="1" max="31" placeholder="1-31">
                    </label>
                  </div>
                  <div class="actions">
                    <button type="submit">æ¤œç´¢ã™ã‚‹</button>
                    <button type="button" id="resetSearchButton">æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</button>
                  </div>
                  <p class="muted">â€»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  / ç”Ÿå¹´æœˆæ—¥ã®ã„ãšã‚Œã‹ä¸€ã¤ã ã‘ã§ã‚‚æ¤œç´¢å¯èƒ½ã§ã™ã€‚ç©ºã®ã¾ã¾æ¤œç´¢ã™ã‚‹ã¨å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </form>
              </section>

              <section class="card">
                <h2>æ¤œç´¢çµæœ</h2>
                <div id="resultSummary" class="muted">æ¤œç´¢çµæœ 0 ä»¶</div>
                <div class="list-scroll" style="max-height: 400px; overflow-y: auto;">
                  <table>
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
                        <th>ç”Ÿå¹´æœˆæ—¥</th>
                      </tr>
                    </thead>
                    <tbody id="userTableBody">
                      <tr><td colspan="3" class="muted">æ¥ç¶šã—ã¦èª­ã¿è¾¼ã¿...</td></tr>
                    </tbody>
                  </table>
                </div>
              </section>
            </div>

            <!-- å³å´ï¼šä¼šè©±å±¥æ­´ -->
            <div id="conversationPanelContainer" class="column-right">
                <h2 style="margin: 0 0 16px; flex-shrink: 0;">ä¼šè©±å±¥æ­´ï¼ˆæœ€å¤§6ä»¶ä¿å­˜ï¼šç›´è¿‘3ä»¶+è¦ç´„3ä»¶=63ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†ï¼‰</h2>
                
                <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; flex-shrink: 0;">
                  <label style="flex: 1; min-width: 180px;">
                    ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:
                    <select id="conversationCharacterFilter" style="width: 100%; margin-top: 6px;">
                      <option value="">ã™ã¹ã¦</option>
                      <option value="kaede">æ¥“</option>
                      <option value="yukino">ç¬¹å²¡é›ªä¹ƒ</option>
                      <option value="sora">ç©º</option>
                      <option value="kaon">ä¸‰å´èŠ±éŸ³</option>
                    </select>
                  </label>
                  <div style="display: flex; gap: 6px; align-items: flex-end; flex-shrink: 0;">
                    <button id="selectAllConversations" style="padding: 8px 12px; background: rgba(138, 43, 226, 0.2); border: 1px solid rgba(138, 43, 226, 0.4); border-radius: 6px; color: #c7cdff; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap;">å…¨é¸æŠ</button>
                    <button id="deselectAllConversations" style="padding: 8px 12px; background: rgba(138, 43, 226, 0.2); border: 1px solid rgba(138, 43, 226, 0.4); border-radius: 6px; color: #c7cdff; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap;">è§£é™¤</button>
                  </div>
                </div>
                
                <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                <div id="conversationDeleteControls" style="display: none; margin-bottom: 12px; padding: 10px; background: rgba(255, 78, 132, 0.1); border: 1px solid rgba(255, 78, 132, 0.3); border-radius: 8px; flex-shrink: 0;">
                  <p class="muted" style="margin: 0 0 8px;">
                    <span id="selectedConversationCount">0</span>ä»¶å‰Šé™¤
                  </p>
                  <div style="display: flex; gap: 6px;">
                    <button id="deleteSelectedConversations" class="danger" style="padding: 6px 12px; font-size: 12px; flex: 1;">å‰Šé™¤å®Ÿè¡Œ</button>
                    <button id="cancelDeleteConversations" style="padding: 6px 12px; background: rgba(138, 43, 226, 0.2); border: 1px solid rgba(138, 43, 226, 0.4); border-radius: 6px; color: #c7cdff; cursor: pointer; font-size: 12px; font-weight: 500; flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                  </div>
                </div>
                
                <!-- å±¥æ­´ãƒªã‚¹ãƒˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ -->
                <div id="conversationList" class="conversation-list" style="flex: 1; overflow-y: auto; min-height: 0; padding-right: 8px;">
                  <p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨çŠ¶æ³ã‚¿ãƒ– -->
      <div class="tab-content" id="token-usage-tab">
        <div class="dashboard-layout">
          <section class="card">
            <h2>ğŸ”¢ ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨çŠ¶æ³</h2>
            <p class="muted">å„é‘‘å®šå£«ã¨ã®ä¼šè©±ã§ä½¿ç”¨ã•ã‚Œã‚‹APIãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
            
            <div style="margin-top: 20px;">
              <h3 style="font-size: 16px; margin-bottom: 12px;">ãƒ†ã‚¹ãƒˆä¼šè©±</h3>
              <p style="font-size: 13px; color: #9da2c6; margin-bottom: 12px;">
                å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ç°¡å˜ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’ç¢ºèªã—ã¾ã™ã€‚
              </p>
              
              <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <label style="flex: 1;">
                  <span style="display: block; margin-bottom: 6px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</span>
                  <select id="tokenTestCharacter" style="width: 100%;">
                    <option value="kaede">æ¥“ï¼ˆã‹ãˆã§ï¼‰</option>
                    <option value="yukino">é›ªä¹ƒï¼ˆã‚†ãã®ï¼‰</option>
                    <option value="sora">ç©ºï¼ˆãã‚‰ï¼‰</option>
                    <option value="kaon">èŠ±éŸ³ï¼ˆã‹ãŠã‚“ï¼‰</option>
                  </select>
                </label>
                <label style="flex: 2;">
                  <span style="display: block; margin-bottom: 6px;">ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
                  <input type="text" id="tokenTestMessage" placeholder="ä¾‹: ã“ã‚“ã«ã¡ã¯" value="ã“ã‚“ã«ã¡ã¯" style="width: 100%;">
                </label>
                <div style="display: flex; align-items: flex-end;">
                  <button id="tokenTestButton" style="padding: 10px 20px; white-space: nowrap;">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                </div>
              </div>
              
              <div id="tokenTestStatus" style="margin-top: 12px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; font-size: 13px; display: none;"></div>
            </div>
            
            <div style="margin-top: 30px;">
              <h3 style="font-size: 16px; margin-bottom: 12px;">ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨å±¥æ­´</h3>
              <div style="overflow-x: auto;">
                <table style="width: 100%; font-size: 13px;">
                  <thead>
                    <tr style="background: rgba(138, 43, 226, 0.2);">
                      <th style="padding: 10px; text-align: left;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</th>
                      <th style="padding: 10px; text-align: left;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                      <th style="padding: 10px; text-align: right;">å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³</th>
                      <th style="padding: 10px; text-align: right;">å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³</th>
                      <th style="padding: 10px; text-align: right;">åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³</th>
                      <th style="padding: 10px; text-align: left;">ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</th>
                      <th style="padding: 10px; text-align: left;">æ™‚åˆ»</th>
                    </tr>
                  </thead>
                  <tbody id="tokenHistoryTableBody">
                    <tr>
                      <td colspan="7" style="padding: 20px; text-align: center; color: #9da2c6;">
                        ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div style="margin-top: 30px; padding: 16px; background: rgba(138, 43, 226, 0.1); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 12px;">
              <h3 style="font-size: 16px; margin-bottom: 12px;">ğŸ’° ã‚³ã‚¹ãƒˆè¨ˆç®—</h3>
              <p style="font-size: 13px; color: #9da2c6; margin-bottom: 16px;">
                DeepSeek API ã®æ–™é‡‘ä½“ç³»ã«åŸºã¥ã„ã¦ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã—ã¾ã™ã€‚
              </p>
              <div id="tokenCostSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                  <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³</div>
                  <div style="font-size: 20px; font-weight: 600; color: #90ffc7;">0</div>
                </div>
                <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                  <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³</div>
                  <div style="font-size: 20px; font-weight: 600; color: #90ffc7;">0</div>
                </div>
                <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                  <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°</div>
                  <div style="font-size: 20px; font-weight: 600; color: #d6c9ff;">0</div>
                </div>
                <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                  <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">æ¨å®šã‚³ã‚¹ãƒˆ (USD)</div>
                  <div style="font-size: 20px; font-weight: 600; color: #ffb366;">$0.00</div>
                </div>
              </div>
              <p style="font-size: 11px; color: #9da2c6; margin-top: 12px;">
                â€» DeepSeek API (2026å¹´2æœˆæ™‚ç‚¹): å…¥åŠ›Â¥42/1M tokens, å‡ºåŠ›Â¥63/1M tokens<br>
                â€» ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã¯å…¥åŠ›Â¥4.2/1M tokensã¨ã•ã‚‰ã«ä½ã‚³ã‚¹ãƒˆ
              </p>
            </div>
          </section>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
    (function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.admin-nav-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/admin/') && href === 'dashboard.html')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    })();
    
    const adminTokenInput = null; // å‰Šé™¤
    const connectButton = null; // å‰Šé™¤
    const connectionStatus = null; // å‰Šé™¤
    const clientIpDisplay = null; // å‰Šé™¤
    const adminIpPanel = null; // å‰Šé™¤
    const newAdminIp = null; // å‰Šé™¤
    const newAdminIpDescription = null; // å‰Šé™¤
    const addAdminIpButton = null; // å‰Šé™¤
    const registeredIpsContainer = null; // å‰Šé™¤
    const registeredIpsList = null; // å‰Šé™¤
    const currentIpDisplay = null; // å‰Šé™¤
    const addCurrentIpButton = null; // å‰Šé™¤
    const userTableBody = document.getElementById('userTableBody');
    const form = document.getElementById('userForm');
    const formUserId = document.getElementById('formUserId');
    const formNickname = document.getElementById('formNickname');
    const formYear = document.getElementById('formYear');
    const formMonth = document.getElementById('formMonth');
    const formDay = document.getElementById('formDay');
    const formPassphrase = document.getElementById('formPassphrase');
    const formGuardian = document.getElementById('formGuardian');
    const formStatus = document.getElementById('formStatus');
    const deleteUserButton = document.getElementById('deleteUserButton');
    const searchForm = document.getElementById('searchForm');
    const searchNickname = document.getElementById('searchNickname');
    const searchYear = document.getElementById('searchYear');
    const searchMonth = document.getElementById('searchMonth');
    const searchDay = document.getElementById('searchDay');
    const resetSearchButton = document.getElementById('resetSearchButton');
    const resultSummary = document.getElementById('resultSummary');
    const detailCard = null; // è¦ç´ ã¯å‰Šé™¤æ¸ˆã¿
    const selectedUserLabel = document.getElementById('selectedUserLabel');
    const conversationCard = null; // è¦ç´ ã¯å‰Šé™¤æ¸ˆã¿
    const conversationList = document.getElementById('conversationList');
    const userInfoPanel = document.getElementById('userInfoPanel');
    const closeUserPanel = document.getElementById('closeUserPanel');
    // ãƒ†ã‚¹ãƒˆé–¢é€£ã®è¦ç´ ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆãƒ†ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç®¡ç†ï¼‰
    // const launchTestModeButton = document.getElementById('launchTestModeButton');
    // const testUserSelect = document.getElementById('testUserSelect');
    // const testCharacterSelect = document.getElementById('testCharacterSelect');
    // const testFirstVisitButton = document.getElementById('testFirstVisitButton');
    // const testReturningVisitButton = document.getElementById('testReturningVisitButton');
    // const clearHistoryButton = document.getElementById('clearHistoryButton');
    // const testStatus = document.getElementById('testStatus');
    // const testResultPanel = document.getElementById('testResultPanel');
    // const testResultContent = document.getElementById('testResultContent');
    const feedbackTitle = document.getElementById('feedbackTitle');
    const feedbackDescription = document.getElementById('feedbackDescription');
    const feedbackPriority = document.getElementById('feedbackPriority');
    const feedbackCharacter = document.getElementById('feedbackCharacter');
    const submitFeedbackButton = document.getElementById('submitFeedbackButton');
    const loadFeedbackButton = document.getElementById('loadFeedbackButton');
    const feedbackStatus = document.getElementById('feedbackStatus');
    const feedbackHistoryPanel = document.getElementById('feedbackHistoryPanel');
    const feedbackHistoryContent = document.getElementById('feedbackHistoryContent');

    const deities = [
      'æ¡œèˆã„æ•£ã‚‹æ˜¥ã®é“',
      'æœˆæ˜ã‹ã‚Šã«æµ®ã‹ã¶å¤¢',
      'æ˜Ÿé™ã‚‹å¤œã®ç‰©èª',
      'æœéœ²ã«å…‰ã‚‹å¸Œæœ›',
      'å¤•ç„¼ã‘ã®ã‚„ã•ã—ã•',
      'è™¹ã®æ¶ã‘æ©‹',
      'æ˜¥é¢¨ã«æºã‚Œã‚‹èŠ±',
      'é›ªåŒ–ç²§ã®é™ã‘ã•',
      'é¢¨éˆ´ã®æ¶¼ã—ã„éŸ³',
      'è‰ã—ãã‚Œã®å¤',
      'ç´…è‘‰æ•£ã‚‹å°é“',
      'åˆé›ªã®è´ˆã‚Šç‰©',
      'èœã®èŠ±ç•‘ã®æ˜¥',
      'è›èˆã†å¤•ã¹',
      'é›²æµ·ã«æµ®ã‹ã¶å¤¢',
      'æ³¢ã®éŸ³ã®å­å®ˆæ­Œ',
      'éœ§é›¨ã®æ½¤ã„',
      'è½è‘‰ã®æ•·ãæ¯¯',
      'æ˜¥éœã®æºã‚‰ã',
      'å°é³¥ã®ã•ãˆãšã‚Š',
      'å°å·ã®ã›ã›ã‚‰ã',
      'é‡åŸã®é¢¨è»Š',
      'è—¤è‰²ã®èŠ±',
      'é‡‘è‰²ã®ç¨²ç©‚'
    ];
    deities.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      formPassphrase.appendChild(option);
    });

    let currentToken = '';
    let users = [];
    let filteredUsers = [];
    let selectedUserId = null;
    let currentClientIp = null;

    function hideDetailSections() {
      if (detailCard) detailCard.classList.add('hidden');
      if (conversationCard) conversationCard.classList.add('hidden');
      if (conversationList) conversationList.innerHTML = '<p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>';
      selectedUserLabel.textContent = '';
      formStatus.textContent = '';
      form.style.display = 'block'; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã«æˆ»ã™
      selectedUserId = null;
      userInfoPanel.classList.remove('open');
    }

    function showDetailSections(user) {
      if (detailCard) detailCard.classList.remove('hidden');
      if (conversationCard) conversationCard.classList.remove('hidden');
      selectedUserLabel.textContent = `ID: ${user.id} / ${user.nickname} / ${user.birth_year}å¹´${user.birth_month}æœˆ${user.birth_day}æ—¥`;
      form.style.display = 'block';
      userInfoPanel.classList.add('open');
    }

    hideDetailSections();
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
    fetchUsers();

    async function fetchUsers() {
      try {
        const usersRes = await fetch('/api/admin/users');
        if (!usersRes.ok) throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        const usersData = await usersRes.json();
        
        // APIã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ•´å½¢
        users = (usersData.users || []).map(user => ({
          id: user.id,
          nickname: user.nickname,
          birth_year: user.birth_year,
          birth_month: user.birth_month,
          birth_day: user.birth_day,
          passphrase: user.passphrase,
          guardian: user.guardian,
          created_at: user.created_at,
          message_count: user.message_count || 0
        }));

        applyFilters();
        renderUsers();
        hideDetailSections();
      } catch (error) {
        console.error(error);
        userTableBody.innerHTML = `<tr><td colspan="6" class="muted">ã‚¨ãƒ©ãƒ¼: ${error instanceof Error ? error.message : String(error)}</td></tr>`;
      }
    }

    function applyFilters() {
      const nickname = searchNickname.value.trim();
      const yearValue = searchYear.value.trim();
      const monthValue = searchMonth.value.trim();
      const dayValue = searchDay.value.trim();

      const hasNickname = nickname.length > 0;
      const hasYear = yearValue.length > 0;
      const hasMonth = monthValue.length > 0;
      const hasDay = dayValue.length > 0;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filteredUsers = users.filter((user) => {
        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ¤œç´¢
        let nicknameMatch = true;
        if (hasNickname) {
          nicknameMatch = user.nickname && user.nickname.includes(nickname);
        }

        // ç”Ÿå¹´æœˆæ—¥æ¤œç´¢
        const year = Number(yearValue);
        const month = Number(monthValue);
        const day = Number(dayValue);
        const yearMatch = hasYear ? (user.birth_year === year) : true;
        const monthMatch = hasMonth ? (user.birth_month === month) : true;
        const dayMatch = hasDay ? (user.birth_day === day) : true;

        return nicknameMatch && yearMatch && monthMatch && dayMatch;
      });
    }

    function renderUsers(list = filteredUsers) {
      resultSummary.textContent = `æ¤œç´¢çµæœ ${list.length} ä»¶`;
      if (!list.length) {
        userTableBody.innerHTML = '<tr><td colspan="5" class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }
      
      userTableBody.innerHTML = list.map((user) => {
        return `
          <tr>
            <td>${user.id}</td>
            <td><a href="#" style="color: #d6c9ff; cursor: pointer; text-decoration: underline;" data-user-id="${user.id}" class="user-nickname-link">${user.nickname || 'N/A'}</a></td>
            <td>${user.birth_year ? `${user.birth_year}/${user.birth_month}/${user.birth_day}` : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    userTableBody.addEventListener('click', (event) => {
      const target = event.target;
      // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯
      if (target.matches('.user-nickname-link')) {
        event.preventDefault();
        const id = Number(target.dataset.userId);
        const user = users.find((u) => u.id === id);
        if (user) {
          populateForm(user);
          fetchConversations(id);
          selectedUserId = id;
        }
      }
    });

    function populateForm(user) {
      formUserId.value = user.id;
      formNickname.value = user.nickname;
      formYear.value = user.birth_year;
      formMonth.value = user.birth_month;
      formDay.value = user.birth_day;
      formPassphrase.value = user.passphrase || '';
      formGuardian.value = user.guardian || '';
      formStatus.textContent = '';
      selectedUserId = user.id;
      showDetailSections(user);
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³æ¨å®šé–¢æ•°
    function estimateTokens(text) {
      if (!text) return 0;
      
      // æ—¥æœ¬èªæ–‡å­—æ•°ã‚’æ¨å®šï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ï¼‰
      const japaneseChars = (text.match(/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF]/g) || []).length;
      // è‹±æ•°å­—ã¨è¨˜å·
      const otherChars = text.length - japaneseChars;
      
      // æ—¥æœ¬èª: 1æ–‡å­— â‰ˆ 2.5ãƒˆãƒ¼ã‚¯ãƒ³ã€è‹±æ•°å­—: 1æ–‡å­— â‰ˆ 0.25ãƒˆãƒ¼ã‚¯ãƒ³
      return Math.ceil(japaneseChars * 2.5 + otherChars * 0.25);
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ï¼‰
    const systemPromptTokens = {
      'kaede': 1200,   // æ¥“ã¯å®ˆè­·ç¥æƒ…å ±ãŒã‚ã‚Šé•·ã„
      'yukino': 800,   // é›ªä¹ƒã¯ã‚¿ãƒ­ãƒƒãƒˆæƒ…å ±
      'sora': 600,     // ç©ºã¯æ¨™æº–çš„
      'kaon': 1000     // èŠ±éŸ³ã¯è¨ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¤å®šã‚ã‚Š
    };
    
    function renderConversationList(records) {
      if (!records.length) {
        conversationList.innerHTML = '<p class="muted">ä¼šè©±å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        document.getElementById('conversationDeleteControls').style.display = 'none';
        return;
      }
      
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      records.forEach(item => {
        if (!grouped[item.character_id]) {
          grouped[item.character_id] = [];
        }
        grouped[item.character_id].push(item);
      });
      
      // å…¨ä½“ã®åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—
      let grandTotalTokens = 0;
      const characterTokens = {};
      
      conversationList.innerHTML = Object.entries(grouped).map(([characterId, items]) => {
        const characterNames = {
          'kaede': 'æ¥“',
          'yukino': 'ç¬¹å²¡é›ªä¹ƒ',
          'sora': 'ç©º',
          'kaon': 'ä¸‰å´èŠ±éŸ³'
        };
        const characterName = characterNames[characterId] || characterId;
        
        // ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—
        let characterTotalTokens = 0;
        
        // ä¼šè©±ãƒšã‚¢ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨ˆç®—ï¼ˆuser + assistantï¼‰
        const conversationPairs = [];
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.role === 'user') {
            // æ¬¡ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
            const assistantMsg = items[i + 1];
            if (assistantMsg && assistantMsg.role === 'assistant') {
              const userTokens = estimateTokens(item.message);
              const assistantTokens = estimateTokens(assistantMsg.message);
              const systemTokens = systemPromptTokens[characterId] || 800;
              const totalTokens = systemTokens + userTokens + assistantTokens;
              
              conversationPairs.push({
                userItem: item,
                assistantItem: assistantMsg,
                userTokens,
                assistantTokens,
                systemTokens,
                totalTokens
              });
              
              characterTotalTokens += totalTokens;
              i++; // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }
          }
        }
        
        grandTotalTokens += characterTotalTokens;
        characterTokens[characterId] = characterTotalTokens;
        
        return `
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(138, 43, 226, 0.1); border: 1px solid rgba(138, 43, 226, 0.2); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <input type="checkbox" class="character-group-checkbox" data-character="${characterId}" style="cursor: pointer; width: 18px; height: 18px;">
              <h4 style="margin: 0; font-size: 14px; color: #d6c9ff; flex: 1;">
                ${characterName} (${items.length}ä»¶)
              </h4>
              <span style="font-size: 12px; color: #90ffc7; font-weight: 600;">
                ~${characterTotalTokens.toLocaleString()} tokens
              </span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
              ${conversationPairs.map((pair, index) => {
                const safeUserContent = pair.userItem.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeAssistantContent = pair.assistantItem.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const timestamp = new Date(pair.userItem.created_at).toLocaleString('ja-JP');
                
                return `
                  <details class="conversation-item" style="background: rgba(138, 43, 226, 0.08); border: 1px solid rgba(138, 43, 226, 0.2); border-radius: 6px; padding: 8px;">
                    <summary style="padding: 6px 0; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" class="conversation-checkbox" data-id="${pair.userItem.id}" data-character="${characterId}" style="cursor: pointer; width: 16px; height: 16px; flex-shrink: 0;" onclick="event.stopPropagation();">
                      <span style="flex: 1; font-size: 12px; color: #c7cdff;">
                        ğŸ’¬ ä¼šè©± #${conversationPairs.length - index} - ${timestamp}
                      </span>
                      <span style="font-size: 11px; color: #ffb366; font-weight: 600;">
                        ~${pair.totalTokens.toLocaleString()} tokens
                      </span>
                    </summary>
                    <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
                      <div style="padding: 8px; background: rgba(100, 150, 255, 0.1); border-left: 3px solid rgba(100, 150, 255, 0.5); border-radius: 4px;">
                        <div style="font-size: 11px; color: #90c2ff; margin-bottom: 4px; display: flex; justify-content: space-between;">
                          <span>ğŸ‘¤ ç›¸è«‡è€…</span>
                          <span style="color: #90ffc7;">~${pair.userTokens} tokens</span>
                        </div>
                        <div style="font-size: 12px; color: #e0e0e0; white-space: pre-wrap;">${safeUserContent}</div>
                      </div>
                      <div style="padding: 8px; background: rgba(200, 150, 255, 0.1); border-left: 3px solid rgba(200, 150, 255, 0.5); border-radius: 4px;">
                        <div style="font-size: 11px; color: #d6c9ff; margin-bottom: 4px; display: flex; justify-content: space-between;">
                          <span>ğŸ”® ${characterName}</span>
                          <span style="color: #90ffc7;">~${pair.assistantTokens} tokens</span>
                        </div>
                        <div style="font-size: 12px; color: #e0e0e0; white-space: pre-wrap;">${safeAssistantContent}</div>
                      </div>
                      <div style="font-size: 10px; color: #9da2c6; padding: 4px 0; text-align: right;">
                        ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ~${pair.systemTokens} tokens
                      </div>
                    </div>
                  </details>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // å…¨ä½“ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚µãƒãƒªãƒ¼ã‚’å…ˆé ­ã«è¿½åŠ 
      if (grandTotalTokens > 0) {
        // DeepSeek API ã®æ–™é‡‘ï¼ˆ2026å¹´2æœˆæ™‚ç‚¹ï¼‰
        // å…¥åŠ›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœªãƒ’ãƒƒãƒˆï¼‰: Â¥42/1M tokens ($0.28/1M tokens)
        // å‡ºåŠ›: Â¥63/1M tokens ($0.42/1M tokens)
        // ç°¡æ˜“è¨ˆç®—: å…¥åŠ›ã¨å‡ºåŠ›ã®æ¯”ç‡ã‚’ 3:2 ã¨ä»®å®š
        const estimatedInputTokens = Math.ceil(grandTotalTokens * 0.6);
        const estimatedOutputTokens = Math.ceil(grandTotalTokens * 0.4);
        const estimatedCostUSD = (estimatedInputTokens / 1000000) * 0.28 + (estimatedOutputTokens / 1000000) * 0.42;
        const estimatedCostJPY = (estimatedInputTokens / 1000000) * 42 + (estimatedOutputTokens / 1000000) * 63;
        
        const summaryHTML = `
          <div style="margin-bottom: 20px; padding: 16px; background: rgba(0, 200, 120, 0.1); border: 2px solid rgba(0, 200, 120, 0.3); border-radius: 12px;">
            <h4 style="margin: 0 0 12px; font-size: 14px; color: #90ffc7;">ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚µãƒãƒªãƒ¼</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
              <div>
                <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆæ¨å®šï¼‰</div>
                <div style="font-size: 20px; font-weight: 600; color: #d6c9ff;">~${grandTotalTokens.toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">æ¨å®šã‚³ã‚¹ãƒˆ</div>
                <div style="font-size: 20px; font-weight: 600; color: #ffb366;">Â¥${estimatedCostJPY.toFixed(2)}</div>
                <div style="font-size: 10px; color: #9da2c6; margin-top: 2px;">($${estimatedCostUSD.toFixed(4)})</div>
              </div>
              <div>
                <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ä¼šè©±ãƒšã‚¢æ•°</div>
                <div style="font-size: 20px; font-weight: 600; color: #90ffc7;">${Math.floor(records.length / 2)}</div>
              </div>
            </div>
            <p style="font-size: 10px; color: #9da2c6; margin: 12px 0 0; line-height: 1.4;">
              â€» ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¯æ¨å®šå€¤ã§ã™ï¼ˆæ—¥æœ¬èª1æ–‡å­—â‰ˆ2.5tokensï¼‰ã€‚<br>
              â€» ã‚³ã‚¹ãƒˆè¨ˆç®—: DeepSeek API (å…¥åŠ›Â¥42/1M, å‡ºåŠ›Â¥63/1M), å…¥åŠ›:å‡ºåŠ›=3:2ã¨ä»®å®šã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœªãƒ’ãƒƒãƒˆæƒ³å®šã€‚
            </p>
          </div>
        `;
        conversationList.innerHTML = summaryHTML + conversationList.innerHTML;
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      setupConversationCheckboxes();
    }
    
    function setupConversationCheckboxes() {
      const characterGroupCheckboxes = document.querySelectorAll('.character-group-checkbox');
      const conversationCheckboxes = document.querySelectorAll('.conversation-checkbox');
      const deleteControls = document.getElementById('conversationDeleteControls');
      const selectedCount = document.getElementById('selectedConversationCount');
      
      // æ–‡å­—ã‚°ãƒ«ãƒ¼ãƒ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      characterGroupCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const character = checkbox.dataset.character;
          const itemCheckboxes = document.querySelectorAll(`.conversation-checkbox[data-character="${character}"]`);
          itemCheckboxes.forEach(itemCheckbox => {
            itemCheckbox.checked = checkbox.checked;
          });
          updateDeleteControls();
        });
      });
      
      // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      conversationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteControls);
      });
      
      function updateDeleteControls() {
        const selectedCheckboxes = document.querySelectorAll('.conversation-checkbox:checked');
        if (selectedCheckboxes.length > 0) {
          deleteControls.style.display = 'block';
          selectedCount.textContent = selectedCheckboxes.length;
        } else {
          deleteControls.style.display = 'none';
        }
      }
    }

    async function fetchConversations(userId) {
      conversationList.innerHTML = '<p class="muted">èª­ã¿è¾¼ã¿ä¸­...</p>';
      try {
        const res = await fetch(`/api/admin/conversations?userId=${userId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ä¼šè©±å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // å…¨ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
        allConversations = data.conversations || [];
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        conversationCharacterFilter.value = '';
        
        // è¡¨ç¤º
        filterAndRenderConversations();
      } catch (error) {
        conversationList.innerHTML = `<p class="muted">${error.message}</p>`;
        document.getElementById('conversationDeleteControls').style.display = 'none';
      }
    }

    // connectButton ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤ï¼ˆèªå¯ãªã—ã«ãªã£ãŸãŸã‚ä¸è¦ï¼‰

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
      renderUsers();
    });

    resetSearchButton.addEventListener('click', () => {
      searchForm.reset();
      applyFilters();
      renderUsers();
    });

    closeUserPanel.addEventListener('click', hideDetailSections);

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      const payload = {
        id: Number(formUserId.value),
        nickname: formNickname.value.trim(),
        birthYear: Number(formYear.value),
        birthMonth: Number(formMonth.value),
        birthDay: Number(formDay.value),
        passphrase: formPassphrase.value,
        guardian: formGuardian.value || null,
      };
      try {
        const res = await fetch('/api/admin/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'æ›´æ–°ã—ã¾ã—ãŸã€‚';
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    deleteUserButton.addEventListener('click', async () => {
      if (!formUserId.value) {
        formStatus.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      if (!confirm('æœ¬å½“ã«é€€ä¼šå‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿä¼šè©±å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }
      try {
        const res = await fetch(`/api/admin/users?id=${formUserId.value}`, {
          method: 'DELETE',
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        formStatus.textContent = 'å‰Šé™¤ã—ã¾ã—ãŸã€‚';
        form.reset();
        hideDetailSections();
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    // ============================================
    // ä¼šè©±å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»å‰Šé™¤æ©Ÿèƒ½
    // ============================================
    const conversationCharacterFilter = document.getElementById('conversationCharacterFilter');
    const selectAllConversations = document.getElementById('selectAllConversations');
    const deselectAllConversations = document.getElementById('deselectAllConversations');
    const deleteSelectedConversations = document.getElementById('deleteSelectedConversations');
    const cancelDeleteConversations = document.getElementById('cancelDeleteConversations');
    
    let allConversations = [];
    
    conversationCharacterFilter.addEventListener('change', () => {
      filterAndRenderConversations();
    });
    
    selectAllConversations.addEventListener('click', () => {
      document.querySelectorAll('.conversation-checkbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      updateDeleteControls();
    });
    
    deselectAllConversations.addEventListener('click', () => {
      document.querySelectorAll('.conversation-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      updateDeleteControls();
    });
    
    deleteSelectedConversations.addEventListener('click', async () => {
      const selectedCheckboxes = document.querySelectorAll('.conversation-checkbox:checked');
      const conversationIds = Array.from(selectedCheckboxes).map(cb => Number(cb.dataset.id));
      
      if (!confirm(`${conversationIds.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/conversations', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversationIds,
          }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        // å‰Šé™¤å¾Œã«å±¥æ­´ã‚’å†å–å¾—
        fetchConversations(selectedUserId);
        alert(`${conversationIds.length}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } catch (error) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    });
    
    cancelDeleteConversations.addEventListener('click', () => {
      document.querySelectorAll('.conversation-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      updateDeleteControls();
    });
    
    function filterAndRenderConversations() {
      const selectedCharacter = conversationCharacterFilter.value;
      let filtered = allConversations;
      
      if (selectedCharacter) {
        filtered = allConversations.filter(item => item.character_id === selectedCharacter);
      }
      
      renderConversationList(filtered);
    }
    
    function updateDeleteControls() {
      const selectedCheckboxes = document.querySelectorAll('.conversation-checkbox:checked');
      const deleteControls = document.getElementById('conversationDeleteControls');
      const selectedCount = document.getElementById('selectedConversationCount');
      
      if (selectedCheckboxes.length > 0) {
        deleteControls.style.display = 'block';
        selectedCount.textContent = selectedCheckboxes.length;
      } else {
        deleteControls.style.display = 'none';
      }
    }

    // ============================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
    // ============================================
    document.querySelectorAll('.admin-nav-item').forEach(navItem => {
      navItem.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const targetTab = navItem.dataset.tab;
        
        if (!targetTab) {
          console.warn('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] targetTabãŒã‚ã‚Šã¾ã›ã‚“:', navItem);
          return;
        }
        
        console.log('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™:', targetTab);
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
          console.log('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ:', content.id);
        });
        
        const targetContent = document.getElementById(`${targetTab}-tab`);
        console.log('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] æ¤œç´¢å¯¾è±¡ID:', `${targetTab}-tab`);
        console.log('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] è¦‹ã¤ã‹ã£ãŸè¦ç´ :', targetContent);
        
        if (targetContent) {
          targetContent.classList.add('active');
          console.log('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] ã‚¿ãƒ–ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ:', targetTab, targetContent);
          
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
          const contentArea = document.querySelector('.content-area');
          if (contentArea) {
            contentArea.scrollTop = 0;
          }
        } else {
          console.error('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', `${targetTab}-tab`);
          console.error('[ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ] åˆ©ç”¨å¯èƒ½ãªã‚¿ãƒ–:', Array.from(document.querySelectorAll('.tab-content')).map(el => el.id));
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã‚¿ãƒ–ã«æˆ»ã£ãŸå ´åˆã®ã¿è©³ç´°ã‚’éš ã™
        if (targetTab === 'user-search') {
          hideDetailSections();
        }
      });
    });

    // ============================================
    // æ€§æ ¼è¨­å®šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆå‰Šé™¤ï¼‰
    // ============================================
    // ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯ç®¡ç†ç”»é¢ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸ

    // ============================================
    // ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœè¨­å®š
    // ============================================
    function setupButtonHoverEffects() {
      // å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«ãƒœã‚¿ãƒ³åŠ¹æœã®è¨­å®šã‚’è¿½åŠ 
    }
    
    // ============================================
    // IPç®¡ç†æ©Ÿèƒ½
    // ============================================
    
    // IPç®¡ç†æ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆèªå¯ãªã—ã«ãªã£ãŸãŸã‚ä¸è¦ï¼‰
    
    // ãƒœã‚¿ãƒ³ãƒ›ãƒãƒ¼åŠ¹æœã‚’åˆæœŸåŒ–
    setupButtonHoverEffects();
    
    // ============================================
    // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨çŠ¶æ³æ©Ÿèƒ½
    // ============================================
    const tokenTestButton = document.getElementById('tokenTestButton');
    const tokenTestCharacter = document.getElementById('tokenTestCharacter');
    const tokenTestMessage = document.getElementById('tokenTestMessage');
    const tokenTestStatus = document.getElementById('tokenTestStatus');
    const tokenHistoryTableBody = document.getElementById('tokenHistoryTableBody');
    
    let tokenHistory = [];
    
    if (tokenTestButton) {
      tokenTestButton.addEventListener('click', async () => {
        const character = tokenTestCharacter.value;
        const message = tokenTestMessage.value.trim();
        
        if (!message) {
          tokenTestStatus.style.display = 'block';
          tokenTestStatus.style.background = 'rgba(255, 107, 157, 0.2)';
          tokenTestStatus.style.borderLeft = '3px solid #ff6b9d';
          tokenTestStatus.textContent = 'âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
          return;
        }
        
        tokenTestButton.disabled = true;
        tokenTestButton.textContent = 'å®Ÿè¡Œä¸­...';
        tokenTestStatus.style.display = 'block';
        tokenTestStatus.style.background = 'rgba(138, 43, 226, 0.2)';
        tokenTestStatus.style.borderLeft = '3px solid rgba(138, 43, 226, 0.6)';
        tokenTestStatus.textContent = 'â„¹ï¸ API ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...';
        
        try {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆç®¡ç†ç”»é¢ãªã®ã§ã€ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨ï¼‰
          // ã¾ãšã€é©å½“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
          const searchRes = await fetch('/api/admin/users?search=');
          const searchData = await searchRes.json();
          
          if (!searchData.users || searchData.users.length === 0) {
            throw new Error('ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
          }
          
          const testUser = searchData.users[0]; // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨
          
          // API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
          const response = await fetch('/api/consult', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: message,
              character: character,
              userId: testUser.id,
              clientHistory: [],
            }),
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'API ã‚¨ãƒ©ãƒ¼');
          }
          
          // ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
          if (data.tokenUsage) {
            const characterNames = {
              'kaede': 'æ¥“ï¼ˆã‹ãˆã§ï¼‰',
              'yukino': 'é›ªä¹ƒï¼ˆã‚†ãã®ï¼‰',
              'sora': 'ç©ºï¼ˆãã‚‰ï¼‰',
              'kaon': 'èŠ±éŸ³ï¼ˆã‹ãŠã‚“ï¼‰'
            };
            
            const historyEntry = {
              character: characterNames[character] || character,
              message: message,
              promptTokens: data.tokenUsage.prompt_tokens,
              completionTokens: data.tokenUsage.completion_tokens,
              totalTokens: data.tokenUsage.total_tokens,
              provider: data.provider || data.tokenUsage.model || 'unknown',
              timestamp: new Date().toLocaleString('ja-JP'),
            };
            
            tokenHistory.unshift(historyEntry);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            updateTokenHistoryTable();
            updateTokenCostSummary();
            
            tokenTestStatus.style.background = 'rgba(0, 200, 120, 0.2)';
            tokenTestStatus.style.borderLeft = '3px solid #90ffc7';
            tokenTestStatus.innerHTML = `âœ… <strong>ãƒ†ã‚¹ãƒˆå®Œäº†</strong><br>
              å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: ${data.tokenUsage.prompt_tokens} | 
              å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: ${data.tokenUsage.completion_tokens} | 
              åˆè¨ˆ: ${data.tokenUsage.total_tokens} | 
              ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${data.provider || data.tokenUsage.model}`;
          } else {
            tokenTestStatus.style.background = 'rgba(255, 179, 102, 0.2)';
            tokenTestStatus.style.borderLeft = '3px solid #ffb366';
            tokenTestStatus.textContent = 'âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
          }
        } catch (error) {
          console.error('ãƒˆãƒ¼ã‚¯ãƒ³ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          tokenTestStatus.style.background = 'rgba(255, 107, 157, 0.2)';
          tokenTestStatus.style.borderLeft = '3px solid #ff6b9d';
          tokenTestStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        } finally {
          tokenTestButton.disabled = false;
          tokenTestButton.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ';
        }
      });
    }
    
    function updateTokenHistoryTable() {
      if (tokenHistory.length === 0) {
        tokenHistoryTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="padding: 20px; text-align: center; color: #9da2c6;">
              ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
            </td>
          </tr>
        `;
        return;
      }
      
      tokenHistoryTableBody.innerHTML = tokenHistory.map(entry => `
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
          <td style="padding: 10px;">${entry.character}</td>
          <td style="padding: 10px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${entry.message}</td>
          <td style="padding: 10px; text-align: right; color: #90ffc7;">${entry.promptTokens.toLocaleString()}</td>
          <td style="padding: 10px; text-align: right; color: #90ffc7;">${entry.completionTokens.toLocaleString()}</td>
          <td style="padding: 10px; text-align: right; color: #d6c9ff; font-weight: 600;">${entry.totalTokens.toLocaleString()}</td>
          <td style="padding: 10px;">${entry.provider}</td>
          <td style="padding: 10px; font-size: 11px; color: #9da2c6;">${entry.timestamp}</td>
        </tr>
      `).join('');
    }
    
    function updateTokenCostSummary() {
      const totalPromptTokens = tokenHistory.reduce((sum, entry) => sum + entry.promptTokens, 0);
      const totalCompletionTokens = tokenHistory.reduce((sum, entry) => sum + entry.completionTokens, 0);
      const totalTokens = tokenHistory.reduce((sum, entry) => sum + entry.totalTokens, 0);
      
      // DeepSeek API ã®æ–™é‡‘ï¼ˆ2026å¹´2æœˆæ™‚ç‚¹ï¼‰
      // å…¥åŠ›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœªãƒ’ãƒƒãƒˆï¼‰: Â¥42/1M tokens ($0.28/1M tokens)
      // å‡ºåŠ›: Â¥63/1M tokens ($0.42/1M tokens)
      const inputCostUSD = (totalPromptTokens / 1000000) * 0.28;
      const outputCostUSD = (totalCompletionTokens / 1000000) * 0.42;
      const totalCostUSD = inputCostUSD + outputCostUSD;
      
      const inputCostJPY = (totalPromptTokens / 1000000) * 42;
      const outputCostJPY = (totalCompletionTokens / 1000000) * 63;
      const totalCostJPY = inputCostJPY + outputCostJPY;
      
      const costSummary = document.getElementById('tokenCostSummary');
      if (costSummary) {
        costSummary.innerHTML = `
          <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
            <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³</div>
            <div style="font-size: 20px; font-weight: 600; color: #90ffc7;">${totalPromptTokens.toLocaleString()}</div>
          </div>
          <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
            <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³</div>
            <div style="font-size: 20px; font-weight: 600; color: #90ffc7;">${totalCompletionTokens.toLocaleString()}</div>
          </div>
          <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
            <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">ç·ãƒˆãƒ¼ã‚¯ãƒ³æ•°</div>
            <div style="font-size: 20px; font-weight: 600; color: #d6c9ff;">${totalTokens.toLocaleString()}</div>
          </div>
          <div style="padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
            <div style="font-size: 11px; color: #9da2c6; margin-bottom: 4px;">æ¨å®šã‚³ã‚¹ãƒˆ</div>
            <div style="font-size: 20px; font-weight: 600; color: #ffb366;">Â¥${totalCostJPY.toFixed(2)}</div>
            <div style="font-size: 11px; color: #9da2c6; margin-top: 2px;">($${totalCostUSD.toFixed(6)})</div>
          </div>
        `;
      }
    }
    
    // ============================================
    // ä¿®æ­£è¦æœ›ãƒ‘ãƒãƒ«æ©Ÿèƒ½
    // ============================================
    submitFeedbackButton.addEventListener('click', () => {
      const title = feedbackTitle.value.trim();
      const description = feedbackDescription.value.trim();
      const priority = feedbackPriority.value;
      const character = feedbackCharacter.value;

      if (!title || !description) {
        feedbackStatus.textContent = 'âŒ ã‚¿ã‚¤ãƒˆãƒ«ã¨è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¦æœ›ã‚’ä¿å­˜
      const feedback = {
        id: Date.now(),
        title,
        description,
        priority,
        character,
        createdAt: new Date().toLocaleString('ja-JP'),
        status: 'pending', // pending / in_progress / completed
      };

      let feedbackList = JSON.parse(localStorage.getItem('feedbackList') || '[]');
      feedbackList.push(feedback);
      localStorage.setItem('feedbackList', JSON.stringify(feedbackList));

      feedbackStatus.textContent = 'âœ… è¦æœ›ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼';
      feedbackTitle.value = '';
      feedbackDescription.value = '';
      feedbackPriority.value = 'medium';
      feedbackCharacter.value = '';

      // 2ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      setTimeout(() => {
        feedbackStatus.textContent = '';
      }, 2000);
    });

    loadFeedbackButton.addEventListener('click', () => {
      let feedbackList = JSON.parse(localStorage.getItem('feedbackList') || '[]');

      if (feedbackList.length === 0) {
        feedbackHistoryContent.innerHTML = '<p class="muted">è¦æœ›ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      } else {
        // æœ€æ–°é †ã«ä¸¦ã³æ›¿ãˆ
        feedbackList.sort((a, b) => b.id - a.id);

        feedbackHistoryContent.innerHTML = feedbackList.map(feedback => {
          const priorityColors = {
            'low': '#90ffc7',
            'medium': '#d6c9ff',
            'high': '#ffb366',
            'critical': '#ff6b9d'
          };
          const priorityLabels = {
            'low': 'ä½',
            'medium': 'ä¸­',
            'high': 'é«˜',
            'critical': 'ç·Šæ€¥'
          };
          const statusLabels = {
            'pending': 'æœªå¯¾å¿œ',
            'in_progress': 'å¯¾å¿œä¸­',
            'completed': 'å®Œäº†'
          };

          return `
            <div style="margin-bottom: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-left: 3px solid ${priorityColors[feedback.priority]}; border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                <span style="color: ${priorityColors[feedback.priority]}; font-weight: 600; font-size: 11px;">ã€${priorityLabels[feedback.priority]}ã€‘</span>
                <span style="color: #bfc4ff; font-weight: 600;">${feedback.title}</span>
                <span style="color: #9da2c6; font-size: 10px; margin-left: auto;">${feedback.createdAt}</span>
              </div>
              <p style="margin: 6px 0; color: #e0e0e0; font-size: 11px; line-height: 1.5; white-space: pre-wrap;">${feedback.description}</p>
              <div style="display: flex; gap: 8px; font-size: 10px; color: #9da2c6;">
                <span>ğŸ­ ${feedback.character || 'å…¨ä½“'}</span>
                <span style="margin-left: auto;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusLabels[feedback.status]}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      feedbackHistoryPanel.style.display = feedbackHistoryPanel.style.display === 'none' ? 'block' : 'none';
    });
    
  </script>
</body>
</html>
