<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユーザー管理 - 運命の扉</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    :root { color-scheme: dark; }
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* PC版: 全体を左側に配置 */
    @media (min-width: 769px) {
      body {
        align-items: flex-start;
      }
    }
    header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.4);
    }
    
    /* ナビゲーション（PC: 左側、モバイル: 上部） */
    .admin-navigation {
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 240px;
    }
    
    .admin-navigation h2 {
      margin: 0 0 16px;
      font-size: 18px;
      color: #c7cdff;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 12px;
    }
    
    .admin-nav-item {
      display: block;
      padding: 12px 16px;
      border-radius: 8px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      color: #f7f5ff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .admin-nav-item:hover {
      background: rgba(138, 43, 226, 0.35);
      border-color: rgba(138, 43, 226, 0.5);
      transform: translateX(4px);
    }
    
    .admin-nav-item.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .admin-nav-url {
      font-size: 11px;
      color: #9da2c6;
      margin-top: 4px;
      word-break: break-all;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
      max-width: 100%;
    }
    
    /* PC版: コンテンツエリアを左側に配置 */
    @media (min-width: 769px) {
      .content-area {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0 20px 40px;
    }
    main {
      flex: 1;
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(8px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: clamp(22px, 4vw, 28px); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label {
      font-size: 13px;
      color: #bfc4ff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    textarea { min-height: 140px; }
    button, .button-link {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    button:hover, .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(138, 43, 226, 0.35);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      text-align: left;
      vertical-align: top;
    }
    th { font-weight: 600; color: #c7cdff; }
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 0 20px 40px;
      width: 100%;
      max-width: 100%;
    }
    
    /* PC版: 左側に配置 */
    @media (min-width: 769px) {
      .dashboard-layout {
        align-items: flex-start;
      }
    }
    
    .dashboard-columns {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .column-left,
    .column-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #resultSummary {
      margin-bottom: 10px;
    }
    .detail-card.hidden,
    .conversation-card.hidden {
      display: none;
    }
    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .conversation-item {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 10px 14px;
      color: #f7f5ff;
    }
    .conversation-item summary {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }
    .conversation-item summary::-webkit-details-marker {
      display: none;
    }
    .conversation-meta {
      font-size: 12px;
      color: #c7cff5;
    }
    .conversation-body {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    @media (max-width: 768px) {
      table { font-size: 12px; }
      .dashboard-layout { padding: 0 16px 32px; }
      
      /* モバイル: ナビゲーションを上部に */
      .main-container {
        flex-direction: column;
      }
      
      .admin-navigation {
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 16px;
        min-width: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .admin-navigation h2 {
        width: 100%;
        margin: 0 0 12px;
        padding-bottom: 8px;
      }
      
      .admin-nav-item {
        flex: 1;
        min-width: calc(50% - 4px);
        padding: 10px 12px;
        font-size: 13px;
      }
      
      .admin-nav-item:hover {
        transform: translateY(-2px);
      }
      
      .admin-nav-url {
        display: none; /* モバイルではURLを非表示 */
      }
    }
    @media (min-width: 769px) {
      /* PC: ナビゲーションを左側に */
      .main-container {
        flex-direction: row;
      }
    }
    @media (min-width: 960px) {
      .dashboard-columns {
        flex-direction: row;
        align-items: flex-start;
        gap: 24px;
      }
      .column-left {
        width: 45%;
        max-width: 520px;
      }
      .column-right {
        flex: 1;
      }
    }
    .token-input { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .token-input input { flex: 1; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(138, 43, 226, 0.2);
      color: #d6c9ff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }
    .list-scroll { max-height: 360px; overflow: auto; padding-right: 4px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { background: linear-gradient(135deg, rgba(255, 78, 132, 0.9), rgba(255, 130, 0, 0.8)); }
    .muted { color: #9da2c6; font-size: 12px; }
    
    /* タブ機能 */
    .admin-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      justify-content: flex-start;
      align-items: flex-start;
    }
    
    /* PC版: 左側に配置 */
    @media (min-width: 769px) {
      .admin-tabs {
        justify-content: flex-start;
        align-items: flex-start;
        padding-left: 20px;
      }
    }
    
    .admin-tab {
      padding: 12px 24px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: #f7f5ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .admin-tab:hover {
      background: rgba(138, 43, 226, 0.3);
    }
    
    .admin-tab.active {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.7);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* チャット管理 */
    .chat-admin-container {
      padding: 20px;
      max-width: 100%;
    }
    
    .chat-admin-entry {
      text-align: left;
    }
    
    .chat-admin-entry h2 {
      margin-bottom: 10px;
      font-size: 24px;
      text-align: left;
    }
    
    .chat-admin-entry > p {
      margin-bottom: 30px;
      text-align: left;
    }
    
    .user-type-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .user-type-card {
      background: rgba(255, 255, 255, 0.04);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .user-type-card:hover {
      background: rgba(138, 43, 226, 0.2);
      border-color: rgba(138, 43, 226, 0.6);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(138, 43, 226, 0.3);
    }
    
    .user-type-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #f7f5ff;
    }
    
    .user-type-card p {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
      line-height: 1.6;
    }
    
    .chat-admin-select {
      text-align: left;
    }
    
    .chat-admin-select h2 {
      margin-bottom: 20px;
      font-size: 24px;
      text-align: left;
    }
    
    .user-type-badge {
      display: inline-block;
      margin-bottom: 20px;
      padding: 6px 16px;
      background: rgba(138, 43, 226, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 20px;
      font-size: 14px;
    }
    
    .appraisers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .appraiser-card {
      background: rgba(255, 255, 255, 0.04);
      border: 2px solid rgba(138, 43, 226, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .appraiser-card:hover {
      background: rgba(138, 43, 226, 0.2);
      border-color: rgba(138, 43, 226, 0.6);
      transform: translateY(-3px);
    }
    
    .appraiser-card img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 10px;
      object-fit: cover;
    }
    
    .appraiser-card h3 {
      margin: 0 0 5px;
      font-size: 16px;
    }
    
    .appraiser-card p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .back-button {
      padding: 10px 20px;
      background: rgba(75, 0, 130, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 8px;
      color: #f7f5ff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .back-button:hover {
      background: rgba(75, 0, 130, 0.5);
      border-color: rgba(138, 43, 226, 0.8);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* チャット管理統合レイアウト */
    .chat-admin-wrapper {
      display: flex;
      gap: 20px;
      height: calc(100vh - 200px);
      min-height: 600px;
    }
    
    .chat-panel {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-panel iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .analysis-panel {
      width: 350px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      overflow-y: auto;
      max-height: 100%;
    }
    
    .analysis-panel h3 {
      margin: 0 0 20px;
      font-size: 18px;
      color: #f7f5ff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }
    
    .analysis-section {
      margin-bottom: 20px;
    }
    
    .analysis-section h4 {
      margin: 0 0 10px;
      font-size: 14px;
      color: #c7cdff;
      font-weight: 600;
    }
    
    .analysis-content {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.6;
      color: #e8d5ff;
    }
    
    .analysis-content p {
      margin: 0;
    }
    
    .analysis-item {
      margin-bottom: 8px;
    }
    
    .analysis-item:last-child {
      margin-bottom: 0;
    }
    
    .analysis-label {
      font-weight: 600;
      color: #b794ff;
      margin-right: 8px;
    }
    
    .analysis-value {
      color: #e8d5ff;
    }
    
    /* テスト用コントロール */
    .test-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .test-button {
      padding: 8px 12px;
      background: rgba(138, 43, 226, 0.3);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 6px;
      color: #f7f5ff;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      width: 100%;
    }
    
    .test-button:hover {
      background: rgba(138, 43, 226, 0.5);
      border-color: rgba(138, 43, 226, 0.8);
      transform: translateX(2px);
    }
    
    .test-button.danger {
      background: rgba(255, 78, 132, 0.3);
      border-color: rgba(255, 78, 132, 0.5);
    }
    
    .test-button.danger:hover {
      background: rgba(255, 78, 132, 0.5);
      border-color: rgba(255, 78, 132, 0.8);
    }
    
    .test-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 1200px) {
      .chat-admin-wrapper {
        flex-direction: column;
        height: auto;
      }
      
      .analysis-panel {
        width: 100%;
        max-height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ユーザー管理ダッシュボード</h1>
    <p class="muted">管理操作用のパスコード（X-Admin-Token）を入力して接続してください。</p>
    <div class="token-input">
      <input type="password" id="adminToken" placeholder="管理者トークン">
      <button id="connectButton">接続</button>
      <span id="connectionStatus" class="badge">未接続</span>
    </div>
  </header>

  <div class="main-container">
    <!-- ナビゲーション（PC: 左側、モバイル: 上部） -->
    <nav class="admin-navigation">
      <h2>管理メニュー</h2>
      <a href="dashboard.html" class="admin-nav-item active">
        ユーザー検索
        <div class="admin-nav-url">/pages/admin/dashboard.html</div>
      </a>
    </nav>
    
    <!-- メインコンテンツエリア -->
    <div class="content-area">
      <!-- タブ切り替え -->
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="user-search">ユーザー検索</button>
        <button class="admin-tab" data-tab="chat-admin">チャット管理</button>
      </div>

      <!-- ユーザー検索タブ -->
      <div class="tab-content active" id="user-search-tab">
      <div class="dashboard-layout">
        <div class="dashboard-columns">
      <div class="column-left">
        <section class="card">
          <h2>ユーザー検索</h2>
          <form id="searchForm">
            <label>ニックネーム
              <input type="text" id="searchNickname" placeholder="部分一致で検索できます">
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">年
                <input type="number" id="searchYear" min="1900" max="2100" placeholder="例: 1990">
              </label>
              <label style="flex:1;">月
                <input type="number" id="searchMonth" min="1" max="12" placeholder="1-12">
              </label>
              <label style="flex:1;">日
                <input type="number" id="searchDay" min="1" max="31" placeholder="1-31">
              </label>
            </div>
            <label>合言葉
              <input type="text" id="searchPassphrase" placeholder="例: 桜舞い散る春の道">
            </label>
            <div class="actions">
              <button type="submit">検索する</button>
              <button type="button" id="resetSearchButton">条件をクリア</button>
            </div>
            <p class="muted">※ニックネーム / 生年月日 / 合言葉のいずれか一つだけでも検索可能です。空のまま検索すると全ユーザーが表示されます。</p>
          </form>
        </section>

        <section class="card">
          <h2>検索結果</h2>
          <div id="resultSummary" class="muted">検索結果 0 件</div>
          <div class="list-scroll">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ニックネーム</th>
                  <th>誕生日</th>
                  <th>合言葉</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                <tr><td colspan="5" class="muted">接続して読み込み...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="column-right">
        <section class="card detail-card hidden" id="detailCard">
          <h2>ユーザー情報</h2>
          <p class="muted" id="selectedUserLabel"></p>
          <form id="userForm">
            <input type="hidden" id="formUserId">
            <label>ニックネーム
              <input type="text" id="formNickname" required>
            </label>
            <div style="display:flex; gap:8px;">
              <label style="flex:1;">年
                <input type="number" id="formYear" min="1900" max="2100" required>
              </label>
              <label style="flex:1;">月
                <input type="number" id="formMonth" min="1" max="12" required>
              </label>
              <label style="flex:1;">日
                <input type="number" id="formDay" min="1" max="31" required>
              </label>
            </div>
            <label>合言葉
              <select id="formDeity"></select>
            </label>
            <div class="actions">
              <button type="submit">更新する</button>
              <button type="button" class="danger" id="deleteUserButton">退会（削除）</button>
            </div>
            <p class="muted" id="formStatus"></p>
          </form>
        </section>

        <section class="card conversation-card hidden" id="conversationCard">
          <h2>会話履歴（最新100件）</h2>
          <div id="conversationList" class="conversation-list">
            <p class="muted">ユーザーを選択すると会話履歴を表示します。</p>
          </div>
        </section>
      </div>
    </div>
    </div>
      </div>

      <!-- チャット管理タブ -->
      <div class="tab-content" id="chat-admin-tab">
        <div class="chat-admin-container" id="chatAdminContainer">
          <div class="chat-admin-entry" id="chatAdminEntry">
            <h2>管理者用チャット - エントリー</h2>
            <p class="muted">本番環境と同じ状態でチャットをテストするために、ユーザータイプを選択してください</p>
            
            <div class="user-type-selector">
              <div class="user-type-card" data-user-type="guest">
                <h3>ゲストユーザー</h3>
                <p>初めての方入口と同じ状態で動作します。登録なしでチャットを開始できます（10通まで）。</p>
              </div>
              
              <div class="user-type-card" data-user-type="registered">
                <h3>登録ユーザー</h3>
                <p>登録済みの方入口と同じ状態で動作します。ログインが必要です。</p>
              </div>
            </div>
          </div>

          <div class="chat-admin-select hidden" id="chatAdminSelect">
            <h2>どの鑑定師を選びますか？</h2>
            <div class="user-type-badge" id="chatUserTypeBadge"></div>
            <div class="appraisers-grid" id="chatAppraisersGrid"></div>
            <button class="back-button" id="chatBackToEntryBtn">ユーザータイプ選択に戻る</button>
          </div>

          <div class="chat-admin-chat hidden" id="chatAdminChat">
            <div class="chat-admin-wrapper">
              <div class="chat-panel" id="chatPanel">
                <!-- チャット画面はJavaScriptで動的に生成 -->
              </div>
              <div class="analysis-panel" id="analysisPanel">
                <h3>会話分析パネル</h3>
                <div class="analysis-section">
                  <h4>現在の状態</h4>
                  <div id="analysisCurrentState" class="analysis-content">
                    <p>読み込み中...</p>
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>フェーズ情報</h4>
                  <div id="analysisPhaseInfo" class="analysis-content">
                    <p>読み込み中...</p>
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>会話履歴構造</h4>
                  <div id="analysisHistory" class="analysis-content">
                    <p>読み込み中...</p>
                  </div>
                </div>
                <div class="analysis-section">
                  <h4>テスト用コントロール</h4>
                  <div class="analysis-content">
                    <div class="test-controls">
                      <button class="test-button" id="resetConversationBtn" title="会話をリセット（ゲスト状態に戻す）">
                        会話をリセット
                      </button>
                      <button class="test-button" id="resetPhaseBtn" title="フェーズをリセット（メッセージカウントを0に）">
                        フェーズをリセット
                      </button>
                      <button class="test-button" id="triggerEventBtn" title="守護神の儀式を直接発動（登録済みの場合のみ）">
                        イベント発動
                      </button>
                      <button class="test-button" id="simulateRegistrationBtn" title="テスト用ユーザー登録をシミュレート">
                        登録シミュレート
                      </button>
                      <button class="test-button danger" id="logoutBtn" title="ログアウトしてゲスト状態に戻す">
                        ログアウト
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button class="back-button" id="chatBackToSelectBtn" style="margin-top: 10px;">鑑定師選択に戻る</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ナビゲーションのアクティブ状態を設定
    (function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.admin-nav-item');
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/admin/') && href === 'dashboard.html')) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    })();
    
    const adminTokenInput = document.getElementById('adminToken');
    const connectButton = document.getElementById('connectButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const userTableBody = document.getElementById('userTableBody');
    const form = document.getElementById('userForm');
    const formUserId = document.getElementById('formUserId');
    const formNickname = document.getElementById('formNickname');
    const formYear = document.getElementById('formYear');
    const formMonth = document.getElementById('formMonth');
    const formDay = document.getElementById('formDay');
    const formDeity = document.getElementById('formDeity');
    const formStatus = document.getElementById('formStatus');
    const deleteUserButton = document.getElementById('deleteUserButton');
    const searchForm = document.getElementById('searchForm');
    const searchNickname = document.getElementById('searchNickname');
    const searchYear = document.getElementById('searchYear');
    const searchMonth = document.getElementById('searchMonth');
    const searchDay = document.getElementById('searchDay');
    const searchPassphrase = document.getElementById('searchPassphrase');
    const resetSearchButton = document.getElementById('resetSearchButton');
    const resultSummary = document.getElementById('resultSummary');
    const detailCard = document.getElementById('detailCard');
    const selectedUserLabel = document.getElementById('selectedUserLabel');
    const conversationCard = document.getElementById('conversationCard');
    const conversationList = document.getElementById('conversationList');

    const deities = [
      '桜舞い散る春の道',
      '月明かりに浮かぶ夢',
      '星降る夜の物語',
      '朝露に光る希望',
      '夕焼けのやさしさ',
      '虹の架け橋',
      '春風に揺れる花',
      '雪化粧の静けさ',
      '風鈴の涼しい音',
      '蝉しぐれの夏',
      '紅葉散る小道',
      '初雪の贈り物',
      '菜の花畑の春',
      '蛍舞う夕べ',
      '雲海に浮かぶ夢',
      '波の音の子守歌',
      '霧雨の潤い',
      '落葉の敷き毯',
      '春霞の揺らぎ',
      '小鳥のさえずり',
      '小川のせせらぎ',
      '野原の風車',
      '藤色の花',
      '金色の稲穂'
    ];
    deities.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      formDeity.appendChild(option);
    });

    let currentToken = '';
    let users = [];
    let filteredUsers = [];
    let selectedUserId = null;

    function hideDetailSections() {
      detailCard.classList.add('hidden');
      conversationCard.classList.add('hidden');
      conversationList.innerHTML = '<p class="muted">ユーザーを選択すると会話履歴を表示します。</p>';
      selectedUserLabel.textContent = '';
      formStatus.textContent = '';
      selectedUserId = null;
    }

    function showDetailSections(user) {
      detailCard.classList.remove('hidden');
      conversationCard.classList.remove('hidden');
      selectedUserLabel.textContent = `ID: ${user.id} / ${user.nickname} / ${user.birth_year}年${user.birth_month}月${user.birth_day}日`;
    }

    hideDetailSections();

    function setStatus(message, success = false) {
      connectionStatus.textContent = message;
      connectionStatus.style.background = success ? 'rgba(0,120,86,0.4)' : 'rgba(138,43,226,0.2)';
    }

    async function fetchUsers() {
      try {
        const res = await fetch('/api/admin/users', {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '取得に失敗しました');
        users = data.users;
        applyFilters();
        renderUsers();
        hideDetailSections();
        setStatus('接続済み', true);
      } catch (error) {
        console.error(error);
        setStatus('接続エラー');
        userTableBody.innerHTML = `<tr><td colspan="5" class="muted">${error.message}</td></tr>`;
      }
    }

    function applyFilters() {
      const nickname = searchNickname.value.trim();
      const yearValue = searchYear.value.trim();
      const monthValue = searchMonth.value.trim();
      const dayValue = searchDay.value.trim();
      const passphrase = searchPassphrase.value.trim();

      const hasNickname = nickname.length > 0;
      const hasYear = yearValue.length > 0;
      const hasMonth = monthValue.length > 0;
      const hasDay = dayValue.length > 0;
      const hasPassphrase = passphrase.length > 0;

      if (!hasNickname && !hasYear && !hasMonth && !hasDay && !hasPassphrase) {
        filteredUsers = [...users];
        return;
      }

      const year = Number(yearValue);
      const month = Number(monthValue);
      const day = Number(dayValue);

      filteredUsers = users.filter((user) => {
        const nicknameMatch = hasNickname ? user.nickname.includes(nickname) : true;
        const yearMatch = hasYear ? user.birth_year === year : true;
        const monthMatch = hasMonth ? user.birth_month === month : true;
        const dayMatch = hasDay ? user.birth_day === day : true;
        const passphraseMatch = hasPassphrase ? user.assigned_deity.includes(passphrase) : true;
        return nicknameMatch && yearMatch && monthMatch && dayMatch && passphraseMatch;
      });
    }

    function renderUsers(list = filteredUsers) {
      resultSummary.textContent = `検索結果 ${list.length} 件`;
      if (!list.length) {
        userTableBody.innerHTML = '<tr><td colspan="5" class="muted">ユーザーが見つかりません。</td></tr>';
        return;
      }
      userTableBody.innerHTML = list.map((user) => `
        <tr>
          <td>${user.id}</td>
          <td>${user.nickname}</td>
          <td>${user.birth_year}/${user.birth_month}/${user.birth_day}</td>
          <td>${user.assigned_deity}</td>
          <td><button class="button-link" data-user-id="${user.id}">選択</button></td>
        </tr>
      `).join('');
    }

    userTableBody.addEventListener('click', (event) => {
      const target = event.target;
      if (target.matches('[data-user-id]')) {
        const id = Number(target.dataset.userId);
        const user = users.find((u) => u.id === id);
        if (user) {
          populateForm(user);
          fetchConversations(id);
        }
      }
    });

    function populateForm(user) {
      formUserId.value = user.id;
      formNickname.value = user.nickname;
      formYear.value = user.birth_year;
      formMonth.value = user.birth_month;
      formDay.value = user.birth_day;
      formDeity.value = user.assigned_deity;
      formStatus.textContent = '';
      selectedUserId = user.id;
      showDetailSections(user);
    }

    function renderConversationList(records) {
      if (!records.length) {
        conversationList.innerHTML = '<p class="muted">会話履歴はまだありません。</p>';
        return;
      }
      conversationList.innerHTML = records.map((item, index) => {
        const title = `[${item.character_id}] ${item.role === 'assistant' ? '鑑定士' : '相談者'} / ${new Date(item.created_at).toLocaleString('ja-JP')}`;
        const safeContent = item.message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <details class="conversation-item" ${index === 0 ? 'open' : ''}>
            <summary>
              <span>${title}</span>
              <span class="conversation-meta">#${records.length - index}</span>
            </summary>
            <div class="conversation-body">${safeContent}</div>
          </details>
        `;
      }).join('');
    }

    async function fetchConversations(userId) {
      conversationList.innerHTML = '<p class="muted">読み込み中...</p>';
      try {
        const res = await fetch(`/api/admin/conversations?userId=${userId}`, {
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '会話履歴の取得に失敗しました');
        renderConversationList(data.conversations || []);
      } catch (error) {
        conversationList.innerHTML = `<p class="muted">${error.message}</p>`;
      }
    }

    connectButton.addEventListener('click', () => {
      currentToken = adminTokenInput.value.trim();
      if (!currentToken) {
        setStatus('トークンを入力してください');
        return;
      }
      fetchUsers();
    });

    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
      renderUsers();
      hideDetailSections();
    });

    resetSearchButton.addEventListener('click', () => {
      searchForm.reset();
      filteredUsers = [...users];
      renderUsers();
      hideDetailSections();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formUserId.value) {
        formStatus.textContent = 'ユーザーを選択してください。';
        return;
      }
      const payload = {
        id: Number(formUserId.value),
        nickname: formNickname.value.trim(),
        birthYear: Number(formYear.value),
        birthMonth: Number(formMonth.value),
        birthDay: Number(formDay.value),
        assignedDeity: formDeity.value,
      };
      try {
        const res = await fetch('/api/admin/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': currentToken,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '更新に失敗しました');
        formStatus.textContent = '更新しました。';
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    deleteUserButton.addEventListener('click', async () => {
      if (!formUserId.value) {
        formStatus.textContent = 'ユーザーを選択してください。';
        return;
      }
      if (!confirm('本当に退会処理を行いますか？会話履歴も削除されます。')) {
        return;
      }
      try {
        const res = await fetch(`/api/admin/users?id=${formUserId.value}`, {
          method: 'DELETE',
          headers: { 'X-Admin-Token': currentToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '削除に失敗しました');
        formStatus.textContent = '削除しました。';
        form.reset();
        hideDetailSections();
        fetchUsers();
      } catch (error) {
        formStatus.textContent = error.message;
      }
    });

    // ============================================
    // タブ切り替え機能
    // ============================================
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // タブのアクティブ状態を更新
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // コンテンツの表示を切り替え
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${targetTab}-tab`).classList.add('active');
      });
    });

    // ============================================
    // チャット管理機能
    // ============================================
    const chatAdminEntry = document.getElementById('chatAdminEntry');
    const chatAdminSelect = document.getElementById('chatAdminSelect');
    const chatAdminChat = document.getElementById('chatAdminChat');
    const chatUserTypeBadge = document.getElementById('chatUserTypeBadge');
    const chatAppraisersGrid = document.getElementById('chatAppraisersGrid');
    const chatBackToEntryBtn = document.getElementById('chatBackToEntryBtn');
    const chatBackToSelectBtn = document.getElementById('chatBackToSelectBtn');
    
    let currentUserType = null;
    let currentCharacter = null;
    
    const appraisers = [
      { id: 'kaede', name: '楓', nameKana: 'かえで', image: '../../photo/kaede.png' },
      { id: 'yukino', name: '笹岡雪乃', nameKana: 'ささおか ゆきの', image: '../../photo/yukino.png' },
      { id: 'sora', name: '水野ソラ', nameKana: 'みずの そら', image: '../../photo/sora.png' },
      { id: 'kaon', name: '三崎花音', nameKana: 'みさき かおん', image: '../../photo/kaon.png' }
    ];
    
    // ユーザータイプ選択
    document.querySelectorAll('.user-type-card').forEach(card => {
      card.addEventListener('click', () => {
        currentUserType = card.dataset.userType;
        showChatAdminSelect();
      });
    });
    
    // 鑑定師選択画面を表示
    function showChatAdminSelect() {
      chatAdminEntry.classList.add('hidden');
      chatAdminSelect.classList.remove('hidden');
      chatAdminChat.classList.add('hidden');
      
      chatUserTypeBadge.textContent = currentUserType === 'guest' ? 'ゲストユーザー' : '登録ユーザー';
      
      // 鑑定師グリッドをクリア
      chatAppraisersGrid.innerHTML = '';
      
      // 鑑定師カードを生成
      appraisers.forEach(appraiser => {
        const card = document.createElement('div');
        card.className = 'appraiser-card';
        card.innerHTML = `
          <img src="${appraiser.image}" alt="${appraiser.name}" onerror="this.src='../../photo/rogo.png'">
          <h3>${appraiser.name}</h3>
          <p>${appraiser.nameKana}</p>
        `;
        
        card.addEventListener('click', () => {
          currentCharacter = appraiser.id;
          showChatAdminChat();
        });
        
        chatAppraisersGrid.appendChild(card);
      });
    }
    
    // チャット画面を表示
    function showChatAdminChat() {
      chatAdminEntry.classList.add('hidden');
      chatAdminSelect.classList.add('hidden');
      chatAdminChat.classList.remove('hidden');
      
      // iframeで本番環境のチャットページを読み込む（同じ動作を確認）
      const chatUrl = `../chat/chat.html?character=${currentCharacter}&userType=${currentUserType}`;
      const iframe = document.createElement('iframe');
      iframe.src = chatUrl;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      iframe.id = 'chatAdminIframe';
      
      const chatPanel = document.getElementById('chatPanel');
      chatPanel.innerHTML = '';
      chatPanel.appendChild(iframe);
      
      // 分析パネルの更新を開始
      startAnalysisPanel(iframe, currentCharacter, currentUserType);
    }
    
    // 分析パネルを更新
    function startAnalysisPanel(iframe, character, userType) {
      // iframeの読み込み完了を待つ
      iframe.addEventListener('load', () => {
        updateAnalysisPanel(iframe, character, userType);
        // 定期的に更新
        setInterval(() => {
          updateAnalysisPanel(iframe, character, userType);
        }, 2000);
      });
    }
    
    // 分析パネルの内容を更新
    function updateAnalysisPanel(iframe, character, userType) {
      try {
        const iframeWindow = iframe.contentWindow;
        const iframeDoc = iframe.contentDocument || iframeWindow.document;
        
        // 現在の状態を取得
        const currentState = {
          userType: userType || 'unknown',
          character: character || 'unknown',
          isRegistered: iframeWindow.AuthState ? iframeWindow.AuthState.isRegistered() : false,
          userNickname: iframeWindow.ChatData ? iframeWindow.ChatData.userNickname : null
        };
        
        // メッセージカウントを取得
        const messageCount = iframeWindow.ChatData 
          ? iframeWindow.ChatData.getGuestMessageCount(character) 
          : 0;
        
        // フェーズ情報を計算
        const phase = calculatePhase(messageCount, character);
        
        // 会話履歴を取得
        const history = iframeWindow.ChatData
          ? iframeWindow.ChatData.getGuestHistory(character)
          : [];
        
        // 現在の状態を表示
        const currentStateDiv = document.getElementById('analysisCurrentState');
        currentStateDiv.innerHTML = `
          <div class="analysis-item">
            <span class="analysis-label">ユーザータイプ:</span>
            <span class="analysis-value">${currentState.userType === 'guest' ? 'ゲスト' : '登録'}</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">キャラクター:</span>
            <span class="analysis-value">${character}</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">登録状態:</span>
            <span class="analysis-value">${currentState.isRegistered ? '登録済み' : '未登録'}</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">メッセージ数:</span>
            <span class="analysis-value">${messageCount}通</span>
          </div>
        `;
        
        // フェーズ情報を表示
        const phaseInfoDiv = document.getElementById('analysisPhaseInfo');
        phaseInfoDiv.innerHTML = `
          <div class="analysis-item">
            <span class="analysis-label">フェーズ:</span>
            <span class="analysis-value">${phase.name}</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">説明:</span>
            <span class="analysis-value">${phase.description}</span>
          </div>
        `;
        
        // 会話履歴構造を表示
        const historyDiv = document.getElementById('analysisHistory');
        historyDiv.innerHTML = `
          <div class="analysis-item">
            <span class="analysis-label">総メッセージ数:</span>
            <span class="analysis-value">${history.length}件</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">ユーザーメッセージ:</span>
            <span class="analysis-value">${history.filter(m => m.role === 'user').length}件</span>
          </div>
          <div class="analysis-item">
            <span class="analysis-label">アシスタントメッセージ:</span>
            <span class="analysis-value">${history.filter(m => m.role === 'assistant').length}件</span>
          </div>
        `;
      } catch (error) {
        console.error('分析パネルの更新エラー:', error);
      }
    }
    
    // フェーズを計算
    function calculatePhase(messageCount, character) {
      if (character === 'kaede') {
        if (messageCount === 1) {
          return {
            name: 'フェーズ1',
            description: '導入＆未来イメージの選択肢提示'
          };
        } else if (messageCount === 2) {
          return {
            name: 'フェーズ2',
            description: '長所を聞く質問（最後の質問）'
          };
        } else if (messageCount === 3) {
          return {
            name: 'フェーズ3',
            description: '性格診断＋続行確認'
          };
        } else {
          return {
            name: 'フェーズ4',
            description: '未来鑑定＋守護神と儀式の説明'
          };
        }
      }
      return {
        name: '未設定',
        description: 'フェーズ情報がありません'
      };
    }
    
    // 戻るボタン
    if (chatBackToEntryBtn) {
      chatBackToEntryBtn.addEventListener('click', () => {
        chatAdminEntry.classList.remove('hidden');
        chatAdminSelect.classList.add('hidden');
        chatAdminChat.classList.add('hidden');
        currentUserType = null;
        currentCharacter = null;
      });
    }
    
    if (chatBackToSelectBtn) {
      chatBackToSelectBtn.addEventListener('click', () => {
        showChatAdminSelect();
        currentCharacter = null;
        const chatPanel = document.getElementById('chatPanel');
        if (chatPanel) {
          chatPanel.innerHTML = '';
        }
      });
    }
    
    // ============================================
    // テスト用コントロール機能
    // ============================================
    const resetConversationBtn = document.getElementById('resetConversationBtn');
    const resetPhaseBtn = document.getElementById('resetPhaseBtn');
    const triggerEventBtn = document.getElementById('triggerEventBtn');
    const simulateRegistrationBtn = document.getElementById('simulateRegistrationBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // 会話をリセット（ゲスト状態に戻す）
    if (resetConversationBtn) {
      resetConversationBtn.addEventListener('click', () => {
        if (!confirm('会話履歴とメッセージカウントをリセットしてゲスト状態に戻しますか？')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ポストメッセージでiframeにリセット命令を送信
            iframe.contentWindow.postMessage({
              type: 'ADMIN_RESET_CONVERSATION',
              character: currentCharacter
            }, '*');
            
            // ページをリロード
            setTimeout(() => {
              iframe.src = iframe.src;
              alert('会話がリセットされました。');
            }, 100);
          }
        } catch (error) {
          console.error('会話リセットエラー:', error);
          alert('会話のリセットに失敗しました: ' + error.message);
        }
      });
    }
    
    // フェーズをリセット（メッセージカウントを0に）
    if (resetPhaseBtn) {
      resetPhaseBtn.addEventListener('click', () => {
        if (!confirm('メッセージカウントを0にリセットしますか？（会話履歴は保持されます）')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ポストメッセージでiframeにフェーズリセット命令を送信
            iframe.contentWindow.postMessage({
              type: 'ADMIN_RESET_PHASE',
              character: currentCharacter
            }, '*');
            
            alert('フェーズがリセットされました。');
            // 分析パネルを更新
            setTimeout(() => {
              if (iframe.contentWindow) {
                updateAnalysisPanel(iframe, currentCharacter, currentUserType);
              }
            }, 500);
          }
        } catch (error) {
          console.error('フェーズリセットエラー:', error);
          alert('フェーズのリセットに失敗しました: ' + error.message);
        }
      });
    }
    
    // イベント発動（守護神の儀式を直接トリガー）
    if (triggerEventBtn) {
      triggerEventBtn.addEventListener('click', async () => {
        if (!confirm('守護神の儀式を直接発動しますか？（登録済みユーザーのみ有効）')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ポストメッセージでiframeにイベント発動命令を送信
            iframe.contentWindow.postMessage({
              type: 'ADMIN_TRIGGER_RITUAL',
              character: currentCharacter
            }, '*');
            
            alert('守護神の儀式を発動しました。');
          }
        } catch (error) {
          console.error('イベント発動エラー:', error);
          alert('イベントの発動に失敗しました: ' + error.message);
        }
      });
    }
    
    // 登録シミュレート（テスト用ユーザー登録）
    if (simulateRegistrationBtn) {
      simulateRegistrationBtn.addEventListener('click', async () => {
        const nickname = prompt('テスト用ニックネームを入力してください:', 'テストユーザー');
        if (!nickname) return;
        
        const year = prompt('生年を入力してください:', '1990');
        const month = prompt('生月を入力してください:', '1');
        const day = prompt('生日を入力してください:', '1');
        
        if (!year || !month || !day) return;
        
        try {
          // テスト用のユーザー登録
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              nickname: nickname,
              birthYear: parseInt(year),
              birthMonth: parseInt(month),
              birthDay: parseInt(day)
            })
          });
          
          const data = await response.json();
          
          if (response.ok && data.token) {
            // iframeにポストメッセージで登録情報を送信
            const iframe = document.getElementById('chatAdminIframe');
            if (iframe) {
              iframe.contentWindow.postMessage({
                type: 'ADMIN_SIMULATE_REGISTRATION',
                token: data.token,
                nickname: data.nickname,
                assignedDeity: data.assignedDeity
              }, '*');
              
              alert(`テストユーザー「${nickname}」として登録しました。ページをリロードします。`);
              setTimeout(() => {
                iframe.src = iframe.src;
              }, 500);
            }
          } else {
            alert('登録に失敗しました: ' + (data.error || '不明なエラー'));
          }
        } catch (error) {
          console.error('登録シミュレートエラー:', error);
          alert('登録シミュレートに失敗しました: ' + error.message);
        }
      });
    }
    
    // ログアウト
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        if (!confirm('ログアウトしてゲスト状態に戻しますか？')) {
          return;
        }
        
        try {
          const iframe = document.getElementById('chatAdminIframe');
          if (iframe) {
            // ポストメッセージでiframeにログアウト命令を送信
            iframe.contentWindow.postMessage({
              type: 'ADMIN_LOGOUT'
            }, '*');
            
            alert('ログアウトしました。ページをリロードします。');
            setTimeout(() => {
              iframe.src = iframe.src;
            }, 500);
          }
        } catch (error) {
          console.error('ログアウトエラー:', error);
          alert('ログアウトに失敗しました: ' + error.message);
        }
      });
    }
  </script>
</body>
</html>
