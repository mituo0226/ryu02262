<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ - é‹å‘½ã®æ‰‰</title>
  <link rel="stylesheet" href="../../css/styles.css">
  <style>
    :root { color-scheme: dark; }
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #05040a;
      min-height: 100vh;
      margin: 0;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: #f7f5ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ */
    header {
      flex-shrink: 0;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    header h1 {
      margin: 0 0 4px;
      font-size: 18px;
      font-weight: 600;
    }
    
    header .muted {
      color: #9da2c6;
      font-size: 12px;
      margin: 0;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      flex: 1;
      display: flex;
      gap: 16px;
      padding: 16px;
      overflow: hidden;
    }
    
    /* å·¦å´ï¼šãƒ†ã‚¹ãƒˆæ“ä½œãƒ‘ãƒãƒ« */
    .test-controls {
      flex: 0 0 320px;
      background: rgba(138, 43, 226, 0.1);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 12px;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .test-controls h2 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #d6c9ff;
    }
    
    .test-controls label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: #bfc4ff;
    }
    
    .test-controls select {
      padding: 8px 12px;
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 13px;
    }
    
    .test-controls button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    
    .test-controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
    }
    
    .test-controls .btn-primary {
      background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9));
      border: 1px solid rgba(138, 43, 226, 0.5);
    }
    
    .test-controls .btn-success {
      background: linear-gradient(135deg, rgba(0, 200, 120, 0.9), rgba(0, 150, 100, 0.9));
      border: 1px solid rgba(0, 200, 120, 0.5);
    }
    
    .test-controls .btn-danger {
      background: rgba(255, 100, 100, 0.7);
      border: 1px solid rgba(255, 100, 100, 0.5);
    }
    
    .test-status {
      font-size: 12px;
      color: #bfc4ff;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      min-height: 30px;
    }
    
    /* å³å´ï¼šãƒãƒ£ãƒƒãƒˆç”»é¢ */
    .chat-screen {
      flex: 1;
      background: rgba(138, 43, 226, 0.05);
      border: 1px solid rgba(138, 43, 226, 0.2);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-screen-header {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .chat-screen-header h2 {
      margin: 0;
      font-size: 14px;
      color: #d6c9ff;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      word-wrap: break-word;
      animation: slideInMessage 0.4s ease;
      max-width: 85%;
    }
    
    .message.system {
      background: rgba(138, 43, 226, 0.2);
      border-left: 3px solid rgba(138, 43, 226, 0.6);
      color: #d6c9ff;
      text-align: center;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
      font-size: 12px;
    }
    
    .message.assistant {
      background: rgba(138, 43, 226, 0.15);
      border: 1px solid rgba(138, 43, 226, 0.3);
      color: #f7f5ff;
      margin-right: auto;
    }
    
    .message.user {
      background: rgba(75, 120, 180, 0.15);
      border: 1px solid rgba(75, 120, 180, 0.3);
      color: #b8d4ff;
      margin-left: auto;
    }
    
    @keyframes slideInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .placeholder {
      color: #bfc4ff;
      font-size: 13px;
      text-align: center;
      padding: 40px 20px;
      margin: auto;
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(138, 43, 226, 0.4);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(138, 43, 226, 0.6);
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¬ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ</h1>
    <p class="muted" id="testInfo"></p>
  </header>

  <div class="main-content">
    <!-- å·¦å´ï¼šãƒ†ã‚¹ãƒˆæ“ä½œãƒ‘ãƒãƒ« -->
    <div class="test-controls">
      <div>
        <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ“ä½œ</h2>
        
        <label>ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
          <select id="testUserSelect">
            <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>
          </select>
        </label>
        
        <label>ãƒ†ã‚¹ãƒˆå¯¾è±¡é‘‘å®šå£«
          <select id="testCharacterSelect">
            <option value="kaede">æ¥“</option>
            <option value="yukino">ç¬¹å²¡é›ªä¹ƒ</option>
            <option value="sora">ç©º</option>
            <option value="kaon">ä¸‰å´èŠ±éŸ³</option>
          </select>
        </label>
      </div>
      
      <div>
        <button class="btn-primary" id="testFirstVisitButton">
          ğŸ¬ åˆå›è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆ
        </button>
        <button class="btn-success" id="testReturningVisitButton">
          ğŸ”„ å†è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆ
        </button>
        <button class="btn-danger" id="clearHistoryButton">
          ğŸ—‘ï¸ å±¥æ­´ã‚’å‰Šé™¤
        </button>
      </div>

      <div style="border-top: 1px solid rgba(138, 43, 226, 0.3); padding-top: 16px; margin-top: 16px;">
        <button class="btn-primary" id="openChatWindowButton" style="width: 100%; margin-bottom: 8px;">
          ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        </button>
        <button class="btn-success" id="openFeedbackWindowButton" style="width: 100%;">
          ğŸ“‹ è¦æœ›ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
        </button>
      </div>
      
      <div class="test-status" id="testStatus">å¾…æ©Ÿä¸­...</div>
    </div>

    <!-- å³å´ï¼šãƒ†ã‚¹ãƒˆæƒ…å ± + AIä¼šè©± -->
    <div class="chat-screen" style="background: rgba(138, 43, 226, 0.05); border: 1px solid rgba(138, 43, 226, 0.2); display: flex; flex-direction: column;">
      <div class="chat-screen-header">
        <h2>ğŸ¤– ãƒ†ã‚¹ãƒˆçµæœã®AIç›¸è«‡</h2>
      </div>
      
      <!-- ã‚¿ãƒ– -->
      <div style="display: flex; gap: 4px; padding: 8px 12px; border-bottom: 1px solid rgba(138, 43, 226, 0.2); flex-shrink: 0;">
        <button id="tabInfo" class="tab-button active" style="flex: 1; padding: 6px 8px; background: rgba(138, 43, 226, 0.3); border: none; border-radius: 4px; color: #d6c9ff; cursor: pointer; font-size: 12px; font-weight: 600;">ğŸ“Œ ãƒ†ã‚¹ãƒˆæƒ…å ±</button>
        <button id="tabChat" class="tab-button" style="flex: 1; padding: 6px 8px; background: transparent; border: 1px solid rgba(138, 43, 226, 0.2); border-radius: 4px; color: #bfc4ff; cursor: pointer; font-size: 12px; font-weight: 600;">ğŸ’¬ AIç›¸è«‡</button>
      </div>
      
      <!-- ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚¿ãƒ– -->
      <div id="infoPanel" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px;">
        <div style="font-size: 13px; color: #bfc4ff; line-height: 1.6;">
          <strong style="color: #d6c9ff; display: block; margin-bottom: 8px;">ğŸ“š ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ï¼š</strong>
          <span style="font-size: 12px;">
            ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚<br>
            â€¢ ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é‘‘å®šå£«ã‚’é¸æŠ<br>
            â€¢ ä¼šè©±å±¥æ­´ãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ = åˆå›ç™»éŒ²ãƒ†ã‚¹ãƒˆ<br>
            â€¢ ä¼šè©±å±¥æ­´ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ = ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ã‚¹ãƒˆ<br>
            â€¢ ã€Œåˆå›è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆã€ã€Œå†è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆã€ã‚’å®Ÿè¡Œ<br>
            â€¢ ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªãƒ»AIã«ç›¸è«‡å¯èƒ½
          </span>
        </div>
        <div style="border-top: 1px solid rgba(138, 43, 226, 0.2); padding-top: 12px;">
          <strong style="color: #d6c9ff; display: block; margin-bottom: 8px;">ğŸ¯ ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆæƒ…å ±ï¼š</strong>
          <div id="currentTestInfo" style="font-size: 12px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; color: #bfc4ff;">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªé¸æŠ | é‘‘å®šå£«: æ¥“
          </div>
        </div>
        <div style="border-top: 1px solid rgba(138, 43, 226, 0.2); padding-top: 12px;">
          <strong style="color: #d6c9ff; display: block; margin-bottom: 8px;">âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœï¼š</strong>
          <div id="testResult" style="font-size: 12px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; color: #bfc4ff; min-height: 40px; max-height: 150px; overflow-y: auto;">
            ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
          </div>
        </div>
      </div>
      
      <!-- AIä¼šè©±ã‚¿ãƒ– -->
      <div id="chatPanel" style="flex: 1; overflow-y: auto; display: none; padding: 12px; display: flex; flex-direction: column;">
        <div id="aiMessages" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; border: 1px solid rgba(138, 43, 226, 0.2);">
          <div style="color: #bfc4ff; font-size: 12px; text-align: center; padding: 20px;">
            ğŸ’¬ ãƒ†ã‚¹ãƒˆçµæœã«ã¤ã„ã¦AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã«ç›¸è«‡ã§ãã¾ã™<br>
            ãƒ†ã‚¹ãƒˆã—ãŸé‘‘å®šå£«ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¤ã„ã¦è³ªå•ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ãˆã¾ã™
          </div>
        </div>
        
        <!-- AIå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div style="display: flex; flex-direction: column; gap: 8px; flex-shrink: 0;">
          <textarea id="aiInput" placeholder="ãƒ†ã‚¹ãƒˆçµæœã«ã¤ã„ã¦è³ªå•ã‚„è¦æœ›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." style="flex: 1; padding: 10px 12px; border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 6px; background: rgba(0, 0, 0, 0.3); color: #fff; font-size: 12px; min-height: 60px; resize: vertical; font-family: inherit;"></textarea>
          <div style="display: flex; gap: 8px;">
            <button id="aiSendButton" type="button" style="flex: 1; padding: 8px; background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 129, 0.9)); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-weight: 600; font-size: 12px;">âœ“ é€ä¿¡</button>
            <button id="aiClearButton" type="button" style="flex: 1; padding: 8px; background: rgba(100, 100, 100, 0.5); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-weight: 600; font-size: 12px;">ã‚¯ãƒªã‚¢</button>
          </div>
          <div id="aiStatus" style="font-size: 11px; color: #bfc4ff; padding: 6px 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; min-height: 16px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    const characterId = urlParams.get('character');
    
    const testUserSelect = document.getElementById('testUserSelect');
    const testCharacterSelect = document.getElementById('testCharacterSelect');
    const testFirstVisitButton = document.getElementById('testFirstVisitButton');
    const testReturningVisitButton = document.getElementById('testReturningVisitButton');
    const clearHistoryButton = document.getElementById('clearHistoryButton');
    const openChatWindowButton = document.getElementById('openChatWindowButton');
    const openFeedbackWindowButton = document.getElementById('openFeedbackWindowButton');
    const testStatus = document.getElementById('testStatus');
    const currentTestInfo = document.getElementById('currentTestInfo');
    const testResult = document.getElementById('testResult');
    
    // ã‚¿ãƒ–è¦ç´ 
    const tabInfo = document.getElementById('tabInfo');
    const tabChat = document.getElementById('tabChat');
    const infoPanel = document.getElementById('infoPanel');
    const chatPanel = document.getElementById('chatPanel');
    const aiMessages = document.getElementById('aiMessages');
    const aiInput = document.getElementById('aiInput');
    const aiSendButton = document.getElementById('aiSendButton');
    const aiClearButton = document.getElementById('aiClearButton');
    const aiStatus = document.getElementById('aiStatus');
    
    let users = [];
    let selectedUserId = null;
    let selectedCharacter = 'kaede';
    let lastTestResult = null;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function fetchUsers() {
      try {
        const res = await fetch('/api/admin/users');
        if (!res.ok) throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—å¤±æ•—');
        const data = await res.json();
        users = data.users || [];
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
        testUserSelect.innerHTML = '<option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>';
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.nickname} (ID: ${user.id})`;
          testUserSelect.appendChild(option);
        });
      } catch (error) {
        testStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    }
    
    function updateTestInfo() {
      selectedUserId = testUserSelect.value;
      selectedCharacter = testCharacterSelect.value;
      
      const user = users.find(u => u.id == selectedUserId);
      const userText = user ? user.nickname : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªé¸æŠ';
      currentTestInfo.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userText} | é‘‘å®šå£«: ${selectedCharacter}`;
    }
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
    function setSessionData(visitPattern = null) {
      if (!selectedUserId) {
        testStatus.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„';
        return false;
      }
      sessionStorage.setItem('testSessionData', JSON.stringify({
        userId: selectedUserId,
        character: selectedCharacter,
        userName: users.find(u => u.id == selectedUserId)?.nickname || 'Unknown',
        visitPattern: visitPattern || 'first_visit'
      }));
      return true;
    }
    
    // åˆå›è¨ªå•ãƒ†ã‚¹ãƒˆ
    testFirstVisitButton.addEventListener('click', async () => {
      updateTestInfo();
      if (!setSessionData('first_visit')) return;
      
      testStatus.textContent = 'ğŸ”„ åˆå›è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆä¸­...';
      testResult.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
      
      try {
        const res = await fetch('/api/generate-welcome', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            character: selectedCharacter,
            userId: Number(selectedUserId),
            visitPattern: 'first_visit',
          }),
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ãƒ†ã‚¹ãƒˆå¤±æ•—');
        
        lastTestResult = {
          type: 'first_visit',
          character: selectedCharacter,
          message: data.message,
          timestamp: new Date().toLocaleString('ja-JP')
        };
        
        testResult.innerHTML = `
          <strong style="color: #d6c9ff; display: block; margin-bottom: 8px;">ğŸ¬ åˆå›è¨ªå•ãƒ†ã‚¹ãƒˆçµæœ</strong>
          <div style="font-size: 11px; color: #9da2c6; margin-bottom: 8px;">
            ${lastTestResult.timestamp} | ${selectedCharacter}
          </div>
          <div style="white-space: pre-wrap; word-break: break-word; line-height: 1.5;">
            ${data.message || 'ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰'}
          </div>
        `;
        
        testStatus.textContent = 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ã€‚çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚';
      } catch (error) {
        testStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        testResult.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    });
    
    // å†è¨ªå•ãƒ†ã‚¹ãƒˆ
    testReturningVisitButton.addEventListener('click', async () => {
      updateTestInfo();
      if (!setSessionData('returning')) return;
      
      testStatus.textContent = 'ğŸ”„ å†è¨ªå•ã‚’ãƒ†ã‚¹ãƒˆä¸­...';
      testResult.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
      
      try {
        const res = await fetch('/api/generate-welcome', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            character: selectedCharacter,
            userId: Number(selectedUserId),
            visitPattern: 'returning',
          }),
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'ãƒ†ã‚¹ãƒˆå¤±æ•—');
        
        lastTestResult = {
          type: 'returning',
          character: selectedCharacter,
          message: data.message,
          timestamp: new Date().toLocaleString('ja-JP')
        };
        
        testResult.innerHTML = `
          <strong style="color: #d6c9ff; display: block; margin-bottom: 8px;">ğŸ”„ å†è¨ªå•ãƒ†ã‚¹ãƒˆçµæœ</strong>
          <div style="font-size: 11px; color: #9da2c6; margin-bottom: 8px;">
            ${lastTestResult.timestamp} | ${selectedCharacter}
          </div>
          <div style="white-space: pre-wrap; word-break: break-word; line-height: 1.5;">
            ${data.message || 'ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰'}
          </div>
        `;
        
        testStatus.textContent = 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ã€‚çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚';
      } catch (error) {
        testStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        testResult.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    });
    
    // å±¥æ­´å‰Šé™¤
    clearHistoryButton.addEventListener('click', async () => {
      updateTestInfo();
      if (!setSessionData()) return;
      
      if (!confirm(`${selectedCharacter}ã¨ã®ä¼šè©±å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      testStatus.textContent = 'ğŸ”„ å±¥æ­´ã‚’å‰Šé™¤ä¸­...';
      
      try {
        const res = await fetch('/api/admin/conversations', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: Number(selectedUserId),
            characterId: selectedCharacter,
            deleteAll: true,
          }),
        });
        
        if (!res.ok) throw new Error('å‰Šé™¤å¤±æ•—');
        testStatus.textContent = 'âœ… å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
        testResult.textContent = 'å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ';
      } catch (error) {
        testStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    });
    
    // ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
    openChatWindowButton.addEventListener('click', () => {
      updateTestInfo();
      if (!setSessionData()) return;
      
      const chatWindow = window.open(
        `/pages/admin/test-chat-window.html`,
        'testChatWindow',
        'width=900,height=700,resizable=yes,scrollbars=yes'
      );
      
      if (!chatWindow) {
        testStatus.textContent = 'âŒ ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã¾ã›ã‚“';
      }
    });
    
    // è¦æœ›ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
    openFeedbackWindowButton.addEventListener('click', () => {
      updateTestInfo();
      if (!setSessionData()) return;
      
      const feedbackWindow = window.open(
        `/pages/admin/test-feedback-window.html`,
        'testFeedbackWindow',
        'width=900,height=700,resizable=yes,scrollbars=yes'
      );
      
      if (!feedbackWindow) {
        testStatus.textContent = 'âŒ è¦æœ›ç®¡ç†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã¾ã›ã‚“';
      }
    });
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    tabInfo.addEventListener('click', () => {
      infoPanel.style.display = 'block';
      chatPanel.style.display = 'none';
      tabInfo.style.background = 'rgba(138, 43, 226, 0.3)';
      tabInfo.style.borderColor = 'rgba(138, 43, 226, 0.6)';
      tabInfo.style.color = '#d6c9ff';
      tabChat.style.background = 'transparent';
      tabChat.style.borderColor = 'rgba(138, 43, 226, 0.2)';
      tabChat.style.color = '#bfc4ff';
    });
    
    tabChat.addEventListener('click', () => {
      infoPanel.style.display = 'none';
      chatPanel.style.display = 'flex';
      tabInfo.style.background = 'transparent';
      tabInfo.style.borderColor = 'rgba(138, 43, 226, 0.2)';
      tabInfo.style.color = '#bfc4ff';
      tabChat.style.background = 'rgba(138, 43, 226, 0.3)';
      tabChat.style.borderColor = 'rgba(138, 43, 226, 0.6)';
      tabChat.style.color = '#d6c9ff';
    });
    
    // AIä¼šè©±æ©Ÿèƒ½
    function displayAIMessage(role, content) {
      const placeholder = aiMessages.querySelector('div[style*="text-align: center"]');
      if (placeholder) {
        placeholder.remove();
      }
      
      const msgEl = document.createElement('div');
      msgEl.style.cssText = 'padding: 12px; border-radius: 8px; word-wrap: break-word; animation: slideInMessage 0.4s ease;';
      
      if (role === 'user') {
        msgEl.style.cssText += 'background: rgba(75, 120, 180, 0.15); border: 1px solid rgba(75, 120, 180, 0.3); color: #b8d4ff; margin-left: auto; max-width: 85%;';
        msgEl.innerHTML = `<strong style="color: #75b8ff; font-size: 12px;">ãƒ†ã‚¹ã‚¿ãƒ¼:</strong><br><span style="font-size: 12px; line-height: 1.5;">${content}</span>`;
      } else if (role === 'assistant') {
        msgEl.style.cssText += 'background: rgba(138, 43, 226, 0.15); border: 1px solid rgba(138, 43, 226, 0.3); color: #f7f5ff; margin-right: auto; max-width: 85%;';
        msgEl.innerHTML = `<strong style="color: #d6c9ff; font-size: 12px;">ğŸ¤– AI:</strong><br><span style="font-size: 12px; line-height: 1.5;">${content.replace(/\n/g, '<br>')}</span>`;
      }
      
      aiMessages.appendChild(msgEl);
      aiMessages.scrollTop = aiMessages.scrollHeight;
    }
    
    // AIé€ä¿¡
    aiSendButton.addEventListener('click', async () => {
      const message = aiInput.value.trim();
      if (!message) {
        aiStatus.textContent = 'âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return;
      }
      
      if (!lastTestResult) {
        aiStatus.textContent = 'âŒ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
        return;
      }
      
      displayAIMessage('user', message);
      aiInput.value = '';
      aiStatus.textContent = 'ğŸ”„ AIå›ç­”ç”Ÿæˆä¸­...';
      
      try {
        // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã«ç›¸è«‡ã‚’é€ä¿¡
        const res = await fetch('/api/admin/ai-assistant', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            testContext: lastTestResult ? {
              character: lastTestResult.character,
              testType: lastTestResult.type,
              welcomeMessage: lastTestResult.message,
            } : null,
          }),
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'é€ä¿¡å¤±æ•—');
        
        displayAIMessage('assistant', data.response || 'ï¼ˆå›ç­”ãªã—ï¼‰');
        aiStatus.textContent = 'âœ… ç›¸è«‡ã«å›ç­”ã—ã¾ã—ãŸ';
      } catch (error) {
        aiStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        displayAIMessage('assistant', `ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    });
    
    // AIã‚¯ãƒªã‚¢
    aiClearButton.addEventListener('click', () => {
      aiInput.value = '';
      aiStatus.textContent = '';
    });
    
    // é¸æŠå¤‰æ›´æ™‚ã«ãƒ†ã‚¹ãƒˆæƒ…å ±æ›´æ–°
    testUserSelect.addEventListener('change', updateTestInfo);
    testCharacterSelect.addEventListener('change', updateTestInfo);
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
    fetchUsers();
  </script>
</body>
</html>
