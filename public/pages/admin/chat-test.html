<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆ - ç®¡ç†ç”»é¢</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 100%);
            color: #e8d5ff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #8b3dff;
            margin-bottom: 20px;
            text-align: center;
        }

        .controls {
            background: rgba(75, 0, 130, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(138, 61, 255, 0.3);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-row label {
            min-width: 120px;
            color: #d4c4e8;
        }

        .user-mode-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .user-mode-badge.guest {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e8d5ff;
        }

        .user-mode-badge.registered {
            background: linear-gradient(135deg, rgba(139, 61, 255, 0.8), rgba(75, 0, 130, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
        }

        .controls-row input,
        .controls-row select,
        .controls-row button {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid rgba(138, 61, 255, 0.5);
            background: rgba(26, 10, 46, 0.8);
            color: #e8d5ff;
            font-size: 14px;
        }

        .controls-row button {
            background: linear-gradient(135deg, rgba(138, 61, 255, 0.8), rgba(75, 0, 130, 0.8));
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .controls-row button:hover {
            background: linear-gradient(135deg, rgba(138, 61, 255, 1), rgba(75, 0, 130, 1));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(138, 61, 255, 0.4);
        }

        .controls-row button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .chat-container {
                grid-template-columns: 1fr;
            }
        }

        .chat-area {
            background: rgba(75, 0, 130, 0.2);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(138, 61, 255, 0.3);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: rgba(138, 61, 255, 0.3);
            margin-left: auto;
            text-align: right;
            border: 1px solid rgba(138, 61, 255, 0.5);
        }

        .message.assistant {
            background: rgba(75, 0, 130, 0.5);
            margin-right: auto;
            border: 1px solid rgba(75, 0, 130, 0.7);
        }

        .message.system {
            background: rgba(0, 0, 0, 0.5);
            margin: 0 auto 15px auto;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            max-width: 90%;
        }

        .message-header {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .input-area {
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid rgba(138, 61, 255, 0.5);
            background: rgba(26, 10, 46, 0.8);
            color: #e8d5ff;
            font-size: 14px;
        }

        .input-area button {
            padding: 12px 25px;
            border-radius: 5px;
            border: none;
            background: linear-gradient(135deg, rgba(138, 61, 255, 0.8), rgba(75, 0, 130, 0.8));
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .input-area button:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(138, 61, 255, 1), rgba(75, 0, 130, 1));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(138, 61, 255, 0.4);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .debug-panel {
            background: rgba(75, 0, 130, 0.2);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(138, 61, 255, 0.3);
            height: 600px;
            overflow-y: auto;
        }

        .debug-panel h3 {
            color: #8b3dff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border-left: 3px solid #8b3dff;
        }

        .debug-section h4 {
            color: #d4c4e8;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .debug-section pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            color: #e8d5ff;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.success {
            background: #4caf50;
        }

        .status-indicator.error {
            background: #f44336;
        }

        .status-indicator.loading {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loop-warning {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            color: #ffcdd2;
        }

        .phase-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .phase-badge.phase1 {
            background: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        .phase-badge.phase2 {
            background: rgba(33, 150, 243, 0.3);
            color: #64b5f6;
        }

        .phase-badge.phase3 {
            background: rgba(156, 39, 176, 0.3);
            color: #ba68c8;
        }

        .phase-badge.phase4 {
            background: rgba(255, 152, 0, 0.3);
            color: #ffb74d;
        }

        /* ç™»éŒ²ãƒœã‚¿ãƒ³ */
        .registration-button-container {
            padding: 16px;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            margin-top: 10px;
        }
        
        .registration-button-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .registration-button {
            background: linear-gradient(135deg, #8b3dff 0%, #6b2acc 100%);
            color: #ffffff;
            border: none;
            padding: 14px 28px;
            border-radius: 999px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(139, 61, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .registration-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 61, 255, 0.4);
        }
        
        .registration-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”® ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆ - ç®¡ç†ç”»é¢</h1>

        <div class="controls">
            <div class="controls-row">
                <label>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</label>
                <select id="characterSelect">
                    <option value="kaede" selected>æ¥“ï¼ˆã‹ãˆã§ï¼‰</option>
                    <option value="yukino">ç¬¹å²¡é›ªä¹ƒ</option>
                    <option value="sora">æ°´é‡ã‚½ãƒ©</option>
                    <option value="kaon">ä¸‰å´èŠ±éŸ³</option>
                </select>
                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³:</label>
                <input type="text" id="userTokenInput" placeholder="ï¼ˆã‚²ã‚¹ãƒˆã®å ´åˆã¯ç©ºæ¬„ï¼‰" style="flex: 1;">
                <label>ä½¿ç”¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:</label>
                <select id="providerSelect">
                    <option value="auto" selected>è‡ªå‹•ï¼ˆDeepSeekå„ªå…ˆï¼‰</option>
                    <option value="deepseek">DeepSeekï¼ˆå¼·åˆ¶ï¼‰</option>
                    <option value="openai">OpenAI / GPT-APIï¼ˆå¼·åˆ¶ï¼‰</option>
                </select>
                <button onclick="resetChat()">ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                <button onclick="clearAllHistory()" style="background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(198, 40, 40, 0.8));">å…¨å±¥æ­´ã‚’å‰Šé™¤</button>
            </div>
            <div class="controls-row">
                <label>ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰:</label>
                <span id="userModeBadge" class="user-mode-badge guest">ã‚²ã‚¹ãƒˆ</span>
                <button onclick="switchToGuest()" id="switchGuestButton" disabled style="background: transparent; border: 1px solid rgba(255,255,255,0.3);">ã‚²ã‚¹ãƒˆã«æˆ»ã‚‹</button>
            </div>
            <div class="controls-row" style="flex-wrap: wrap; gap: 10px;">
                <label>ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²:</label>
                <input type="text" id="registerNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " style="min-width: 180px;">
                <input type="date" id="registerBirthDate" style="min-width: 170px;">
                <button onclick="registerTestUser()" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(56, 142, 60, 0.8));">ç™»éŒ²ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
                <span id="registerStatus" style="font-size: 13px; color: #e8d5ff;"></span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-area">
                <div class="messages" id="messagesContainer">
                    <div class="message assistant">
                        <div class="message-header">ã‚·ã‚¹ãƒ†ãƒ </div>
                        <div>ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</div>
                    </div>
                </div>
                <!-- ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã§è¡¨ç¤ºï¼‰ -->
                <div class="registration-button-container" id="registrationButtonContainer" style="display: none;">
                    <button class="registration-button" id="registrationButton" onclick="openRegistrationFromChat()">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’ã—ã¦é‘‘å®šã‚’ç¶šã‘ã‚‹
                    </button>
                </div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="handleKeyPress(event)">
                    <button id="sendButton" onclick="sendMessage()">é€ä¿¡</button>
                </div>
            </div>

            <div class="debug-panel">
                <h3>ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
                
                <div class="debug-section">
                    <h4>ä¼šè©±çŠ¶æ…‹</h4>
                    <div>
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">å¾…æ©Ÿä¸­</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</strong> <span id="messageCount">0</span>
                    </div>
                    <div>
                        <strong>ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º:</strong> <span id="currentPhase">-</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>å®Ÿéš›ã«ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼:</strong> <span id="providerInfo" style="color: #81c784;">-</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ¼ãƒ‰:</strong> <span id="debugUserMode">ã‚²ã‚¹ãƒˆ</span>
                    </div>
                </div>

                <div class="debug-section">
                    <h4>ä¼šè©±å±¥æ­´ï¼ˆJSONï¼‰</h4>
                    <pre id="historyJson">[]</pre>
                </div>

                <div class="debug-section">
                    <h4>æœ€å¾Œã®APIå¿œç­”</h4>
                    <pre id="lastResponse">-</pre>
                </div>

                <div class="debug-section" id="loopWarning" style="display: none;">
                    <h4>âš ï¸ ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h4>
                    <div class="loop-warning">
                        <div>åŒã˜å†…å®¹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
                        <div id="loopDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let messageCount = 0;
        let lastMessages = []; // ãƒ«ãƒ¼ãƒ—æ¤œå‡ºç”¨
        let currentUserMode = 'guest';
        let currentUserNickname = '';
        let currentUserToken = '';

        const API_BASE_URL = '/api/consult';

        function getCurrentPhase(count) {
            if (count === 1) return 'ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆæœªæ¥ã‚¤ãƒ¡ãƒ¼ã‚¸é¸æŠï¼‰';
            if (count === 2) return 'ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆé•·æ‰€è³ªå•ï¼‰';
            if (count === 3) return 'ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆæ€§æ ¼è¨ºæ–­ï¼‰';
            if (count >= 4) return 'ãƒ•ã‚§ãƒ¼ã‚º4ï¼ˆæœªæ¥ãƒ»å®ˆè­·ãƒ»å„€å¼ï¼‰';
            return '-';
        }

        function getPhaseBadgeClass(count) {
            if (count === 1) return 'phase1';
            if (count === 2) return 'phase2';
            if (count === 3) return 'phase3';
            if (count >= 4) return 'phase4';
            return '';
        }

        function updateDebugInfo() {
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('currentPhase').innerHTML = 
                getCurrentPhase(messageCount) + 
                (messageCount > 0 ? `<span class="phase-badge ${getPhaseBadgeClass(messageCount)}">${messageCount}é€šç›®</span>` : '');
            
            document.getElementById('historyJson').textContent = 
                JSON.stringify(conversationHistory, null, 2);
        }

        function setProviderInfoDisplay(provider) {
            const providerInfo = document.getElementById('providerInfo');
            if (!provider) {
                providerInfo.textContent = '-';
                providerInfo.style.color = '#e8d5ff';
                return;
            }
            if (provider === 'deepseek') {
                providerInfo.textContent = 'DeepSeek';
                providerInfo.style.color = '#64b5f6';
            } else if (provider === 'openai') {
                providerInfo.textContent = 'OpenAI (GPT-API)';
                providerInfo.style.color = '#ffb74d';
            } else {
                providerInfo.textContent = provider;
                providerInfo.style.color = '#e8d5ff';
            }
        }

        function updateUserModeDisplay() {
            const badge = document.getElementById('userModeBadge');
            const debugMode = document.getElementById('debugUserMode');
            const switchButton = document.getElementById('switchGuestButton');

            if (currentUserMode === 'registered') {
                badge.textContent = currentUserNickname ? `ç™»éŒ²æ¸ˆ: ${currentUserNickname}` : 'ç™»éŒ²æ¸ˆ';
                badge.classList.remove('guest');
                badge.classList.add('registered');
                debugMode.textContent = currentUserNickname ? `ç™»éŒ²æ¸ˆ (${currentUserNickname})` : 'ç™»éŒ²æ¸ˆ';
                switchButton.disabled = false;
            } else {
                badge.textContent = 'ã‚²ã‚¹ãƒˆ';
                badge.classList.remove('registered');
                badge.classList.add('guest');
                debugMode.textContent = 'ã‚²ã‚¹ãƒˆ';
                switchButton.disabled = true;
            }
        }

        function addSystemMessage(content) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ';
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function checkForLoop(newMessage) {
            // ç›´è¿‘3ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æ¯”è¼ƒ
            if (lastMessages.length >= 2) {
                const lastTwo = lastMessages.slice(-2);
                const normalizedNew = newMessage.toLowerCase().trim();
                
                for (const msg of lastTwo) {
                    const normalized = msg.toLowerCase().trim();
                    // 80%ä»¥ä¸Šä¸€è‡´ã™ã‚‹å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã¨åˆ¤å®š
                    if (normalized.length > 0 && 
                        (normalizedNew.includes(normalized.substring(0, Math.min(20, normalized.length))) ||
                         normalized.includes(normalizedNew.substring(0, Math.min(20, normalizedNew.length))))) {
                        document.getElementById('loopWarning').style.display = 'block';
                        document.getElementById('loopDetails').textContent = 
                            `é¡ä¼¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${msg.substring(0, 50)}..."`;
                        return true;
                    }
                }
            }
            
            document.getElementById('loopWarning').style.display = 'none';
            return false;
        }

        function addMessage(role, content, isUser = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            if (role === 'system') {
                header.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ';
            } else if (isUser) {
                header.textContent = 'ã‚ãªãŸ';
            } else {
                header.textContent = document.getElementById('characterSelect').value === 'kaede' ? 'æ¥“' : 'é‘‘å®šå£«';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // ãƒ«ãƒ¼ãƒ—æ¤œå‡º
            if (role === 'assistant') {
                lastMessages.push(content);
                if (lastMessages.length > 3) {
                    lastMessages.shift();
                }
                checkForLoop(content);
            }
        }

        function setStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            const characterId = document.getElementById('characterSelect').value;
            const userToken = document.getElementById('userTokenInput').value.trim();

            // UIæ›´æ–°
            addMessage('user', message, true);
            input.value = '';
            setStatus('loading', 'é€ä¿¡ä¸­...');
            document.getElementById('sendButton').disabled = true;
            setProviderInfoDisplay(null);

            // ä¼šè©±å±¥æ­´ã‚’æ›´æ–°
            conversationHistory.push({ role: 'user', content: message });
            messageCount++;
            updateDebugInfo();

            try {
                const selectedProvider = document.getElementById('providerSelect').value;
                const requestBody = {
                    message: message,
                    character: characterId,
                    userToken: userToken || undefined,
                    clientHistory: conversationHistory.slice(0, -1), // ç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ã
                    // ãƒ†ã‚¹ãƒˆç”¨: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å¼·åˆ¶æŒ‡å®š
                    forceProvider: selectedProvider !== 'auto' ? selectedProvider : undefined
                };
                if (currentUserMode === 'guest') {
                    requestBody.guestMetadata = {
                        messageCount: messageCount - 1
                    };
                }

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });

                const data = await response.json();

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
                document.getElementById('lastResponse').textContent = 
                    JSON.stringify(data, null, 2);

                setProviderInfoDisplay(data.provider);

                if (data.error) {
                    setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + data.error);
                    addMessage('assistant', 'ã‚¨ãƒ©ãƒ¼: ' + data.error);
                } else if (data.message) {
                    setStatus('success', 'æˆåŠŸ');
                    addMessage('assistant', data.message);
                    
                    // ä¼šè©±å±¥æ­´ã‚’æ›´æ–°
                    conversationHistory.push({ role: 'assistant', content: data.message });
                    updateDebugInfo();
                    
                    // needsRegistrationãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã€ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    if (data.needsRegistration && currentUserMode === 'guest') {
                        setTimeout(() => {
                            showRegistrationButton();
                        }, 3000); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã‚“ã å¾Œã€3ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    }
                } else {
                    setStatus('error', 'å¿œç­”ãŒç©ºã§ã™');
                    addMessage('assistant', 'å¿œç­”ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
                addMessage('assistant', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                document.getElementById('lastResponse').textContent = 
                    'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            } finally {
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoSendFirstMessage() {
            const characterId = document.getElementById('characterSelect').value;
            // æ¥“ãŒé¸æŠã•ã‚Œã¦ã„ã¦ã€ä¼šè©±å±¥æ­´ãŒç©ºã®å ´åˆã®ã¿è‡ªå‹•é€ä¿¡
            if (characterId === 'kaede' && conversationHistory.length === 0 && messageCount === 0) {
                const input = document.getElementById('messageInput');
                input.value = 'æœªæ¥ã®å§¿ã‚’å ã£ã¦æ¬²ã—ã„ã§ã™ã€‚';
                sendMessage();
                return true;
            }
            return false;
        }

        function resetChat() {
            conversationHistory = [];
            messageCount = 0;
            lastMessages = [];
            document.getElementById('messagesContainer').innerHTML = `
                <div class="message assistant">
                    <div class="message-header">ã‚·ã‚¹ãƒ†ãƒ </div>
                    <div>ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ¥“ã®å ´åˆã¯è‡ªå‹•çš„ã«ã€Œæœªæ¥ã®å§¿ã‚’å ã£ã¦æ¬²ã—ã„ã§ã™ã€‚ã€ã‚’é€ä¿¡ã—ã¾ã™ã€‚</div>
                </div>
            `;
            document.getElementById('lastResponse').textContent = '-';
            document.getElementById('loopWarning').style.display = 'none';
            setStatus('success', 'ãƒªã‚»ãƒƒãƒˆå®Œäº†');
            updateDebugInfo();
            setProviderInfoDisplay(null);
            
            // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            hideRegistrationButton();
            
            // æ¥“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            setTimeout(() => {
                autoSendFirstMessage();
            }, 300);
        }

        function clearAllHistory() {
            if (!confirm('ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®å±¥æ­´ï¼ˆlocalStorageã€sessionStorageã€ã‚¯ãƒƒã‚­ãƒ¼ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                // localStorage ã‚’ã‚¯ãƒªã‚¢
                localStorage.clear();
                console.log('localStorage cleared');

                // sessionStorage ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.clear();
                console.log('sessionStorage cleared');

                // ã‚¯ãƒƒã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¯èƒ½ãªç¯„å›²ã§ï¼‰
                // ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const eqPos = cookie.indexOf('=');
                    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                    // ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤ï¼ˆæœ‰åŠ¹æœŸé™ã‚’éå»ã«è¨­å®šï¼‰
                    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
                    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=' + window.location.hostname;
                    document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.' + window.location.hostname;
                }
                console.log('Cookies cleared');

                // ä¼šè©±å±¥æ­´ã‚‚ãƒªã‚»ãƒƒãƒˆ
                resetChat();

                setStatus('success', 'å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const messagesContainer = document.getElementById('messagesContainer');
                const successDiv = document.createElement('div');
                successDiv.className = 'message assistant';
                successDiv.innerHTML = `
                    <div class="message-header">ã‚·ã‚¹ãƒ†ãƒ </div>
                    <div style="color: #81c784;">âœ… å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆlocalStorageã€sessionStorageã€ã‚¯ãƒƒã‚­ãƒ¼ï¼‰</div>
                `;
                messagesContainer.appendChild(successDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error clearing history:', error);
                setStatus('error', 'å±¥æ­´å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                alert('å±¥æ­´å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
        document.getElementById('characterSelect').addEventListener('change', function() {
            // ä¼šè©±ãŒç©ºã§æ¥“ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€è‡ªå‹•çš„ã«æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            setTimeout(() => {
                autoSendFirstMessage();
            }, 300);
        });

        function switchToGuest() {
            if (currentUserMode === 'guest') {
                return;
            }
            currentUserMode = 'guest';
            currentUserNickname = '';
            currentUserToken = '';
            document.getElementById('userTokenInput').value = '';
            document.getElementById('registerStatus').textContent = 'ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã—ãŸã€‚';
            document.getElementById('registerStatus').style.color = '#e8d5ff';
            updateUserModeDisplay();
            addSystemMessage('ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã—ãŸã€‚ä¼šè©±ã¯ã‚²ã‚¹ãƒˆã¨ã—ã¦ç¶šè¡Œã•ã‚Œã¾ã™ã€‚');
            
            // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã£ãŸæ™‚ç‚¹ã§ã¯è¡¨ç¤ºã—ãªã„ï¼‰
            hideRegistrationButton();
        }

        function showRegistrationButton() {
            const registrationButtonContainer = document.getElementById('registrationButtonContainer');
            if (registrationButtonContainer) {
                registrationButtonContainer.style.display = 'block';
                // å¼·åˆ¶çš„ã«å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                requestAnimationFrame(() => {
                    registrationButtonContainer.classList.add('visible');
                });
            }
        }

        function hideRegistrationButton() {
            const registrationButtonContainer = document.getElementById('registrationButtonContainer');
            if (registrationButtonContainer) {
                registrationButtonContainer.classList.remove('visible');
                setTimeout(() => {
                    registrationButtonContainer.style.display = 'none';
                }, 500); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
            }
        }

        function openRegistrationFromChat() {
            // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const nicknameInput = document.getElementById('registerNickname');
            if (nicknameInput) {
                // è¦ªè¦ç´ ã®controls-rowã‚’æ¢ã™
                let registerSection = nicknameInput.closest('.controls-row');
                if (!registerSection) {
                    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€controlsè¦ç´ å…¨ä½“ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    registerSection = document.querySelector('.controls');
                }
                if (registerSection) {
                    registerSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›æ¬„ã«
                    setTimeout(() => {
                        nicknameInput.focus();
                    }, 500);
                }
            }
        }

        async function registerTestUser() {
            const nicknameInput = document.getElementById('registerNickname');
            const birthInput = document.getElementById('registerBirthDate');
            const statusEl = document.getElementById('registerStatus');
            const nickname = nicknameInput.value.trim();
            const birthDate = birthInput.value;

            if (!nickname || !birthDate) {
                statusEl.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                statusEl.style.color = '#ffcdd2';
                return;
            }

            const [year, month, day] = birthDate.split('-').map(Number);
            if (!year || !month || !day) {
                statusEl.textContent = 'ç”Ÿå¹´æœˆæ—¥ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                statusEl.style.color = '#ffcdd2';
                return;
            }

            statusEl.textContent = 'ç™»éŒ²å‡¦ç†ä¸­...';
            statusEl.style.color = '#ffeb3b';

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nickname,
                        birthYear: year,
                        birthMonth: month,
                        birthDay: day
                    })
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    statusEl.textContent = data.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    statusEl.style.color = '#ffcdd2';
                    return;
                }

                currentUserMode = 'registered';
                currentUserNickname = data.nickname || nickname;
                currentUserToken = data.userToken;
                document.getElementById('userTokenInput').value = currentUserToken;
                statusEl.textContent = `ç™»éŒ²å®Œäº†: ${currentUserNickname} ã•ã‚“ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚`;
                statusEl.style.color = '#81c784';
                updateUserModeDisplay();
                addSystemMessage('ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä¼šè©±ã¯ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç¶šè¡Œã•ã‚Œã¾ã™ã€‚');
                
                // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                hideRegistrationButton();
                
                resetChat();
            } catch (error) {
                statusEl.textContent = 'ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
                statusEl.style.color = '#ffcdd2';
            }
        }

        // åˆæœŸåŒ–
        updateDebugInfo();
        updateUserModeDisplay();
        
        // åˆæœŸè¡¨ç¤ºæ™‚ã«æ¥“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        setTimeout(() => {
            if (!autoSendFirstMessage()) {
                // æ¥“ã§ãªã„å ´åˆã¯å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                document.getElementById('messageInput').focus();
            }
        }, 500);
    </script>
</body>
</html>

