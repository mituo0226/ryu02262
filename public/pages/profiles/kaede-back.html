<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>楓への導き - 運命の扉</title>
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="back-transition-page">
    <div class="image-transition-container">
        <img src="../../photo/kaede.png" alt="楓" class="fortune-teller-image-back" id="fortuneImage">
        <video 
            src="../../photo/back.mp4" 
            class="back-video" 
            id="backVideo"
            playsinline
            webkit-playsinline
            autoplay
            muted
            preload="auto"
            loop
        ></video>
        
        <div class="message-flow" id="messageFlow">
            <p id="messageText"></p>
        </div>

        <div class="final-button-container">
            <a href="#" id="chatLink" class="talk-button">楓とつながる</a>
        </div>
    </div>

    <script src="../../js/auth-state.js"></script>
    <script>
        // ユーザーの登録状況に応じてリンク先を設定
        function setChatLink() {
            const chatLink = document.getElementById('chatLink');
            if (!chatLink) return;
            
            // AuthStateを初期化
            if (window.AuthState && typeof window.AuthState.init === 'function') {
                window.AuthState.init();
            }
            
            // 登録済みユーザーかどうかを確認
            const isRegistered = window.AuthState && typeof window.AuthState.isRegistered === 'function' 
                ? window.AuthState.isRegistered() 
                : false;
            
            if (isRegistered) {
                // 登録済みユーザー → chat.html
                chatLink.href = '../chat/chat.html?character=kaede';
            } else {
                // 未登録者 → chat-example.html
                chatLink.href = '../chat/chat-example.html?character=kaede';
            }
        }
        
        // ページ読み込み時にリンクを設定
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setChatLink);
        } else {
            setChatLink();
        }
    </script>
    <script>
        const backVideo = document.getElementById('backVideo');
        const messageText = document.getElementById('messageText');
        const messageFlow = document.getElementById('messageFlow');
        
        // iPhoneでの動画表示制限を回避するための設定
        backVideo.setAttribute('playsinline', 'true');
        backVideo.setAttribute('webkit-playsinline', 'true');
        backVideo.setAttribute('x5-video-player-type', 'h5');
        backVideo.setAttribute('x5-video-player-fullscreen', 'true');
        backVideo.setAttribute('x5-video-orientation', 'portrait');
        
        // 動画のループ設定
        backVideo.loop = true;
        
        // 動画の読み込み完了を待つ
        backVideo.addEventListener('loadedmetadata', () => {
            backVideo.play().catch(err => {
                console.log('自動再生がブロックされました:', err);
            });
        });

        // 動画の再生を強制（1秒後から開始して重なりを長くする）
        setTimeout(() => {
            backVideo.play().catch(err => {
                console.log('動画再生エラー:', err);
            });
        }, 1000);

        // タイプライターエフェクト
        const fullText = 'あなたの心の迷いを\n\n鑑定師に 打ち明けなさい';
        let currentIndex = 0;
        
        function typeWriter() {
            if (currentIndex < fullText.length) {
                if (fullText[currentIndex] === '\n') {
                    messageText.innerHTML += '<br>';
                } else {
                    messageText.innerHTML += fullText[currentIndex];
                }
                currentIndex++;
                setTimeout(typeWriter, 100);
            } else {
                // タイプライター完了後、カーソルを追加
                messageText.classList.add('typewriter-text');
            }
        }

        // 7秒後にタイプライター開始と吹き出し表示
        setTimeout(() => {
            messageFlow.classList.add('show');
            typeWriter();
        }, 7000);
    </script>
</body>
</html>
