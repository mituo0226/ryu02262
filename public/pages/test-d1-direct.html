<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D1 ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1000px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-section h2 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-section h2::before {
            content: 'ğŸ“Œ';
            font-size: 18px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }
        .result.success {
            border-color: #4caf50;
            background: #f1f8f6;
            color: #2e7d32;
        }
        .result.error {
            border-color: #f44336;
            background: #fdf0f0;
            color: #c62828;
        }
        .result.loading {
            border-color: #ff9800;
            background: #fff3f0;
            color: #e65100;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.success {
            background: #4caf50;
        }
        .status-indicator.error {
            background: #f44336;
        }
        .status-indicator.loading {
            background: #ff9800;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .info-text {
            color: #666;
            font-size: 13px;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Cloudflare D1 ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</h1>

        <!-- ãƒ†ã‚¹ãƒˆ1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²API -->
        <div class="test-section">
            <h2>ãƒ†ã‚¹ãƒˆ1ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² (/api/auth/register)</h2>
            <div class="button-group">
                <button onclick="testRegister()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Ÿè¡Œ</button>
                <button onclick="clearResult('register')">ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="register-result" class="result"></div>
            <div class="info-text">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆä¸€è¦§å–å¾—ï¼‰API -->
        <div class="test-section">
            <h2>ãƒ†ã‚¹ãƒˆ2ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾— (/api/admin/users GET)</h2>
            <div class="button-group">
                <button onclick="testGetUsers()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—</button>
                <button onclick="clearResult('users')">ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="users-result" class="result"></div>
            <div class="info-text">ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ3: ãƒãƒ£ãƒƒãƒˆAPI -->
        <div class="test-section">
            <h2>ãƒ†ã‚¹ãƒˆ3ï¼šãƒãƒ£ãƒƒãƒˆAPI (/api/consult)</h2>
            <div class="button-group">
                <button onclick="testConsult()">ãƒãƒ£ãƒƒãƒˆAPIå®Ÿè¡Œ</button>
                <button onclick="clearResult('consult')">ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="consult-result" class="result"></div>
            <div class="info-text">ãƒãƒ£ãƒƒãƒˆAPIã‚’å®Ÿè¡Œã—ã€è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ4: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆPOSTï¼‰-->
        <div class="test-section">
            <h2>ãƒ†ã‚¹ãƒˆ4ï¼šãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ (/api/admin/users POST)</h2>
            <div class="button-group">
                <button onclick="testCreateTestUser()">ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</button>
                <button onclick="clearResult('test-user')">ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="test-user-result" class="result"></div>
            <div class="info-text">AdminToken ãŒå¿…è¦ã§ã™ã€‚æˆåŠŸæ™‚ã¯ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDãŒè¿”ã•ã‚Œã¾ã™ã€‚</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ5: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’ä¸€æ‹¬å®Ÿè¡Œ -->
        <div class="test-section">
            <h2>ãƒ†ã‚¹ãƒˆ5ï¼šå…¨ãƒ†ã‚¹ãƒˆä¸€æ‹¬å®Ÿè¡Œ</h2>
            <div class="button-group">
                <button onclick="testAll()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button onclick="clearAllResults()">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="all-result" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const ADMIN_TOKEN = localStorage.getItem('admin-token') || '';

        function showLoading(resultId) {
            const result = document.getElementById(resultId);
            result.innerHTML = '<span class="status-indicator loading"></span>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
            result.className = 'result loading';
        }

        function showSuccess(resultId, data) {
            const result = document.getElementById(resultId);
            result.innerHTML = `<span class="status-indicator success"></span><strong>âœ“ æˆåŠŸ</strong>\n\n${JSON.stringify(data, null, 2)}`;
            result.className = 'result success';
        }

        function showError(resultId, error) {
            const result = document.getElementById(resultId);
            result.innerHTML = `<span class="status-indicator error"></span><strong>âœ— ã‚¨ãƒ©ãƒ¼</strong>\n\n${error}`;
            result.className = 'result error';
        }

        function clearResult(resultId) {
            document.getElementById(resultId).innerHTML = '';
        }

        function clearAllResults() {
            clearResult('register');
            clearResult('users');
            clearResult('consult');
            clearResult('test-user');
            clearResult('all-result');
        }

        // ãƒ†ã‚¹ãƒˆ1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
        async function testRegister() {
            const resultId = 'register-result';
            showLoading(resultId);
            
            const nickname = `TestUser_${Date.now()}`;
            const payload = {
                nickname: nickname,
                birthYear: 2000,
                birthMonth: 1,
                birthDay: 1
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(resultId, {
                        status: response.status,
                        message: 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ',
                        userId: data.userId,
                        nickname: data.nickname
                    });
                } else {
                    showError(resultId, `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showError(resultId, `ä¾‹å¤–ç™ºç”Ÿ: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
        async function testGetUsers() {
            const resultId = 'users-result';
            showLoading(resultId);

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Token': ADMIN_TOKEN
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess(resultId, {
                        status: response.status,
                        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—æˆåŠŸ',
                        userCount: data.users?.length || 0,
                        users: data.users?.slice(0, 3) // æœ€åˆã®3ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
                    });
                } else {
                    const text = await response.text();
                    showError(resultId, `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${text.substring(0, 300)}`);
                }
            } catch (error) {
                showError(resultId, `ä¾‹å¤–ç™ºç”Ÿ: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ3: ãƒãƒ£ãƒƒãƒˆAPI
        async function testConsult() {
            const resultId = 'consult-result';
            showLoading(resultId);

            const payload = {
                userId: 1,
                characterId: 2,
                message: 'ã“ã‚“ã«ã¡ã¯',
                nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                birthYear: 2000,
                birthMonth: 1,
                birthDay: 1
            };

            try {
                const response = await fetch(`${API_BASE}/consult`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    timeout: 30000
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess(resultId, {
                        status: response.status,
                        message: 'ãƒãƒ£ãƒƒãƒˆAPIå®Ÿè¡ŒæˆåŠŸ',
                        response: data.message?.substring(0, 200) || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—æˆåŠŸ'
                    });
                } else {
                    const text = await response.text();
                    showError(resultId, `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${text.substring(0, 300)}`);
                }
            } catch (error) {
                showError(resultId, `ä¾‹å¤–ç™ºç”Ÿ: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ4: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        async function testCreateTestUser() {
            const resultId = 'test-user-result';
            showLoading(resultId);

            if (!ADMIN_TOKEN) {
                showError(resultId, 'AdminToken ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:\nlocalStorage.setItem("admin-token", "your-token")');
                return;
            }

            const payload = { action: 'create_or_get' };

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Token': ADMIN_TOKEN
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(resultId, {
                        status: response.status,
                        message: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/å–å¾—æˆåŠŸ',
                        testUserId: data.testUserId,
                        nickname: data.nickname
                    });
                } else {
                    showError(resultId, `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}\n${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showError(resultId, `ä¾‹å¤–ç™ºç”Ÿ: ${error.message}`);
            }
        }

        // ãƒ†ã‚¹ãƒˆ5: ã™ã¹ã¦å®Ÿè¡Œ
        async function testAll() {
            const resultId = 'all-result';
            const result = document.getElementById(resultId);
            result.innerHTML = '<span class="status-indicator loading"></span>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...\n\n';
            result.className = 'result loading';

            const tests = [
                { name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²', fn: testRegister, id: 'register' },
                { name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§', fn: testGetUsers, id: 'users' },
                { name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ', fn: testCreateTestUser, id: 'test-user' },
                { name: 'ãƒãƒ£ãƒƒãƒˆAPI', fn: testConsult, id: 'consult' }
            ];

            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                result.innerHTML += `å®Ÿè¡Œä¸­: ${test.name}...\n`;
                await new Promise(resolve => setTimeout(resolve, 500));
                
                try {
                    await test.fn();
                    const testResult = document.getElementById(`${test.id}-result`);
                    if (testResult.className.includes('success')) {
                        result.innerHTML += `âœ“ ${test.name} - æˆåŠŸ\n`;
                        passed++;
                    } else {
                        result.innerHTML += `âœ— ${test.name} - å¤±æ•—\n`;
                        failed++;
                    }
                } catch {
                    result.innerHTML += `âœ— ${test.name} - ã‚¨ãƒ©ãƒ¼\n`;
                    failed++;
                }
            }

            result.innerHTML += `\nçµæœ: ${passed}/${tests.length} æˆåŠŸ, ${failed}/${tests.length} å¤±æ•—`;
            if (failed === 0) {
                result.className = 'result success';
            } else if (passed > 0) {
                result.className = 'result loading';
            } else {
                result.className = 'result error';
            }
        }

        // åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        window.addEventListener('load', () => {
            if (ADMIN_TOKEN) {
                console.log('âœ“ AdminToken ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™');
            } else {
                console.warn('âš  AdminToken ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆ4ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:');
                console.warn('localStorage.setItem("admin-token", "your-admin-token")');
            }
        });
    </script>
</body>
</html>
