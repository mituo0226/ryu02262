<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é‘‘å®šå£«ãƒãƒ£ãƒƒãƒˆ</title>
    
    <link rel="stylesheet" href="../../css/chat.css">
    <link rel="stylesheet" href="../../css/chat-engine-ui.css">
    <link rel="stylesheet" href="../../css/chat-transitions.css">

</head>
<body>
    <!-- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çµ±ä¸€åˆæœŸåŒ–ã¨ userId æ¤œè¨¼ï¼ˆè¨­è¨ˆã®ç¶™æ‰¿ï¼‰ -->
    <script>
    (function() {
        'use strict';
        // ã€é‡è¦ã€‘JavaScriptå®Ÿè¡Œå‰ã«ãƒšãƒ¼ã‚¸åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        // CSSãŒåå¿œã™ã‚‹å‰ã«ã€ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒãƒ©ã¤ãã‚’é˜²ã
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        
        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§å³åº§ã«éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆCSSèª­ã¿è¾¼ã¿å‰ã«å®Ÿè¡Œï¼‰
        if (userId) {
            const style = document.createElement('style');
            style.textContent = `
                #entryFormContainer { display: none !important; }
                #chatContainer { display: flex !important; }
            `;
            document.head.appendChild(style);
        }
        
        if (userId) {
            // userId ãŒã‚ã‚‹å ´åˆã€ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã«äº‹å‰ã« hidden ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const entryFormContainer = document.getElementById('entryFormContainer');
            if (entryFormContainer) {
                entryFormContainer.classList.add('entry-form-hidden');
            }
        }
        
        // å˜ä¸€ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆ
        if (!window._chatUrlParams) {
            window._chatUrlParams = new URLSearchParams(window.location.search);
        }
        
        // ã€é‡è¦ã€‘userId ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æ¤œè¨¼
        // è¨­è¨ˆï¼šuserId ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã€ã‚ã‚‹å ´åˆã¯ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
        const userIdFromCache = window._chatUrlParams.get('userId');
        const character = window._chatUrlParams.get('character');
        
        console.log('[URLæ¤œè¨¼] userId:', userIdFromCache, 'character:', character);
        
        if (!userIdFromCache) {
            // âŒ userId ãŒãªã„å ´åˆï¼šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ã€ç™»éŒ²ãƒšãƒ¼ã‚¸ã‚’è¦‹ã›ã‚‹
            console.error('[è¨­è¨ˆã‚¨ãƒ©ãƒ¼] userIdãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ­£è¦ã®flowã§é·ç§»ã—ã¦ãã ã•ã„ã€‚');
            const entryFormError = document.getElementById('entryFormError');
            if (entryFormError) {
                entryFormError.innerHTML = 'ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã€‚<br>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
            }
            // entryFormContainer ã¯è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼‰
            // chatContainer ã¯éè¡¨ç¤ºï¼ˆentry-form-hidden ã‚¯ãƒ©ã‚¹ãŒä»˜ã„ã¦ã„ã‚‹ï¼‰
            document.body.removeAttribute('data-user-id');
            console.log('[åˆæœŸåŒ–] ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæ¤œè¨¼å¤±æ•—ï¼šç™»éŒ²ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™');
        } else {
            // âœ… userId ãŒã‚ã‚‹å ´åˆï¼šbody ã«å±æ€§ã‚’è¨­å®šã—ã¦ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
            document.body.setAttribute('data-user-id', userIdFromCache);
            console.log('[åˆæœŸåŒ–] body[data-user-id] å±æ€§ã‚’è¨­å®šã—ã¾ã—ãŸ:', userIdFromCache);
            console.log('[åˆæœŸåŒ–] Cloudflareãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™');
        }
    })();
    </script>
    
    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="mobile-header" id="mobileHeader">
        <div class="mobile-header-content">
            <a href="../main.html" class="mobile-header-back" aria-label="å‰ã®ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹">â‰ª</a>
            <div class="mobile-header-title" id="mobileHeaderTitle">é‘‘å®šå£«</div>
        </div>
    </div>

    <main>
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div class="loading-screen fade-element" id="loadingScreen">
            <div class="loading-screen-content">
                <!-- å‹•ç”»èƒŒæ™¯ -->
                <div class="loading-video-container">
                    <video id="loadingVideo" class="loading-video" autoplay loop muted playsinline>
                        <source src="../../photo/call.mp4" type="video/mp4">
                        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“
                    </video>
                    <div class="loading-video-overlay"></div>
                </div>
                
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆ -->
                <div class="loading-text-container">
                    <div class="loading-character-name" id="loadingCharacterName"></div>
                    
                    <div class="loading-messages" id="loadingMessages">
                        <div class="loading-message" id="loadingMessage1">
                            <span id="loadingMessage1Text">æ¥“ãŒæº–å‚™ã‚’ã—ã¦ã„ã¾ã™...</span>
                        </div>
                    </div>
                    
                    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®è¦ç´  -->
                    <div class="loading-animation-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…¥å£ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="entry-form-container" id="entryFormContainer">
            <form class="entry-form" id="entryForm" aria-label="é‘‘å®šãƒ•ã‚©ãƒ¼ãƒ ">
                <h2 class="entry-form-title">é‘‘å®šã‚’å§‹ã‚ã‚‹</h2>
                <div class="entry-form-error" id="entryFormError" role="alert" aria-live="polite"></div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label" for="entryNickname">
                        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ <span class="required" aria-label="å¿…é ˆé …ç›®">*</span>
                    </label>
                    <input type="text" class="entry-form-input" id="entryNickname" name="nickname" required maxlength="50" placeholder="é‘‘å®šã§ä½¿ç”¨ã™ã‚‹åå‰ã‚’å…¥åŠ›" aria-required="true">
                </div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label">
                        ç”Ÿå¹´æœˆæ—¥<span class="required" aria-label="å¿…é ˆé …ç›®">*</span>
                    </label>
                    <div class="entry-form-row">
                        <div class="entry-form-group">
                            <label for="entryBirthYear" class="sr-only">ç”Ÿã¾ã‚ŒãŸå¹´</label>
                            <input type="number" class="entry-form-input" id="entryBirthYear" name="birthYear" required min="1900" max="2100" placeholder="å¹´" aria-label="ç”Ÿå¹´ï¼ˆå¹´ï¼‰" aria-required="true">
                        </div>
                        <div class="entry-form-group">
                            <label for="entryBirthMonth" class="sr-only">ç”Ÿã¾ã‚ŒãŸæœˆ</label>
                            <input type="number" class="entry-form-input" id="entryBirthMonth" name="birthMonth" required min="1" max="12" placeholder="æœˆ" aria-label="ç”Ÿå¹´ï¼ˆæœˆï¼‰" aria-required="true">
                        </div>
                        <div class="entry-form-group">
                            <label for="entryBirthDay" class="sr-only">ç”Ÿã¾ã‚ŒãŸæ—¥</label>
                            <input type="number" class="entry-form-input" id="entryBirthDay" name="birthDay" required min="1" max="31" placeholder="æ—¥" aria-label="ç”Ÿå¹´ï¼ˆæ—¥ï¼‰" aria-required="true">
                        </div>
                    </div>
                </div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label" for="entryGender">æ€§åˆ¥</label>
                    <select class="entry-form-select" id="entryGender" name="gender" aria-label="æ€§åˆ¥">
                        <option value="">å›ç­”ã—ãªã„</option>
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
                
                <button type="submit" class="entry-form-submit" id="entryFormSubmit">é‘‘å®šã‚’å§‹ã‚ã‚‹</button>
            </form>
        </div>
        
        <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="chat-container entry-form-hidden" id="chatContainer">
            <!-- PCç‰ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé‘‘å®šå£«æƒ…å ±ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼‰-->
            <div class="character-header" id="characterHeader">
                <img id="characterHeaderImage" src="" alt="" class="character-header-image">
                <div class="character-header-name" id="characterHeaderName">é‘‘å®šå£«</div>
                <a href="../main.html" class="character-header-back" aria-label="é‘‘å®šå¸«ä¸€è¦§ã«æˆ»ã‚‹">é‘‘å®šå¸«ä¸€è¦§ã«æˆ»ã‚‹</a>
            </div>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="user-status" id="userStatus" role="status" aria-live="polite">åˆ©ç”¨è€…æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="messages" id="messages" role="log" aria-live="polite" aria-label="ãƒãƒ£ãƒƒãƒˆå±¥æ­´"></div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <div class="input-row">
                    <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="1" maxlength="1000" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›"></textarea>
                    <button id="sendButton" onclick="sendMessage()" title="é€ä¿¡" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: åˆ†æãƒ‘ãƒãƒ« -->
    <div class="admin-analysis-panel hidden" id="adminAnalysisPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 18px; color: #f7f5ff; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">ä¼šè©±åˆ†æãƒ‘ãƒãƒ«</h3>
            <button id="adminRefreshBtn" style="padding: 6px 12px; font-size: 12px; min-width: auto; background: rgba(138, 43, 226, 0.3); border: 1px solid rgba(138, 43, 226, 0.5); border-radius: 6px; color: #f7f5ff; cursor: pointer;" aria-label="åˆ†æãƒ‘ãƒãƒ«ã‚’æ›´æ–°">ğŸ”„ æ›´æ–°</button>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ç¾åœ¨ã®çŠ¶æ…‹</h4>
            <div id="adminCurrentState" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±</h4>
            <div id="adminPhaseInfo" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ä¼šè©±å±¥æ­´æ§‹é€ </h4>
            <div id="adminHistory" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®æ©Ÿèƒ½ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å´ã§å‹•çš„ã«ç”Ÿæˆ -->
        <div class="analysis-section" id="adminCharacterFeatures">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®æ©Ÿèƒ½ï¼ˆä¾‹ï¼šå®ˆè­·ç¥ã®å„€å¼å†ç™ºå‹•ãªã©ï¼‰ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å´ã§å‹•çš„ã«è¿½åŠ  -->
        </div>
    </div>

    <!-- å…¥å£ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã¯chat-engine.jsã«çµ±åˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯æœ€å°é™ã®å‡¦ç†ã®ã¿ -->
    <script>
    // å…¥å£ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã¯chat-engine.jsã§å‡¦ç†ã•ã‚Œã‚‹
    // åŸºæœ¬çš„ãªæ§‹é€ ã®ã¿ã‚’HTMLã«ä¿æŒ
    </script>
    
    <!-- å¾…æ©Ÿç”»é¢åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆè¨­è¨ˆç¶™æ‰¿ï¼šback.html ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ -->
    <script>
    (function() {
        'use strict';
        const urlParams = window._chatUrlParams;
        const character = urlParams.get('character');
        const characterInfo = {
            'kaede': { name: 'æ¥“', fullName: 'æ¥“', icon: '../../photo/kaede.png' },
            'yukino': { name: 'é›ªä¹ƒ', fullName: 'ç¬¹å²¡é›ªä¹ƒ', icon: '../../photo/yukino.png' },
            'sora': { name: 'ã‚½ãƒ©', fullName: 'æ°´é‡ã‚½ãƒ©', icon: '../../photo/sora.png' },
            'kaon': { name: 'èŠ±éŸ³', fullName: 'ä¸‰å´èŠ±éŸ³', icon: '../../photo/kaon.png' }
        };
        
        function customizeLoadingScreen() {
            if (character && characterInfo[character]) {
                const info = characterInfo[character];
                
                // å¾…æ©Ÿç”»é¢ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’æ›´æ–°
                const loadingCharacterName = document.getElementById('loadingCharacterName');
                if (loadingCharacterName) {
                    loadingCharacterName.textContent = info.fullName;
                }
                
                // å¾…æ©Ÿç”»é¢ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                const loadingMessage1Text = document.getElementById('loadingMessage1Text');
                if (loadingMessage1Text) {
                    loadingMessage1Text.textContent = `${info.fullName}ãŒæº–å‚™ã‚’ã—ã¦ã„ã¾ã™...`;
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', customizeLoadingScreen, { once: true });
        } else {
            customizeLoadingScreen();
        }
        
        window.hideLoadingScreen = function() {
            console.log('[hideLoadingScreen] é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            const loadingScreen = document.getElementById('loadingScreen');
            
            if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                console.log('[hideLoadingScreen] hiddenã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¾ã™');
                loadingScreen.classList.add('hidden');
                
                setTimeout(() => {
                    console.log('[hideLoadingScreen] 800mså¾Œ: loadingScreenã‚’å‰Šé™¤ã—ã¾ã™');
                    if (loadingScreen.parentNode) {
                        loadingScreen.parentNode.removeChild(loadingScreen);
                        console.log('[hideLoadingScreen] loadingScreenã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    }
                }, 800);
            }
        };
    })();
    </script>
    
    <!-- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†ï¼ˆmain.html ã®è¨­è¨ˆã‚’ç¶™æ‰¿ï¼‰ -->
    <script>
    (function() {
        'use strict';
        const urlParams = window._chatUrlParams;
        const userId = urlParams.get('userId');
        const character = urlParams.get('character');
        
        // ã€main.html ã¨åŒã˜è¨­è¨ˆã€‘
        // userId ãŒã‚ã‚‹å ´åˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã« userId ã‚’è¿½åŠ 
        if (userId) {
            console.log('[è¨­è¨ˆç¶™æ‰¿] userIdã‚’æ¤œå‡ºï¼š', userId);
            
            // PCç‰ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã« userId ã‚’è¿½åŠ 
            document.querySelectorAll('.character-header-back[href="../main.html"]').forEach((link) => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('userId', userId);
                link.href = url.pathname + url.search;
                console.log('[è¨­è¨ˆç¶™æ‰¿] PCç‰ˆãƒ˜ãƒƒãƒ€ãƒ¼æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°:', link.href);
            });
            
            // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã« userId ã‚’è¿½åŠ 
            document.querySelectorAll('.mobile-header-back[href="../main.html"]').forEach((link) => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('userId', userId);
                link.href = url.pathname + url.search;
                console.log('[è¨­è¨ˆç¶™æ‰¿] ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°:', link.href);
            });
        } else {
            console.warn('[è¨­è¨ˆã‚¨ãƒ©ãƒ¼] userIdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
    })();
    </script>
    
    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="../../js/auth-state.js" defer></script>
    <script src="../../js/chat-loading-animation.js" defer></script>
    <script src="../../js/character-features.js" defer></script>
    <script id="chatEngineScript" src="../../js/chat-engine.js" defer></script>
    <script src="../../js/character-registry.js" defer></script>
    <script src="../../js/character-loader.js" defer></script>
    
    <!-- chat-engine.jsèª­ã¿è¾¼ã¿å®Œäº†æ¤œçŸ¥ -->
    <script>
    (function() {
        'use strict';
        const chatEngineScript = document.getElementById('chatEngineScript');
        if (chatEngineScript) {
            chatEngineScript.addEventListener('load', function() {
                window.chatEngineLoaded = true;
                console.log('[chat-engine] ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
            });
        }
    })();
    </script>
    
    <!-- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‹•çš„èª­ã¿è¾¼ã¿ï¼ˆback.html ã®è¨­è¨ˆã‚’ç¶™æ‰¿ï¼‰ -->
    <script>
    (async function() {
        'use strict';
        const urlParams = window._chatUrlParams;
        const characterId = urlParams.get('character');
        const userId = urlParams.get('userId');
        
        // ã€è¨­è¨ˆæ¤œè¨¼ã€‘back.html ã¨åŒã˜ãã€character ã¨ userId ã®ä¸¡æ–¹ã‚’ç¢ºèª
        if (!characterId || !userId) {
            console.error('[ãƒãƒ³ãƒ‰ãƒ©ãƒ¼] ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ï¼šcharacterã¾ãŸã¯userIdãŒä¸è¶³ã—ã¦ã„ã¾ã™', {
                characterId,
                userId
            });
            return;
        }
        
        if (characterId) {
            let attempts = 0;
            const maxAttempts = 50;
            while (!window.CharacterLoader && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (window.CharacterLoader) {
                try {
                    await CharacterLoader.loadHandler(characterId);
                    console.log('[ãƒãƒ³ãƒ‰ãƒ©ãƒ¼] ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:', characterId, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼:', userId);
                } catch (error) {
                    console.error('[CharacterLoader] ãƒãƒ³ãƒ‰ãƒ©ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            } else {
                console.error('[CharacterLoader] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: CharacterLoaderãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆè©¦è¡Œ: ' + attempts + 'å›ï¼‰');
            }
        }
    })();
    </script>
    
    <!-- iframeé€šä¿¡ -->
    <script>
    (function() {
        'use strict';
        let readyNotificationSent = false;
        
        function sendReadyNotification() {
            if (readyNotificationSent) return;
            if (!window.parent || window.parent === window) return;
            try {
                const urlParams = window._chatUrlParams;
                const character = urlParams.get('character') || 'unknown';
                window.parent.postMessage({
                    type: 'CHAT_IFRAME_READY',
                    character: character,
                    messageCount: 0,
                    timestamp: Date.now(),
                    ready: true
                }, '*');
                readyNotificationSent = true;
                console.log('[iframe] æº–å‚™å®Œäº†é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('[iframe] é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(sendReadyNotification, 100), { once: true });
        } else {
            setTimeout(sendReadyNotification, 100);
        }
        if (document.readyState !== 'complete') {
            window.addEventListener('load', () => setTimeout(sendReadyNotification, 100), { once: true });
        }
    })();
    </script>
    
    <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ– -->
    <script>
    (function() {
        'use strict';
        const urlParams = window._chatUrlParams;
        const isAdminMode = urlParams.has('admin') || urlParams.get('admin') === 'true' || urlParams.get('admin') === '1';
        if (isAdminMode) {
            document.body.classList.add('admin-mode');
            const analysisPanel = document.getElementById('adminAnalysisPanel');
            if (analysisPanel) analysisPanel.classList.remove('hidden');
            console.log('[admin] ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™');
        }
    })();
    </script>
    
    <!-- ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ -->
    <script src="../../js/chat-autoscroll.js" defer></script>
</body>
</html>

