<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é‘‘å®šå£«ãƒãƒ£ãƒƒãƒˆ</title>
    
    <!-- userIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å³åº§ã«bodyã«å±æ€§ã‚’è¿½åŠ  -->
    <script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        if (userId) {
            if (document.body) {
                document.body.setAttribute('data-user-id', userId);
            } else {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.setAttribute('data-user-id', userId);
                    }, { once: true });
                } else {
                    setTimeout(function() {
                        if (document.body) {
                            document.body.setAttribute('data-user-id', userId);
                        }
                    }, 0);
                }
            }
        }
    })();
    </script>
    
    <link rel="stylesheet" href="../../css/chat.css">
</head>
<body>
    <!-- å¾…æ©Ÿç”»é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <img id="loadingCharacterIcon" class="loading-character-icon" src="" alt="èª­ã¿è¾¼ã¿ä¸­" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">é‘‘å®šã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™...</div>
        <div class="loading-subtext" id="loadingSubtext">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</div>
    </div>
    
    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="mobile-header" id="mobileHeader">
        <div class="mobile-header-content">
            <a href="../main.html" class="mobile-header-back">â‰ª</a>
            <div class="mobile-header-title" id="mobileHeaderTitle">é‘‘å®šå£«</div>
        </div>
    </div>

    <main>
        <!-- å…¥å£ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="entry-form-container" id="entryFormContainer">
            <form class="entry-form" id="entryForm">
                <h2 class="entry-form-title">é‘‘å®šã‚’å§‹ã‚ã‚‹</h2>
                <div class="entry-form-error" id="entryFormError"></div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label">
                        ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ <span class="required">*</span>
                    </label>
                    <input type="text" class="entry-form-input" id="entryNickname" name="nickname" required maxlength="50" placeholder="é‘‘å®šã§ä½¿ç”¨ã™ã‚‹åå‰ã‚’å…¥åŠ›">
                </div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label">
                        ç”Ÿå¹´æœˆæ—¥<span class="required">*</span>
                    </label>
                    <div class="entry-form-row">
                        <div class="entry-form-group">
                            <input type="number" class="entry-form-input" id="entryBirthYear" name="birthYear" required min="1900" max="2100" placeholder="å¹´">
                        </div>
                        <div class="entry-form-group">
                            <input type="number" class="entry-form-input" id="entryBirthMonth" name="birthMonth" required min="1" max="12" placeholder="æœˆ">
                        </div>
                        <div class="entry-form-group">
                            <input type="number" class="entry-form-input" id="entryBirthDay" name="birthDay" required min="1" max="31" placeholder="æ—¥">
                        </div>
                    </div>
                </div>
                
                <div class="entry-form-group">
                    <label class="entry-form-label">æ€§åˆ¥</label>
                    <select class="entry-form-select" id="entryGender" name="gender">
                        <option value="">å›ç­”ã—ãªã„</option>
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
                
                <button type="submit" class="entry-form-submit" id="entryFormSubmit">é‘‘å®šã‚’å§‹ã‚ã‚‹</button>
            </form>
        </div>
        
        <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="chat-container entry-form-hidden" id="chatContainer">
            <!-- PCç‰ˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="character-header" id="characterHeader">
                <img id="characterHeaderImage" src="" alt="" class="character-header-image">
                <div class="character-header-name" id="characterHeaderName">é‘‘å®šå£«</div>
            </div>
            
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="navigation-links">
                <a href="../main.html">é‘‘å®šå¸«ä¸€è¦§ã«æˆ»ã‚‹</a>
            </div>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="user-status" id="userStatus">åˆ©ç”¨è€…æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="messages" id="messages"></div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <div class="input-row">
                    <textarea id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="1" maxlength="1000"></textarea>
                    <button id="sendButton" onclick="sendMessage()" title="é€ä¿¡">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: åˆ†æãƒ‘ãƒãƒ« -->
    <div class="admin-analysis-panel hidden" id="adminAnalysisPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; font-size: 18px; color: #f7f5ff; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px;">ä¼šè©±åˆ†æãƒ‘ãƒãƒ«</h3>
            <button id="adminRefreshBtn" style="padding: 6px 12px; font-size: 12px; min-width: auto; background: rgba(138, 43, 226, 0.3); border: 1px solid rgba(138, 43, 226, 0.5); border-radius: 6px; color: #f7f5ff; cursor: pointer;">ğŸ”„ æ›´æ–°</button>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ç¾åœ¨ã®çŠ¶æ…‹</h4>
            <div id="adminCurrentState" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±</h4>
            <div id="adminPhaseInfo" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <div class="analysis-section">
            <h4 style="margin: 0 0 10px; font-size: 14px; color: #c7cdff; font-weight: 600;">ä¼šè©±å±¥æ­´æ§‹é€ </h4>
            <div id="adminHistory" class="analysis-content"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>
        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®æ©Ÿèƒ½ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å´ã§å‹•çš„ã«ç”Ÿæˆ -->
        <div class="analysis-section" id="adminCharacterFeatures">
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰ã®æ©Ÿèƒ½ï¼ˆä¾‹ï¼šå®ˆè­·ç¥ã®å„€å¼å†ç™ºå‹•ãªã©ï¼‰ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å´ã§å‹•çš„ã«è¿½åŠ  -->
        </div>
    </div>

    <!-- å…¥å£ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã¯chat-engine.jsã«çµ±åˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯æœ€å°é™ã®å‡¦ç†ã®ã¿ -->
    <script>
    // å…¥å£ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã¯chat-engine.jsã§å‡¦ç†ã•ã‚Œã‚‹
    // åŸºæœ¬çš„ãªæ§‹é€ ã®ã¿ã‚’HTMLã«ä¿æŒ
    </script>
    
    <!-- å¾…æ©Ÿç”»é¢åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
    (function() {
        'use strict';
        const urlParams = new URLSearchParams(window.location.search);
        const character = urlParams.get('character');
        const characterInfo = {
            'kaede': { name: 'æ¥“', icon: '../../photo/kaede.png' },
            'yukino': { name: 'é›ªä¹ƒ', icon: '../../photo/yukino.png' },
            'sora': { name: 'ã‚½ãƒ©', icon: '../../photo/sora.png' },
            'kaon': { name: 'èŠ±éŸ³', icon: '../../photo/kaon.png' }
        };
        
        function customizeLoadingScreen() {
            if (character && characterInfo[character]) {
                const info = characterInfo[character];
                const loadingText = document.getElementById('loadingText');
                const loadingIcon = document.getElementById('loadingCharacterIcon');
                if (loadingText) loadingText.textContent = `${info.name}ãŒæº–å‚™ã‚’ã—ã¦ã„ã¾ã™...`;
                if (loadingIcon && info.icon) {
                    loadingIcon.src = info.icon;
                    loadingIcon.style.display = 'block';
                }
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', customizeLoadingScreen, { once: true });
        } else {
            customizeLoadingScreen();
        }
        
        window.hideLoadingScreen = function() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    if (loadingScreen.parentNode) {
                        loadingScreen.parentNode.removeChild(loadingScreen);
                    }
                }, 800);
            }
        };
    })();
    </script>
    
    <!-- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç† -->
    <script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        if (userId) {
            document.querySelectorAll('.navigation-links a[href="../main.html"]').forEach((link) => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('userId', userId);
                link.href = url.pathname + url.search;
            });
            document.querySelectorAll('.mobile-header-back[href="../main.html"]').forEach((link) => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('userId', userId);
                link.href = url.pathname + url.search;
            });
        }
    })();
    </script>
    
    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="../../js/auth-state.js" defer></script>
    <script src="../../js/character-features.js" defer></script>
    <script src="../../js/chat-engine.js" defer onload="window.chatEngineLoaded = true;"></script>
    <script src="../../js/character-registry.js" defer></script>
    <script src="../../js/character-loader.js" defer></script>
    
    <!-- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‹•çš„èª­ã¿è¾¼ã¿ -->
    <script>
    (async function() {
        'use strict';
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('character');
        if (characterId) {
            let attempts = 0;
            const maxAttempts = 50;
            while (!window.CharacterLoader && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (window.CharacterLoader) {
                await CharacterLoader.loadHandler(characterId);
            }
        }
    })();
    </script>
    
    <!-- iframeé€šä¿¡ -->
    <script>
    (function() {
        'use strict';
        function sendReadyNotification() {
            if (!window.parent || window.parent === window) return;
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const character = urlParams.get('character') || 'unknown';
                window.parent.postMessage({
                    type: 'CHAT_IFRAME_READY',
                    character: character,
                    messageCount: 0,
                    timestamp: Date.now(),
                    ready: true
                }, '*');
            } catch (error) {
                console.error('[iframe] é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(sendReadyNotification, 100));
        } else {
            setTimeout(sendReadyNotification, 100);
        }
        if (document.readyState !== 'complete') {
            window.addEventListener('load', () => setTimeout(sendReadyNotification, 100));
        } else {
            setTimeout(sendReadyNotification, 100);
        }
    })();
    </script>
    
    <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ– -->
    <script>
    (function() {
        'use strict';
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.has('admin') || urlParams.get('admin') === 'true' || urlParams.get('admin') === '1';
        if (isAdminMode) {
            document.body.classList.add('admin-mode');
            const analysisPanel = document.getElementById('adminAnalysisPanel');
            if (analysisPanel) analysisPanel.classList.remove('hidden');
        }
        // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®è©³ç´°ãªå‡¦ç†ã¯æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ä»»ã›ã‚‹
    })();
    </script>
    
    <!-- ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ -->
    <script src="../../js/chat-autoscroll.js" defer></script>
</body>
</html>

