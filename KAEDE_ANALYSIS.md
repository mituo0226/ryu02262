# Kaede.js 文字数制限問題の分析と解決策

## 問題の全体像

ウェルカムメッセージが途中で途切れる理由：

### 根本的な原因

1. **kaede.js のプロンプトが非常に複雑・長大**
   - 初回訪問フェーズ：105～299行目（約190行の長いプロンプト）
   - 通常鑑定フェーズ：420～750行目（約330行の複雑なプロンプト）
   - 合計：1168行で、ほぼすべてが詳細なシステムプロンプト

2. **トークン消費の構造**
   - システムプロンプト自体が2000トークン以上を消費
   - LLM生成時のmaxTokens設定：2000（kaede）
   - 実際の応答生成用トークン：トークン不足で途切れる

3. **ウェルカムメッセージ生成時の設定**
   - `generate-welcome.ts`：`maxTokens: 800`（楓用）
   - ただし、プロンプトが短縮版なため意外と機能している
   - 「短縮版」が実は150～200文字に限定されている

### なぜ笹岡雪乃（yukino.js）では問題がないのか？

```
✅ 笹岡雪乃：
   - ゲストユーザーとの関係を明確に分離
   - フェーズごとに異なるプロンプトを適用
   - 文字数制限が明記されている（150～250文字など）
   - [SUGGEST_TAROT]など、マーカーで処理を明確化

❌ 楓（kaede）：
   - ゲストユーザー対応があるが、プロンプトが複雑
   - ウェルカムメッセージはほぼ「簡潔版」（150～200字）だが、
     通常の返信時は「完全版」（最大600字以上）を使用
   - システムプロンプト自体が非常に長い
```

## 解決策

### オプション1：kaede-simplified.js に完全移行

**利点：**
- システムプロンプトを1/3以下に削減
- トークン消費を大幅削減
- ウェルカムメッセージの途切れ解決

**実装：**
```typescript
// character-system.js の import を変更
import { generateKaedePrompt } from './characters/kaede-simplified.js';
```

### オプション2：kaede.js を圧縮版に置き換え

既存のkaede.jsの後方互換性を保ちながら、プロンプトを大幅削減。

**改善点：**
1. 初回訪問フェーズ（105～299行）→ 短縮版（50行程度）
2. 通常鑑定フェーズ（420～750行）→ シンプル化（100行程度）
3. ゲストユーザーフェーズ（600～656行）→ yukino.js に合わせて改善

### オプション3：プロンプトをファイル分割

`kaede-full.js`（完全版・アーカイブ用）と`kaede.js`（実運用・シンプル版）に分ける

## 推奨する対応

**即時実装**: kaede-simplified.js を使用開始

**中期実装**: kaede.js 本体を大幅削減

理由：
- 文字数制限問題をすぐに解決
- 既存コード互換性は保持可能
- 将来的な拡張性も確保
