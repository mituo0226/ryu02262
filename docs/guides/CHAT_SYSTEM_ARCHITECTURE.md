# チャットシステム全体構造図と説明

## 目次
1. [システム全体構造](#システム全体構造)
2. [主要ファイルの役割](#主要ファイルの役割)
3. [初回訪問時と再訪問時の処理フロー](#初回訪問時と再訪問時の処理フロー)
4. [各キャラクターの初回訪問時と再訪問時の対応](#各キャラクターの初回訪問時と再訪問時の対応)

---

## システム全体構造

```
┌─────────────────────────────────────────────────────────────────┐
│                        フロントエンド層                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ chat-engine.js│  │  chat-ui.js  │  │  chat-api.js │         │
│  │              │  │              │  │              │         │
│  │ ・初期化処理  │  │ ・UI更新     │  │ ・API通信    │         │
│  │ ・メッセージ  │  │ ・レンダリング│  │ ・会話履歴   │         │
│  │   送信制御   │  │ ・メッセージ  │  │   取得       │         │
│  │ ・訪問判定   │  │   表示       │  │ ・メッセージ  │         │
│  │              │  │              │  │   送信       │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                  │                  │                  │
│         └──────────────────┼──────────────────┘                  │
│                            │                                     │
│                   ┌─────────▼─────────┐                          │
│                   │   chat-data.js    │                          │
│                   │                   │                          │
│                   │ ・状態管理        │                          │
│                   │ ・会話履歴管理    │                          │
│                   │ ・メッセージ生成  │                          │
│                   └─────────┬─────────┘                          │
│                             │                                     │
└─────────────────────────────┼─────────────────────────────────────┘
                              │
                              │ HTTP Request
                              │
┌─────────────────────────────▼─────────────────────────────────────┐
│                        バックエンド層                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              functions/api/consult.ts                    │   │
│  │                                                           │   │
│  │ ・リクエスト検証                                         │   │
│  │ ・ユーザー識別（userId優先）                             │   │
│  │ ・会話履歴取得（D1データベース）                         │   │
│  │ ・訪問パターン判定                                       │   │
│  │ ・システムプロンプト生成                                 │   │
│  │ ・LLM API呼び出し（DeepSeek → OpenAI）                  │   │
│  │ ・会話履歴保存                                           │   │
│  └───────────────┬─────────────────────────────────────────┘   │
│                  │                                                │
│  ┌───────────────▼───────────────┐                              │
│  │ visit-pattern-detector.js    │                              │
│  │                               │                              │
│  │ ・訪問パターン判定           │                              │
│  │   - first_visit              │                              │
│  │   - returning                │                              │
│  │   - continuing               │                              │
│  └───────────────┬───────────────┘                              │
│                  │                                                │
│  ┌───────────────▼───────────────┐                              │
│  │  character-system.js          │                              │
│  │                               │                              │
│  │ ・システムプロンプト生成       │                              │
│  │ ・キャラクター固有プロンプト   │                              │
│  └───────────────────────────────┘                              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │
┌─────────────────────────────▼─────────────────────────────────────┐
│                        データベース層                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────┐  ┌──────────────────┐                    │
│  │  users テーブル  │  │ conversations    │                    │
│  │                  │  │     テーブル     │                    │
│  │ ・ユーザー情報   │  │                  │                    │
│  │ ・守護神情報     │  │ ・会話履歴       │                    │
│  │ ・生年月日       │  │ ・メッセージ     │                    │
│  └──────────────────┘  └──────────────────┘                    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 主要ファイルの役割

### フロントエンド

#### `chat-engine.js`
**役割**: チャットシステムの中核制御エンジン

**主な機能**:
- ページ初期化処理（`initPage()`）
- 会話履歴の読み込みと表示
- 初回訪問時/再訪問時の判定とメッセージ表示
- メッセージ送信の制御（`sendMessage()`）
- キャラクター固有ハンドラーへの処理委譲

**重要な処理フロー**:
1. ページ読み込み時に`initPage()`が実行される
2. `ChatAPI.loadConversationHistory()`で会話履歴を取得
3. `historyData.hasHistory`で初回/再訪問を判定
4. 初回訪問時: `generateFirstTimeMessage()`でメッセージ生成
5. 再訪問時: `generateInitialMessage()`またはAPIから動的生成

#### `chat-ui.js`
**役割**: UI更新とレンダリング

**主な機能**:
- DOM要素の初期化
- メッセージの追加・表示（`addMessage()`）
- キャラクターヘッダーの更新
- ユーザーステータスの表示
- スクロール制御
- 守護神の儀式関連UI

#### `chat-api.js`
**役割**: バックエンドAPIとの通信

**主な機能**:
- 会話履歴取得（`loadConversationHistory()`）
  - `/api/conversation-history`を呼び出し
  - userIdを優先的に使用
- メッセージ送信（`sendMessage()`）
  - `/api/consult`を呼び出し
  - 会話履歴とユーザー情報を送信

#### `chat-data.js`
**役割**: データ管理と状態管理

**主な機能**:
- キャラクター情報の読み込み（`loadCharacterData()`）
- 会話履歴の管理（sessionStorage）
- メッセージカウント管理
- 初回メッセージ生成（`generateFirstTimeMessage()`）
- 再訪問メッセージ生成（`generateInitialMessage()`）
- テンプレート変数の置換（`replaceMessageTemplate()`）

### バックエンド

#### `functions/api/consult.ts`
**役割**: メッセージ送信APIエンドポイント

**主な処理フロー**:
1. リクエスト検証（メッセージ、キャラクターID）
2. ユーザー識別（userId優先、nickname+生年月日は後方互換性）
3. 会話履歴取得（D1データベース）
4. 訪問パターン判定（`detectVisitPattern()`）
5. システムプロンプト生成（`generateSystemPrompt()`）
6. LLM API呼び出し（DeepSeek → OpenAIフォールバック）
7. 会話履歴保存（2段階保存: ユーザーメッセージ → アシスタントメッセージ）

**重要な判定**:
- `hasPreviousConversation`: データベースに会話履歴があるか
- `visitPattern`: `first_visit` / `returning` / `continuing`

#### `functions/_lib/visit-pattern-detector.js`
**役割**: 訪問パターンの判定

**判定ロジック**:
```
データベースに履歴があるか？
├─ ない
│  ├─ 登録済みユーザー → `continuing` (継続セッション)
│  └─ 未登録ユーザー → `first_visit` (初回訪問)
└─ ある
   └─ `returning` (再訪問、履歴あり)
```

**返却データ**:
- `pattern`: 訪問パターン
- `conversationHistory`: 会話履歴
- `lastConversationSummary`: 前回会話の要約
- `sessionContext`: セッションコンテキスト

#### `functions/_lib/character-system.js`
**役割**: システムプロンプトの生成

**主な機能**:
- キャラクター固有プロンプトの生成
- 訪問パターンに応じたプロンプト調整
- 安全ガイドラインの追加
- 機能制約の追加

---

## 初回訪問時と再訪問時の処理フロー

### 初回訪問時の処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. ページ読み込み                                           │
│     chat.html が読み込まれる                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  2. chat-engine.js 初期化                                    │
│     ChatInit.initPage() が実行される                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 会話履歴取得                                             │
│     ChatAPI.loadConversationHistory(character)               │
│     → /api/conversation-history?userId=xxx&character=xxx     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 訪問パターン判定                                         │
│     historyData.hasHistory === false                         │
│     → 初回訪問として判定                                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 初回メッセージ生成                                       │
│     オプションA: APIから動的生成（推奨）                     │
│       ChatAPI.sendMessage('初めてお会いします', ...)         │
│                                                              │
│     オプションB: 定型文生成（フォールバック）               │
│       ChatData.generateFirstTimeMessage(character, ...)      │
│       → characters.json の firstTimeGuest を使用             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  6. メッセージ表示                                           │
│     ChatUI.addMessage('welcome', message, characterName)    │
└─────────────────────────────────────────────────────────────┘
```

### 再訪問時の処理フロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. ページ読み込み                                           │
│     chat.html が読み込まれる                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  2. chat-engine.js 初期化                                    │
│     ChatInit.initPage() が実行される                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 会話履歴取得                                             │
│     ChatAPI.loadConversationHistory(character)               │
│     → /api/conversation-history?userId=xxx&character=xxx     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 訪問パターン判定                                         │
│     historyData.hasHistory === true                          │
│     → 再訪問として判定                                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 会話履歴の表示                                           │
│     historyData.recentMessages を順次表示                    │
│     ChatUI.addMessage(type, content, sender)                │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 再訪問メッセージ生成                                     │
│     オプションA: APIから動的生成（推奨）                     │
│       ChatAPI.sendMessage(lastUserMessage, ...)              │
│                                                              │
│     オプションB: 定型文生成（フォールバック）               │
│       ChatData.generateInitialMessage(character, historyData)│
│       → characters.json の returning を使用                  │
│       → {nickname}, {lastDate}, {conversationContent} を置換│
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  7. メッセージ表示                                           │
│     ChatUI.addMessage('welcome', message, characterName)    │
└─────────────────────────────────────────────────────────────┘
```

### 継続セッション時の処理フロー（履歴なしの再訪問）

```
┌─────────────────────────────────────────────────────────────┐
│  1. ページ読み込み                                           │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 会話履歴取得                                             │
│     historyData.hasHistory === false                        │
│     かつ historyData.nickname が存在                        │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 継続セッションとして判定                                 │
│     visitPattern === 'continuing'                            │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 継続メッセージ生成                                       │
│     ChatAPI.sendMessage('前回の会話の続きです', ...)         │
│     → API側で「前回の会話の継続」として処理                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 各キャラクターの初回訪問時と再訪問時の対応

### 全キャラクター共通の処理

#### 初回訪問時
1. **判定条件**: `historyData.hasHistory === false` かつ `historyData.nickname` が存在しない
2. **メッセージ生成方法**:
   - **優先**: APIから動的生成（`ChatAPI.sendMessage('初めてお会いします', ...)`）
   - **フォールバック**: 定型文（`characters.json`の`firstTimeGuest`）

#### 再訪問時（履歴あり）
1. **判定条件**: `historyData.hasHistory === true`
2. **処理順序**:
   1. 会話履歴を画面に表示（`historyData.recentMessages`）
   2. 再訪問メッセージを生成
      - **優先**: APIから動的生成（最後のユーザーメッセージを使用）
      - **フォールバック**: 定型文（`characters.json`の`returning`）

#### 継続セッション（履歴なしの再訪問）
1. **判定条件**: `historyData.hasHistory === false` かつ `historyData.nickname` が存在
2. **メッセージ生成方法**:
   - APIから動的生成（`ChatAPI.sendMessage('前回の会話の続きです', ...)`）
   - API側で`visitPattern === 'continuing'`として処理

### キャラクター固有の処理

#### 楓（kaede）
**初回訪問時**:
- 守護神の儀式への同意ボタンを表示（ハンドラー側で処理）
- 守護神が未決定の場合: `firstTimeGuest`メッセージ
- 守護神が決定済みの場合: 守護神確認メッセージ（ハンドラー側で処理）

**再訪問時**:
- 守護神情報をシステムプロンプトに含める
- 前回の会話内容を参照したメッセージを生成

#### 笹岡雪乃（yukino）
**初回訪問時**:
- タロットカード機能の説明
- `firstTimeGuest`メッセージを表示

**再訪問時**:
- 前回のタロットカード結果を参照（該当する場合）
- `returning`メッセージを表示

#### 空（sora）
**初回訪問時**:
- 共感と論理のバランスを重視したメッセージ
- `firstTimeGuest`メッセージを表示

**再訪問時**:
- 前回の相談内容を踏まえたメッセージ
- `returning`メッセージを表示

#### 三崎花音（kaon）
**初回訪問時**:
- 訪問パターンに応じた動的プロンプト生成
- `visitPattern === 'first_visit'`として処理

**再訪問時**:
- 訪問パターンに応じた動的プロンプト生成
- `visitPattern === 'returning'`として処理
- 前回会話の要約（`lastConversationSummary`）をプロンプトに含める

---

## データフロー図

### メッセージ送信時のデータフロー

```
ユーザー入力
    │
    ▼
chat-engine.js (sendMessage)
    │
    ├─→ chat-ui.js (addMessage) → ユーザーメッセージを画面に表示
    │
    └─→ chat-api.js (sendMessage)
            │
            ├─→ HTTP POST /api/consult
            │       │
            │       ├─→ consult.ts
            │       │       │
            │       │       ├─→ ユーザー識別（userId）
            │       │       │
            │       │       ├─→ 会話履歴取得（D1）
            │       │       │
            │       │       ├─→ 訪問パターン判定
            │       │       │   (visit-pattern-detector.js)
            │       │       │
            │       │       ├─→ システムプロンプト生成
            │       │       │   (character-system.js)
            │       │       │
            │       │       ├─→ LLM API呼び出し
            │       │       │   (DeepSeek → OpenAI)
            │       │       │
            │       │       └─→ 会話履歴保存（D1）
            │       │
            │       └─→ JSON Response
            │               │
            │               └─→ chat-engine.js
            │                       │
            │                       └─→ chat-ui.js (addMessage)
            │                               │
            │                               └─→ アシスタントメッセージを画面に表示
```

### ページ初期化時のデータフロー

```
ページ読み込み
    │
    ▼
chat.html
    │
    ├─→ chat-engine.js 読み込み
    │       │
    │       └─→ ChatInit.initPage()
    │               │
    │               ├─→ ChatData.loadCharacterData()
    │               │       └─→ characters.json 読み込み
    │               │
    │               └─→ ChatAPI.loadConversationHistory()
    │                       │
    │                       └─→ HTTP GET /api/conversation-history
    │                               │
    │                               └─→ conversation-history.ts
    │                                       │
    │                                       ├─→ ユーザー情報取得（D1）
    │                                       │
    │                                       └─→ 会話履歴取得（D1）
    │                                               │
    │                                               └─→ JSON Response
    │                                                       │
    │                                                       └─→ chat-engine.js
    │                                                               │
    │                                                               ├─→ 会話履歴表示
    │                                                               │
    │                                                               └─→ 初回/再訪問メッセージ生成
```

---

## 重要な設計ポイント

### 1. データベースベースの判断
- すべてのユーザー情報と会話履歴はD1データベースで管理
- `userId`を優先的に使用（nickname+生年月日は後方互換性のため）
- sessionStorageは補助的な用途のみ

### 2. 訪問パターン判定の統一
- `visit-pattern-detector.js`で統一的な判定ロジック
- 3つのパターン: `first_visit`, `returning`, `continuing`
- 判定結果はシステムプロンプト生成に使用

### 3. 動的メッセージ生成の優先
- 初回訪問時・再訪問時ともに、APIから動的生成を優先
- 定型文はフォールバックとして使用
- LLMが文脈を理解した自然なメッセージを生成

### 4. キャラクター固有処理の分離
- キャラクター固有の処理はハンドラー（`character-handlers/`）に委譲
- `chat-engine.js`は汎用的な処理のみを担当
- スケーラビリティと保守性を向上

### 5. 2段階保存による会話履歴管理
- ユーザーメッセージ: 送信時に即座に保存
- アシスタントメッセージ: LLM応答後に保存
- 100件制限とアシスタントメッセージ10件制限を実装

---

## 関連ファイル一覧

### フロントエンド
- `public/js/chat-engine.js` - チャットエンジン
- `public/js/chat-ui.js` - UI更新
- `public/js/chat-api.js` - API通信
- `public/js/chat-data.js` - データ管理
- `public/pages/chat/chat.html` - チャットページ
- `public/data/characters.json` - キャラクター情報と定型文

### バックエンド
- `functions/api/consult.ts` - メッセージ送信API
- `functions/api/conversation-history.ts` - 会話履歴取得API
- `functions/_lib/visit-pattern-detector.js` - 訪問パターン判定
- `functions/_lib/character-system.js` - システムプロンプト生成
- `functions/_lib/character-loader.js` - キャラクターローダー

### キャラクター固有
- `public/js/character-handlers/*/handler.js` - 各キャラクターのハンドラー
- `functions/_lib/characters/*/index.js` - 各キャラクターのプロンプト生成
