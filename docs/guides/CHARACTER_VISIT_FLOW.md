# 各キャラクターの初回訪問時と再訪問時の対応フロー図

## 目次
1. [全キャラクター共通フロー](#全キャラクター共通フロー)
2. [楓（kaede）の対応フロー](#楓kaedeの対応フロー)
3. [笹岡雪乃（yukino）の対応フロー](#笹岡雪乃yukinoの対応フロー)
4. [空（sora）の対応フロー](#空soraの対応フロー)
5. [三崎花音（kaon）の対応フロー](#三崎花音kaonの対応フロー)

---

## 全キャラクター共通フロー

### 初回訪問時の判定と処理

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
│       かつ historyData.nickname が存在しない                │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン: first_visit     │
        └───────────────┬───────────────┘
                        │
        ┌───────────────▼───────────────┐
        │  メッセージ生成方法の選択       │
        └───────────────┬───────────────┘
                        │
        ┌───────────────▼───────────────┐
        │  優先: APIから動的生成          │
        │  ChatAPI.sendMessage(          │
        │    '初めてお会いします',        │
        │    character,                  │
        │    [], // 空の履歴            │
        │    {}                          │
        │  )                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  成功？                        │
        └───────┬───────────────┬───────┘
                │               │
             Yes│               │No
                │               │
                ▼               ▼
    ┌───────────────────┐  ┌───────────────────┐
    │ APIから取得した    │  │ 定型文生成         │
    │ メッセージを表示   │  │ ChatData.         │
    │                   │  │   generateFirst    │
    │                   │  │   TimeMessage()    │
    │                   │  │ → characters.json │
    │                   │  │   のfirstTimeGuest │
    └───────────────────┘  └─────────┬─────────┘
                                      │
                                      ▼
                            ┌───────────────────┐
                            │ 定型文を表示       │
                            └───────────────────┘
```

### 再訪問時の判定と処理（履歴あり）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === true                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン: returning       │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  会話履歴を画面に表示          │
        │  historyData.recentMessages    │
        │  を順次表示                    │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  最後のユーザーメッセージを抽出 │
        │  lastUserMessage =             │
        │    conversationHistory          │
        │      .filter(msg =>            │
        │        msg.role === 'user'     │
        │      ).slice(-1)[0]             │
        └───────────────┬───────────────┘
                        │
        ┌───────────────▼───────────────┐
        │  優先: APIから動的生成          │
        │  ChatAPI.sendMessage(          │
        │    lastUserMessage,            │
        │    character,                  │
        │    conversationHistory,        │
        │    {}                          │
        │  )                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  成功？                        │
        └───────┬───────────────┬───────┘
                │               │
             Yes│               │No
                │               │
                ▼               ▼
    ┌───────────────────┐  ┌───────────────────┐
    │ APIから取得した    │  │ 定型文生成         │
    │ メッセージを表示   │  │ ChatData.         │
    │                   │  │   generateInitial  │
    │                   │  │   Message()        │
    │                   │  │ → characters.json │
    │                   │  │   のreturning     │
    │                   │  │ → {nickname},     │
    │                   │  │    {lastDate},    │
    │                   │  │    {conversation  │
    │                   │  │     Content}を置換│
    └───────────────────┘  └─────────┬─────────┘
                                      │
                                      ▼
                            ┌───────────────────┐
                            │ 定型文を表示       │
                            └───────────────────┘
```

### 継続セッション時の判定と処理（履歴なしの再訪問）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
│       かつ historyData.nickname が存在                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン: continuing       │
        │  （同じセッション内の継続）     │
        └───────────────┬───────────────┘
                        │
        ┌───────────────▼───────────────┐
        │  APIから動的生成                │
        │  ChatAPI.sendMessage(          │
        │    '前回の会話の続きです',      │
        │    character,                  │
        │    [], // 空の履歴            │
        │    {}                          │
        │  )                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  API側で処理                    │
        │  visitPattern === 'continuing'  │
        │  としてシステムプロンプト生成   │
        │  → 「前回の会話の継続」として   │
        │     応答を生成                 │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  継続メッセージを表示           │
        └───────────────────────────────┘
```

---

## 楓（kaede）の対応フロー

### 初回訪問時

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
│       かつ historyData.nickname が存在しない                │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  守護神の状態を確認             │
        │  historyData.assignedDeity     │
        └───────┬───────────────┬───────┘
                │               │
           未決定│               │決定済み
                │               │
                ▼               ▼
    ┌───────────────────┐  ┌───────────────────┐
    │ 守護神の儀式への   │  │ 守護神確認メッセージ│
    │ 同意ボタンを表示   │  │ を表示             │
    │ (ハンドラー側)     │  │ (ハンドラー側)     │
    │                   │  │                   │
    │ → firstTimeGuest  │  │ → getGuardian     │
    │    メッセージ      │  │    Confirmation   │
    │                   │  │    Message()       │
    └───────────────────┘  └───────────────────┘
```

**特徴**:
- 守護神の儀式が重要な要素
- 守護神が未決定の場合、儀式への同意を促す
- 守護神が決定済みの場合、確認メッセージを表示

### 再訪問時（履歴あり）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === true                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  会話履歴を表示                │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  守護神情報をシステムプロンプト│
        │  に含める                      │
        │  options.guardian =            │
        │    historyData.assignedDeity   │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (前回の会話内容を参照)         │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  再訪問メッセージを表示         │
        └───────────────────────────────┘
```

**特徴**:
- 守護神情報を常にシステムプロンプトに含める
- 前回の会話内容を踏まえた自然なメッセージを生成

---

## 笹岡雪乃（yukino）の対応フロー

### 初回訪問時

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  タロットカード機能の説明       │
        │  (ハンドラー側で処理)           │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  初回メッセージ生成            │
        │  → firstTimeGuest メッセージ   │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  初回メッセージを表示           │
        └───────────────────────────────┘
```

**特徴**:
- タロットカード機能が主要な機能
- 初回訪問時にタロットカードの説明を含める

### 再訪問時（履歴あり）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === true                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  会話履歴を表示                │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  前回のタロットカード結果を    │
        │  参照（該当する場合）          │
        │  (ハンドラー側で処理)           │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (前回の相談内容を参照)         │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  再訪問メッセージを表示         │
        └───────────────────────────────┘
```

**特徴**:
- 前回のタロットカード結果を参照できる
- タロットカード関連のキーワード検出機能あり

---

## 空（sora）の対応フロー

### 初回訪問時

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  共感と論理のバランスを重視     │
        │  したメッセージ生成             │
        │  → firstTimeGuest メッセージ   │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  初回メッセージを表示           │
        └───────────────────────────────┘
```

**特徴**:
- 共感と論理のバランスを重視した応答
- シンプルな初回メッセージ

### 再訪問時（履歴あり）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === true                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  会話履歴を表示                │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (前回の相談内容を踏まえた      │
        │   共感的かつ論理的な応答)       │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  再訪問メッセージを表示         │
        └───────────────────────────────┘
```

**特徴**:
- 前回の相談内容を踏まえた応答
- 共感と論理のバランスを保つ

---

## 三崎花音（kaon）の対応フロー

### 初回訪問時

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン判定               │
        │  visitPattern === 'first_visit' │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  動的プロンプト生成             │
        │  generateKaonPrompt({          │
        │    visitPattern: 'first_visit', │
        │    conversationHistory: [],     │
        │    lastConversationSummary:    │
        │      null,                      │
        │    sessionContext: null         │
        │  })                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (初回訪問用のプロンプト)       │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  初回メッセージを表示           │
        └───────────────────────────────┘
```

**特徴**:
- 訪問パターンに応じた動的プロンプト生成
- 初回訪問時は特別なプロンプトを使用

### 再訪問時（履歴あり）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === true                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン判定               │
        │  visitPattern === 'returning'  │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  会話履歴を表示                │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  前回会話の要約生成             │
        │  lastConversationSummary =     │
        │    generateConversationSummary│
        │      (lastConversation,        │
        │       allHistory)              │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  動的プロンプト生成             │
        │  generateKaonPrompt({          │
        │    visitPattern: 'returning',  │
        │    conversationHistory: [...],  │
        │    lastConversationSummary:    │
        │      summary,                  │
        │    sessionContext: null        │
        │  })                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (前回会話の要約を含む          │
        │   プロンプトを使用)             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  再訪問メッセージを表示         │
        │  (前回の相談内容を参照)         │
        └───────────────────────────────┘
```

**特徴**:
- 訪問パターンに応じた動的プロンプト生成
- 前回会話の要約（`lastConversationSummary`）をプロンプトに含める
- より文脈を理解した応答が可能

### 継続セッション時（履歴なしの再訪問）

```
┌─────────────────────────────────────────────────────────────┐
│  判定: historyData.hasHistory === false                     │
│       かつ historyData.nickname が存在                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  訪問パターン判定               │
        │  visitPattern === 'continuing' │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  動的プロンプト生成             │
        │  generateKaonPrompt({          │
        │    visitPattern: 'continuing',  │
        │    conversationHistory: [],     │
        │    lastConversationSummary:    │
        │      null,                      │
        │    sessionContext:              │
        │      '前回の会話の継続です。    │
        │       同じセッション内での      │
        │       継続的な会話として        │
        │       応答してください。'       │
        │  })                             │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  APIから動的生成                │
        │  (継続セッション用のプロンプト) │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  継続メッセージを表示           │
        └───────────────────────────────┘
```

**特徴**:
- 継続セッション用の特別なプロンプトを使用
- `sessionContext`で「前回の会話の継続」であることを明示

---

## 訪問パターン判定の詳細

### visit-pattern-detector.js の判定ロジック

```
データベースから会話履歴を取得
    │
    ▼
履歴があるか？
    │
    ├─→ ない
    │   │
    │   ├─→ 登録済みユーザー？
    │   │   │
    │   │   ├─→ Yes → pattern: 'continuing'
    │   │   │        sessionContext: '前回の会話の継続です...'
    │   │   │
    │   │   └─→ No  → pattern: 'first_visit'
    │   │
    │   └─→ 未登録ユーザー → pattern: 'first_visit'
    │
    └─→ ある
        │
        └─→ pattern: 'returning'
             conversationHistory: [...]
             lastConversationSummary: '前回(日付)の相談: ...'
```

### 各パターンの特徴

| パターン | 条件 | プロンプトへの影響 |
|---------|------|-------------------|
| `first_visit` | 履歴なし + 未登録 | 初回訪問用のプロンプト |
| `returning` | 履歴あり | 前回会話を参照したプロンプト |
| `continuing` | 履歴なし + 登録済み | 継続セッション用のプロンプト |

---

## まとめ

### 全キャラクター共通
1. **初回訪問時**: APIから動的生成を優先、定型文はフォールバック
2. **再訪問時**: 会話履歴を表示後、APIから動的生成
3. **継続セッション**: 特別なプロンプトで「前回の会話の継続」として処理

### キャラクター固有の特徴
- **楓**: 守護神の儀式が重要な要素
- **笹岡雪乃**: タロットカード機能が主要
- **空**: 共感と論理のバランスを重視
- **三崎花音**: 訪問パターンに応じた動的プロンプト生成

### 設計のポイント
1. **統一的な判定ロジック**: `visit-pattern-detector.js`で全キャラクター共通
2. **動的メッセージ生成の優先**: LLMが文脈を理解した自然なメッセージ
3. **キャラクター固有処理の分離**: ハンドラーに委譲してスケーラビリティを確保
