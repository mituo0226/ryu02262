# 笹岡雪乃のタロット占い機能 - システム仕様書

## 概要
笹岡雪乃のチャット機能は、初回ゲストユーザーに対して必須の3枚タロット鑑定を行い、その後通常の相談とオプションの1枚タロット鑑定を提供する仕組みです。

---

## ファイル構成

### **1. フロントエンド**

#### `public/js/features/yukino-tarot.js`
- **役割**: タロット鑑定機能の完全な実装（3枚鑑定と1枚鑑定）
- **主な機能**:
  - 3枚のカード選択と表示（過去・現在・未来）
  - カードのめくり動作
  - AI解説のリクエスト（直接`/api/consult`を呼び出し）
  - まとめ鑑定の実行
  - 1枚のカード鑑定（通常会話後）
  - 入力欄の無効化/有効化
  - ローディングオーバーレイの表示
  - 完了後のメッセージ送信（定型文 + システムメッセージ）

**重要な関数**:
- `startTarotReading()`: 3枚のタロット鑑定を開始
- `startSingleCardReading()`: 1枚のタロット鑑定を開始
- `requestSingleCardExplanation()`: 1枚のカード解説をリクエスト
- `sendCompletionMessages()`: 3枚鑑定完了後の定型文とシステムメッセージを送信
- `showConsultationButton()`: 「雪乃に個別相談する」ボタンを表示
- `enableMessageInput()` / `disableMessageInput()`: 入力欄の制御

#### `public/js/chat-ui.js`
- **役割**: チャットUIの管理、メッセージ表示、初回ボタンの追加
- **主な機能**:
  - メッセージの追加と表示
  - 「タロット占い開始」ボタンの自動追加（初回メッセージ後）
  - 初回ボタン表示時に入力欄を無効化（NEW: 2025-12-22）
  - AIの「タロットカードを1枚引いてみましょう」フレーズを検出して1枚鑑定を開始

**重要なコード**:
```javascript
// 雪乃の初回メッセージの後に「タロット占い開始」ボタンを追加
if ((type === 'welcome' || type === 'character') && 
    ChatData.currentCharacter === 'yukino' && 
    text.includes('それではまず、過去のカードをめくってみましょう')) {
    
    // ボタンを作成
    // ...
    
    // 初回の3枚タロット鑑定が完了するまで、メッセージ入力欄を無効化
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    if (messageInput) {
        messageInput.disabled = true;
        messageInput.placeholder = '3枚のタロット鑑定を完了してから相談できます';
    }
    if (sendButton) {
        sendButton.disabled = true;
    }
}
```

#### `public/js/chat-init.js`
- **役割**: チャット機能の初期化、API呼び出し、メッセージ送信
- **主な機能**:
  - チャットの初期化
  - メッセージ送信処理
  - 初回メッセージの表示

#### `public/js/chat-data.js`
- **役割**: 会話履歴とメッセージカウントの管理
- **主な機能**:
  - 会話履歴の保存と読み込み
  - メッセージカウントの管理

---

### **2. バックエンド**

#### `functions/_lib/characters/yukino.js`
- **役割**: 笹岡雪乃のキャラクター設定とAIプロンプト生成
- **主な機能**:
  - ゲストユーザーのメッセージカウント（`msgCount`）に応じたプロンプト生成
  - タロット鑑定提案の条件制御
  - カード解説とまとめ鑑定の指示

**重要なロジック**:

##### **msgCount === 1 または msgCount === 2（初回・2通目）**
```javascript
【現在のフェーズ: 通常の相談（${msgCount}通目）】

【このフェーズで行うこと】：
1. ユーザーのメッセージを受け止め、優しく挨拶する
2. ユーザーの相談内容に対して、優しく丁寧に答える
3. タロット占い師としての視点から、アドバイスを提供する

【⚠️【絶対禁止】タロット鑑定を提案してはいけない場合】：
- ユーザーが相談内容として「迷っている」「困っている」「悩んでいる」を使っている場合は、**絶対にタロット鑑定を提案しない**
- 例：「今の彼氏が既婚者だということがわかりました。別れようかどうか迷っています。」
  → **タロット鑑定を提案してはいけない。通常の相談として答える。**

【タロット鑑定を提案してよい場合】：
- ユーザーが「タロット」「鑑定」「占い」などのキーワードを**明確に使って**鑑定を求めている場合のみ
- 例：「タロットで占ってほしい」「鑑定をお願いします」
```

##### **msgCount >= 3（まとめ鑑定後の通常の会話）**
```javascript
◆ まとめ鑑定後の通常の会話の場合：
1. ユーザーのメッセージに特別なマーカーが含まれていない場合、通常の相談として扱う
2. **タロット以外の悩みや質問にも、優しく丁寧に答える**

3. **⚠️【超重要】タロット鑑定を提案できる条件：**
   - ユーザーが**以下のキーワードをタロット鑑定を求める文脈で使った場合のみ**タロット鑑定を提案できる：
     - 「タロット」「鑑定」「占い」「迷っている」「困っている」「悩んでいる」
   
   - **【判断基準】：**
     - ユーザーが**タロット鑑定や占いを明確に求めている**場合のみ提案する
     - 「迷っている」「困っている」「悩んでいる」だけでは不十分。これらは相談内容として使われることが多い。
     - 「タロット」「鑑定」「占い」というキーワードと組み合わさっている場合、または「カードを引いて」「占って」など明確な依頼表現がある場合のみ提案可能

4. **新たにタロット鑑定を行う場合は、1枚のカードのみを引く：**
   - 1枚のカード鑑定を行う場合は、必ず「**タロットカードを1枚引いてみましょう**」というフレーズを使う
   - このフレーズがシステムのトリガーとなり、1枚のカード表示が開始される
```

#### `functions/api/consult.ts`
- **役割**: メインAPI - ユーザーのメッセージを受け取り、AIの応答を返す
- **主な機能**:
  - ユーザーメッセージの受信
  - キャラクター別のプロンプト生成
  - AIへのリクエスト
  - 応答の返却

---

## フロー詳細

### **1. 初回ゲストユーザーのフロー（3枚のタロット鑑定）**

1. **チャット画面を開く**
   - URL: `/pages/chat/chat?character=yukino`
   - `chat-init.js`が初期化を実行

2. **初回メッセージの表示**
   - `chat-init.js`がゲストユーザーを検出
   - `characters.json`から`firstTimeGuest`メッセージを取得
   - メッセージ: 「はじめまして、笹岡雪乃です...それではまず、過去のカードをめくってみましょう。」
   - `ChatUI.addMessage()`でメッセージを表示

3. **「タロット占い開始」ボタンの表示と入力欄の無効化（NEW: 2025-12-22）**
   - `chat-ui.js`がメッセージ内の「それではまず、過去のカードをめくってみましょう」を検出
   - 「タロット占い開始」ボタンを自動的に追加
   - **同時にメッセージ入力欄と送信ボタンを無効化**
   - プレースホルダー: 「3枚のタロット鑑定を完了してから相談できます」
   - **ユーザーはボタンをクリックするまで何もできない**

4. **ボタンクリック → 3枚のタロット鑑定開始**
   - `YukinoTarot.start()`を呼び出し
   - 入力欄を無効化（タロット鑑定中）
   - 3枚のカード（過去・現在・未来）をランダムに選択

5. **過去のカード**
   - 雪乃のメッセージ: 「それではまず過去のタロットから占いますね。カードを伏せておきますので、めくってください。」
   - カードの裏面を表示
   - ユーザーがカードをクリック → カードがめくれる
   - 「雪乃の解説」ボタンが表示
   - ボタンをクリック → AIに解説をリクエスト（マーカー: `[TAROT_EXPLANATION_TRIGGER:過去:カード名]`）
   - AIの解説を表示
   - 「次のカードの鑑定」ボタンを表示

6. **現在のカード**
   - 雪乃のメッセージ: 「それでは次に現在のカードをめくってみましょう。」
   - （過去のカードと同じ流れ）

7. **未来のカード**
   - 雪乃のメッセージ: 「それでは次に未来のカードをめくってみましょう。」
   - （過去のカードと同じ流れ）
   - 解説後、「雪乃のまとめ」ボタンを表示

8. **まとめ鑑定**
   - ボタンをクリック → AIにまとめをリクエスト（マーカー: `[TAROT_SUMMARY_TRIGGER:...]`）
   - 3枚のカードを統括した総合鑑定を表示
   - 最後に「何か質問があれば、お気軽にお聞かせくださいね」

9. **完了メッセージの送信**
   - 定型文: 「あなたの現在の運勢結果はここまでです。ここからは全く新しい鑑定を始めましょう」
   - システムメッセージ（非表示）: 「3枚のカードの鑑定は終わりました。これから先は新しい鑑定をゼロから始めてください」
   - **このシステムメッセージにより、AIは新しい文脈として認識する**

10. **「雪乃に個別相談する」ボタンの表示**
    - ボタンをクリック → 入力欄が有効化
    - 通常の会話モードに移行

---

### **2. 通常の会話（まとめ鑑定後）**

11. **通常の相談**
    - 例: 「恋愛のことで悩んでいます」
    - AIは通常の相談として答える
    - **タロット鑑定を提案しない**（「悩んでいます」だけでは提案しない）

12. **明確なタロット鑑定の依頼**
    - 例: 「タロット占いで恋愛運を占ってください」
    - AIが「タロットカードを1枚引いてみましょう」フレーズを使う
    - `chat-ui.js`がこのフレーズを検出
    - `YukinoTarot.startSingleCard()`を呼び出し

---

### **3. 1枚のタロット鑑定（通常会話後）**

13. **1枚のカード鑑定開始**
    - 入力欄を無効化
    - 1枚のカードをランダムに選択
    - 雪乃のメッセージ: 「それでは、カードを伏せておきますので、めくってください。」
    - カードの裏面を表示

14. **カードをめくる**
    - ユーザーがカードをクリック → カードがめくれる
    - 「雪乃の解説」ボタンが表示

15. **解説をリクエスト**
    - ボタンをクリック → AIに解説をリクエスト（マーカー: `[TAROT_SINGLE_CARD:カード名]`）
    - AIの解説を表示
    - 解説の最後: 「他にも気になることがあれば、どうぞ教えてくださいね」

16. **自動的に入力欄を有効化（NEW: 2025-12-22）**
    - **「雪乃に個別相談する」ボタンは表示しない**
    - 自動的に入力欄が有効化される
    - 会話の流れを中断しない

---

## 重要な設計決定

### **1. タロット鑑定提案の厳格化（2025-12-22）**
- **問題**: AIが「迷っている」「困っている」「悩んでいる」という言葉に反応してタロット鑑定を提案してしまう
- **解決**: プロンプトで明確に禁止
  - 相談内容として使われている場合は提案しない
  - 「タロット」「鑑定」「占い」と組み合わされている場合のみ提案可能

### **2. 1枚鑑定後のボタン表示を廃止（2025-12-22）**
- **問題**: 1枚のタロット鑑定後に「雪乃に個別相談する」ボタンが表示されるのは不自然
- **解決**: 1枚鑑定後は自動的に入力欄を有効化
  - 3枚鑑定: 初回の必須鑑定で明確な区切りがあるため、ボタン表示が適切
  - 1枚鑑定: 通常会話の流れの中にあるため、ボタンで会話を中断する必要がない

### **3. 初回入力欄の無効化（2025-12-22）**
- **問題**: 初回画面に「タロット占い開始」ボタンがあるのに、ユーザーがメッセージを送信できてしまう → AIが混乱
- **解決**: 初回ボタン表示時に入力欄を無効化
  - UIが明確: 初回ゲストユーザーは必ず3枚のタロット鑑定を受ける
  - AIの混乱を防止: ユーザーが文章で「タロット占い」を依頼することがなくなる
  - UXの改善: 「まずタロット鑑定を受けてから相談」という明確なフロー

---

## タロットカード一覧

### **大アルカナ（22枚）**
1. 愚者
2. 魔術師
3. 女教皇
4. 女帝
5. 皇帝
6. 教皇
7. 恋人
8. 戦車
9. 力
10. 隠者
11. 運命の輪
12. 正義
13. 吊るされた男
14. 死神
15. 節制
16. 悪魔
17. 塔
18. 星
19. 月
20. 太陽
21. 審判
22. 世界

---

## トラブルシューティング

### **問題1: AIが「タロット鑑定を提案してしまう」**
- **原因**: ユーザーのメッセージに「迷っている」「困っている」「悩んでいる」が含まれている
- **解決**: `yukino.js`のプロンプトで禁止されているか確認
- **確認方法**: ユーザーのメッセージに「タロット」「鑑定」「占い」が含まれているか確認

### **問題2: 「雪乃に個別相談する」ボタンが表示されない**
- **原因**: `showConsultationButton()`が呼び出されていない
- **解決**: 3枚鑑定の`requestSummary()`→`sendCompletionMessages()`→`showConsultationButton()`の順で呼び出されているか確認

### **問題3: 初回メッセージでメッセージを送信できてしまう**
- **原因**: `chat-ui.js`の入力欄無効化ロジックが実行されていない
- **解決**: コンソールログで`[chat-ui] 初回タロット鑑定ボタン表示 - 入力欄を無効化しました`が出力されているか確認

---

## 今後の拡張可能性

1. **カードの向き（正位置/逆位置）の実装**
2. **カード画像のアニメーション改善**
3. **タロット鑑定履歴の保存**
4. **特定のスプレッド（ケルト十字など）の追加**
5. **他のキャラクターへのタロット機能の展開**

---

**最終更新日**: 2025-12-22
**作成者**: AI Assistant (Cursor Sonnet 4.5)
