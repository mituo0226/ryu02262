# å¾…æ©Ÿç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„åŸå›  - ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ

**åˆ†ææ—¥**: 2026å¹´1æœˆ25æ—¥  
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•**: èŠ±éŸ³ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€ã‚’é€ä¿¡  
**ç¾è±¡**: å¾…æ©Ÿç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„

---

## ğŸ”´ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‹ã‚‰ç™ºè¦‹ã—ãŸå•é¡Œ

### ãƒ­ã‚°ã®æµã‚Œ

```
âœ… [ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ : ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™
âœ… [ä¸‰å´èŠ±éŸ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‰å‡¦ç†: ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™
âœ… [ä¸‰å´èŠ±éŸ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‰å‡¦ç†: ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™

âŒ ã“ã“ã§ãƒ­ã‚°ãŒé€”çµ¶ãˆã‚‹...

âŒ å¾…æ©Ÿç”»é¢ä½œæˆãƒ­ã‚°ãŒãªã„
âŒ APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ­ã‚°ãŒãªã„
âŒ APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ­ã‚°ãŒãªã„
```

### ğŸš¨ å•é¡Œã®ç‰¹å®š

**ãƒ­ã‚°ãŒé€”çµ¶ãˆã‚‹å ´æ‰€**: `chat-engine.js:2992-2999` ï¼ˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‡¦ç†å¾Œï¼‰

```javascript
// chat-engine.js:2992-2999
let handler = CharacterRegistry.get(character);
if (handler && typeof handler.beforeMessageSent === 'function') {
    const beforeResult = handler.beforeMessageSent(messageToSend);
    if (beforeResult && beforeResult.waitingMessageId) {
        waitingMessageId = beforeResult.waitingMessageId;
        console.log('[ChatEngine] ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰å¾…æ©Ÿç”»é¢IDã‚’å–å¾—:', waitingMessageId);
    }
}

// ã€ã“ã®è¡Œä»¥é™ã®ãƒ­ã‚°ãŒãªã„ã€‘
// chat-engine.js:3003
if (!waitingMessageId) {
    waitingMessageId = window.ChatUI.addMessage('loading', 'è¿”ä¿¡ãŒæ¥ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', null);
}
```

---

## ğŸ’¡ æ¨å®šåŸå› 

### åŸå› 1: **JavaScript ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹**
- `beforeMessageSent()` å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- ã¾ãŸã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‘¼ã³å‡ºã—å¾Œã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒãªã„ãŸã‚ã€å‡¦ç†ãŒåœæ­¢

### åŸå› 2: **ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‡¦ç†ãŒç„¡é™ãƒ«ãƒ¼ãƒ— ã¾ãŸã¯ éåŒæœŸå‡¦ç†ãŒæœªå®Œäº†**
- `beforeMessageSent()` ãŒ `await` ãªã—ã§ async é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹
- ã¾ãŸã¯ promise ãŒè§£æ±ºã•ã‚Œã¦ã„ãªã„

### åŸå› 3: **ä¾‹å¤–ãŒ catch ã•ã‚Œãšã«ç™ºç”Ÿ**
- try-catch ãƒ–ãƒ­ãƒƒã‚¯ãŒãªã„éƒ¨åˆ†ã§ã®ä¾‹å¤–
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„

---

## ğŸ”§ è§£æ±ºæ–¹æ³•

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ« â†’ ã‚³ãƒ³ã‚½ãƒ¼ãƒ« ã§å®Ÿè¡Œ

// 1. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹
window.CharacterRegistry.get('kaon')

// 2. beforeMessageSentãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹
window.CharacterRegistry.get('kaon')?.beforeMessageSent

// 3. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
window.CharacterRegistry.get('kaon')?.beforeMessageSent('ãƒ†ã‚¹ãƒˆ')
```

### ã‚¹ãƒ†ãƒƒãƒ—2: chat-engine.js ã«ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ 

**ä¿®æ­£ç®‡æ‰€**: `chat-engine.js:2992-3004`

```javascript
let handler = CharacterRegistry.get(character);
console.log('[ãƒ‡ãƒãƒƒã‚°] handlerå–å¾—:', handler); // â† ãƒ­ã‚°ã‚’è¿½åŠ 

if (handler && typeof handler.beforeMessageSent === 'function') {
    try {
        const beforeResult = handler.beforeMessageSent(messageToSend);
        console.log('[ãƒ‡ãƒãƒƒã‚°] beforeMessageSentçµæœ:', beforeResult); // â† ãƒ­ã‚°ã‚’è¿½åŠ 
        if (beforeResult && beforeResult.waitingMessageId) {
            waitingMessageId = beforeResult.waitingMessageId;
            console.log('[ChatEngine] ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰å¾…æ©Ÿç”»é¢IDã‚’å–å¾—:', waitingMessageId);
        }
    } catch (error) {
        console.error('[ãƒ‡ãƒãƒƒã‚°] beforeMessageSent ã§ã‚¨ãƒ©ãƒ¼:', error); // â† ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ
    }
}

// ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå¾…æ©Ÿç”»é¢ã‚’è¡¨ç¤ºã—ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
console.log('[ãƒ‡ãƒãƒƒã‚°] waitingMessageId:', waitingMessageId); // â† ãƒ­ã‚°ã‚’è¿½åŠ 
if (!waitingMessageId) {
    console.log('[ãƒ‡ãƒãƒƒã‚°] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¾…æ©Ÿç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™'); // â† ãƒ­ã‚°ã‚’è¿½åŠ 
    waitingMessageId = window.ChatUI.addMessage('loading', 'è¿”ä¿¡ãŒæ¥ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', null);
    console.log('[ãƒ‡ãƒãƒƒã‚°] å¾…æ©Ÿç”»é¢ä½œæˆå®Œäº†:', waitingMessageId); // â† ãƒ­ã‚°ã‚’è¿½åŠ 
}
```

---

## ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ­ã‚°ãŒé€”çµ¶ãˆã‚‹åŸå› ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

| ç¢ºèªé …ç›® | çŠ¶æ…‹ |
|---------|------|
| ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒ `beforeMessageSent()` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ | âœ… ç¢ºèªæ¸ˆã¿ |
| `beforeMessageSent()` ãŒ return ã—ã¦ã„ã‚‹ã‹ | â“ **ç¢ºèªãŒå¿…è¦** |
| `beforeMessageSent()` ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ | â“ **ç¢ºèªãŒå¿…è¦** |
| `window.ChatUI.addMessage()` ãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ | â“ **ç¢ºèªãŒå¿…è¦** |
| ãã®å¾Œã® APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ | â“ **ç¢ºèªãŒå¿…è¦** |

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç¢ºèª**
2. **ä¸Šè¨˜ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ chat-engine.js ã«è¿½åŠ **
3. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†åº¦é€ä¿¡ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèª**
4. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å ±å‘Š**

---

**ç¢ºèªçŠ¶æ³**: âš ï¸ **ã‚¨ãƒ©ãƒ¼åœ°ç‚¹ç‰¹å®šå®Œäº†** - ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‡¦ç†å¾Œã®ãƒ­ã‚°é€”çµ¶ãŒå•é¡Œã®æ ¹æœ¬åŸå› 

