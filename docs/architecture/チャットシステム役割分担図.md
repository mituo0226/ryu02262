# チャットシステム役割分担図

## システム全体のアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    チャット画面（chat.html）                      │
│                    guest-chat.html                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    【メインチャットロジック】                     │
│                    chat-init.js                                  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 初期化処理 (initPage)                                     │  │
│  │ ・キャラクター情報読み込み                                 │  │
│  │ ・ゲスト/登録ユーザー判定                                  │  │
│  │ ・会話履歴読み込み                                         │  │
│  │ ・各キャラクターハンドラーの初期化                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ メッセージ送信処理 (sendMessage)                          │  │
│  │ ・ユーザー入力受付                                         │  │
│  │ ・API呼び出し (ChatAPI.sendMessage)                       │  │
│  │ ・応答処理                                                 │  │
│  │ ・キャラクターハンドラーへの委譲                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              【共通ゲスト制限管理】                               │
│              guest-limit-manager.js                             │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ checkAndHandleGuestLimit(character, apiResponse)         │  │
│  │ ・10通到達チェック                                         │  │
│  │ ・キャラクターハンドラーの handleGuestLimit を呼び出し   │  │
│  │ ・共通処理（フォールバック）                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│            【キャラクター専用ハンドラー】                         │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ kaede-handler│  │yukino-handler│  │ sora-handler │        │
│  │              │  │              │  │              │        │
│  │・init()      │  │・init()      │  │・init()      │        │
│  │・handleGuest │  │・handleGuest │  │・handleGuest │        │
│  │  Limit()     │  │  Limit()     │  │  Limit()     │        │
│  │・handleRespo │  │・handleRespo │  │・handleRespo │        │
│  │  nse()       │  │  nse()       │  │  nse()       │        │
│  │・handlePost  │  │・handlePost  │  │・handlePost  │        │
│  │  Registration│  │  Registration│  │  Registration│        │
│  │・守護神の儀式│  │・タロット機能│  │・ダイナミック│        │
│  │  専用処理    │  │  専用処理    │  │  ソウル処理  │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                  │
│  ┌──────────────┐                                              │
│  │ kaon-handler │                                              │
│  │              │                                              │
│  │・init()      │                                              │
│  │・handleGuest │                                              │
│  │  Limit()     │                                              │
│  │・handleRespo │                                              │
│  │  nse()       │                                              │
│  │・handlePost  │                                              │
│  │  Registration│                                              │
│  └──────────────┘                                              │
└─────────────────────────────────────────────────────────────────┘
```

## ゲストモードからユーザー登録までのフロー

```
【ゲストモード開始】
         │
         ▼
┌────────────────────────────────────────┐
│ chat-init.js: initPage()               │
│ ・AuthState.isRegistered() = false     │
│ ・ゲスト履歴読み込み                    │
│ ・各ハンドラーの init() 呼び出し       │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 初回メッセージ表示                      │
│ ChatData.generateFirstTimeMessage()   │
│ （各キャラクターの firstTimeGuest）    │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【1-9通目】メッセージ送信               │
│ chat-init.js: sendMessage()            │
│ ・ユーザー入力 → ChatAPI.sendMessage() │
│ ・API応答受信                           │
│ ・キャラクターハンドラーの              │
│   handleResponse() 呼び出し（オプション）│
│ ・ゲスト履歴に追加                      │
│ ・メッセージカウント更新                │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【10通目到達】                          │
│ chat-init.js: sendMessage()            │
│  → GuestLimitManager                   │
│     .checkAndHandleGuestLimit()        │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ GuestLimitManager                      │
│ checkAndHandleGuestLimit()             │
│ ・guestCount >= 10 チェック             │
│ ・キャラクターハンドラー取得             │
│ ・handler.handleGuestLimit() 呼び出し  │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【キャラクター固有処理】                │
│                                         │
│ 楓 (KaedeHandler):                     │
│ ・守護神の儀式ボタン表示                │
│ ・acceptedGuardianRitual フラグ設定    │
│                                         │
│ 雪乃 (YukinoHandler):                  │
│ ・登録ボタン表示                        │
│ ・acceptedGuardianRitual フラグ設定    │
│                                         │
│ ソラ (SoraHandler):                    │
│ ・登録ボタン表示                        │
│ ・acceptedGuardianRitual フラグ設定    │
│                                         │
│ 薫音 (KaonHandler):                    │
│ ・登録ボタン表示                        │
│ ・acceptedGuardianRitual フラグ設定    │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ ChatUI.showRitualConsentButtons()      │
│ ・登録ボタン表示                        │
│ ・「はい」「いいえ」ボタン              │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ ユーザーが「はい」をクリック            │
│ handleRitualConsent(true)              │
│                                         │
│ 楓の場合:                              │
│ ・KaedeHandler.handleRitualConsent()   │
│ ・ゲスト履歴を保存                      │
│ ・登録画面へ遷移                        │
│                                         │
│ その他のキャラクター:                  │
│ ・登録画面へ遷移                        │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【ユーザー登録画面】                    │
│ register.html                          │
│ ・生年月日・ニックネーム入力            │
│ ・API: /api/auth/register              │
│ ・userToken 取得                        │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【登録完了】                            │
│ ・localStorage に userToken 保存        │
│ ・justRegistered フラグ設定             │
│ ・チャット画面へリダイレクト            │
│   (?justRegistered=true)               │
└────────────────────────────────────────┘
```

## ユーザー登録後のフロー

```
【登録ユーザーモード開始】
         │
         ▼
┌────────────────────────────────────────┐
│ chat-init.js: initPage()               │
│ ・AuthState.isRegistered() = true      │
│ ・justRegistered フラグチェック        │
│ ・会話履歴読み込み (ChatAPI.load...)   │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【登録完了処理】                        │
│                                         │
│ 楓 (KaedeHandler):                     │
│ ・handlePostRegistrationRitualStart() │
│ ・acceptedGuardianRitual チェック      │
│ ・守護神の儀式開始準備                  │
│ ・ゲスト履歴を pendingRitualGuestHistory│
│   に保存                                │
│                                         │
│ 雪乃 (YukinoHandler):                  │
│ ・handlePostRegistration()             │
│ ・ゲスト履歴フラグクリア                │
│ ・会話履歴表示                          │
│                                         │
│ ソラ (SoraHandler):                    │
│ ・handlePostRegistration()             │
│ ・ゲスト履歴フラグクリア                │
│ ・会話履歴表示                          │
│                                         │
│ 薫音 (KaonHandler):                    │
│ ・handlePostRegistration()             │
│ ・会話履歴表示                          │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【楓専用】守護神の儀式                  │
│ chat-init.js: startGuardianRitual()   │
│ ・guardian-ritual.html へ遷移          │
│ ・守護神決定                            │
│ ・儀式完了                              │
│ ・チャット画面へ戻る                    │
│                                         │
│ KaedeHandler:                          │
│ ・handleGuardianRitualCompletion()     │
│ ・定型文表示                            │
│ ・会話履歴クリア                        │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【通常の会話継続】                      │
│ chat-init.js: sendMessage()            │
│ ・登録ユーザーとして API 呼び出し       │
│ ・会話履歴は API から取得               │
│ ・キャラクターハンドラーの              │
│   handleResponse() 呼び出し（オプション）│
│ ・メッセージ表示                        │
└────────────────────────────────────────┘
```

## 各モジュールの役割分担

### chat-init.js（メインチャットロジック）
- **初期化**: ページ読み込み時の初期化処理
- **メッセージ送信**: ユーザー入力の処理とAPI呼び出し
- **応答処理**: API応答の受信と表示
- **共通処理**: 全キャラクター共通の処理
- **委譲**: キャラクター固有処理を各ハンドラーに委譲

### guest-limit-manager.js（共通ゲスト制限管理）
- **10通到達チェック**: ゲストメッセージ数が10通に達したかチェック
- **ハンドラー呼び出し**: 各キャラクターハンドラーの`handleGuestLimit()`を呼び出し
- **共通処理**: ハンドラーがない場合のフォールバック処理

### character-handlers/*（キャラクター専用ハンドラー）
各キャラクター固有の処理を担当：

#### 共通メソッド
- `init()`: 初期化処理
- `handleGuestLimit(guestCount, apiData)`: 10通到達時の処理
- `handleResponse(response, character)`: API応答後の処理
- `handlePostRegistration(historyData, guestHistory)`: 登録完了後の処理

#### キャラクター固有処理
- **楓 (kaede-handler.js)**:
  - 守護神の儀式の開始・完了処理
  - `handleGuardianRitualCompletion()`: 儀式完了後の定型文表示
  - `handlePostRegistrationRitualStart()`: 登録後の儀式開始準備

- **雪乃 (yukino-handler.js)**:
  - タロット機能の初期化
  - ゲストモード再訪問チェック

- **ソラ (sora-handler.js)**:
  - ダイナミック・ソウル・アプローチ（性別による動的モード切り替え）
  - ゲストモード再訪問チェック

- **薫音 (kaon-handler.js)**:
  - 将来の拡張用

### chat-data.js（データ管理）
- キャラクター情報の管理
- ゲスト履歴の管理
- メッセージカウントの管理

### chat-ui.js（UI管理）
- メッセージ表示
- 登録ボタン表示
- UI更新

### chat-api.js（API通信）
- API呼び出し
- エラーハンドリング

### auth-state.js（認証状態管理）
- ユーザー登録状態の管理
- ゲスト履歴の管理
- トークン管理

## データフロー

```
【ゲストモード】
sessionStorage:
  - guestConversationHistory_{character}: 会話履歴
  - guestMessageCount_{character}: メッセージカウント
  - acceptedGuardianRitual: 登録同意フラグ
  - pendingRitualGuestHistory: 楓の儀式用ゲスト履歴

【登録ユーザーモード】
localStorage:
  - userToken: 認証トークン
  - userNickname: ニックネーム
  - assignedDeity: 守護神（楓のみ）
  - birthYear/Month/Day: 生年月日

API (データベース):
  - 会話履歴
  - ユーザー情報
  - 守護神情報（楓のみ）
```

## 重要なポイント

1. **共通ロジックと個別ロジックの分離**
   - 共通処理: `chat-init.js` と `guest-limit-manager.js`
   - 個別処理: 各キャラクターハンドラー

2. **10通到達時の処理**
   - システム的に10通目に到達したとき、`GuestLimitManager`がチェック
   - 各キャラクターハンドラーの`handleGuestLimit()`に委譲
   - APIの`registrationSuggested`フラグに依存しない

3. **登録後の処理**
   - 各キャラクターハンドラーの`handlePostRegistration()`で処理
   - 楓は守護神の儀式を開始
   - その他のキャラクターは通常の会話履歴表示

4. **データの移行**
   - ゲスト履歴 → データベースへの移行
   - 楓の場合は儀式用に一時保存
