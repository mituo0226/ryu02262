# ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£åˆ†æã¨æ”¹å–„æ¡ˆ

## ğŸ”´ ç¾åœ¨ã®å•é¡Œç‚¹

### 1. chat-init.jsã«å¤šæ•°ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¤å®š

**å•é¡Œç®‡æ‰€**: 34ç®‡æ‰€ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸåˆ¤å®š

```javascript
// ä¾‹1: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‘¼ã³å‡ºã—ï¼ˆ1287-1295è¡Œç›®ï¼‰
if (character === 'yukino' && window.YukinoHandler) {
    handlerProcessed = await window.YukinoHandler.handleResponse(response, character);
}
else if (character === 'kaede' && window.KaedeHandler) {
    handlerProcessed = await window.KaedeHandler.handleResponse(response, character);
}
else if (character === 'sora' && window.SoraHandler) {
    handlerProcessed = await window.SoraHandler.handleResponse(response, character);
}
else if (character === 'kaon' && window.KaonHandler) {
    handlerProcessed = await window.KaonHandler.handleResponse(response, character);
}
// â† æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«ã€ã“ã“ã« else if ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

// ä¾‹2: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ºæœ‰å‡¦ç†ï¼ˆ1279è¡Œç›®ï¼‰
if (character === 'kaede' && window.KaedeRitualHandler) {
    window.KaedeRitualHandler.addRitualStartButtonToMessageIfNeeded(...);
}

// ä¾‹3: åˆæœŸåŒ–å‡¦ç†ï¼ˆ199-203è¡Œç›®ï¼‰
if (character === 'yukino' && window.YukinoHandler) {
    await window.YukinoHandler.init();
} else if (character === 'sora' && window.SoraHandler) {
    await window.SoraHandler.init();
} else if (character === 'kaon' && window.KaonHandler) {
    await window.KaonHandler.init();
}
```

**å½±éŸ¿**:
- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«ã€`chat-init.js`ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°ãŒå¢—ãˆã‚‹ã¨ã€if-elseãƒã‚§ãƒ¼ãƒ³ãŒé•·ããªã‚Šã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹
- ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‚¥å¤§åŒ–ã—ã€ä¿å®ˆæ€§ãŒä½ä¸‹

### 2. guest-limit-manager.jsã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

```javascript
getCharacterHandler(character) {
    const handlers = {
        'kaede': window.KaedeHandler,
        'yukino': window.YukinoHandler,
        'sora': window.SoraHandler,
        'kaon': window.KaonHandler
    };
    return handlers[character] || null;
}
```

**å½±éŸ¿**:
- æ–°ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«ã€ã“ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### 3. å‘½åè¦å‰‡ã¸ã®ä¾å­˜

ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€`window.{CharacterName}Handler`ã¨ã„ã†å‘½åè¦å‰‡ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚
- `window.KaedeHandler`
- `window.YukinoHandler`
- `window.SoraHandler`
- `window.KaonHandler`

**å•é¡Œ**:
- å‘½åè¦å‰‡ãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ï¼ˆKaedeHandler vs KaedeRitualHandlerï¼‰
- å‹•çš„ãªå–å¾—ãŒå›°é›£

## âœ… æ”¹å–„æ¡ˆ: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚·ã‚¹ãƒ†ãƒ 

### æ”¹å–„æ¡ˆ1: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®å°å…¥

```javascript
// character-handler-registry.jsï¼ˆæ–°è¦ä½œæˆï¼‰
const CharacterHandlerRegistry = {
    handlers: new Map(),
    
    /**
     * ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç™»éŒ²
     * @param {string} characterId - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
     * @param {Object} handler - ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    register(characterId, handler) {
        if (!handler || typeof handler !== 'object') {
            console.error(`[ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒª] ç„¡åŠ¹ãªãƒãƒ³ãƒ‰ãƒ©ãƒ¼: ${characterId}`);
            return false;
        }
        
        this.handlers.set(characterId, handler);
        console.log(`[ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒª] ç™»éŒ²å®Œäº†: ${characterId}`);
        return true;
    },
    
    /**
     * ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å–å¾—
     * @param {string} characterId - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
     * @returns {Object|null} ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    get(characterId) {
        return this.handlers.get(characterId) || null;
    },
    
    /**
     * ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
     * @param {string} characterId - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
     * @returns {boolean}
     */
    has(characterId) {
        return this.handlers.has(characterId);
    },
    
    /**
     * ã™ã¹ã¦ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å–å¾—
     * @returns {Array<Object>} ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®é…åˆ—
     */
    getAll() {
        return Array.from(this.handlers.values());
    }
};

window.CharacterHandlerRegistry = CharacterHandlerRegistry;
```

### æ”¹å–„æ¡ˆ2: å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®è‡ªå‹•ç™»éŒ²

```javascript
// character-handlers/kaede-handler.js
const KaedeHandler = {
    characterId: 'kaede',
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
};

// è‡ªå‹•ç™»éŒ²
if (window.CharacterHandlerRegistry) {
    window.CharacterHandlerRegistry.register('kaede', KaedeHandler);
}

window.KaedeHandler = KaedeHandler; // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
```

### æ”¹å–„æ¡ˆ3: chat-init.jsã®å‹•çš„å‘¼ã³å‡ºã—ã«å¤‰æ›´

```javascript
// æ”¹å–„å‰ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰
if (character === 'yukino' && window.YukinoHandler) {
    handlerProcessed = await window.YukinoHandler.handleResponse(response, character);
}
else if (character === 'kaede' && window.KaedeHandler) {
    handlerProcessed = await window.KaedeHandler.handleResponse(response, character);
}
// ... ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ ...

// æ”¹å–„å¾Œï¼ˆå‹•çš„å–å¾—ï¼‰
const handler = window.CharacterHandlerRegistry?.get(character);
if (handler && typeof handler.handleResponse === 'function') {
    handlerProcessed = await handler.handleResponse(response, character);
}
```

### æ”¹å–„æ¡ˆ4: guest-limit-manager.jsã®å‹•çš„å–å¾—ã«å¤‰æ›´

```javascript
getCharacterHandler(character) {
    // æ”¹å–„å‰ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰
    // const handlers = { 'kaede': window.KaedeHandler, ... };
    // return handlers[character] || null;
    
    // æ”¹å–„å¾Œï¼ˆå‹•çš„å–å¾—ï¼‰
    return window.CharacterHandlerRegistry?.get(character) || null;
}
```

## ğŸ“Š æ”¹å–„åŠ¹æœ

### æ”¹å–„å‰ï¼ˆç¾åœ¨ï¼‰
- **æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ æ™‚ã®ä¿®æ­£ç®‡æ‰€**: 
  - `chat-init.js`: ç´„10-15ç®‡æ‰€
  - `guest-limit-manager.js`: 1ç®‡æ‰€
  - **åˆè¨ˆ**: ç´„11-16ç®‡æ‰€

### æ”¹å–„å¾Œ
- **æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ æ™‚ã®ä¿®æ­£ç®‡æ‰€**: 
  - `character-handlers/{new-character}-handler.js`: 1ç®‡æ‰€ï¼ˆè‡ªå‹•ç™»éŒ²ã‚³ãƒ¼ãƒ‰è¿½åŠ ï¼‰
  - HTMLãƒ•ã‚¡ã‚¤ãƒ«: 1ç®‡æ‰€ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°è¿½åŠ ï¼‰
  - **åˆè¨ˆ**: 2ç®‡æ‰€ã®ã¿

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**æ”¹å–„å‰**:
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°ãŒå¢—ãˆã‚‹ã¨ã€if-elseãƒã‚§ãƒ¼ãƒ³ã®è©•ä¾¡å›æ•°ãŒå¢—åŠ 
- 10ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´åˆã€æœ€æ‚ª10å›ã®åˆ¤å®šãŒå¿…è¦

**æ”¹å–„å¾Œ**:
- Mapã«ã‚ˆã‚‹O(1)ã®å–å¾—
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°ã«é–¢ä¿‚ãªãã€å¸¸ã«1å›ã®å–å¾—ã§å®Œäº†

## ğŸš€ å®Ÿè£…æ‰‹é †

1. **character-handler-registry.jsã‚’ä½œæˆ**
2. **å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã«è‡ªå‹•ç™»éŒ²ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ **
3. **chat-init.jsã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸåˆ¤å®šã‚’å‹•çš„å–å¾—ã«ç½®ãæ›ãˆ**
4. **guest-limit-manager.jsã®getCharacterHandler()ã‚’å‹•çš„å–å¾—ã«å¤‰æ›´**
5. **HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«character-handler-registry.jsã‚’è¿½åŠ **

## âš ï¸ æ³¨æ„ç‚¹

- å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€æ—¢å­˜ã®`window.{CharacterName}Handler`ã‚‚ç¶­æŒ
- æ®µéšçš„ãªç§»è¡ŒãŒå¯èƒ½ï¼ˆä¸€éƒ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã ã‘æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ï¼‰
