# キャラクター切り替えの仕組み

## 現在の実装（ハードコード方式）

### 動作フロー

```
【ユーザーがURLを変更】
例: ?character=yukino → ?character=sora

         │
         ▼
┌────────────────────────────────────────┐
│ ChatData.getCharacterFromURL()         │
│ URLパラメータからキャラクターID取得     │
│ character = 'sora'                     │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ chat-init.js: sendMessage()            │
│ API応答受信後                           │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【ハードコードされた判定】              │
│                                         │
│ if (character === 'yukino' && ...) {  │
│     handler = window.YukinoHandler;    │
│ }                                      │
│ else if (character === 'kaede' && ...)│
│     handler = window.KaedeHandler;    │
│ }                                      │
│ else if (character === 'sora' && ...) │
│     handler = window.SoraHandler;     │  ← ここで取得
│ }                                      │
│ else if (character === 'kaon' && ...) │
│     handler = window.KaonHandler;     │
│ }                                      │
│                                         │
│ ⚠️ 問題: 新しいキャラクターを追加する   │
│    たびに、ここに else if を追加する   │
│    必要がある                           │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ handler.handleResponse(response)       │
│ SoraHandler の処理が実行される          │
└────────────────────────────────────────┘
```

### 問題点

1. **新規キャラクター追加時の修正箇所**
   - `chat-init.js`: 約10-15箇所に`else if`を追加
   - `guest-limit-manager.js`: 1箇所にマッピングを追加
   - **合計**: 約11-16箇所の修正が必要

2. **パフォーマンス**
   - キャラクター数が増えると、if-elseチェーンの評価回数が増加
   - 10キャラクターの場合、最悪10回の判定が必要

## 改善後の実装（動的取得方式）

### 動作フロー

```
【ユーザーがURLを変更】
例: ?character=yukino → ?character=sora

         │
         ▼
┌────────────────────────────────────────┐
│ ChatData.getCharacterFromURL()         │
│ URLパラメータからキャラクターID取得     │
│ character = 'sora'                     │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ chat-init.js: sendMessage()            │
│ API応答受信後                           │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ 【動的取得】                            │
│                                         │
│ const handler =                        │
│   CharacterHandlerRegistry.get(character);│
│                                         │
│ // character = 'sora' の場合            │
│ // → SoraHandler が自動的に取得される  │
│                                         │
│ ✅ メリット:                            │
│    - 新しいキャラクターを追加しても     │
│      chat-init.js の修正不要            │
│    - O(1)の高速取得（Map使用）          │
└────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────┐
│ handler.handleResponse(response)       │
│ SoraHandler の処理が実行される          │
└────────────────────────────────────────┘
```

### ハンドラーレジストリの仕組み

```javascript
// character-handler-registry.js
const CharacterHandlerRegistry = {
    handlers: new Map(),  // キャラクターID → ハンドラーのマッピング
    
    // ハンドラーを登録（各ハンドラーファイルで自動実行）
    register(characterId, handler) {
        this.handlers.set(characterId, handler);
    },
    
    // ハンドラーを取得（動的）
    get(characterId) {
        return this.handlers.get(characterId) || null;
    }
};
```

### 各ハンドラーファイルでの自動登録

```javascript
// character-handlers/sora-handler.js
const SoraHandler = {
    characterId: 'sora',
    // ... ハンドラーの実装 ...
};

// 自動登録（ファイル読み込み時に実行）
if (window.CharacterHandlerRegistry) {
    window.CharacterHandlerRegistry.register('sora', SoraHandler);
}

// 後方互換性のため、グローバルにも公開
window.SoraHandler = SoraHandler;
```

## キャラクター切り替えの具体例

### シナリオ: ユーザーが雪乃からソラに切り替え

```
【ステップ1】URL変更
?character=yukino → ?character=sora

【ステップ2】ページ読み込み
chat-init.js: initPage()
  → ChatData.getCharacterFromURL() 
  → character = 'sora'

【ステップ3】ハンドラー取得（改善後）
const handler = CharacterHandlerRegistry.get('sora');
// → SoraHandler が取得される

【ステップ4】初期化
handler.init();
// → SoraHandler.init() が実行される
// → ソラ専用の初期化処理が実行

【ステップ5】メッセージ送信時
handler.handleResponse(response, 'sora');
// → SoraHandler.handleResponse() が実行される
// → ソラ専用の応答処理が実行

【ステップ6】10通到達時
GuestLimitManager.checkAndHandleGuestLimit('sora', response)
  → CharacterHandlerRegistry.get('sora')
  → handler.handleGuestLimit(guestCount, apiData)
  → SoraHandler.handleGuestLimit() が実行される
  → ソラ専用の登録ボタン表示処理が実行
```

## 改善効果

### 新規キャラクター追加時の作業

**改善前（現在）**:
1. `character-handlers/{new}-handler.js` を作成
2. `chat-init.js` の約10-15箇所に `else if` を追加
3. `guest-limit-manager.js` のマッピングに追加
4. HTMLファイルにスクリプトタグを追加
5. **合計**: 約13-18箇所の修正

**改善後**:
1. `character-handlers/{new}-handler.js` を作成（自動登録コードを含む）
2. HTMLファイルにスクリプトタグを追加
3. **合計**: 2箇所の修正のみ

### パフォーマンス比較

| キャラクター数 | 改善前（if-else） | 改善後（Map） |
|--------------|-----------------|-------------|
| 4キャラクター  | 最悪4回の判定    | 1回の取得    |
| 10キャラクター | 最悪10回の判定   | 1回の取得    |
| 20キャラクター | 最悪20回の判定   | 1回の取得    |

## まとめ

**はい、その通りです！**

キャラクター（鑑定士）が切り替わると：
1. URLパラメータからキャラクターIDを取得
2. **ハンドラーレジストリから自動的にそのキャラクターのハンドラーを取得**
3. ハンドラーのメソッド（`init()`, `handleResponse()`, `handleGuestLimit()`など）を呼び出し
4. **そのキャラクター専用の処理が自動的に実行される**

改善後は、新しいキャラクターを追加しても、メインファイル（`chat-init.js`）の修正は不要になり、**スケーラブルな設計**になります。
