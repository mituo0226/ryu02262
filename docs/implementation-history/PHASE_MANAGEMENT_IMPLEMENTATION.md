# ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã®å®Ÿè£…çŠ¶æ³ã¨æ”¹å–„ç‚¹

## ğŸ“Š ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³

### âœ… å®Ÿè£…æ¸ˆã¿

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆAPIï¼‰ã§ã®ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†**
   - `functions/lib/character-system.ts`ã§ãƒ•ã‚§ãƒ¼ã‚ºã«åŸºã¥ããƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
   - `functions/api/consult.ts`ã§`userMessageCount`ã‚’å—ã‘å–ã‚Šã€`generateSystemPrompt`ã«æ¸¡ã—ã¦ã„ã‚‹
   - æ¥“ï¼ˆkaedeï¼‰ã®å ´åˆã®ã¿ã€ãƒ•ã‚§ãƒ¼ã‚º1-4ã®ç®¡ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

2. **ç®¡ç†ç”»é¢ã§ã®ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º**
   - `public/pages/admin/dashboard.html`ã§`calculatePhase`é–¢æ•°ã‚’å®šç¾©
   - åˆ†æãƒ‘ãƒãƒ«ã«ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤º

### âŒ æœªå®Ÿè£…ãƒ»å•é¡Œç‚¹

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰APIã¸ã®ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±é€ä¿¡**
   - `public/js/chat-init.js`ã®`sendMessage()`ã§`ChatAPI.sendMessage()`ã‚’å‘¼ã¶éš›ã€`userMessageCount`ã‚’é€ä¿¡ã—ã¦ã„ãªã„
   - `public/js/chat-api.js`ã®`sendMessage()`ãƒ¡ã‚½ãƒƒãƒ‰ã§`guestMetadata.messageCount`ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ãŒã€ã“ã‚ŒãŒæ­£ã—ãAPIã«æ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªãŒå¿…è¦

2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è©³ç´°ã§ã®ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±è¡¨ç¤º**
   - ç®¡ç†ç”»é¢ã®ã€Œä¼šè©±å±¥æ­´æ§‹é€ ã€ã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã®ã¿è¡¨ç¤º
   - å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„

3. **å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œ**
   - ç¾åœ¨ã€æ¥“ï¼ˆkaedeï¼‰ã®ã¿ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
   - ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆé›ªä¹ƒã€èŠ±éŸ³ã€ã‚½ãƒ©ï¼‰ã«ã‚‚ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ãŒå¿…è¦

## ğŸ”§ å®Ÿè£…ã™ã¹ãæ”¹å–„ç‚¹

### 1. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’ç¢ºå®Ÿã«é€ä¿¡

**ãƒ•ã‚¡ã‚¤ãƒ«**: `public/js/chat-init.js`

```javascript
// ç¾åœ¨ï¼ˆå•é¡Œã‚ã‚Šï¼‰
const response = await ChatAPI.sendMessage(
    messageToSend,
    character,
    conversationHistory
);

// æ”¹å–„å¾Œ
const isGuest = !AuthState.isRegistered();
const messageCount = isGuest 
    ? ChatData.getGuestMessageCount(character)
    : conversationHistory.filter(msg => msg.role === 'user').length;

const response = await ChatAPI.sendMessage(
    messageToSend,
    character,
    conversationHistory,
    {
        guestMetadata: {
            messageCount: messageCount
        }
    }
);
```

### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è©³ç´°ã«ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤º

**ãƒ•ã‚¡ã‚¤ãƒ«**: `public/pages/admin/dashboard.html`

ä¼šè©±å±¥æ­´æ§‹é€ ã®è¡¨ç¤ºéƒ¨åˆ†ã‚’æ‹¡å¼µã—ã€å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

### 3. å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/lib/character-system.ts`

ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆé›ªä¹ƒã€èŠ±éŸ³ã€ã‚½ãƒ©ï¼‰ã«ã‚‚ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã€‚

## ğŸ“ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `chat-init.js`ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«`userMessageCount`ã‚’ç¢ºå®Ÿã«é€ä¿¡
- [ ] `chat-api.js`ã§`guestMetadata.messageCount`ã‚’æ­£ã—ãAPIã«é€ä¿¡
- [ ] ç®¡ç†ç”»é¢ã®ä¼šè©±å±¥æ­´ã«ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã‚’è¡¨ç¤º
- [ ] å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã‚’å®Ÿè£…
- [ ] ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ãŒAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

