# 会話履歴管理ポリシー

## 概要

ユーザーとキャラクターの関係性を長期的に構築・維持するため、会話履歴は基本的に**永続保持**されます。ただし、ストレージ容量を適切に管理するため、以下のルールに従います。

---

## 📋 保持ルール

### 1. 基本原則
- **保持期間**: 無制限（基本的に永続保持）
- **容量制限**: ユーザー × キャラクター単位で**最大100メッセージ**
- **削除方式**: 古い順に自動削除（FIFO: First In, First Out）

### 2. 容量管理

#### 自動削除メカニズム

```
【ユーザーA × 三崎花音の履歴】

状態: 95件のメッセージ
    ↓
新しいメッセージが到着
    ↓
状態: 96件のメッセージ（許容範囲内）
    ↓
新しいメッセージが到着 ×5回
    ↓
状態: 101件のメッセージ（超過）
    ↓
【自動削除実行】古い順に1件削除
    ↓
状態: 100件のメッセージ（復帰）
```

### 3. キャラクター別の特性

各キャラクターとの関係性の深さに応じた保持方針：

| キャラクター | 最大保持 | 理由 | 備考 |
|-----------|--------|------|-----|
| 楓 | 100件 | 守護神儀式など重要な関係構築 | 重要な決定が含まれる |
| 笹岡雪乃 | 100件 | 恋愛相談など継続的サポート | 長期的な心理サポート |
| 空 | 100件 | 夢・目標の相談 | キャリア支援 |
| 三崎花音 | 100件 | 占いを通じた人生相談 | 最も個人的な相談 |

**今後の拡張**: 必要に応じてキャラクター別に容量を調整可能

---

## 🛠️ 手動削除

### 管理画面での削除方法

1. **ユーザー検索** → ニックネームをクリック
2. **会話履歴セクション** → キャラクターをフィルター
3. **メッセージにチェック** → 複数選択可能
4. **「全選択」** → グループ内のすべてを選択
5. **「削除実行」** → 確認ダイアログ後に削除

### 削除のユースケース

- ユーザーが個人情報を削除したい場合
- キャラクター設定を大幅変更した後、古い応答パターンの影響を排除したい場合
- ユーザーが「この会話を忘れてほしい」と希望した場合

---

## 🔍 LLMへの履歴送信

### 重要な区別

```
【データベース】
└─ 100件までを保持（自動管理）

【LLMへの送信】
└─ 最新10～20件のみ（プロンプトで指定）
```

**理由**: 
- LLMのコンテキストウィンドウ制限
- 古い履歴はサマリー化して対応
- 過去パターンの重複を防止

---

## 📊 実装詳細

### consult.ts の処理フロー

```javascript
1. ユーザーのメッセージ受信
   ↓
2. getConversationHistory() 実行
   ├─ キャッシュから取得試行
   ├─ ミス時はDBから最新100件取得
   ├─ 容量超過チェック（100件以上？）
   ├─ YES: 古い順に削除実行
   └─ LLMに最新10～20件を送信
   ↓
3. LLMが応答
   ↓
4. 応答をDBに保存
```

### API エンドポイント

#### DELETE /api/admin/conversations
複数のメッセージを手動削除

```json
{
  "conversationIds": [123, 124, 125]
}
```

---

## ⚠️ 設計上の注意点

### 過去パターンの影響

```
【古い履歴が多い場合の問題】

❌ キャラクター設定を修正しても
　　→ 古い履歴のパターンを優先される可能性

【対策】
✅ プロンプトに「過去パターン無効化」の指示を追加
✅ 管理画面から古い履歴を削除可能
✅ 容量制限で最古のパターンは自動排除
```

---

## 📝 今後の改善案

### 優先度の高い改善

1. **会話タイプ別の保持**: 深刻な相談（悩み）vs 軽い雑談で保持期間を分ける
2. **ユーザー主導の削除**: ユーザーが「この会話を忘れて」とリクエスト可能にする
3. **サマリー機能**: 100件超過時に古い会話を要約して保持

### 将来的な拡張

- タグ機能（「重要」「個人」など）による選別削除
- キャラクター間の履歴共有設定
- 定期的な履歴レビュー機能

---

## 📞 関連ドキュメント

- [管理画面の使い方](./ADMIN_DASHBOARD_GUIDE.md)
- [キャラクター設定ガイド](./CHARACTER_SETTINGS.md)
- [LLMプロンプト最適化](./PROMPT_OPTIMIZATION.md)
