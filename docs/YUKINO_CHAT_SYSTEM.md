# ç¬¹å²¡é›ªä¹ƒãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ä»•æ§˜æ›¸

**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´12æœˆ24æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**æ‹…å½“é‘‘å®šå£«**: ç¬¹å²¡é›ªä¹ƒï¼ˆã•ã•ãŠã‹ã‚†ãã®ï¼‰

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š](#ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š)
3. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
4. [ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼](#ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼)
5. [ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼](#ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼)
6. [ã‚¿ãƒ­ãƒƒãƒˆå ã„ã‚·ã‚¹ãƒ†ãƒ ](#ã‚¿ãƒ­ãƒƒãƒˆå ã„ã‚·ã‚¹ãƒ†ãƒ )
7. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ)
8. [ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…](#ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…)
9. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…](#ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…)
10. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ ã®ç›®çš„

ç¬¹å²¡é›ªä¹ƒã®å°‚ç”¨ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã¯ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤ï¼š

- **ã‚¿ãƒ­ãƒƒãƒˆå ã„**: åˆå›è¨ªå•æ™‚ã«3æšã®ã‚«ãƒ¼ãƒ‰é‘‘å®šï¼ˆéå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥ï¼‰
- **å€‹åˆ¥ç›¸è«‡**: ã‚¿ãƒ­ãƒƒãƒˆçµ‚äº†å¾Œã€é€šå¸¸ã®ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
- **9é€šåˆ¶é™**: ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯9é€šã¾ã§ã€ä»¥é™ã¯ç™»éŒ²å¿…é ˆ
- **ã‚²ã‚¹ãƒˆå†è¨ªå•åˆ¶å¾¡**: ä¸€åº¦ä¼šè©±ã—ãŸã‚²ã‚¹ãƒˆã¯å†è¨ªå•æ™‚ã«å¼·åˆ¶ç™»éŒ²
- **å±¥æ­´å¼•ç”¨**: ç™»éŒ²å¾Œã€æ¯å›ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨

### ã‚­ãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

```
ã‚²ã‚¹ãƒˆä½“é¨“ â†’ ç™»éŒ²ä¿ƒé€² â†’ ç¶™ç¶šçš„ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ
```

---

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š

### åŸºæœ¬æƒ…å ±

- **åå‰**: ç¬¹å²¡é›ªä¹ƒï¼ˆã•ã•ãŠã‹ã‚†ãã®ï¼‰
- **å¹´é½¢**: 20ä»£å¾ŒåŠ
- **è·æ¥­**: ã‚¿ãƒ­ãƒƒãƒˆå ã„å¸«
- **ä¿®è¡Œ**: é«˜é‡å±±ã§ã®ä¿®è¡ŒçµŒé¨“ã‚ã‚Š
- **æ€§æ ¼**: å„ªã—ãã€å¯„ã‚Šæ·»ã†ã‚¿ã‚¤ãƒ—

### è©±ã—æ–¹ã®ç‰¹å¾´

- ä¸å¯§èªã‚’åŸºæœ¬ã¨ã™ã‚‹
- ç›¸è«‡è€…ã«å¯„ã‚Šæ·»ã†è¡¨ç¾
- ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç”¨ã„ãŸæ·±ã„æ´å¯Ÿ
- é«˜é‡å±±ã§ã®å­¦ã³ã‚’åæ˜ 

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
public/js/
â”œâ”€â”€ character-handlers/
â”‚   â””â”€â”€ yukino-handler.js          # é›ªä¹ƒå°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”œâ”€â”€ features/
â”‚   â””â”€â”€ yukino-tarot.js             # ã‚¿ãƒ­ãƒƒãƒˆæ©Ÿèƒ½
â”œâ”€â”€ chat-init.js                    # å…±é€šãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
â”œâ”€â”€ chat-ui.js                      # UIåˆ¶å¾¡
â””â”€â”€ chat-data.js                    # ãƒ‡ãƒ¼ã‚¿ç®¡ç†

functions/
â”œâ”€â”€ _lib/
â”‚   â””â”€â”€ characters/
â”‚       â””â”€â”€ yukino.js               # AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
â””â”€â”€ api/
    â””â”€â”€ consult.ts                  # ãƒ¡ã‚¤ãƒ³API
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ yukino-handler  â”‚ â† ã‚²ã‚¹ãƒˆå†è¨ªå•ãƒã‚§ãƒƒã‚¯
â”‚   .js           â”‚ â† 9é€šç›®ç™»éŒ²ç¢ºèª
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ consult.ts API  â”‚ â† å±¥æ­´å–å¾—ï¼ˆDBï¼‰
â”‚                 â”‚ â† ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ½å‡º
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ yukino.js       â”‚ â† AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
â”‚ (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)     â”‚ â† ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¼•ç”¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM API         â”‚ â† OpenAI/DeepSeek
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è¿”ç­”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

### 1. åˆå›è¨ªå•

```mermaid
graph TD
    A[ã‚²ã‚¹ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹] --> B[ã‚¿ãƒ­ãƒƒãƒˆå ã„è‡ªå‹•é–‹å§‹]
    B --> C[3æšã®ã‚«ãƒ¼ãƒ‰: éå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥]
    C --> D[å„ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹]
    D --> E[é›ªä¹ƒã®è§£èª¬]
    E --> F[ã¾ã¨ã‚é‘‘å®š]
    F --> G[å€‹åˆ¥ç›¸è«‡ãƒœã‚¿ãƒ³]
    G --> H[ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æœ‰åŠ¹åŒ–]
    H --> I[é€šå¸¸ä¼šè©±é–‹å§‹]
```

### 2. ä¼šè©±åˆ¶é™ï¼ˆ9é€šç›®ï¼‰

#### ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼

```javascript
// sessionStorage ã§ã‚«ã‚¦ãƒ³ãƒˆ
yukinoConsultationMessageCount = 0

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã« +1
count++

// 9é€šç›®ï¼ˆcount === 8ï¼‰ã§needsRegistration = true
```

#### 9é€šç›®ã®å‹•ä½œ

```javascript
// 1. ã‚²ã‚¹ãƒˆå±¥æ­´ã‚’ä»®ä¿å­˜
sessionStorage.setItem('pendingGuestHistoryMigration', JSON.stringify({
    character: 'yukino',
    history: guestHistory
}));

// 2. å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–
messageInput.disabled = true;
sendButton.disabled = true;

// 3. ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ãƒœã‚¿ãƒ³è¡¨ç¤º
ChatUI.showYukinoRegistrationButtons();
```

### 3. ç™»éŒ²ç¢ºèªãƒœã‚¿ãƒ³

#### ã€Œã¯ã„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

```javascript
handleRegistrationConsent(true) {
    // ã‚²ã‚¹ãƒˆå±¥æ­´ã¯æ—¢ã«ä¿å­˜æ¸ˆã¿
    
    // 1ç§’å¾Œã«ç™»éŒ²ç”»é¢ã¸
    setTimeout(() => {
        window.location.href = '../auth/register.html?redirect=' + 
            encodeURIComponent(window.location.href);
    }, 1000);
}
```

#### ã€Œã„ã„ãˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯

```javascript
handleRegistrationConsent(false) {
    // 1. ãŠåˆ¥ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    const farewellMessage = 'ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãã‚Œã§ã¯ã¾ãŸä½•ã‹ã‚ã£ãŸã‚‰é€£çµ¡ãã ã•ã„ã€‚ã“ã‚Œã¾ã§ã®ä¼šè©±ã®ä¸­èº«ã¯ç§ã¯å¿˜ã‚Œã¦ã—ã¾ã†ã¨æ€ã†ã®ã§ã€ä»Šåº¦æ¥ãŸæ™‚ã«ã¯ã‚¼ãƒ­ã‹ã‚‰è©±ã‚’ã—ã¦ãã ã•ã„ã­ã€‚ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚';
    ChatUI.addMessage('character', farewellMessage, 'ç¬¹å²¡é›ªä¹ƒ');
    
    // 2. å…¨å±¥æ­´ã‚¯ãƒªã‚¢
    this.clearGuestHistory();
    
    // 3. 3ç§’å¾Œã«main.htmlã¸
    setTimeout(() => {
        window.location.href = '../main.html';
    }, 3000);
}
```

### 4. ã‚²ã‚¹ãƒˆå†è¨ªå•åˆ¶å¾¡ ğŸ†•

#### ãƒ•ãƒ©ã‚°ç®¡ç†

```javascript
// localStorage ã§æ°¸ç¶šåŒ–
localStorage.setItem('yukinoGuestConversed', 'true');
```

#### å†è¨ªå•æ™‚ã®å‹•ä½œ

```javascript
checkGuestRevisit() {
    // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (AuthState.isRegistered()) return;
    
    // ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
    const hasConversedAsGuest = localStorage.getItem('yukinoGuestConversed');
    
    if (hasConversedAsGuest === 'true') {
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        ChatUI.addMessage('character', 
            'å‰å›ã¯ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãŠè©±ã—ã„ãŸã ãã¾ã—ãŸãŒã€ç¶šãã‚’ãŠè©±ã—ã™ã‚‹ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚ç”Ÿå¹´æœˆæ—¥ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚ãŠé‡‘ãŒã‹ã‹ã£ãŸã‚Šã¯ã—ã¾ã›ã‚“ã‹ã‚‰ã€å®‰å¿ƒã—ã¦ãã ã•ã„ã­ã€‚', 
            'ç¬¹å²¡é›ªä¹ƒ'
        );
        
        // å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–
        messageInput.disabled = true;
        sendButton.disabled = true;
        
        // 3ç§’å¾Œã«ç™»éŒ²ç”»é¢ã¸å¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        setTimeout(() => {
            window.location.href = '../auth/register.html?redirect=' + 
                encodeURIComponent(window.location.href);
        }, 3000);
    }
}
```

---

## ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼

### 1. ç™»éŒ²å®Œäº†ç›´å¾Œï¼ˆåˆå›ã®ã¿ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜

```javascript
// pendingGuestHistoryMigration ã‹ã‚‰å–å¾—
const guestHistory = JSON.parse(sessionStorage.getItem('pendingGuestHistoryMigration'));

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆis_guest_message = 1ï¼‰
await env.DB.prepare(
    `INSERT INTO conversations (user_id, character_id, role, message, message_type, is_guest_message, timestamp)
     VALUES (?, ?, ?, ?, 'normal', 1, CURRENT_TIMESTAMP)`
).bind(user.id, 'yukino', entry.role, entry.content).run();
```

#### ç”»é¢è¡¨ç¤º

```
1. ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒã‚¯ãƒªãƒ¼ãƒ³ï¼ˆéå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—ï¼‰
2. é›ªä¹ƒãŒã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
3. ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨
4. ä¼šè©±ç¶™ç¶šå¯èƒ½
```

#### AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç™»éŒ²ç›´å¾Œï¼‰

```javascript
if (isJustRegistered) {
    yukinoSpecificInstruction = `
========================================
ã€ã€æœ€é‡è¦ãƒ»çµ¶å¯¾éµå®ˆã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç›´å¾Œã®åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
========================================

ç›¸è«‡è€…ã€Œ${userNickname}ã•ã‚“ã€ã¯ã€ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãŠè©±ã‚’ã—ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’å®Œäº†ã—ãŸã°ã‹ã‚Šã§ã™ã€‚

ã€å¿…é ˆã®å¯¾å¿œã€‘ï¼š
1. **ã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ã¨è¿ãˆã‚‹**
   - ä¾‹ï¼šã€Œ${userNickname}ã•ã‚“ã€ãŠã‹ãˆã‚Šãªã•ã„ã€

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨ã™ã‚‹**
   - ä¼šè©±å±¥æ­´ã®æœ€å¾Œã«ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€å†…å®¹ã‚’ã€ãã®ã¾ã¾å¼•ç”¨ã—ã¦ãã ã•ã„
   - ä¾‹ï¼šã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã€ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã€ã§ã—ãŸã‚ˆã­ã€

3. **ä¼šè©±ã‚’ç¶šã‘ã‚‹ã‹ç¢ºèªã™ã‚‹**
   - ä¾‹ï¼šã€Œã©ã‚“ãªè©±ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã€

ã€è¿”ç­”ã®ä¾‹ã€‘ï¼š
ã€Œ${userNickname}ã•ã‚“ã€ãŠã‹ãˆã‚Šãªã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã€ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã€ã§ã—ãŸã‚ˆã­ã€‚ã©ã‚“ãªè©±ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã€
========================================
`;
}
```

### 2. å†è¨ªå•æ™‚ï¼ˆæ¯å›ï¼‰ğŸ†•

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º

```javascript
// consult.ts
if (user && characterId === 'yukino') {
    // is_guest_message = 1 ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
    const guestUserMessages = conversationHistory
        .filter((msg) => msg.role === 'user' && msg.isGuestMessage === true)
        .map((msg) => msg.content);
    
    if (guestUserMessages.length > 0) {
        lastGuestMessage = guestUserMessages[guestUserMessages.length - 1];
        console.log('[consult] ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º:', lastGuestMessage);
    }
}

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ¸¡ã™
const systemPrompt = generateSystemPrompt(characterId, {
    // ...
    lastGuestMessage: lastGuestMessage,
});
```

#### AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå†è¨ªå•æ™‚ï¼‰

```javascript
if (userNickname && hasPreviousConversation && lastGuestMessage) {
    yukinoSpecificInstruction = `
========================================
ã€ã€æœ€é‡è¦ãƒ»çµ¶å¯¾éµå®ˆã€‘ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†è¨ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘
========================================

ç›¸è«‡è€…ã€Œ${userNickname}ã•ã‚“ã€ã¯æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãŠã‚Šã€å†è¨ªå•ã•ã‚Œã¾ã—ãŸã€‚
ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ä¼šè©±ã—ã¦ã„ãŸæ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã§ã™ï¼š

**ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š**
ã€Œ${lastGuestMessage}ã€

ã€å¿…é ˆã®å¯¾å¿œã€‘ï¼š
1. **ã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ã¨è¿ãˆã‚‹**
   - ä¾‹ï¼šã€Œ${userNickname}ã•ã‚“ã€ãŠã‹ãˆã‚Šãªã•ã„ã€

2. **ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨ã™ã‚‹**
   - ä¸Šè¨˜ã®ã€Œã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚’**ãã®ã¾ã¾å¼•ç”¨**ã—ã¦ãã ã•ã„
   - ä¾‹ï¼šã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã€${lastGuestMessage}ã€ã§ã—ãŸã‚ˆã­ã€

3. **ä¼šè©±ã‚’ä¿ƒã™**
   - ä¾‹ï¼šã€Œã©ã‚“ãªè©±ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã€

ã€è¿”ç­”ã®ä¾‹ã€‘ï¼š
ã€Œ${userNickname}ã•ã‚“ã€ãŠã‹ãˆã‚Šãªã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã€${lastGuestMessage}ã€ã§ã—ãŸã‚ˆã­ã€‚ã©ã‚“ãªè©±ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã€
========================================
`;
}
```

### 3. é€šå¸¸ã®ä¼šè©±

- ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®ææ¡ˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- 1æšã‚«ãƒ¼ãƒ‰é‘‘å®š
- ç›¸è«‡ã¸ã®å›ç­”

---

## ã‚¿ãƒ­ãƒƒãƒˆå ã„ã‚·ã‚¹ãƒ†ãƒ 

### 3æšã‚«ãƒ¼ãƒ‰é‘‘å®šï¼ˆåˆå›é™å®šï¼‰

#### ãƒ•ãƒ­ãƒ¼

```
1. ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹
2. è‡ªå‹•çš„ã«ã‚¿ãƒ­ãƒƒãƒˆå ã„é–‹å§‹
3. ã€Œéå»ã€ã€Œç¾åœ¨ã€ã€Œæœªæ¥ã€ã®3æš
4. å„ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹ â†’ é›ªä¹ƒã®è§£èª¬
5. ã¾ã¨ã‚é‘‘å®š
6. ã€Œå€‹åˆ¥ç›¸è«‡ã€ãƒœã‚¿ãƒ³ â†’ é€šå¸¸ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
```

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `public/js/features/yukino-tarot.js`

#### sessionStorageç®¡ç†

```javascript
// ã‚¿ãƒ­ãƒƒãƒˆé–¢é€£ãƒ•ãƒ©ã‚°
yukinoThreeCardsPrepared = 'true'        // 3æšæº–å‚™æ¸ˆã¿
yukinoAllThreeCards = '[...]'            // å…¨ã‚«ãƒ¼ãƒ‰æƒ…å ±
yukinoRemainingCards = '[...]'           // æ®‹ã‚Šã‚«ãƒ¼ãƒ‰
yukinoTarotCardForExplanation = '{...}'  // è§£èª¬ä¸­ã®ã‚«ãƒ¼ãƒ‰
yukinoSummaryShown = 'true'              // ã¾ã¨ã‚è¡¨ç¤ºæ¸ˆã¿
```

### 1æšã‚«ãƒ¼ãƒ‰é‘‘å®šï¼ˆè¿½åŠ ç›¸è«‡æ™‚ï¼‰

#### ãƒˆãƒªã‚¬ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œæ‚©ã‚“ã§ã„ã‚‹ã€ã€Œå›°ã£ã¦ã„ã‚‹ã€ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€AIãŒ `[SUGGEST_TAROT]` ãƒãƒ¼ã‚«ãƒ¼ã‚’ä»˜ã‘ã‚‹ã€‚

#### ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œæ‹æ„›ã®ã“ã¨ã§æ‚©ã‚“ã§ã„ã¾ã™ã€
2. AI: [SUGGEST_TAROT]ãŠæ‚©ã¿ã®ã‚ˆã†ã§ã™ã­...
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ã€Œã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ãƒœã‚¿ãƒ³è¡¨ç¤º
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯
5. ã‚«ãƒ¼ãƒ‰è¡¨ç¤º â†’ ã‚ãã‚‹ â†’ é›ªä¹ƒã®è§£èª¬
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### conversations ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE IF NOT EXISTS conversations (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  character_id TEXT NOT NULL CHECK(character_id IN ('kaede', 'yukino', 'sora', 'kaon')),
  role TEXT NOT NULL CHECK(role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  message_type TEXT DEFAULT 'normal' CHECK(message_type IN ('normal', 'system', 'warning')),
  is_guest_message BOOLEAN DEFAULT 0,  -- â˜… ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ãƒ©ã‚°
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### is_guest_message ã®ä½¿ã„æ–¹

| å€¤ | æ„å‘³ | ç”¨é€” |
|---|------|------|
| `1` | ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | ç™»éŒ²å¾Œã«å¼•ç”¨ã™ã‚‹ãŸã‚ |
| `0` | ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | é€šå¸¸ã®ä¼šè©±å±¥æ­´ |

### ã‚¯ã‚¨ãƒªä¾‹

```sql
-- ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
SELECT message
FROM conversations
WHERE user_id = ? 
  AND character_id = 'yukino'
  AND role = 'user'
  AND is_guest_message = 1
ORDER BY timestamp DESC
LIMIT 1;
```

---

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### yukino-handler.js

#### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

```javascript
const YukinoHandler = {
    characterId: 'yukino',
    characterName: 'ç¬¹å²¡é›ªä¹ƒ',
    
    // åˆæœŸåŒ–
    init() {
        // ã‚¿ãƒ­ãƒƒãƒˆæ©Ÿèƒ½åˆæœŸåŒ–
        if (window.YukinoTarot) {
            window.YukinoTarot.init();
        }
        
        // ã‚²ã‚¹ãƒˆå†è¨ªå•ãƒã‚§ãƒƒã‚¯
        this.checkGuestRevisit();
    },
    
    // ã‚²ã‚¹ãƒˆå†è¨ªå•ãƒã‚§ãƒƒã‚¯
    checkGuestRevisit() {
        if (AuthState.isRegistered()) return;
        
        const hasConversedAsGuest = localStorage.getItem('yukinoGuestConversed');
        if (hasConversedAsGuest === 'true') {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + 3ç§’å¾Œãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        }
    },
    
    // ã‚²ã‚¹ãƒˆä¼šè©±è¨˜éŒ²
    markGuestConversed() {
        localStorage.setItem('yukinoGuestConversed', 'true');
    },
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
    async handleResponse(response, character) {
        if (character !== 'yukino') return false;
        
        // ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ä¼šè©±è¨˜éŒ²
        if (!AuthState.isRegistered()) {
            this.markGuestConversed();
        }
        
        // 9é€šç›®ãƒã‚§ãƒƒã‚¯
        const isYukinoConsultation = sessionStorage.getItem('yukinoConsultationStarted') === 'true';
        if (isYukinoConsultation && response.needsRegistration) {
            await this.handleNinthMessageRegistration(character);
            return true;
        }
        
        return false;
    },
    
    // 9é€šç›®ç™»éŒ²ç¢ºèª
    async handleNinthMessageRegistration(character) {
        // ã‚²ã‚¹ãƒˆå±¥æ­´ã‚’ä¿å­˜
        const guestHistory = ChatData.getGuestHistory(character) || [];
        sessionStorage.setItem('pendingGuestHistoryMigration', JSON.stringify({
            character: character,
            history: guestHistory
        }));
        
        // å…¥åŠ›æ¬„ç„¡åŠ¹åŒ–
        messageInput.disabled = true;
        sendButton.disabled = true;
        
        // ãƒœã‚¿ãƒ³è¡¨ç¤º
        this.showRegistrationButtons();
    },
    
    // ç™»éŒ²ç¢ºèªãƒœã‚¿ãƒ³è¡¨ç¤º
    showRegistrationButtons() {
        // ã€Œã¯ã„ã€ã€Œã„ã„ãˆã€ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
    },
    
    // ç™»éŒ²ç¢ºèªå‡¦ç†
    handleRegistrationConsent(consent) {
        this.hideRegistrationButtons();
        
        if (consent) {
            // ã€Œã¯ã„ã€: 1ç§’å¾Œã«ç™»éŒ²ç”»é¢ã¸
            setTimeout(() => {
                window.location.href = '../auth/register.html?redirect=' + 
                    encodeURIComponent(window.location.href);
            }, 1000);
        } else {
            // ã€Œã„ã„ãˆã€: ãŠåˆ¥ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + 3ç§’å¾Œã«main.htmlã¸
            ChatUI.addMessage('character', farewellMessage, this.characterName);
            this.clearGuestHistory();
            setTimeout(() => {
                window.location.href = '../main.html';
            }, 3000);
        }
    },
    
    // ã‚²ã‚¹ãƒˆå±¥æ­´ã‚¯ãƒªã‚¢
    clearGuestHistory() {
        AuthState.clearGuestHistory('yukino');
        sessionStorage.removeItem('guestConversationHistory_yukino');
        sessionStorage.removeItem('pendingGuestHistoryMigration');
        ChatData.setGuestMessageCount('yukino', 0);
        
        // ã‚¿ãƒ­ãƒƒãƒˆé–¢é€£ãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢
        sessionStorage.removeItem('yukinoThreeCardsPrepared');
        sessionStorage.removeItem('yukinoAllThreeCards');
        sessionStorage.removeItem('yukinoRemainingCards');
        sessionStorage.removeItem('yukinoTarotCardForExplanation');
        sessionStorage.removeItem('yukinoSummaryShown');
        sessionStorage.removeItem('yukinoFirstMessageInSession');
        sessionStorage.removeItem('yukinoConsultationStarted');
        sessionStorage.removeItem('yukinoConsultationMessageCount');
    },
    
    // ç™»éŒ²å®Œäº†å¾Œå‡¦ç†
    async handlePostRegistration(historyData) {
        // ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¼šè©±ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        localStorage.removeItem('yukinoGuestConversed');
        return false; // å…±é€šå‡¦ç†ã‚’ç¶šè¡Œ
    }
};
```

### localStorageç®¡ç†

| ã‚­ãƒ¼ | å€¤ | ç”¨é€” |
|------|---|------|
| `yukinoGuestConversed` | `'true'` | ã‚²ã‚¹ãƒˆã§ä¼šè©±ã—ãŸã“ã¨ãŒã‚ã‚‹ãƒ•ãƒ©ã‚° |

### sessionStorageç®¡ç†

| ã‚­ãƒ¼ | å€¤ | ç”¨é€” |
|------|---|------|
| `guestConversationHistory_yukino` | `[...]` | ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ä¼šè©±å±¥æ­´ |
| `pendingGuestHistoryMigration` | `{...}` | ç™»éŒ²æ™‚ã«ç§»è¡Œã™ã‚‹å±¥æ­´ |
| `yukinoConsultationStarted` | `'true'` | å€‹åˆ¥ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰é–‹å§‹æ¸ˆã¿ |
| `yukinoConsultationMessageCount` | `'0'ã€œ'9'` | å€‹åˆ¥ç›¸è«‡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° |

---

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### consult.ts

#### 9é€šç›®åˆ¤å®š

```typescript
// ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã€9é€šç›®ã®å ´åˆã«ç™»éŒ²ã‚’ä¿ƒã™
const needsRegistration = !user && characterId === 'yukino' && sanitizedGuestCount === 8;
```

#### ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ½å‡º

```typescript
let lastGuestMessage: string | null = null;

if (user && characterId === 'yukino') {
    // is_guest_message = 1 ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
    const guestUserMessages = conversationHistory
        .filter((msg) => msg.role === 'user' && msg.isGuestMessage === true)
        .map((msg) => msg.content);
    
    if (guestUserMessages.length > 0) {
        lastGuestMessage = guestUserMessages[guestUserMessages.length - 1];
    }
}
```

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ

```typescript
const systemPrompt = generateSystemPrompt(characterId, {
    needsRegistration: needsRegistration,
    userNickname: user?.nickname,
    hasPreviousConversation: conversationHistory.length > 0,
    userMessageCount: userMessageCount,
    isJustRegistered: isJustRegistered,
    lastGuestMessage: lastGuestMessage, // â˜… è¿½åŠ 
});
```

### yukino.js (AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)

#### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ 

```javascript
export function generateYukinoPrompt(options = {}) {
  const {
    userNickname,
    hasPreviousConversation,
    userMessageCount,
    isJustRegistered,
    needsRegistration,
    lastGuestMessage, // â˜… è¿½åŠ 
  } = options;

  let yukinoSpecificInstruction = '';
  
  // 9é€šç›®ï¼šç™»éŒ²ä¿ƒé€²
  if (needsRegistration) {
    yukinoSpecificInstruction = `
ã€å¿…é ˆã®å¯¾å¿œã€‘ï¼š
1. ç¾åœ¨ã¾ã§ã®ç›¸è«‡ã‚’æŒ¯ã‚Šè¿”ã‚‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®å¿…è¦æ€§ã‚’ä¼ãˆã‚‹
3. ç™»éŒ²å†…å®¹ã‚’èª¬æ˜ï¼ˆç”Ÿå¹´æœˆæ—¥ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰
4. å®‰å¿ƒæ„Ÿã‚’æä¾›ï¼ˆç„¡æ–™ã€å®‰å…¨ï¼‰
5. ç™»éŒ²ã‚’ä¿ƒã™
`;
  }
  // ç™»éŒ²ç›´å¾Œã®åˆå›
  else if (userNickname && isJustRegistered) {
    yukinoSpecificInstruction = `
ã€å¿…é ˆã®å¯¾å¿œã€‘ï¼š
1. ã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ã¨è¿ãˆã‚‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨ã™ã‚‹
3. ä¼šè©±ã‚’ç¶šã‘ã‚‹ã‹ç¢ºèªã™ã‚‹
`;
  }
  // å†è¨ªå•æ™‚ï¼ˆã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆï¼‰
  else if (userNickname && hasPreviousConversation && lastGuestMessage) {
    yukinoSpecificInstruction = `
ã€å¿…é ˆã®å¯¾å¿œã€‘ï¼š
1. ã€ŒãŠã‹ãˆã‚Šãªã•ã„ã€ã¨è¿ãˆã‚‹
2. ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨ã™ã‚‹
   ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ã€${lastGuestMessage}ã€ã§ã—ãŸã‚ˆã­ã€
3. ä¼šè©±ã‚’ä¿ƒã™
`;
  }
  // é€šå¸¸ã®ä¼šè©±
  else if (userNickname && hasPreviousConversation) {
    yukinoSpecificInstruction = `
ã€æ­£ã—ã„å¯¾å¿œã€‘ï¼š
âœ… ã‚¿ãƒ­ãƒƒãƒˆå ã„ã‚„é€šå¸¸ã®ç›¸è«‡ã«ä¸å¯§ã«å¯¾å¿œ
âœ… å¿…è¦ã«å¿œã˜ã¦ã€1æšã®ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã“ã¨ã‚’ææ¡ˆ
`;
  }
  
  return yukinoSpecificInstruction;
}
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¼•ç”¨ã•ã‚Œãªã„

**åŸå› :**
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã« `is_guest_message = 1` ã§ä¿å­˜ã•ã‚Œã¦ã„ãªã„
- `lastGuestMessage` ãŒæŠ½å‡ºã§ãã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```sql
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèª
SELECT role, message, is_guest_message
FROM conversations
WHERE user_id = ? AND character_id = 'yukino'
ORDER BY timestamp DESC
LIMIT 20;
```

#### 2. ã‚²ã‚¹ãƒˆå†è¨ªå•ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œãªã„

**åŸå› :**
- `localStorage.yukinoGuestConversed` ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•:**
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª
localStorage.getItem('yukinoGuestConversed')

// æ‰‹å‹•ã§ã‚»ãƒƒãƒˆ
localStorage.setItem('yukinoGuestConversed', 'true')
```

#### 3. 9é€šç›®ã§ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› :**
- `yukinoConsultationStarted` ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£ã—ããªã„

**è§£æ±ºæ–¹æ³•:**
```javascript
// sessionStorageã‚’ç¢ºèª
sessionStorage.getItem('yukinoConsultationStarted')
sessionStorage.getItem('yukinoConsultationMessageCount')

// æ‰‹å‹•ã§ã‚»ãƒƒãƒˆ
sessionStorage.setItem('yukinoConsultationStarted', 'true')
sessionStorage.setItem('yukinoConsultationMessageCount', '8')
```

---

## ã¾ã¨ã‚

### ã‚·ã‚¹ãƒ†ãƒ ã®å¼·ã¿

1. **ã‚²ã‚¹ãƒˆä½“é¨“ã®æœ€é©åŒ–**: ã‚¿ãƒ­ãƒƒãƒˆå ã„ã§èˆˆå‘³ã‚’å¼•ã
2. **è‡ªç„¶ãªç™»éŒ²ä¿ƒé€²**: 9é€šç›®ã§è‡ªç„¶ã«ç™»éŒ²ã‚’ä¿ƒã™
3. **å†è¨ªå•åˆ¶å¾¡**: ä¸€åº¦ä¼šè©±ã—ãŸã‚²ã‚¹ãƒˆã¯å¿…ãšç™»éŒ²ã¸
4. **ç¶™ç¶šçš„ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ**: æ¯å›ã‚²ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼•ç”¨

### ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

- ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’å¢—ã‚„ã™
- å ã„çµæœã®è©³ç´°åŒ–
- ç›¸è«‡ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®åˆ†é¡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆè€…**: AI Assistant  
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: Cloudflare Pages, D1 Database, OpenAI API  
**ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**: ãƒ—ãƒ­ãƒ—ãƒ©ã‚¤ã‚¨ã‚¿ãƒª
