# ゲストチャットHTMLとチャットHTMLの挙動フロー図

## 全体フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                    トップページ (index.html)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  ユーザータイプ判定  │
                    └─────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │   ゲストユーザー        │   │   登録ユーザー        │
    │  (未登録)              │   │  (登録済み)          │
    └───────────────────────┘   └───────────────────────┘
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │  guest-chat.html      │   │  chat.html            │
    │  (ゲストチャット画面)   │   │  (登録ユーザーチャット) │
    └───────────────────────┘   └───────────────────────┘
```

## ゲストユーザーのフロー (guest-chat.html)

```
┌─────────────────────────────────────────────────────────────────┐
│                   ゲストユーザーがアクセス                        │
│                  guest-chat.html?character=kaede                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  AuthState確認   │
                    │  isRegistered() │
                    └─────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                    │
            ┌───────▼───────┐   ┌───────▼───────┐
            │ 登録ユーザー    │   │ ゲストユーザー  │
            │ (isRegistered) │   │ (!isRegistered)│
            └───────┬───────┘   └───────┬───────┘
                    │                   │
                    │                   │
        ┌───────────▼───────────┐      │
        │ chat.htmlにリダイレクト │      │
        │ (登録ユーザー用画面へ)  │      │
        └───────────────────────┘      │
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │  ゲストチャット画面を表示   │
                        │  - ログインモーダルなし    │
                        │  - 守護神表示なし          │
                        │  - ゲストモード表示        │
                        └───────────────────────────┘
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │  メッセージ送信 (最大10通)  │
                        │  messageCount < 10        │
                        └───────────────────────────┘
                                        │
                        ┌───────────────┴───────────────┐
                        │                               │
                ┌───────▼───────┐           ┌──────────▼──────────┐
                │ messageCount   │           │ messageCount >= 4   │
                │ < 4            │           │ (Phase 4到達)       │
                └───────┬───────┘           └──────────┬──────────┘
                        │                               │
                        │                               ▼
                        │               ┌───────────────────────────┐
                        │               │ ゲスト履歴をsessionStorage │
                        │               │ に保存                     │
                        │               │ pendingGuestHistoryMigration│
                        │               └───────────────────────────┘
                        │                               │
                        │                               ▼
                        │               ┌───────────────────────────┐
                        │               │ 登録画面にリダイレクト      │
                        │               │ ../auth/register.html     │
                        │               │ ?redirect=chat.html       │
                        │               └───────────────────────────┘
                        │
                        ▼
            ┌───────────────────────────┐
            │  通常のチャット継続         │
            │  (Phase 1-3)              │
            └───────────────────────────┘
```

## 登録ユーザーのフロー (chat.html)

```
┌─────────────────────────────────────────────────────────────────┐
│                   登録ユーザーがアクセス                          │
│                  chat.html?character=kaede                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  AuthState確認   │
                    │  isRegistered() │
                    └─────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                    │
            ┌───────▼───────┐   ┌───────▼───────┐
            │ 登録ユーザー    │   │ ゲストユーザー  │
            │ (isRegistered) │   │ (!isRegistered)│
            └───────┬───────┘   └───────┬───────┘
                    │                   │
                    │                   │
                    │           ┌───────▼───────┐
                    │           │ guest-chat.html│
                    │           │ にリダイレクト  │
                    │           └───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │  ログイン状態を確認         │
        │  userToken存在チェック     │
        └───────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐       ┌───────────────┐
│ userTokenなし │       │ userTokenあり │
│ (未ログイン)   │       │ (ログイン済み) │
└───────┬───────┘       └───────┬───────┘
        │                       │
        ▼                       │
┌───────────────┐               │
│ ログインモーダル │               │
│ を表示          │               │
│ - ニックネーム  │               │
│ - 生年月日      │               │
│ - 合言葉        │               │
└───────┬───────┘               │
        │                       │
        ▼                       │
┌───────────────┐               │
│ ログイン成功    │               │
│ userToken保存  │               │
└───────┬───────┘               │
        │                       │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │  守護神情報をチェック       │
        │  assignedDeity存在確認     │
        └───────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐       ┌───────────────┐
│ 守護神あり      │       │ 守護神なし      │
│ (assignedDeity)│       │ (!assignedDeity)│
└───────┬───────┘       └───────┬───────┘
        │                       │
        ▼                       │
┌───────────────┐               │
│ 守護神名を表示  │               │
│ (guardianDisplay)│              │
└───────┬───────┘               │
        │                       │
        │                       │
        │               ┌───────┴───────────┐
        │               │                   │
        │       ┌───────▼───────┐   ┌───────▼───────┐
        │       │ character=kaede│   │ character≠kaede│
        │       │ (楓)          │   │ (他の鑑定士)   │
        │       └───────┬───────┘   └───────┬───────┘
        │               │                   │
        │               │                   │
        │               ▼                   ▼
        │       ┌───────────────┐   ┌───────────────┐
        │       │ 守護神の儀式    │   │ 通常のチャット  │
        │       │ ボタンを表示    │   │ 開始           │
        │       │ (儀式開始ボタン) │   │ (履歴継承)     │
        │       └───────┬───────┘   └───────────────┘
        │               │
        │               ▼
        │       ┌───────────────┐
        │       │ 儀式実行       │
        │       │ 守護神割り当て  │
        │       └───────┬───────┘
        │               │
        │               ▼
        │       ┌───────────────┐
        │       │ 守護神名を表示  │
        │       │ チャット開始   │
        │       └───────┬───────┘
        │               │
        └───────────────┘
                    │
                    ▼
        ┌───────────────────────────┐
        │  登録ユーザーのチャット開始  │
        │  - 守護神名表示            │
        │  - 会話履歴継承            │
        │  - 無制限メッセージ        │
        └───────────────────────────┘
```

## 登録完了後のフロー

```
┌─────────────────────────────────────────────────────────────────┐
│              ゲストユーザーがPhase 4到達                         │
│              (messageCount >= 4)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ ゲスト履歴を保存  │
                    │ sessionStorage │
                    │ pendingGuestHistoryMigration│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 登録画面にリダイレクト│
                    │ ../auth/register.html│
                    │ ?redirect=chat.html│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ ユーザー登録完了  │
                    │ - ニックネーム   │
                    │ - 生年月日       │
                    │ - 合言葉(守護神) │
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ chat.htmlにリダイレクト│
                    │ ?character=kaede│
                    │ &justRegistered=true│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ ログイン状態確認  │
                    │ (userToken保存済み)│
                    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 守護神情報チェック│
                    │ assignedDeity   │
                    └─────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                    │
            ┌───────▼───────┐   ┌───────▼───────┐
            │ 守護神あり      │   │ 守護神なし      │
            │ (登録時に割当)   │   │ (未割当)       │
            └───────┬───────┘   └───────┬───────┘
                    │                    │
                    │                    │
        ┌───────────▼───────────┐       │
        │ 守護神名を表示          │       │
        │ チャット開始           │       │
        └───────────────────────┘       │
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │ 楓の場合: 守護神の儀式ボタン│
                        │ を表示                     │
                        │ (ゲスト履歴を使用)         │
                        └───────────────────────────┘
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │ 儀式実行                   │
                        │ 守護神割り当て              │
                        └───────────────────────────┘
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │ 守護神名を表示              │
                        │ チャット開始                │
                        └───────────────────────────┘
```

## 重要なポイント

1. **ゲストユーザー (guest-chat.html)**
   - 登録ユーザーがアクセスした場合 → `chat.html`にリダイレクト
   - Phase 4到達時 → 登録画面にリダイレクト
   - ログインモーダルなし
   - 守護神表示なし

2. **登録ユーザー (chat.html)**
   - ゲストユーザーがアクセスした場合 → `guest-chat.html`にリダイレクト
   - 未ログイン時 → ログインモーダル表示
   - ログイン済み → 守護神情報チェック
   - 守護神あり → 守護神名表示してチャット開始
   - 守護神なし（楓の場合） → 守護神の儀式ボタン表示

3. **登録完了後**
   - `justRegistered=true`フラグで識別
   - ゲスト履歴を継承（楓の場合）
   - 守護神の儀式を実行（楓の場合）

